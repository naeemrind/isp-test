This file is a merged representation of a subset of the codebase, containing specifically included files, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Only files matching these patterns are included: **/*.{js,jsx}
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
eslint.config.js
src/App.jsx
src/components/layout/Navbar.jsx
src/components/shared/WhatsAppButton.jsx
src/components/ui/BackupBanner.jsx
src/components/ui/Badge.jsx
src/components/ui/ConfirmDialog.jsx
src/components/ui/ConnectionJobsLog.jsx
src/components/ui/HistoryModal.jsx
src/components/ui/InvoiceModal.jsx
src/components/ui/Issuehistorymodal.jsx
src/components/ui/IssueStockModal.jsx
src/components/ui/Modal.jsx
src/components/ui/RestockHistoryModal.jsx
src/components/ui/RestockModal.jsx
src/config/messageTemplates.js
src/db/database.js
src/main.jsx
src/pages/Customers/CustomerForm.jsx
src/pages/Customers/Customers.jsx
src/pages/Customers/CustomerTable.jsx
src/pages/Customers/NewConnectionForm.jsx
src/pages/Dashboard.jsx
src/pages/Expenses/ExpenseForm.jsx
src/pages/Expenses/Expenses.jsx
src/pages/Inventory/Inventory.jsx
src/pages/Inventory/InventoryForm.jsx
src/pages/Login.jsx
src/pages/Payments/PaymentForm.jsx
src/pages/Settings.jsx
src/store/useConnectionJobStore.js
src/store/useCustomerStore.js
src/store/useExpenseStore.js
src/store/useInventoryStore.js
src/store/usePackageStore.js
src/store/usePaymentStore.js
src/utils/backup.js
src/utils/dateUtils.js
src/utils/devTools.js
src/utils/duplicateCheck.js
src/utils/Statusutils.js
vite.config.js
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="eslint.config.js">
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import { defineConfig, globalIgnores } from 'eslint/config'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{js,jsx}'],
    extends: [
      js.configs.recommended,
      reactHooks.configs.flat.recommended,
      reactRefresh.configs.vite,
    ],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
      parserOptions: {
        ecmaVersion: 'latest',
        ecmaFeatures: { jsx: true },
        sourceType: 'module',
      },
    },
    rules: {
      'no-unused-vars': ['error', { varsIgnorePattern: '^[A-Z_]' }],
    },
  },
])
</file>

<file path="src/components/shared/WhatsAppButton.jsx">
import { generateWhatsAppLink } from "../../config/messageTemplates";

export default function WhatsAppButton({ mobileNo, message, label = "Send" }) {
  if (!mobileNo || String(mobileNo).replace(/\D/g, "").length < 10) {
    return <span className="text-xs text-gray-400">No mobile</span>;
  }

  const link = generateWhatsAppLink(mobileNo, message);

  return (
    <a
      href={link}
      target="_blank"
      rel="noopener noreferrer"
      className="inline-flex items-center gap-1 px-2 py-1 text-xs bg-green-600 text-white rounded hover:bg-green-700"
    >
      <svg
        viewBox="0 0 24 24"
        className="w-3 h-3 fill-current"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z" />
      </svg>
      {label}
    </a>
  );
}
</file>

<file path="src/components/ui/BackupBanner.jsx">
import { useState, useEffect } from "react";
import { AlertTriangle } from "lucide-react";
import { getLastBackupDate, exportBackup } from "../../utils/backup";
import { today } from "../../utils/dateUtils";

export default function BackupBanner() {
  const [show, setShow] = useState(false);
  const [loading, setLoading] = useState(false);

  useEffect(() => {
    getLastBackupDate().then((date) => {
      if (date !== today()) setShow(true);
    });
  }, []);

  if (!show) return null;

  const handleBackup = async () => {
    setLoading(true);
    await exportBackup();
    setLoading(false);
    setShow(false);
  };

  return (
    <div className="bg-amber-50 border-b border-amber-200 px-4 py-2 flex items-center justify-between text-sm">
      <div className="flex items-center gap-2 text-amber-800">
        <AlertTriangle size={15} />
        <span>No backup yet today. Save your data before closing.</span>
      </div>
      <button
        onClick={handleBackup}
        disabled={loading}
        className="text-amber-800 underline font-medium hover:text-amber-900 disabled:opacity-50"
      >
        {loading ? "Saving..." : "Backup Now"}
      </button>
    </div>
  );
}
</file>

<file path="src/components/ui/ConfirmDialog.jsx">
import { useState, useEffect } from "react";
import { AlertTriangle, Trash2, Eye, EyeOff, Archive } from "lucide-react";
import Modal from "./Modal";

// Updated to match your Login credentials
const ADMIN_PASSWORD = "admin1357";

export default function ConfirmDialog({
  isOpen,
  onClose,
  onConfirm,
  title,
  message,
  confirmLabel = "Delete",
  danger = true,
  confirmText = null,
  requirePassword = false,
  showReason = false,
  reasonLabel = "Reason (optional)",
}) {
  const [typed, setTyped] = useState("");
  const [password, setPassword] = useState("");
  const [showPw, setShowPw] = useState(false);
  const [pwError, setPwError] = useState("");
  const [reason, setReason] = useState("");

  useEffect(() => {
    if (isOpen) {
      const timer = setTimeout(() => {
        setTyped("");
        setPassword("");
        setPwError("");
        setShowPw(false);
        setReason("");
      }, 0);
      return () => clearTimeout(timer);
    }
  }, [isOpen, confirmText]);

  const nameOk = confirmText
    ? typed.trim() === confirmText.trim() && typed.length > 0
    : true;
  const passwordOk = requirePassword ? password === ADMIN_PASSWORD : true;
  const canConfirm =
    nameOk && (requirePassword ? password.length > 0 && passwordOk : true);

  const handleConfirm = () => {
    if (confirmText && !nameOk) return;
    if (requirePassword && password !== ADMIN_PASSWORD) {
      setPwError("Incorrect admin password.");
      return;
    }
    onConfirm(reason);
    onClose();
  };

  let stepNum = 0;
  const stepCount = [confirmText, requirePassword].filter(Boolean).length;

  return (
    <Modal isOpen={isOpen} onClose={onClose} title={title} size="sm">
      <div className="space-y-4">
        {/* Warning */}
        <div className="flex gap-3 bg-red-50 border border-red-200 rounded-lg p-3">
          <div className="shrink-0 w-9 h-9 rounded-full bg-red-100 flex items-center justify-center">
            <AlertTriangle size={18} className="text-red-600" />
          </div>
          <p className="text-sm text-red-800 leading-relaxed pt-0.5">
            {message}
          </p>
        </div>

        {/* Optional reason */}
        {showReason && (
          <div className="space-y-1.5">
            <label className="block text-xs font-semibold text-gray-600">
              {reasonLabel}
            </label>
            <input
              className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="e.g. Customer relocated, Duplicate entry..."
              value={reason}
              onChange={(e) => setReason(e.target.value)}
            />
          </div>
        )}

        {/* Step: type name */}
        {confirmText && (
          <div className="space-y-1.5">
            <label className="block text-xs font-semibold text-gray-600">
              {stepCount > 1 ? `Step ${++stepNum} — ` : ""}Type the customer
              name to confirm:
            </label>
            <div className="bg-gray-100 rounded px-2 py-1 text-xs font-mono font-bold text-gray-800 inline-block mb-1">
              {confirmText}
            </div>
            <input
              autoFocus
              className={`w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 transition-colors ${
                typed.length > 0 && !nameOk
                  ? "border-red-300 focus:ring-red-400 bg-red-50"
                  : nameOk
                    ? "border-green-400 focus:ring-green-400 bg-green-50"
                    : "border-gray-300 focus:ring-blue-500"
              }`}
              placeholder={`Type "${confirmText}"`}
              value={typed}
              onChange={(e) => setTyped(e.target.value)}
              onKeyDown={(e) => e.key === "Enter" && handleConfirm()}
            />
            {typed.length > 0 && !nameOk && (
              <p className="text-xs text-red-500">
                Name does not match. Check spelling and capitalisation.
              </p>
            )}
            {nameOk && (
              <p className="text-xs text-green-600 font-semibold">
                ✓ Name confirmed
              </p>
            )}
          </div>
        )}

        {/* Step: admin password */}
        {requirePassword && (
          <div className="space-y-1.5">
            <label className="block text-xs font-semibold text-gray-600">
              {stepCount > 1 ? `Step ${++stepNum} — ` : ""}Enter admin password:
            </label>
            <div className="relative">
              <input
                type={showPw ? "text" : "password"}
                className={`w-full border rounded-lg px-3 py-2 pr-10 text-sm focus:outline-none focus:ring-2 transition-colors ${
                  pwError
                    ? "border-red-300 focus:ring-red-400 bg-red-50"
                    : passwordOk && password.length > 0
                      ? "border-green-400 focus:ring-green-400 bg-green-50"
                      : "border-gray-300 focus:ring-blue-500"
                }`}
                placeholder="Admin password"
                value={password}
                onChange={(e) => {
                  setPassword(e.target.value);
                  setPwError("");
                }}
                onKeyDown={(e) => e.key === "Enter" && handleConfirm()}
              />
              <button
                type="button"
                onClick={() => setShowPw((s) => !s)}
                className="absolute right-2.5 top-2 text-gray-400 hover:text-gray-600"
              >
                {showPw ? <EyeOff size={16} /> : <Eye size={16} />}
              </button>
            </div>
            {pwError && (
              <p className="text-xs text-red-500 font-medium">{pwError}</p>
            )}
            {passwordOk && password.length > 0 && (
              <p className="text-xs text-green-600 font-semibold">
                ✓ Password correct
              </p>
            )}
          </div>
        )}

        {/* Buttons */}
        <div className="flex gap-2 justify-end pt-1">
          <button
            onClick={onClose}
            className="px-4 py-2 text-sm border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 font-medium"
          >
            Cancel
          </button>
          <button
            onClick={handleConfirm}
            disabled={!canConfirm}
            className={`px-4 py-2 text-sm rounded-lg font-semibold text-white flex items-center gap-1.5 ${
              danger
                ? "bg-red-600 hover:bg-red-700"
                : "bg-blue-600 hover:bg-blue-700"
            } disabled:opacity-40 disabled:cursor-not-allowed`}
          >
            {danger && <Archive size={14} />}
            {confirmLabel}
          </button>
        </div>
      </div>
    </Modal>
  );
}
</file>

<file path="src/components/ui/ConnectionJobsLog.jsx">
import { useState } from "react";
import {
  Search,
  X,
  User,
  Wrench,
  Package,
  Calendar,
  Trash2,
  ChevronDown,
  ChevronRight,
  FileText,
} from "lucide-react";
import useConnectionJobStore from "../../store/useConnectionJobStore";
import { formatDate } from "../../utils/dateUtils";

/**
 * ConnectionJobsLog
 * Shows all past connection jobs with filtering by subscriber / technician.
 * Expandable rows show line-by-line item details.
 */
export default function ConnectionJobsLog({ onClose }) {
  const jobs = useConnectionJobStore((s) => s.jobs);
  const deleteJob = useConnectionJobStore((s) => s.deleteJob);
  const [search, setSearch] = useState("");
  const [expanded, setExpanded] = useState(new Set());
  const [confirmDelete, setConfirmDelete] = useState(null);

  const filtered = [...jobs]
    .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
    .filter((j) => {
      if (!search.trim()) return true;
      const q = search.toLowerCase();
      return (
        j.subscriberName?.toLowerCase().includes(q) ||
        j.subscriberUsername?.toLowerCase().includes(q) ||
        j.technicianName?.toLowerCase().includes(q) ||
        j.note?.toLowerCase().includes(q) ||
        j.items?.some((i) => i.description?.toLowerCase().includes(q))
      );
    });

  const toggleExpand = (id) => {
    setExpanded((prev) => {
      const next = new Set(prev);
      if (next.has(id)) next.delete(id);
      else next.add(id);
      return next;
    });
  };

  const handleDelete = async (job) => {
    await deleteJob(job.id);
    setConfirmDelete(null);
  };

  const totalValue = filtered.reduce((s, j) => s + (j.totalValue || 0), 0);

  return (
    <div className="space-y-4">
      {/* Summary bar */}
      <div className="grid grid-cols-3 gap-3">
        <div className="bg-blue-50 border border-blue-100 rounded-xl px-3 py-2.5 text-center">
          <p className="text-xs text-blue-600 font-semibold uppercase tracking-wide">
            Jobs
          </p>
          <p className="text-xl font-black text-blue-700">{filtered.length}</p>
        </div>
        <div className="bg-green-50 border border-green-100 rounded-xl px-3 py-2.5 text-center">
          <p className="text-xs text-green-600 font-semibold uppercase tracking-wide">
            Total Value
          </p>
          <p className="text-lg font-black text-green-700">
            PKR {totalValue.toLocaleString()}
          </p>
        </div>
        <div className="bg-purple-50 border border-purple-100 rounded-xl px-3 py-2.5 text-center">
          <p className="text-xs text-purple-600 font-semibold uppercase tracking-wide">
            Items Issued
          </p>
          <p className="text-xl font-black text-purple-700">
            {filtered.reduce((s, j) => s + (j.items?.length || 0), 0)}
          </p>
        </div>
      </div>

      {/* Search */}
      <div className="relative">
        <Search
          size={14}
          className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"
        />
        <input
          type="text"
          placeholder="Search by subscriber, technician, item…"
          value={search}
          onChange={(e) => setSearch(e.target.value)}
          className="w-full pl-9 pr-8 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
        />
        {search && (
          <button
            onClick={() => setSearch("")}
            className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
          >
            <X size={14} />
          </button>
        )}
      </div>

      {/* Jobs list */}
      <div className="space-y-2 max-h-[58vh] overflow-y-auto pr-1">
        {filtered.length === 0 && (
          <div className="text-center py-12 text-gray-400">
            <Package size={32} className="mx-auto mb-3 opacity-30" />
            <p className="font-medium text-gray-500">
              No connection jobs found
            </p>
            <p className="text-xs mt-1">
              Use "New Connection Job" to issue items for a subscriber
            </p>
          </div>
        )}

        {filtered.map((job) => {
          const isOpen = expanded.has(job.id);
          return (
            <div
              key={job.id}
              className="border border-gray-200 rounded-xl overflow-hidden bg-white"
            >
              {/* Header row */}
              <div
                className="flex items-center gap-3 px-4 py-3 cursor-pointer hover:bg-gray-50 transition-colors"
                onClick={() => toggleExpand(job.id)}
              >
                <div className="text-gray-400">
                  {isOpen ? (
                    <ChevronDown size={16} />
                  ) : (
                    <ChevronRight size={16} />
                  )}
                </div>

                <div className="flex-1 min-w-0">
                  <div className="flex items-center gap-2 flex-wrap">
                    {job.subscriberName ? (
                      <span className="font-bold text-gray-900 text-sm">
                        {job.subscriberName}
                      </span>
                    ) : (
                      <span className="text-gray-400 text-sm italic">
                        No subscriber recorded
                      </span>
                    )}
                    {job.subscriberUsername && (
                      <span className="text-xs text-gray-400 bg-gray-100 px-2 py-0.5 rounded-full">
                        @{job.subscriberUsername}
                      </span>
                    )}
                    {job.technicianName && (
                      <span className="flex items-center gap-1 text-xs text-blue-700 bg-blue-50 px-2 py-0.5 rounded-full">
                        <Wrench size={10} /> {job.technicianName}
                      </span>
                    )}
                  </div>
                  <div className="flex items-center gap-3 mt-0.5">
                    <span className="flex items-center gap-1 text-xs text-gray-400">
                      <Calendar size={11} /> {formatDate(job.date)}
                    </span>
                    <span className="text-xs text-gray-400">
                      {job.items?.length || 0} item
                      {job.items?.length !== 1 ? "s" : ""}
                    </span>
                    {job.note && (
                      <span className="flex items-center gap-1 text-xs text-gray-400 truncate max-w-36">
                        <FileText size={11} /> {job.note}
                      </span>
                    )}
                  </div>
                </div>

                <div className="text-right shrink-0">
                  <p className="font-bold text-gray-900 text-sm">
                    PKR {(job.totalValue || 0).toLocaleString()}
                  </p>
                </div>

                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    setConfirmDelete(job);
                  }}
                  className="p-1.5 text-gray-300 hover:text-red-500 transition-colors shrink-0"
                  title="Delete job"
                >
                  <Trash2 size={14} />
                </button>
              </div>

              {/* Expanded detail */}
              {isOpen && (
                <div className="border-t border-gray-100 bg-gray-50 px-4 py-3 space-y-1.5">
                  {(job.items || []).map((item, idx) => (
                    <div
                      key={idx}
                      className="flex items-center justify-between text-sm"
                    >
                      <div className="flex items-center gap-2">
                        <Package size={13} className="text-gray-400 shrink-0" />
                        <span className="font-medium text-gray-800">
                          {item.description}
                        </span>
                        <span className="text-gray-400">
                          × {item.qty} {item.unit}
                        </span>
                        <span className="text-xs text-gray-400">
                          @ PKR {item.unitRate}/{item.unit}
                        </span>
                      </div>
                      <span className="font-semibold text-gray-700">
                        PKR {item.totalValue.toLocaleString()}
                      </span>
                    </div>
                  ))}
                  <div className="border-t border-gray-200 pt-2 flex justify-between font-bold text-sm">
                    <span className="text-gray-700">Total Material Value</span>
                    <span className="text-green-700">
                      PKR {(job.totalValue || 0).toLocaleString()}
                    </span>
                  </div>
                </div>
              )}
            </div>
          );
        })}
      </div>

      {/* Delete confirm */}
      {confirmDelete && (
        <div className="fixed inset-0 z-[999] bg-black/40 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm space-y-4">
            <p className="font-bold text-gray-900">Delete this job?</p>
            <p className="text-sm text-gray-500">
              Job for{" "}
              <strong>
                {confirmDelete.subscriberName || "Unknown subscriber"}
              </strong>{" "}
              on {formatDate(confirmDelete.date)} will be removed from history.
              <br />
              <span className="text-amber-600 font-medium">
                Note: Inventory changes are NOT reversed.
              </span>
            </p>
            <div className="flex gap-3">
              <button
                onClick={() => setConfirmDelete(null)}
                className="flex-1 py-2 border border-gray-300 rounded-lg text-sm font-semibold text-gray-700 hover:bg-gray-50"
              >
                Cancel
              </button>
              <button
                onClick={() => handleDelete(confirmDelete)}
                className="flex-1 py-2 bg-red-600 text-white rounded-lg text-sm font-semibold hover:bg-red-700"
              >
                Delete
              </button>
            </div>
          </div>
        </div>
      )}

      <button
        onClick={onClose}
        className="w-full py-2.5 border border-gray-300 rounded-lg text-sm font-semibold text-gray-700 hover:bg-gray-50"
      >
        Close
      </button>
    </div>
  );
}
</file>

<file path="src/components/ui/Modal.jsx">
// src/components/ui/Modal.jsx
import { useEffect } from "react";
import { X } from "lucide-react";

export default function Modal({
  isOpen,
  onClose,
  title,
  children,
  size = "md",
}) {
  useEffect(() => {
    const handler = (e) => {
      if (e.key === "Escape") onClose();
    };
    if (isOpen) document.addEventListener("keydown", handler);
    return () => document.removeEventListener("keydown", handler);
  }, [isOpen, onClose]);

  if (!isOpen) return null;

  // Added new 2xl and 3xl sizes
  const sizeClass =
    {
      sm: "max-w-sm",
      md: "max-w-lg",
      lg: "max-w-2xl",
      xl: "max-w-4xl",
      "2xl": "max-w-6xl", // ~1152px
      "3xl": "max-w-[1200px]", // Exactly 1200px
    }[size] || "max-w-lg";

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
      <div
        className={`bg-white rounded-lg shadow-xl w-full mx-4 ${sizeClass} max-h-[90vh] flex flex-col`}
      >
        <div className="flex items-center justify-between px-6 py-4 border-b border-gray-200">
          <h2 className="text-base font-semibold text-gray-800">{title}</h2>
          <button
            onClick={onClose}
            className="text-gray-400 hover:text-gray-600 p-1 rounded"
          >
            <X size={18} />
          </button>
        </div>
        <div className="overflow-y-auto flex-1 px-6 py-4">{children}</div>
      </div>
    </div>
  );
}
</file>

<file path="src/components/ui/RestockHistoryModal.jsx">
import {
  ArrowDownCircle,
  Package,
  FileText,
  Calendar,
  Inbox,
  Star,
} from "lucide-react";
import { formatDate } from "../../utils/dateUtils";

/**
 * RestockHistoryModal
 * Shows the original purchase + all restock events in a single timeline.
 *
 * Props:
 *  item    – the inventory item object
 *  onClose – callback to close
 */
export default function RestockHistoryModal({ item, onClose }) {
  // Restock log entries (newest first after reverse)
  const restockLog = Array.isArray(item.restockLog)
    ? [...item.restockLog].reverse()
    : [];

  // Build the original purchase entry from the item itself
  const originalEntry = {
    _isOriginal: true,
    date: item.date,
    qty: item.quantity || 0,
    unitRate: item.unitRate || 0,
    invoiceNo: item.invoiceNo || null,
    poNo: item.poNo || null,
    note: item.remarks || null,
    inHandAfter: null, // we don't know the exact state at creation
  };

  // Full timeline: restocks newest-first, original at the bottom
  const timeline = [...restockLog, originalEntry];

  // Totals include original purchase + all restocks
  const totalAllQty =
    (item.quantity || 0) + restockLog.reduce((sum, e) => sum + (e.qty || 0), 0);
  const totalAllSpent =
    (item.quantity || 0) * (item.unitRate || 0) +
    restockLog.reduce((sum, e) => sum + (e.qty || 0) * (e.unitRate || 0), 0);

  return (
    <div className="space-y-4">
      {/* Item summary bar */}
      <div className="bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 flex items-center justify-between gap-4 flex-wrap">
        <div className="flex items-center gap-2.5">
          <Package size={16} className="text-gray-500" />
          <div>
            <p className="font-bold text-gray-900">{item.description}</p>
            <p className="text-xs text-gray-500 mt-0.5">
              Unit:{" "}
              <span className="font-semibold text-gray-700">{item.unit}</span>
            </p>
          </div>
        </div>
        <div className="flex items-center gap-5 text-center">
          <div>
            <p className="text-xs text-gray-400 font-medium">Total Purchased</p>
            <p className="text-lg font-black text-green-600">+{totalAllQty}</p>
          </div>
          <div>
            <p className="text-xs text-gray-400 font-medium">Total Spent</p>
            <p className="text-lg font-black text-blue-600">
              PKR {totalAllSpent.toLocaleString()}
            </p>
          </div>
          <div>
            <p className="text-xs text-gray-400 font-medium">Purchases</p>
            <p className="text-lg font-black text-gray-700">
              {timeline.length}
            </p>
          </div>
        </div>
      </div>

      {/* Timeline */}
      <div className="relative">
        {/* vertical line */}
        <div className="absolute left-4.75 top-0 bottom-0 w-px bg-gray-200" />

        <div className="space-y-3">
          {timeline.map((entry, idx) => {
            const isOriginal = entry._isOriginal;
            const purchaseValue = (entry.qty || 0) * (entry.unitRate || 0);

            return (
              <div key={idx} className="flex gap-3 relative">
                {/* Timeline dot */}
                <div className="shrink-0 w-10 flex justify-center pt-1">
                  <div
                    className={`w-5 h-5 rounded-full flex items-center justify-center z-10 border-2 ${
                      isOriginal
                        ? "bg-blue-100 border-blue-400"
                        : "bg-green-100 border-green-400"
                    }`}
                  >
                    {isOriginal ? (
                      <Star size={9} className="text-blue-600" />
                    ) : (
                      <ArrowDownCircle size={10} className="text-green-600" />
                    )}
                  </div>
                </div>

                {/* Card */}
                <div
                  className={`flex-1 border rounded-xl px-4 py-3 shadow-sm mb-1 ${
                    isOriginal
                      ? "bg-blue-50 border-blue-200"
                      : "bg-white border-gray-200"
                  }`}
                >
                  <div className="flex items-start justify-between gap-2 flex-wrap">
                    {/* Badges */}
                    <div className="flex items-center gap-2 flex-wrap">
                      <span
                        className={`text-sm font-black px-2.5 py-0.5 rounded-lg border ${
                          isOriginal
                            ? "bg-blue-100 border-blue-200 text-blue-700"
                            : "bg-green-50 border-green-200 text-green-700"
                        }`}
                      >
                        + {entry.qty} {item.unit}
                      </span>
                      <span className="bg-white border border-gray-200 text-gray-700 text-xs font-semibold px-2 py-0.5 rounded-lg">
                        PKR {(entry.unitRate || 0).toLocaleString()}/{item.unit}
                      </span>
                      {isOriginal && (
                        <span className="text-xs bg-blue-600 text-white font-semibold px-2 py-0.5 rounded-full">
                          Original Purchase
                        </span>
                      )}
                      {!isOriginal && idx === 0 && (
                        <span className="text-xs bg-green-600 text-white font-semibold px-2 py-0.5 rounded-full">
                          Latest Restock
                        </span>
                      )}
                    </div>

                    {/* Date */}
                    <span className="flex items-center gap-1 text-xs text-gray-400 font-medium whitespace-nowrap">
                      <Calendar size={11} />
                      {formatDate(entry.date)}
                    </span>
                  </div>

                  {/* Invoice / PO */}
                  {(entry.invoiceNo || entry.poNo) && (
                    <p className="flex items-center gap-1.5 text-sm text-gray-700 font-medium mt-2">
                      <FileText size={12} className="text-gray-400 shrink-0" />
                      {entry.invoiceNo && <>Invoice: {entry.invoiceNo}</>}
                      {entry.invoiceNo && entry.poNo && (
                        <span className="text-gray-300 mx-1">|</span>
                      )}
                      {entry.poNo && <>PO: {entry.poNo}</>}
                    </p>
                  )}

                  {/* Note / Remarks */}
                  {entry.note && (
                    <p className="flex items-start gap-1.5 text-xs text-gray-500 mt-1.5 leading-relaxed">
                      <FileText
                        size={11}
                        className="text-gray-400 shrink-0 mt-0.5"
                      />
                      {entry.note}
                    </p>
                  )}

                  {/* Bottom row: purchase value + stock after */}
                  <div className="flex items-center justify-between mt-2 border-t border-gray-100 pt-1.5">
                    <p className="text-xs text-gray-400">
                      Purchase value:{" "}
                      <span className="font-semibold text-gray-600">
                        PKR {purchaseValue.toLocaleString()}
                      </span>
                    </p>
                    {!isOriginal && entry.inHandAfter != null && (
                      <p className="text-xs text-gray-400">
                        Stock after:{" "}
                        <span className="font-semibold text-gray-600">
                          {entry.inHandAfter} {item.unit}
                        </span>
                      </p>
                    )}
                    {isOriginal && (
                      <p className="text-xs text-blue-400 italic">
                        First stock entry
                      </p>
                    )}
                  </div>
                </div>
              </div>
            );
          })}
        </div>

        {/* Total summary at bottom */}
        {timeline.length > 1 && (
          <div className="ml-10 mt-2 bg-gray-50 border border-gray-200 rounded-xl px-4 py-2.5 flex items-center justify-between text-sm">
            <span className="text-gray-500 font-medium">
              Total spent across all {timeline.length} purchases
            </span>
            <span className="font-bold text-blue-600">
              PKR {totalAllSpent.toLocaleString()}
            </span>
          </div>
        )}
      </div>

      {/* Close */}
      <div className="flex justify-end pt-1 border-t border-gray-100">
        <button
          onClick={onClose}
          className="px-5 py-2 text-sm font-medium border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors"
        >
          Close
        </button>
      </div>
    </div>
  );
}
</file>

<file path="src/components/ui/RestockModal.jsx">
import { useState } from "react";
import {
  ArrowDownCircle,
  Package,
  FileText,
  CheckCircle,
  AlertTriangle,
  History,
  TrendingUp,
} from "lucide-react";
import useInventoryStore from "../../store/useInventoryStore";
import { today } from "../../utils/dateUtils";

/**
 * RestockModal
 * Allows adding a new bulk purchase to an existing inventory item.
 * Updates stockIn, quantity, inHand, and appends to restockLog.
 *
 * Props:
 *  item          – the inventory item object (required)
 *  onClose       – callback to close the modal
 *  onViewHistory – optional callback to open restock history
 */
export default function RestockModal({ item, onClose, onViewHistory }) {
  const restockItem = useInventoryStore((s) => s.restockItem);

  const [qty, setQty] = useState("");
  const [unitRate, setUnitRate] = useState(String(item.unitRate || ""));
  const [invoiceNo, setInvoiceNo] = useState("");
  const [note, setNote] = useState("");
  const [date, setDate] = useState(today());
  const [error, setError] = useState("");
  const [saving, setSaving] = useState(false);
  const [done, setDone] = useState(false);

  const addedQty = Number(qty) || 0;
  const newRate = Number(unitRate) || item.unitRate || 0;
  const newInHand = (item.inHand || 0) + addedQty;
  const addedValue = addedQty * newRate;

  // Weighted average rate preview
  const oldValue = (item.inHand || 0) * (item.unitRate || 0);
  const newAvgRate =
    newInHand > 0 ? Math.round((oldValue + addedValue) / newInHand) : newRate;

  const restockLogCount = Array.isArray(item.restockLog)
    ? item.restockLog.length
    : 0;

  const handleSubmit = async () => {
    setError("");
    if (!addedQty || addedQty <= 0) {
      setError("Enter a quantity greater than 0.");
      return;
    }
    if (!newRate || newRate <= 0) {
      setError("Enter a valid unit rate.");
      return;
    }

    setSaving(true);
    try {
      await restockItem(item.id, {
        qty: addedQty,
        unitRate: newRate,
        invoiceNo,
        date,
        note,
      });
      setDone(true);
    } catch (err) {
      setError("Failed to restock: " + err.message);
    }
    setSaving(false);
  };

  // ── Success State ──
  if (done) {
    return (
      <div className="flex flex-col items-center gap-4 py-6 text-center">
        <div className="w-14 h-14 rounded-full bg-green-100 flex items-center justify-center">
          <CheckCircle size={28} className="text-green-600" />
        </div>
        <div>
          <p className="text-base font-bold text-gray-900">Stock Restocked!</p>
          <p className="text-sm text-gray-500 mt-1">
            <span className="font-semibold text-green-600">
              +{addedQty} {item.unit}
            </span>{" "}
            added to <span className="font-semibold">{item.description}</span>.
            <br />
            <span className="text-gray-400">
              New in hand:{" "}
              <span className="font-semibold text-gray-600">
                {newInHand} {item.unit}
              </span>
            </span>
          </p>
        </div>
        <div className="flex gap-3 mt-1">
          {onViewHistory && (
            <button
              onClick={() => {
                onClose();
                onViewHistory();
              }}
              className="flex items-center gap-1.5 px-4 py-2 text-sm font-semibold border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors"
            >
              <History size={14} /> View History
            </button>
          )}
          <button
            onClick={onClose}
            className="px-6 py-2 bg-gray-900 text-white text-sm font-semibold rounded-lg hover:bg-gray-700 transition-colors"
          >
            Done
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-5">
      {/* ── Item Summary ── */}
      <div className="bg-blue-50 border border-blue-200 rounded-xl px-4 py-3 flex items-center justify-between gap-4">
        <div className="flex items-center gap-2.5">
          <Package size={16} className="text-blue-600" />
          <div>
            <p className="font-bold text-gray-900">{item.description}</p>
            <p className="text-xs text-gray-500 mt-0.5">
              Unit: <span className="font-semibold">{item.unit}</span>
            </p>
          </div>
        </div>
        <div className="flex items-center gap-5 text-center">
          <div>
            <p className="text-xs text-gray-400 font-medium">Current In Hand</p>
            <p className="text-lg font-black text-green-600">
              {item.inHand ?? 0}
            </p>
          </div>
          <div>
            <p className="text-xs text-gray-400 font-medium">Current Rate</p>
            <p className="text-lg font-black text-gray-700">
              PKR {(item.unitRate || 0).toLocaleString()}
            </p>
          </div>
        </div>
      </div>

      {/* ── Restock Details ── */}
      <div className="space-y-3">
        <div className="text-xs font-bold text-gray-500 uppercase tracking-wide border-b border-gray-100 pb-1.5 flex items-center gap-1.5">
          <ArrowDownCircle size={13} className="text-green-600" />
          New Stock Purchase
        </div>

        <div className="grid grid-cols-2 gap-3">
          {/* Date */}
          <div>
            <label className="block text-xs font-semibold text-gray-600 mb-1.5">
              Purchase Date
            </label>
            <input
              type="date"
              className="w-full border border-gray-300 rounded-lg px-3 h-10 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
              value={date}
              max={today()}
              onChange={(e) => setDate(e.target.value)}
            />
          </div>

          {/* Invoice No */}
          <div>
            <label className="block text-xs font-semibold text-gray-600 mb-1.5">
              Invoice No{" "}
              <span className="font-normal text-gray-400">(optional)</span>
            </label>
            <input
              className="w-full border border-gray-300 rounded-lg px-3 h-10 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
              value={invoiceNo}
              placeholder="e.g. INV-045"
              onChange={(e) => setInvoiceNo(e.target.value)}
            />
          </div>

          {/* Quantity */}
          <div>
            <label className="block text-xs font-semibold text-gray-600 mb-1.5">
              Qty to Add <span className="text-red-500">*</span>
            </label>
            <div className="relative">
              <ArrowDownCircle
                size={14}
                className="absolute left-3 top-1/2 -translate-y-1/2 text-green-500 pointer-events-none"
              />
              <input
                type="number"
                min="1"
                className="w-full border border-gray-300 rounded-lg pl-9 pr-3 h-10 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                value={qty}
                placeholder={`How many ${item.unit}s purchased?`}
                onChange={(e) => setQty(e.target.value)}
                autoFocus
              />
            </div>
          </div>

          {/* Unit Rate */}
          <div>
            <label className="block text-xs font-semibold text-gray-600 mb-1.5">
              Unit Rate (PKR) <span className="text-red-500">*</span>
              {newRate !== item.unitRate && item.unitRate > 0 && (
                <span className="ml-1 font-normal text-amber-500">
                  (was PKR {item.unitRate})
                </span>
              )}
            </label>
            <div className="relative">
              <span className="absolute left-3 top-1/2 -translate-y-1/2 text-xs text-gray-400 font-semibold pointer-events-none">
                PKR
              </span>
              <input
                type="number"
                min="0"
                className="w-full border border-gray-300 rounded-lg pl-12 pr-3 h-10 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                value={unitRate}
                placeholder="Cost per unit"
                onChange={(e) => setUnitRate(e.target.value)}
              />
            </div>
          </div>
        </div>

        {/* Note */}
        <div>
          <label className="block text-xs font-semibold text-gray-600 mb-1.5">
            Note{" "}
            <span className="font-normal text-gray-400">
              (optional — supplier, location…)
            </span>
          </label>
          <input
            className="w-full border border-gray-300 rounded-lg px-3 h-10 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
            value={note}
            placeholder="e.g. Bought from Ali Traders, Lahore"
            onChange={(e) => setNote(e.target.value)}
          />
        </div>
      </div>

      {/* ── Live Preview ── */}
      {addedQty > 0 && newRate > 0 && (
        <div className="bg-green-50 border border-green-200 rounded-xl px-4 py-3 space-y-2">
          <p className="text-xs font-bold text-green-700 uppercase tracking-wide flex items-center gap-1.5">
            <TrendingUp size={13} /> After Restock Preview
          </p>
          <div className="grid grid-cols-3 gap-3 text-center text-sm">
            <div className="bg-white rounded-lg py-2 border border-green-100">
              <p className="text-xs text-gray-400 font-medium">In Hand</p>
              <p className="font-black text-green-600 text-base">
                {newInHand} {item.unit}
              </p>
            </div>
            <div className="bg-white rounded-lg py-2 border border-green-100">
              <p className="text-xs text-gray-400 font-medium">Avg Rate</p>
              <p className="font-black text-gray-700 text-base">
                PKR {newAvgRate.toLocaleString()}
              </p>
            </div>
            <div className="bg-white rounded-lg py-2 border border-green-100">
              <p className="text-xs text-gray-400 font-medium">This Purchase</p>
              <p className="font-black text-blue-600 text-base">
                PKR {addedValue.toLocaleString()}
              </p>
            </div>
          </div>
          {newRate !== item.unitRate && item.unitRate > 0 && (
            <p className="text-xs text-amber-600 font-medium flex items-center gap-1">
              <AlertTriangle size={11} />
              Rate changed — unit cost will update to weighted average PKR{" "}
              {newAvgRate.toLocaleString()}
            </p>
          )}
        </div>
      )}

      {/* ── Error ── */}
      {error && (
        <div className="flex items-center gap-2 bg-red-50 border border-red-200 rounded-lg px-3 py-2 text-sm text-red-600 font-medium">
          <AlertTriangle size={14} className="shrink-0" />
          {error}
        </div>
      )}

      {/* ── Actions ── */}
      <div className="flex justify-between items-center gap-3 pt-1 border-t border-gray-100">
        <div className="text-xs text-gray-400">
          {restockLogCount > 0
            ? `${restockLogCount} previous restock${restockLogCount !== 1 ? "s" : ""} recorded`
            : "First restock for this item"}
        </div>
        <div className="flex gap-3">
          <button
            onClick={onClose}
            className="px-5 py-2 text-sm font-medium border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors"
          >
            Cancel
          </button>
          <button
            onClick={handleSubmit}
            disabled={saving || !addedQty || !newRate}
            className="flex items-center gap-2 px-6 py-2 text-sm font-semibold bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 transition-colors shadow-sm"
          >
            <ArrowDownCircle size={14} />
            {saving ? "Saving..." : "Confirm Restock"}
          </button>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/config/messageTemplates.js">
export const MESSAGE_TEMPLATES = {
  paymentDue: (customer, cycle) =>
    `Assalam o Alaikum *${customer.fullName}*,\n\nYour internet bill of *PKR ${cycle.amountPending}* is due. Please pay to continue uninterrupted service.\n\nThank you,\n*Galaxy Internet*`,

  paymentOverdue: (customer, cycle) =>
    `Assalam o Alaikum *${customer.fullName}*,\n\nYour account is overdue. Your service has been suspended.\n\nPlease pay *PKR ${cycle.totalAmount}* to reconnect.\n\nThank you,\n*Galaxy Internet*`,

  paymentConfirmation: (customer, installment) =>
    `Assalam o Alaikum *${customer.fullName}*,\n\nWe received your payment of *PKR ${installment.amountPaid}* on ${installment.datePaid}. Thank you!\n\nYour account is now updated.\n\n*Galaxy Internet*`,

  expiryReminder: (customer, cycle) =>
    `Assalam o Alaikum *${customer.fullName}*,\n\nYour internet plan expires on *${cycle.cycleEndDate}*. Please renew to avoid service interruption.\n\nThank you,\n*Galaxy Internet*`,

  partialPaymentReceived: (customer, installment, remaining) =>
    `Assalam o Alaikum *${customer.fullName}*,\n\nWe received *PKR ${installment.amountPaid}* on ${installment.datePaid}.\n\nRemaining balance: *PKR ${remaining}*\n\nPlease pay the remaining amount soon.\n\n*Galaxy Internet*`,
};

export const generateWhatsAppLink = (mobileNo, message) => {
  if (!mobileNo) return null;
  const cleaned = String(mobileNo).replace(/\D/g, "");
  const withCode = cleaned.startsWith("92") ? cleaned : `92${cleaned}`;
  return `https://wa.me/${withCode}?text=${encodeURIComponent(message)}`;
};
</file>

<file path="src/main.jsx">
import { createRoot } from "react-dom/client";
import "./index.css";
import App from "./App.jsx";
import { setupDevTools } from "./utils/devTools.js";

setupDevTools(); // <-- Add this

createRoot(document.getElementById("root")).render(<App />);
</file>

<file path="src/pages/Customers/NewConnectionForm.jsx">
import { useState, useEffect, useCallback, useRef } from "react";
import {
  User,
  Package,
  CreditCard,
  Plus,
  Trash2,
  AlertTriangle,
  CheckCircle,
  CheckCircle2,
  ChevronDown,
  Wrench,
  Tag,
  Info,
  Zap,
} from "lucide-react";
import { checkDuplicate } from "../../utils/duplicateCheck";
import { today } from "../../utils/dateUtils";
import usePackageStore from "../../store/usePackageStore";
import useCustomerStore from "../../store/useCustomerStore";
import usePaymentStore from "../../store/usePaymentStore";
import useInventoryStore from "../../store/useInventoryStore";
import useConnectionJobStore from "../../store/useConnectionJobStore";
import db from "../../db/database";

// ── CNIC formatter ─────────────────────────────────────────────────────────────
const formatCNIC = (val) => {
  const digits = val.replace(/\D/g, "").slice(0, 13);
  let res = "";
  if (digits.length > 0) res += digits.slice(0, 5);
  if (digits.length > 5) res += "-" + digits.slice(5, 12);
  if (digits.length > 12) res += "-" + digits.slice(12, 13);
  return res;
};

// ── Field wrapper ──────────────────────────────────────────────────────────────
function Field({ label, error, children, hint }) {
  return (
    <div>
      <label className="block text-xs font-semibold text-gray-600 mb-1.5">
        {label}
      </label>
      {children}
      {hint && !error && <p className="text-xs text-gray-400 mt-1">{hint}</p>}
      {error && <p className="text-xs text-red-500 mt-1">{error}</p>}
    </div>
  );
}

const inp = (err) =>
  `w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 ${
    err ? "border-red-400 bg-red-50" : "border-gray-300 bg-white"
  }`;

function SectionTitle({ icon: Icon, color, title, badge }) {
  const colors = {
    blue: "bg-blue-600",
    amber: "bg-amber-500",
    green: "bg-green-600",
    purple: "bg-purple-600",
  };
  return (
    <div className="flex items-center gap-2">
      <div
        className={`${colors[color] ?? "bg-gray-500"} rounded-lg p-1.5 shrink-0`}
      >
        <Icon size={14} className="text-white" />
      </div>
      <span className="text-sm font-bold text-gray-800">{title}</span>
      {badge && (
        <span className="text-xs font-normal text-gray-400 bg-gray-100 px-2 py-0.5 rounded-full">
          {badge}
        </span>
      )}
    </div>
  );
}

// ── Main component ─────────────────────────────────────────────────────────────
export default function NewConnectionForm({ onClose }) {
  // ── Stores ───────────────────────────────────────────────────────────────────
  const addCustomer = useCustomerStore((s) => s.addCustomer);
  const createInitialCycle = usePaymentStore((s) => s.createInitialCycle);
  const addInstallment = usePaymentStore((s) => s.addInstallment);
  const allPackages = usePackageStore((s) => s.packages);
  const packages = allPackages.filter((p) => p.isActive !== false);
  const inventoryItems = useInventoryStore((s) => s.items);
  const updateItem = useInventoryStore((s) => s.updateItem);
  const addJob = useConnectionJobStore((s) => s.addJob);

  // ── Settings ─────────────────────────────────────────────────────────────────
  const [areas, setAreas] = useState([]);
  const [agents, setAgents] = useState([]);
  useEffect(() => {
    db.settings.get("areas").then((r) => setAreas(r?.value ?? []));
    db.settings.get("agents").then((r) => setAgents(r?.value ?? []));
  }, []);

  // ── Section toggles ──────────────────────────────────────────────────────────
  const [showInventory, setShowInventory] = useState(false);
  const [showPayment, setShowPayment] = useState(true);

  // ── Subscriber fields ────────────────────────────────────────────────────────
  const [form, setFormState] = useState({
    fullName: "",
    userName: "",
    mobileNo: "",
    cnic: "",
    mainArea: "",
    recoveryAgent: "",
    packageId: "",
    notes: "",
    startDate: today(),
  });

  // ── Inventory fields ─────────────────────────────────────────────────────────
  const [technicianName, setTechnicianName] = useState("");
  const [jobNote, setJobNote] = useState("");
  const [lines, setLines] = useState([]);

  // ── Payment fields ───────────────────────────────────────────────────────────
  const [amountPaid, setAmountPaid] = useState("");
  const [paymentDate, setPaymentDate] = useState(today());
  const [paymentNote, setPaymentNote] = useState("");

  // ── Discount fields ──────────────────────────────────────────────────────────
  const [discountType, setDiscountType] = useState("none");
  const [discountValue, setDiscountValue] = useState("");

  // ── UI state ─────────────────────────────────────────────────────────────────
  const [errors, setErrors] = useState({});
  const [dupWarning, setDupWarning] = useState(null);
  const [saving, setSaving] = useState(false);
  const [done, setDone] = useState(false);
  const [savedSummary, setSavedSummary] = useState(null);

  // Track whether user manually edited the amount field
  const userEditedAmount = useRef(false);

  // ── Derived: package ─────────────────────────────────────────────────────────
  const selectedPkg = packages.find(
    (p) => Number(p.id) === Number(form.packageId),
  );
  const packagePrice = selectedPkg ? Number(selectedPkg.price) : 0;

  // ── Inventory totals ──────────────────────────────────────────────────────────
  const availableItems = inventoryItems.filter((i) => (i.inHand ?? 0) > 0);

  const lineDetails = lines.map((l) => {
    const item = inventoryItems.find((i) => i.id === Number(l.itemId));
    const qty = Number(l.qty) || 0;
    const rate = Number(l.customRate) || (item ? item.unitRate : 0);
    const total = qty * rate;
    const inHand = item ? (item.inHand ?? 0) : 0;
    const overIssue = qty > inHand;
    return { ...l, item, qty, rate, total, inHand, overIssue };
  });

  const materialTotal = lineDetails.reduce((s, l) => s + l.total, 0);

  // ── Discount ──────────────────────────────────────────────────────────────────
  const rawDiscount =
    discountType === "percent"
      ? (packagePrice * (Number(discountValue) || 0)) / 100
      : discountType === "amount"
        ? Number(discountValue) || 0
        : 0;
  const discountAmt = Math.min(Math.max(0, rawDiscount), packagePrice);
  const effectivePkgPrice = packagePrice - discountAmt;
  const grandTotal = effectivePkgPrice + (showInventory ? materialTotal : 0);

  // ── Auto-fill amountPaid when totals change ───────────────────────────────────
  useEffect(() => {
    if (!userEditedAmount.current) {
      setAmountPaid(grandTotal > 0 ? String(grandTotal) : "");
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [grandTotal]);

  // ── Field helpers ─────────────────────────────────────────────────────────────
  const setField = (field, value) => {
    setFormState((f) => ({ ...f, [field]: value }));
    setErrors((e) => ({ ...e, [field]: "" }));
  };

  const checkDup = useCallback(
    async (field, value) => {
      if (!value) return setDupWarning(null);
      const result = await checkDuplicate(
        field === "userName" ? value : form.userName,
        field === "mobileNo" ? value : form.mobileNo,
        null,
      );
      if (result.hasDuplicate) {
        setDupWarning(
          `${field === "userName" ? "Username" : "Mobile"} already in use by: ${result.existing.fullName}`,
        );
      } else {
        setDupWarning(null);
      }
    },
    [form.userName, form.mobileNo],
  );

  // ── Inventory line helpers ────────────────────────────────────────────────────
  const addLine = () =>
    setLines((prev) => [
      ...prev,
      { id: crypto.randomUUID(), itemId: "", qty: "", customRate: "" },
    ]);

  const removeLine = (id) => {
    setLines((prev) => prev.filter((l) => l.id !== id));
    setErrors((prev) => {
      const e = { ...prev };
      delete e[`item_${id}`];
      delete e[`qty_${id}`];
      delete e[`rate_${id}`];
      return e;
    });
  };

  const updateLine = (id, field, value) => {
    setLines((prev) =>
      prev.map((l) => {
        if (l.id !== id) return l;
        const updated = { ...l, [field]: value };
        if (field === "itemId") {
          const item = inventoryItems.find((i) => i.id === Number(value));
          updated.customRate = item ? String(item.unitRate) : "";
        }
        return updated;
      }),
    );
    setErrors((prev) => {
      const e = { ...prev };
      delete e[`${field}_${id}`];
      return e;
    });
  };

  // ── Validation ────────────────────────────────────────────────────────────────
  const validate = () => {
    const e = {};

    if (!form.fullName.trim()) e.fullName = "Required";
    if (!form.userName.trim()) e.userName = "Required";
    if (!form.packageId) e.packageId = "Select a package";
    if (!form.mainArea) e.mainArea = "Select an area";

    if (form.mobileNo && !/^0\d{10}$/.test(form.mobileNo))
      e.mobileNo = "Must be 11 digits starting with 0 (e.g. 03001234567)";

    if (form.cnic && form.cnic.length < 15)
      e.cnic = "Invalid CNIC — 13 digits required";

    if (showInventory && lines.length > 0) {
      const seen = new Set();
      lineDetails.forEach((l) => {
        if (!l.itemId) e[`item_${l.id}`] = "Select an item";
        if (!l.qty || l.qty <= 0) e[`qty_${l.id}`] = "Enter qty > 0";
        if (l.overIssue) e[`qty_${l.id}`] = `Max: ${l.inHand} available`;
        if (!l.rate || l.rate <= 0) e[`rate_${l.id}`] = "Rate must be > 0";
        if (l.itemId && seen.has(l.itemId))
          e.inventoryGeneral = "Duplicate items — use one line per item.";
        seen.add(l.itemId);
      });
    }

    if (discountType === "percent") {
      const pct = Number(discountValue);
      if (isNaN(pct) || pct < 0 || pct > 100)
        e.discount = "Discount % must be between 0 and 100";
    }
    if (discountType === "amount") {
      const amt = Number(discountValue);
      if (isNaN(amt) || amt < 0 || amt > packagePrice)
        e.discount = `Cannot exceed package price PKR ${packagePrice.toLocaleString()}`;
    }

    if (showPayment && amountPaid !== "") {
      const amt = Number(amountPaid);
      if (isNaN(amt) || amt < 0) e.amountPaid = "Enter a valid amount";
    }
    if (showPayment && !paymentDate) e.paymentDate = "Required";

    return e;
  };

  // ── Submit ────────────────────────────────────────────────────────────────────
  const handleSubmit = async () => {
    const e = validate();
    if (Object.keys(e).length) {
      setErrors(e);
      return;
    }
    if (dupWarning) return;

    setSaving(true);
    try {
      const pkgId = Number(form.packageId);
      const pkg = packages.find((p) => Number(p.id) === pkgId);
      const lockedPrice = pkg ? Number(pkg.price) : 0;

      // 1. Create subscriber
      const newCustomer = await addCustomer({
        fullName: form.fullName.trim(),
        userName: form.userName.trim(),
        mobileNo: form.mobileNo,
        cnic: form.cnic,
        mainArea: form.mainArea,
        recoveryAgent: form.recoveryAgent,
        packageId: pkgId,
        lockedPackagePrice: lockedPrice,
        status: "active",
        notes: form.notes,
      });

      // 2. Create billing cycle with grandTotal as totalAmount
      const newCycle = await createInitialCycle(
        newCustomer.id,
        form.startDate,
        grandTotal,
      );

      // Store breakdown metadata on the cycle for invoice rendering
      const breakdown = {
        originalPackagePrice: lockedPrice,
        discountType: discountType !== "none" ? discountType : null,
        discountValue: discountType !== "none" ? Number(discountValue) || 0 : 0,
        discountAmt,
        effectivePkgPrice,
        materialTotal: showInventory ? materialTotal : 0,
      };
      await db.paymentCycles.update(newCycle.id, { breakdown });
      newCycle.breakdown = breakdown; // patch in-memory

      // 3. Record payment
      const paidAmt = Number(amountPaid) || 0;
      if (showPayment && paidAmt > 0) {
        await addInstallment(
          newCycle.id,
          paidAmt,
          paymentDate,
          paymentNote || "",
        );
      }

      // 4. Issue inventory items
      let savedJob = null;
      if (showInventory && lines.length > 0) {
        const validLines = lineDetails.filter(
          (l) => l.itemId && l.qty > 0 && l.item,
        );
        if (validLines.length > 0) {
          const issuedItems = [];
          for (const l of validLines) {
            const item = l.item;
            const existingLog = Array.isArray(item.issueLog)
              ? item.issueLog
              : [];
            const newStockOut = (item.stockOut || 0) + l.qty;
            const newInHand = (item.stockIn || 0) - newStockOut;

            await updateItem(item.id, {
              ...item,
              stockOut: newStockOut,
              inHand: newInHand,
              balanced: newInHand,
              issued: newStockOut,
              issueLog: [
                ...existingLog,
                {
                  date: form.startDate,
                  qty: l.qty,
                  issuedTo: technicianName.trim() || null,
                  subscriberName: newCustomer.fullName,
                  subscriberUsername: newCustomer.userName,
                  note: jobNote.trim() || "New Connection",
                  balanceAfter: newInHand,
                  unitRate: l.rate,
                  totalValue: l.total,
                  jobRef: true,
                  createdAt: new Date().toISOString(),
                },
              ],
            });

            issuedItems.push({
              inventoryItemId: item.id,
              description: item.description,
              unit: item.unit,
              qty: l.qty,
              unitRate: l.rate,
              totalValue: l.total,
            });
          }

          savedJob = await addJob({
            date: form.startDate,
            technicianName: technicianName.trim() || null,
            subscriberName: newCustomer.fullName,
            subscriberUsername: newCustomer.userName,
            subscriberId: newCustomer.id,
            note: jobNote.trim() || null,
            items: issuedItems,
            totalValue: materialTotal,
          });
        }
      }

      setSavedSummary({
        customer: newCustomer,
        paidAmt,
        grandTotal,
        discountAmt,
        effectivePkgPrice,
        materialTotal: showInventory ? materialTotal : 0,
        job: savedJob,
        packageName: pkg?.name ?? "—",
      });
      setDone(true);
    } catch (err) {
      setErrors({ general: "Error saving: " + err.message });
    }
    setSaving(false);
  };

  // ── Success screen ─────────────────────────────────────────────────────────────
  if (done && savedSummary) {
    const remaining = savedSummary.grandTotal - savedSummary.paidAmt;
    return (
      <div className="space-y-5">
        <div className="flex flex-col items-center gap-3 py-3 text-center">
          <div className="w-14 h-14 rounded-full bg-green-100 flex items-center justify-center">
            <CheckCircle size={28} className="text-green-600" />
          </div>
          <div>
            <p className="text-lg font-bold text-gray-900">
              Connection Created!
            </p>
            <p className="text-sm text-gray-500 mt-0.5">
              {savedSummary.customer.fullName} ({savedSummary.customer.userName}
              ) added successfully.
            </p>
          </div>
        </div>

        <div className="bg-gray-50 border border-gray-200 rounded-xl p-4 space-y-2 text-sm">
          <div className="flex justify-between text-gray-600">
            <span>Package — {savedSummary.packageName}</span>
            <span>PKR {packagePrice.toLocaleString()}</span>
          </div>
          {savedSummary.discountAmt > 0 && (
            <div className="flex justify-between text-green-700">
              <span>Discount</span>
              <span>− PKR {savedSummary.discountAmt.toLocaleString()}</span>
            </div>
          )}
          {savedSummary.materialTotal > 0 && (
            <div className="flex justify-between text-gray-600">
              <span>Material / Equipment</span>
              <span>+ PKR {savedSummary.materialTotal.toLocaleString()}</span>
            </div>
          )}
          <div className="border-t border-gray-200 pt-2 flex justify-between font-bold text-gray-900">
            <span>Total Due</span>
            <span>PKR {savedSummary.grandTotal.toLocaleString()}</span>
          </div>
          {savedSummary.paidAmt > 0 && (
            <div className="flex justify-between text-green-700">
              <span className="font-semibold">Paid Now</span>
              <span className="font-bold">
                PKR {savedSummary.paidAmt.toLocaleString()}
              </span>
            </div>
          )}
          {remaining > 0 ? (
            <div className="flex items-center justify-between bg-amber-50 border border-amber-200 rounded-lg px-3 py-2 text-amber-800">
              <span className="font-semibold">Remaining Balance</span>
              <span className="font-bold">
                PKR {remaining.toLocaleString()}
              </span>
            </div>
          ) : savedSummary.paidAmt > 0 ? (
            <div className="flex items-center gap-1.5 text-green-700 text-xs font-semibold pt-0.5">
              <CheckCircle2 size={13} /> Fully paid
            </div>
          ) : null}
        </div>

        {savedSummary.job && (
          <div className="bg-blue-50 border border-blue-200 rounded-xl p-4 text-sm text-blue-800">
            <p className="font-semibold mb-1.5">
              📦 {savedSummary.job.items.length} item
              {savedSummary.job.items.length !== 1 ? "s" : ""} issued from
              inventory
            </p>
            {savedSummary.job.items.map((item, i) => (
              <p key={i} className="text-xs text-blue-700 leading-relaxed">
                {item.description} × {item.qty} {item.unit} = PKR{" "}
                {item.totalValue.toLocaleString()}
              </p>
            ))}
          </div>
        )}

        <button
          onClick={onClose}
          className="w-full py-2.5 bg-gray-900 text-white font-semibold rounded-lg hover:bg-gray-700 transition-colors"
        >
          Done
        </button>
      </div>
    );
  }

  // ─────────────────────────────────────────────────────────────────────────────
  // ── FORM ─────────────────────────────────────────────────────────────────────
  // ─────────────────────────────────────────────────────────────────────────────
  return (
    <div className="space-y-4">
      {/* ══ SECTION 1: SUBSCRIBER ══════════════════════════════════════════════ */}
      <div className="border border-gray-200 rounded-xl p-5">
        <div className="mb-4">
          <SectionTitle
            icon={User}
            color="blue"
            title="Subscriber Information"
          />
        </div>

        {dupWarning && (
          <div className="bg-red-50 border border-red-300 text-red-700 text-sm px-3 py-2 rounded-lg mb-4">
            ⚠ {dupWarning}
          </div>
        )}

        <div className="grid grid-cols-2 gap-4">
          <Field label="Full Name *" error={errors.fullName}>
            <input
              className={inp(errors.fullName)}
              value={form.fullName}
              onChange={(e) => setField("fullName", e.target.value)}
              placeholder="e.g. Muhammad Qasim"
            />
          </Field>

          <Field label="Username *" error={errors.userName}>
            <input
              className={inp(errors.userName)}
              value={form.userName}
              onChange={(e) => {
                setField("userName", e.target.value);
                checkDup("userName", e.target.value);
              }}
              placeholder="e.g. Qasim6655"
            />
          </Field>

          <Field label="Mobile No" error={errors.mobileNo}>
            <input
              className={inp(errors.mobileNo)}
              value={form.mobileNo}
              type="tel"
              onChange={(e) => {
                const val = e.target.value.replace(/\D/g, "").slice(0, 11);
                setField("mobileNo", val);
                checkDup("mobileNo", val);
              }}
              placeholder="03001234567"
            />
          </Field>

          <Field label="CNIC (Optional)" error={errors.cnic}>
            <input
              className={inp(errors.cnic)}
              value={form.cnic}
              onChange={(e) => setField("cnic", formatCNIC(e.target.value))}
              placeholder="35202-1234567-1"
              maxLength={15}
            />
          </Field>

          <Field label="Package *" error={errors.packageId}>
            <select
              className={inp(errors.packageId)}
              value={form.packageId}
              onChange={(e) => {
                setField("packageId", e.target.value);
                setDiscountValue("");
                userEditedAmount.current = false;
              }}
            >
              <option value="">— Select Package —</option>
              {packages.map((p) => (
                <option key={p.id} value={p.id}>
                  {p.name} — PKR {Number(p.price).toLocaleString()}
                </option>
              ))}
            </select>
          </Field>

          <Field label="Main Area *" error={errors.mainArea}>
            <select
              className={inp(errors.mainArea)}
              value={form.mainArea}
              onChange={(e) => setField("mainArea", e.target.value)}
            >
              <option value="">— Select Area —</option>
              {areas.map((a) => (
                <option key={a} value={a}>
                  {a}
                </option>
              ))}
            </select>
          </Field>

          <Field label="Recovery Agent">
            <select
              className={inp()}
              value={form.recoveryAgent}
              onChange={(e) => setField("recoveryAgent", e.target.value)}
            >
              <option value="">— Select Agent —</option>
              {agents.map((a) => (
                <option key={a} value={a}>
                  {a}
                </option>
              ))}
            </select>
          </Field>

          <Field label="Connection Start Date *">
            <input
              type="date"
              className={inp()}
              value={form.startDate}
              max={today()}
              onChange={(e) => setField("startDate", e.target.value)}
            />
          </Field>

          <div className="col-span-2">
            <Field label="Notes (optional)">
              <textarea
                className={inp() + " resize-none"}
                rows={2}
                value={form.notes}
                onChange={(e) => setField("notes", e.target.value)}
                placeholder="Any notes about this connection..."
              />
            </Field>
          </div>
        </div>
      </div>

      {/* ══ SECTION 2: DISCOUNT ════════════════════════════════════════════════ */}
      {selectedPkg && (
        <div className="border border-gray-200 rounded-xl p-5">
          <div className="mb-4">
            <SectionTitle
              icon={Tag}
              color="green"
              title="Discount"
              badge="Optional"
            />
          </div>

          <div className="grid grid-cols-2 gap-4">
            <Field label="Discount Type">
              <select
                className={inp(errors.discount)}
                value={discountType}
                onChange={(e) => {
                  setDiscountType(e.target.value);
                  setDiscountValue("");
                  setErrors((ex) => ({ ...ex, discount: "" }));
                  userEditedAmount.current = false;
                }}
              >
                <option value="none">No Discount</option>
                <option value="percent">Percentage (%)</option>
                <option value="amount">Fixed Amount (PKR)</option>
              </select>
            </Field>

            {discountType !== "none" && (
              <Field
                label={
                  discountType === "percent"
                    ? "Discount %"
                    : "Discount Amount (PKR)"
                }
                error={errors.discount}
                hint={
                  discountType === "percent" && Number(discountValue) > 0
                    ? `= PKR ${discountAmt.toLocaleString()} off`
                    : undefined
                }
              >
                <input
                  type="number"
                  min="0"
                  max={discountType === "percent" ? 100 : packagePrice}
                  className={inp(errors.discount)}
                  value={discountValue}
                  onChange={(e) => {
                    setDiscountValue(e.target.value);
                    setErrors((ex) => ({ ...ex, discount: "" }));
                    userEditedAmount.current = false;
                  }}
                  placeholder={
                    discountType === "percent" ? "e.g. 10" : "e.g. 500"
                  }
                />
              </Field>
            )}
          </div>

          {discountType !== "none" && discountAmt > 0 && (
            <div className="mt-3 flex items-center gap-2 bg-green-50 border border-green-200 rounded-lg px-4 py-2.5 text-sm">
              <CheckCircle size={14} className="text-green-600 shrink-0" />
              <span className="text-green-800">
                Discount of <strong>PKR {discountAmt.toLocaleString()}</strong>{" "}
                applied — effective package price:{" "}
                <strong>PKR {effectivePkgPrice.toLocaleString()}</strong>
              </span>
            </div>
          )}
        </div>
      )}

      {/* ══ SECTION 3: INVENTORY ═══════════════════════════════════════════════ */}
      <div className="border border-gray-200 rounded-xl overflow-hidden">
        <button
          type="button"
          onClick={() => setShowInventory((v) => !v)}
          className="w-full flex items-center justify-between px-5 py-4 hover:bg-gray-50 transition-colors"
        >
          <SectionTitle
            icon={Package}
            color="amber"
            title="Issue Inventory Items"
            badge={showInventory ? undefined : "Optional"}
          />
          <div className="flex items-center gap-3">
            {showInventory && materialTotal > 0 && (
              <span className="text-xs font-semibold text-amber-700 bg-amber-50 border border-amber-200 px-2 py-0.5 rounded-full">
                PKR {materialTotal.toLocaleString()} material
              </span>
            )}
            <ChevronDown
              size={16}
              className={`text-gray-400 transition-transform ${showInventory ? "rotate-180" : ""}`}
            />
          </div>
        </button>

        {showInventory && (
          <div className="px-5 pb-5 border-t border-gray-100">
            <div className="grid grid-cols-2 gap-4 mt-4 mb-4">
              <Field label="Technician Name">
                <div className="relative">
                  <Wrench
                    size={13}
                    className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"
                  />
                  <input
                    type="text"
                    placeholder="e.g. Ali Khan"
                    value={technicianName}
                    onChange={(e) => setTechnicianName(e.target.value)}
                    className="w-full border border-gray-300 rounded-lg pl-8 pr-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                  />
                </div>
              </Field>
              <Field label="Job Note (optional)">
                <input
                  type="text"
                  placeholder="e.g. New connection Gulshan B5"
                  value={jobNote}
                  onChange={(e) => setJobNote(e.target.value)}
                  className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </Field>
            </div>

            <div className="flex items-center justify-between mb-2">
              <span className="text-xs font-bold text-gray-500 uppercase tracking-wide">
                Items to Issue
              </span>
              <button
                onClick={addLine}
                className="flex items-center gap-1.5 px-3 py-1.5 text-xs font-semibold bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
              >
                <Plus size={12} /> Add Item
              </button>
            </div>

            {lines.length === 0 ? (
              <div
                onClick={addLine}
                className="border-2 border-dashed border-gray-200 rounded-xl py-6 flex flex-col items-center gap-2 text-gray-400 cursor-pointer hover:border-blue-300 hover:text-blue-500 transition-colors"
              >
                <Package size={20} className="opacity-40" />
                <p className="text-xs font-medium">Click to add first item</p>
              </div>
            ) : (
              <div className="space-y-2">
                {lineDetails.map((l) => {
                  const usedIds = lineDetails
                    .filter((x) => x.id !== l.id && x.itemId)
                    .map((x) => Number(x.itemId));
                  const opts = availableItems.filter(
                    (i) => !usedIds.includes(i.id),
                  );
                  return (
                    <div
                      key={l.id}
                      className={`border rounded-xl p-3 space-y-2 ${l.overIssue ? "border-red-300 bg-red-50" : "border-gray-200 bg-gray-50"}`}
                    >
                      <div className="flex items-center gap-2">
                        <div className="flex-1">
                          <select
                            value={l.itemId}
                            onChange={(e) =>
                              updateLine(l.id, "itemId", e.target.value)
                            }
                            className={`w-full border rounded-lg px-3 h-9 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white ${errors[`item_${l.id}`] ? "border-red-400" : "border-gray-300"}`}
                          >
                            <option value="">-- Select item --</option>
                            {opts.map((i) => (
                              <option key={i.id} value={i.id}>
                                {i.description} ({i.inHand} {i.unit} available)
                              </option>
                            ))}
                          </select>
                          {errors[`item_${l.id}`] && (
                            <p className="text-xs text-red-500 mt-0.5">
                              {errors[`item_${l.id}`]}
                            </p>
                          )}
                        </div>
                        <div className="w-20">
                          <input
                            type="number"
                            min="1"
                            placeholder="Qty"
                            value={l.qty}
                            onChange={(e) =>
                              updateLine(l.id, "qty", e.target.value)
                            }
                            className={`w-full border rounded-lg px-2 h-9 text-sm text-center font-semibold focus:outline-none focus:ring-2 focus:ring-blue-500 ${errors[`qty_${l.id}`] ? "border-red-400 bg-red-50" : "border-gray-300"}`}
                          />
                          {errors[`qty_${l.id}`] && (
                            <p className="text-xs text-red-500 mt-0.5">
                              {errors[`qty_${l.id}`]}
                            </p>
                          )}
                        </div>
                        <button
                          onClick={() => removeLine(l.id)}
                          className="p-1.5 text-gray-400 hover:text-red-500 transition-colors shrink-0"
                        >
                          <Trash2 size={15} />
                        </button>
                      </div>

                      {l.item && (
                        <div className="flex items-center gap-3">
                          <div className="flex items-center gap-1.5">
                            <span className="text-xs text-gray-500">PKR</span>
                            <input
                              type="number"
                              min="1"
                              value={l.customRate}
                              onChange={(e) =>
                                updateLine(l.id, "customRate", e.target.value)
                              }
                              className={`w-24 border rounded-lg px-2 h-8 text-sm text-right font-semibold focus:outline-none focus:ring-2 focus:ring-blue-500 ${errors[`rate_${l.id}`] ? "border-red-400 bg-red-50" : "border-gray-300"}`}
                            />
                            <span className="text-xs text-gray-400">
                              per {l.item.unit}
                            </span>
                          </div>
                          {l.qty > 0 && l.rate > 0 && (
                            <span className="ml-auto text-sm font-bold text-gray-800">
                              = PKR {l.total.toLocaleString()}
                            </span>
                          )}
                        </div>
                      )}
                      {l.overIssue && (
                        <p className="flex items-center gap-1 text-xs text-red-600 font-semibold">
                          <AlertTriangle size={11} /> Only {l.inHand}{" "}
                          {l.item?.unit} in stock
                        </p>
                      )}
                    </div>
                  );
                })}
              </div>
            )}

            {errors.inventoryGeneral && (
              <div className="flex items-center gap-2 bg-red-50 border border-red-200 rounded-lg px-3 py-2 text-sm text-red-700 mt-2">
                <AlertTriangle size={13} /> {errors.inventoryGeneral}
              </div>
            )}

            {lines.length > 0 && materialTotal > 0 && (
              <div className="mt-3 bg-amber-50 border border-amber-200 rounded-xl px-4 py-3 flex justify-between items-center">
                <span className="text-xs font-semibold text-amber-700 uppercase tracking-wide">
                  Total Material Cost
                </span>
                <span className="text-base font-black text-amber-700">
                  PKR {materialTotal.toLocaleString()}
                </span>
              </div>
            )}
          </div>
        )}
      </div>

      {/* ══ SECTION 4: PAYMENT ════════════════════════════════════════════════ */}
      <div className="border border-gray-200 rounded-xl overflow-hidden">
        <button
          type="button"
          onClick={() => setShowPayment((v) => !v)}
          className="w-full flex items-center justify-between px-5 py-4 hover:bg-gray-50 transition-colors"
        >
          <SectionTitle
            icon={CreditCard}
            color="purple"
            title="Record First Payment"
            badge={showPayment ? undefined : "Optional"}
          />
          <ChevronDown
            size={16}
            className={`text-gray-400 transition-transform ${showPayment ? "rotate-180" : ""}`}
          />
        </button>

        {showPayment && (
          <div className="px-5 pb-5 border-t border-gray-100">
            {selectedPkg && (
              <div className="mt-4 bg-gray-50 border border-gray-200 rounded-xl p-4 space-y-1.5 text-sm mb-4">
                <p className="text-[10px] font-bold uppercase text-gray-400 tracking-widest mb-2 flex items-center gap-1">
                  <Info size={11} /> Billing Summary
                </p>
                <div className="flex justify-between text-gray-600">
                  <span>Package — {selectedPkg.name}</span>
                  <span>PKR {packagePrice.toLocaleString()}</span>
                </div>
                {discountAmt > 0 && (
                  <div className="flex justify-between text-green-700">
                    <span>Discount</span>
                    <span>− PKR {discountAmt.toLocaleString()}</span>
                  </div>
                )}
                {showInventory && materialTotal > 0 && (
                  <div className="flex justify-between text-gray-600">
                    <span>Material / Equipment</span>
                    <span>+ PKR {materialTotal.toLocaleString()}</span>
                  </div>
                )}
                <div className="flex justify-between font-bold text-gray-900 border-t border-gray-200 pt-2 mt-1">
                  <span>Total Due</span>
                  <span>PKR {grandTotal.toLocaleString()}</span>
                </div>
              </div>
            )}

            <div className="grid grid-cols-2 gap-4">
              <Field
                label="Amount Paid (leave blank to skip)"
                error={errors.amountPaid}
              >
                <input
                  type="number"
                  min="0"
                  className={inp(errors.amountPaid)}
                  value={amountPaid}
                  onChange={(e) => {
                    userEditedAmount.current = true;
                    setAmountPaid(e.target.value);
                    setErrors((ex) => ({ ...ex, amountPaid: "" }));
                  }}
                  placeholder={`Total: PKR ${grandTotal.toLocaleString()}`}
                />
              </Field>

              <Field label="Payment Date *" error={errors.paymentDate}>
                <input
                  type="date"
                  className={inp(errors.paymentDate)}
                  value={paymentDate}
                  max={today()}
                  onChange={(e) => setPaymentDate(e.target.value)}
                />
              </Field>

              <div className="col-span-2">
                <Field label="Payment Note (optional)">
                  <input
                    className={inp()}
                    value={paymentNote}
                    onChange={(e) => setPaymentNote(e.target.value)}
                    placeholder="e.g. Cash, JazzCash, EasyPaisa..."
                  />
                </Field>
              </div>
            </div>

            {selectedPkg && Number(amountPaid) > 0 && (
              <div
                className={`mt-3 flex items-center justify-between rounded-lg px-4 py-2.5 text-sm font-semibold ${
                  Number(amountPaid) >= grandTotal
                    ? "bg-green-100 text-green-800"
                    : "bg-yellow-50 text-yellow-800 border border-yellow-200"
                }`}
              >
                <span>
                  {Number(amountPaid) >= grandTotal
                    ? "✓ Fully Paid"
                    : "Remaining Balance"}
                </span>
                <span>
                  {Number(amountPaid) >= grandTotal
                    ? "PKR 0"
                    : `PKR ${(grandTotal - Number(amountPaid)).toLocaleString()}`}
                </span>
              </div>
            )}
          </div>
        )}
      </div>

      {/* ══ ERRORS + FOOTER ═══════════════════════════════════════════════════ */}
      {errors.general && (
        <div className="flex items-center gap-2 bg-red-50 border border-red-200 rounded-lg px-3 py-2.5 text-sm text-red-700">
          <AlertTriangle size={14} /> {errors.general}
        </div>
      )}

      <div className="flex justify-end gap-3 pt-1 pb-1">
        <button
          onClick={onClose}
          className="px-4 py-2 text-sm border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors"
        >
          Cancel
        </button>
        <button
          onClick={handleSubmit}
          disabled={saving || !!dupWarning}
          className="flex items-center gap-2 px-6 py-2 text-sm bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 disabled:opacity-50 transition-colors"
        >
          {saving ? (
            "Saving..."
          ) : (
            <>
              <Zap size={14} />
              Create Connection
              {grandTotal > 0 && (
                <span className="opacity-70 text-xs font-normal">
                  · PKR{" "}
                  {(userEditedAmount.current && Number(amountPaid) >= 0
                    ? Number(amountPaid)
                    : grandTotal
                  ).toLocaleString()}
                </span>
              )}
            </>
          )}
        </button>
      </div>
    </div>
  );
}
</file>

<file path="src/pages/Expenses/ExpenseForm.jsx">
import { useState } from "react";
import { today } from "../../utils/dateUtils";
import useExpenseStore, {
  EXPENSE_CATEGORIES,
} from "../../store/useExpenseStore";

const EMPTY = {
  date: today(),
  nameOrDept: "",
  description: "",
  category: "",
  amount: "",
};

export default function ExpenseForm({ expense, onClose }) {
  const addExpense = useExpenseStore((s) => s.addExpense);
  const updateExpense = useExpenseStore((s) => s.updateExpense);
  const isEdit = !!expense;
  const [form, setForm] = useState(isEdit ? expense : EMPTY);
  const [errors, setErrors] = useState({});
  const [saving, setSaving] = useState(false);

  const set = (field, value) => {
    setForm((f) => ({ ...f, [field]: value }));
    setErrors((e) => ({ ...e, [field]: "" }));
  };

  const validate = () => {
    const e = {};
    if (!form.date) e.date = "Required";
    if (!form.nameOrDept.trim()) e.nameOrDept = "Required";
    if (!form.category) e.category = "Required";
    if (!form.amount || Number(form.amount) <= 0) e.amount = "Must be > 0";
    return e;
  };

  const handleSubmit = async () => {
    const e = validate();
    if (Object.keys(e).length) {
      setErrors(e);
      return;
    }
    setSaving(true);
    try {
      const data = { ...form, amount: Number(form.amount) };
      if (isEdit) await updateExpense(expense.id, data);
      else await addExpense(data);
      onClose();
    } catch (err) {
      alert("Error: " + err.message);
    }
    setSaving(false);
  };

  return (
    <div className="space-y-4">
      <div className="grid grid-cols-2 gap-4">
        <Field label="Date *" error={errors.date}>
          <input
            type="date"
            className={inp(errors.date)}
            value={form.date}
            max={today()}
            onChange={(e) => set("date", e.target.value)}
          />
        </Field>
        <Field label="Category *" error={errors.category}>
          <select
            className={inp(errors.category)}
            value={form.category}
            onChange={(e) => set("category", e.target.value)}
          >
            <option value="">— Select Category —</option>
            {EXPENSE_CATEGORIES.map((c) => (
              <option key={c} value={c}>
                {c}
              </option>
            ))}
          </select>
        </Field>
        <Field label="Name / Department *" error={errors.nameOrDept}>
          <input
            className={inp(errors.nameOrDept)}
            value={form.nameOrDept}
            onChange={(e) => set("nameOrDept", e.target.value)}
            placeholder="e.g. Ali Muhammad, Wapda"
          />
        </Field>
        <Field label="Amount (PKR) *" error={errors.amount}>
          <input
            type="number"
            min="1"
            className={inp(errors.amount)}
            value={form.amount}
            onChange={(e) => set("amount", e.target.value)}
          />
        </Field>
        <Field label="Description" className="col-span-2">
          <input
            className={inp()}
            value={form.description}
            onChange={(e) => set("description", e.target.value)}
            placeholder="Optional details..."
          />
        </Field>
      </div>
      <div className="flex justify-end gap-3 pt-1">
        <button
          onClick={onClose}
          className="px-4 py-2 text-sm border border-gray-300 rounded text-gray-700 hover:bg-gray-50"
        >
          Cancel
        </button>
        <button
          onClick={handleSubmit}
          disabled={saving}
          className="px-4 py-2 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50"
        >
          {saving ? "Saving..." : isEdit ? "Save Changes" : "Add Expense"}
        </button>
      </div>
    </div>
  );
}

const inp = (err) =>
  `w-full border rounded px-3 py-1.5 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500 ${err ? "border-red-400" : "border-gray-300"}`;
function Field({ label, error, children, className = "" }) {
  return (
    <div className={className}>
      <label className="block text-xs font-medium text-gray-600 mb-1">
        {label}
      </label>
      {children}
      {error && <p className="text-xs text-red-500 mt-0.5">{error}</p>}
    </div>
  );
}
</file>

<file path="src/pages/Expenses/Expenses.jsx">
import { useState } from "react";
import { Plus, Pencil, Trash2 } from "lucide-react";
import Modal from "../../components/ui/Modal";
import ConfirmDialog from "../../components/ui/ConfirmDialog";
import ExpenseForm from "./ExpenseForm";
import useExpenseStore, {
  EXPENSE_CATEGORIES,
} from "../../store/useExpenseStore";
import { formatDate } from "../../utils/dateUtils";

export default function Expenses() {
  const expenses = useExpenseStore((s) => s.expenses);
  const deleteExpense = useExpenseStore((s) => s.deleteExpense);
  const [showAdd, setShowAdd] = useState(false);
  const [editExpense, setEditExpense] = useState(null);
  const [deleteTarget, setDeleteTarget] = useState(null);
  const [filterCategory, setFilterCategory] = useState("all");

  const filtered =
    filterCategory === "all"
      ? expenses
      : expenses.filter((e) => e.category === filterCategory);
  const total = filtered.reduce((sum, e) => sum + (Number(e.amount) || 0), 0);

  const sorted = [...filtered].sort(
    (a, b) => new Date(b.date) - new Date(a.date),
  );

  return (
    <div className="p-4 space-y-3">
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-2">
          <h1 className="text-base font-semibold text-gray-800">Expenses</h1>
          <span className="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full">
            {filtered.length}
          </span>
        </div>
        <button
          onClick={() => setShowAdd(true)}
          className="flex items-center gap-1.5 px-3 py-1.5 text-sm bg-blue-600 text-white rounded hover:bg-blue-700"
        >
          <Plus size={14} /> Add Expense
        </button>
      </div>

      <div className="flex items-center gap-2 flex-wrap">
        <button
          onClick={() => setFilterCategory("all")}
          className={`px-3 py-1 text-xs rounded ${filterCategory === "all" ? "bg-gray-800 text-white" : "border border-gray-300 text-gray-600 hover:bg-gray-50"}`}
        >
          All
        </button>
        {EXPENSE_CATEGORIES.map((c) => (
          <button
            key={c}
            onClick={() => setFilterCategory(c)}
            className={`px-3 py-1 text-xs rounded ${filterCategory === c ? "bg-gray-800 text-white" : "border border-gray-300 text-gray-600 hover:bg-gray-50"}`}
          >
            {c}
          </button>
        ))}
      </div>

      <div className="bg-red-50 rounded p-3 text-sm">
        <span className="text-gray-500">
          Total Expenses{filterCategory !== "all" ? ` (${filterCategory})` : ""}
          :
        </span>{" "}
        <strong className="text-red-700">PKR {total.toLocaleString()}</strong>
      </div>

      <div className="bg-white border border-gray-200 rounded overflow-hidden">
        <table className="w-full text-sm">
          <thead>
            <tr className="bg-gray-100 text-gray-600 text-left">
              <th className="px-3 py-2 font-medium">Date</th>
              <th className="px-3 py-2 font-medium">Name / Dept</th>
              <th className="px-3 py-2 font-medium">Description</th>
              <th className="px-3 py-2 font-medium">Category</th>
              <th className="px-3 py-2 font-medium">Amount</th>
              <th className="px-3 py-2 font-medium"></th>
            </tr>
          </thead>
          <tbody>
            {sorted.map((e) => (
              <tr
                key={e.id}
                className="border-b border-gray-100 hover:bg-gray-50"
              >
                <td className="px-3 py-2 text-xs whitespace-nowrap">
                  {formatDate(e.date)}
                </td>
                <td className="px-3 py-2">{e.nameOrDept}</td>
                <td className="px-3 py-2 text-gray-500 text-xs">
                  {e.description || "-"}
                </td>
                <td className="px-3 py-2">
                  <span className="text-xs bg-gray-100 px-2 py-0.5 rounded">
                    {e.category}
                  </span>
                </td>
                <td className="px-3 py-2 font-medium">
                  PKR {Number(e.amount).toLocaleString()}
                </td>
                <td className="px-3 py-2">
                  <div className="flex gap-1">
                    <button
                      onClick={() => setEditExpense(e)}
                      className="p-1 rounded text-gray-500 hover:bg-gray-100"
                    >
                      <Pencil size={13} />
                    </button>
                    <button
                      onClick={() => setDeleteTarget(e)}
                      className="p-1 rounded text-red-500 hover:bg-red-50"
                    >
                      <Trash2 size={13} />
                    </button>
                  </div>
                </td>
              </tr>
            ))}
            {sorted.length === 0 && (
              <tr>
                <td colSpan={6} className="px-3 py-8 text-center text-gray-400">
                  No expenses recorded yet.
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>

      <Modal
        isOpen={showAdd}
        onClose={() => setShowAdd(false)}
        title="Add Expense"
        size="md"
      >
        <ExpenseForm onClose={() => setShowAdd(false)} />
      </Modal>
      <Modal
        isOpen={!!editExpense}
        onClose={() => setEditExpense(null)}
        title="Edit Expense"
        size="md"
      >
        {editExpense && (
          <ExpenseForm
            expense={editExpense}
            onClose={() => setEditExpense(null)}
          />
        )}
      </Modal>
      <ConfirmDialog
        isOpen={!!deleteTarget}
        onClose={() => setDeleteTarget(null)}
        onConfirm={() => deleteExpense(deleteTarget.id)}
        title="Delete Expense"
        message={`Delete this expense of PKR ${deleteTarget?.amount}?`}
      />
    </div>
  );
}
</file>

<file path="src/pages/Login.jsx">
import { useState } from "react";
import { Lock, User, KeyRound, AlertCircle } from "lucide-react";

export default function Login({ onLogin }) {
  const [username, setUsername] = useState("");
  const [password, setPassword] = useState("");
  const [error, setError] = useState("");

  const handleSubmit = (e) => {
    e.preventDefault();
    setError("");

    // Hardcoded Credentials
    if (username === "admin1357" && password === "admin1357") {
      onLogin();
    } else {
      setError("Invalid username or password");
    }
  };

  return (
    <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
      <div className="bg-white w-full max-w-sm rounded-2xl shadow-xl overflow-hidden border border-gray-200">
        {/* Header */}
        <div className="bg-blue-600 px-6 py-6 text-center">
          <div className="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-3 backdrop-blur-sm">
            <Lock className="text-white" size={24} />
          </div>
          <h1 className="text-xl font-bold text-white tracking-wide">
            Galaxy ISP
          </h1>
          <p className="text-blue-100 text-xs mt-1 font-medium">
            Admin Access Portal
          </p>
        </div>

        {/* Form */}
        <div className="p-6 pt-8">
          <form onSubmit={handleSubmit} className="space-y-5">
            {error && (
              <div className="bg-red-50 text-red-600 text-sm px-3 py-2 rounded-lg flex items-center gap-2 border border-red-100">
                <AlertCircle size={16} />
                {error}
              </div>
            )}

            <div className="space-y-1.5">
              <label className="block text-xs font-bold text-gray-500 uppercase tracking-wider ml-1">
                Admin Username
              </label>
              <div className="relative">
                <div className="absolute left-3 top-2.5 text-gray-400">
                  <User size={18} />
                </div>
                <input
                  type="text"
                  autoFocus
                  value={username}
                  onChange={(e) => setUsername(e.target.value)}
                  className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                  placeholder="Enter username"
                />
              </div>
            </div>

            <div className="space-y-1.5">
              <label className="block text-xs font-bold text-gray-500 uppercase tracking-wider ml-1">
                Admin Password
              </label>
              <div className="relative">
                <div className="absolute left-3 top-2.5 text-gray-400">
                  <KeyRound size={18} />
                </div>
                <input
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                  placeholder="Enter password"
                />
              </div>
            </div>

            <button
              type="submit"
              className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 rounded-lg transition-colors shadow-sm active:transform active:scale-[0.98]"
            >
              Login
            </button>
          </form>

          <div className="mt-6 text-center">
            <p className="text-xs text-gray-400">Authorized personnel only.</p>
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/pages/Settings.jsx">
import { useState, useEffect } from "react";
import {
  Plus,
  Trash2,
  Pencil,
  X,
  Check,
  History,
  TrendingUp,
  Calendar,
  ArrowRight,
  AlertCircle,
  ArrowUp,
  ArrowDown,
} from "lucide-react";

import usePackageStore from "../store/usePackageStore";
import db from "../db/database";
import Modal from "../components/ui/Modal";
import ConfirmDialog from "../components/ui/ConfirmDialog";
import { formatDate, today } from "../utils/dateUtils";

// ─── HELPER COMPONENT (Defined outside to avoid re-render issues) ───
const SortIcon = ({ column, sortConfig }) => {
  if (sortConfig.key !== column)
    return <div className="w-3.5 h-3.5 inline-block" />;

  return sortConfig.direction === "asc" ? (
    <ArrowUp size={14} className="inline-block text-gray-700" />
  ) : (
    <ArrowDown size={14} className="inline-block text-gray-700" />
  );
};

export default function Settings() {
  // Store Hooks
  const packages = usePackageStore((s) => s.packages);
  const addPackage = usePackageStore((s) => s.addPackage);
  const updatePackage = usePackageStore((s) => s.updatePackage);
  const deletePackage = usePackageStore((s) => s.deletePackage);

  // Local Settings State (Areas/Agents)
  const [areas, setAreas] = useState([]);
  const [agents, setAgents] = useState([]);
  const [newArea, setNewArea] = useState("");
  const [newAgent, setNewAgent] = useState("");

  // Package Management State
  const [newPkg, setNewPkg] = useState({ name: "", price: "", speedMbps: "" });
  const [editPkgId, setEditPkgId] = useState(null);
  const [editPkgData, setEditPkgData] = useState({});
  const [historyPkg, setHistoryPkg] = useState(null);
  const [deletePkg, setDeletePkg] = useState(null);

  // Sorting State
  const [sortConfig, setSortConfig] = useState({
    key: "price",
    direction: "asc",
  });

  // Load Initial Data
  useEffect(() => {
    const loadSettings = async () => {
      const a = await db.settings.get("areas");
      const g = await db.settings.get("agents");
      setAreas(a?.value || []);
      setAgents(g?.value || []);
    };
    loadSettings();
  }, []);

  // ── AREA / AGENT HANDLERS ──
  const saveAreas = async (list) => {
    setAreas(list);
    await db.settings.put({ key: "areas", value: list });
  };
  const saveAgents = async (list) => {
    setAgents(list);
    await db.settings.put({ key: "agents", value: list });
  };

  const addArea = async () => {
    const v = newArea.trim();
    if (!v || areas.includes(v)) return;
    await saveAreas([...areas, v]);
    setNewArea("");
  };
  const removeArea = (a) => saveAreas(areas.filter((x) => x !== a));

  const addAgent = async () => {
    const v = newAgent.trim();
    if (!v || agents.includes(v)) return;
    await saveAgents([...agents, v]);
    setNewAgent("");
  };
  const removeAgent = (a) => saveAgents(agents.filter((x) => x !== a));

  // ── PACKAGE HANDLERS ──
  const handleAddPkg = async () => {
    if (!newPkg.name || !newPkg.price) return;
    await addPackage({
      name: newPkg.name,
      price: newPkg.price,
      speedMbps: newPkg.speedMbps,
    });
    setNewPkg({ name: "", price: "", speedMbps: "" });
  };

  const startEdit = (pkg) => {
    setEditPkgId(pkg.id);
    // Copy all fields to edit state
    setEditPkgData({
      name: pkg.name,
      price: pkg.price,
      speedMbps: pkg.speedMbps || "",
    });
  };

  const saveEdit = async () => {
    if (!editPkgId) return;
    await updatePackage(editPkgId, editPkgData);
    setEditPkgId(null);
    setEditPkgData({});
  };

  const cancelEdit = () => {
    setEditPkgId(null);
    setEditPkgData({});
  };

  const handleConfirmDelete = async () => {
    if (deletePkg) {
      await deletePackage(deletePkg.id);
      setDeletePkg(null);
    }
  };

  // ── SORTING LOGIC ──
  const requestSort = (key) => {
    let direction = "asc";
    if (sortConfig.key === key && sortConfig.direction === "asc") {
      direction = "desc";
    }
    setSortConfig({ key, direction });
  };

  const sortedPackages = [...packages].sort((a, b) => {
    const { key, direction } = sortConfig;
    const modifier = direction === "asc" ? 1 : -1;

    switch (key) {
      case "name":
        return modifier * a.name.localeCompare(b.name);
      case "speedMbps":
        return (
          modifier * ((Number(a.speedMbps) || 0) - (Number(b.speedMbps) || 0))
        );
      case "price":
        return modifier * (Number(a.price) - Number(b.price));
      case "lastUpdated": {
        // Wrapped in braces to fix lexical declaration error
        const dateA = a.lastUpdated ? new Date(a.lastUpdated) : new Date(0);
        const dateB = b.lastUpdated ? new Date(b.lastUpdated) : new Date(0);
        return modifier * (dateA - dateB);
      }
      default:
        return 0;
    }
  });

  return (
    <div className="p-5 space-y-6 max-w-6xl mx-auto">
      {/* HEADER */}
      <div>
        <h1 className="text-2xl font-bold text-gray-900">Settings</h1>
        <p className="text-sm text-gray-500 mt-0.5">
          Manage your internet packages, coverage areas, and recovery agents.
        </p>
      </div>

      {/* PACKAGES SECTION */}
      <section className="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden">
        <div className="px-6 py-5 border-b border-gray-200 bg-gray-50/50 flex justify-between items-center">
          <div>
            <h2 className="text-base font-bold text-gray-800">
              Internet Packages
            </h2>
            <p className="text-xs text-gray-500 mt-1">
              Active customer cycles are{" "}
              <strong className="text-gray-700">NOT</strong> affected by price
              changes until they renew.
            </p>
          </div>
          <div className="bg-blue-50 text-blue-700 px-3 py-1 rounded-full text-xs font-semibold">
            {packages.length} Packages
          </div>
        </div>

        <div className="overflow-x-auto">
          <table className="w-full text-sm">
            <thead>
              <tr className="bg-white text-gray-500 text-left border-b border-gray-200">
                <th
                  onClick={() => requestSort("name")}
                  className="px-6 py-4 font-semibold w-1/4 cursor-pointer hover:bg-gray-50 transition-colors select-none"
                >
                  <div className="flex items-center gap-1">
                    Package Name{" "}
                    <SortIcon column="name" sortConfig={sortConfig} />
                  </div>
                </th>
                <th
                  onClick={() => requestSort("speedMbps")}
                  className="px-6 py-4 font-semibold w-1/6 cursor-pointer hover:bg-gray-50 transition-colors select-none"
                >
                  <div className="flex items-center gap-1">
                    Speed{" "}
                    <SortIcon column="speedMbps" sortConfig={sortConfig} />
                  </div>
                </th>
                <th
                  onClick={() => requestSort("price")}
                  className="px-6 py-4 font-semibold w-1/6 cursor-pointer hover:bg-gray-50 transition-colors select-none"
                >
                  <div className="flex items-center gap-1">
                    Current Price{" "}
                    <SortIcon column="price" sortConfig={sortConfig} />
                  </div>
                </th>
                <th
                  onClick={() => requestSort("lastUpdated")}
                  className="px-6 py-4 font-semibold w-1/6 cursor-pointer hover:bg-gray-50 transition-colors select-none"
                >
                  <div className="flex items-center gap-1">
                    Last Updated{" "}
                    <SortIcon column="lastUpdated" sortConfig={sortConfig} />
                  </div>
                </th>
                <th className="px-6 py-4 text-right font-semibold">Actions</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-100">
              {sortedPackages.map((pkg) => (
                <tr
                  key={pkg.id}
                  className="hover:bg-gray-50/80 transition-colors"
                >
                  {editPkgId === pkg.id ? (
                    // EDIT MODE
                    <>
                      <td className="px-6 py-3">
                        <input
                          autoFocus
                          className={inp()}
                          value={editPkgData.name}
                          onChange={(e) =>
                            setEditPkgData((d) => ({
                              ...d,
                              name: e.target.value,
                            }))
                          }
                        />
                      </td>
                      <td className="px-6 py-3">
                        <input
                          type="number"
                          className={inp()}
                          value={editPkgData.speedMbps}
                          placeholder="Mbps"
                          onChange={(e) =>
                            setEditPkgData((d) => ({
                              ...d,
                              speedMbps: e.target.value,
                            }))
                          }
                        />
                      </td>
                      <td className="px-6 py-3">
                        <input
                          type="number"
                          className={inp()}
                          value={editPkgData.price}
                          onChange={(e) =>
                            setEditPkgData((d) => ({
                              ...d,
                              price: e.target.value,
                            }))
                          }
                        />
                      </td>
                      <td className="px-6 py-3 text-gray-400 text-xs italic">
                        Editing...
                      </td>
                      <td className="px-6 py-3">
                        <div className="flex justify-end gap-2">
                          <button
                            onClick={saveEdit}
                            className="p-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors"
                            title="Save Changes"
                          >
                            <Check size={16} />
                          </button>
                          <button
                            onClick={cancelEdit}
                            className="p-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 transition-colors"
                            title="Cancel"
                          >
                            <X size={16} />
                          </button>
                        </div>
                      </td>
                    </>
                  ) : (
                    // VIEW MODE
                    <>
                      <td className="px-6 py-4">
                        <span className="font-bold text-gray-800 text-base">
                          {pkg.name}
                        </span>
                      </td>
                      <td className="px-6 py-4">
                        <span className="bg-gray-100 text-gray-600 px-2.5 py-1 rounded text-xs font-medium border border-gray-200">
                          {pkg.speedMbps ? `${pkg.speedMbps} Mbps` : "N/A"}
                        </span>
                      </td>
                      <td className="px-6 py-4">
                        <span className="font-bold text-blue-700 text-base">
                          PKR {Number(pkg.price).toLocaleString()}
                        </span>
                      </td>
                      <td className="px-6 py-4 text-gray-500">
                        {pkg.lastUpdated ? (
                          <div
                            className={`flex items-center gap-1.5 text-xs ${pkg.lastUpdated === today() ? "text-green-600 font-bold" : ""}`}
                          >
                            <Calendar
                              size={13}
                              className={
                                pkg.lastUpdated === today()
                                  ? "text-green-600"
                                  : "text-gray-400"
                              }
                            />
                            {pkg.lastUpdated === today()
                              ? "Today"
                              : formatDate(pkg.lastUpdated)}
                          </div>
                        ) : (
                          <span className="text-xs text-gray-400 italic">
                            Original
                          </span>
                        )}
                      </td>
                      <td className="px-6 py-4">
                        <div className="flex justify-end gap-2">
                          <button
                            onClick={() => setHistoryPkg(pkg)}
                            className="flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-gray-600 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 hover:text-gray-900 transition-all shadow-sm"
                          >
                            <History size={14} /> History
                          </button>

                          <button
                            onClick={() => startEdit(pkg)}
                            className="p-1.5 text-blue-600 hover:bg-blue-50 rounded-md transition-colors"
                            title="Edit"
                          >
                            <Pencil size={15} />
                          </button>

                          <button
                            onClick={() => setDeletePkg(pkg)}
                            className="p-1.5 text-red-600 hover:bg-red-50 rounded-md transition-colors"
                            title="Delete"
                          >
                            <Trash2 size={15} />
                          </button>
                        </div>
                      </td>
                    </>
                  )}
                </tr>
              ))}
              {packages.length === 0 && (
                <tr>
                  <td
                    colSpan={5}
                    className="px-6 py-10 text-center text-gray-400"
                  >
                    No packages configured. Add your first package below.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>

        {/* ADD FORM */}
        <div className="p-5 bg-gray-50 border-t border-gray-200 flex flex-wrap md:flex-nowrap gap-4 items-center">
          <span className="text-sm font-bold text-gray-700 whitespace-nowrap">
            Add New Package:
          </span>
          <div className="flex-1 grid grid-cols-1 md:grid-cols-3 gap-3">
            <input
              className={inp()}
              placeholder="Name (e.g. Gamer Plus)"
              value={newPkg.name}
              onChange={(e) =>
                setNewPkg((d) => ({ ...d, name: e.target.value }))
              }
            />
            <input
              type="number"
              className={inp()}
              placeholder="Price (PKR)"
              value={newPkg.price}
              onChange={(e) =>
                setNewPkg((d) => ({ ...d, price: e.target.value }))
              }
            />
            <input
              type="number"
              className={inp()}
              placeholder="Speed (Mbps)"
              value={newPkg.speedMbps}
              onChange={(e) =>
                setNewPkg((d) => ({ ...d, speedMbps: e.target.value }))
              }
            />
          </div>
          <button
            onClick={handleAddPkg}
            className="px-6 py-2 bg-gray-900 text-white font-medium rounded-lg hover:bg-black transition-colors flex items-center gap-2 shadow-lg shadow-gray-200"
          >
            <Plus size={16} /> Add Package
          </button>
        </div>
      </section>

      {/* LISTS SECTION */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
        <ListManager
          title="Coverage Areas"
          items={areas}
          newValue={newArea}
          onNewValueChange={setNewArea}
          onAdd={addArea}
          onRemove={removeArea}
          placeholder="e.g. Model Town"
        />
        <ListManager
          title="Recovery Agents"
          items={agents}
          newValue={newAgent}
          onNewValueChange={setNewAgent}
          onAdd={addAgent}
          onRemove={removeAgent}
          placeholder="e.g. Ali Raza"
        />
      </div>

      {/* HISTORY MODAL (TIMELINE) */}
      <Modal
        isOpen={!!historyPkg}
        onClose={() => setHistoryPkg(null)}
        title={`Price History: ${historyPkg?.name}`}
        size="md"
      >
        <div className="p-1">
          <div className="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-100 p-4 rounded-xl flex items-center justify-between mb-6">
            <div>
              <p className="text-xs font-bold text-blue-500 uppercase tracking-wide">
                Current Price
              </p>
              <p className="text-2xl font-black text-blue-900">
                PKR {Number(historyPkg?.price).toLocaleString()}
              </p>
            </div>
            <div className="bg-white p-2 rounded-full shadow-sm">
              <TrendingUp className="text-blue-600" size={24} />
            </div>
          </div>

          <h3 className="text-sm font-bold text-gray-800 mb-4 px-1">
            Change Log
          </h3>

          <div className="relative pl-4 border-l-2 border-gray-200 space-y-8 ml-2">
            {(historyPkg?.priceHistory || []).length === 0 ? (
              <div className="text-gray-400 text-sm flex items-center gap-2 pl-2">
                <AlertCircle size={16} /> No price changes recorded since
                creation.
              </div>
            ) : (
              [...historyPkg.priceHistory].reverse().map((h, i) => (
                <div key={i} className="relative">
                  {/* Dot */}
                  <div className="absolute -left-[21px] top-3.5 w-3 h-3 bg-white rounded-full border-2 border-blue-500 ring-4 ring-blue-50"></div>

                  <div className="bg-white p-3 rounded-lg border border-gray-200 shadow-sm hover:border-blue-300 transition-colors">
                    <div className="flex items-center justify-between mb-1.5">
                      <span className="text-xs font-bold text-gray-500">
                        {formatDate(h.changedAt)}
                      </span>
                    </div>
                    <div className="flex items-center gap-3 text-sm text-gray-800">
                      <span className="font-medium text-gray-400 line-through decoration-red-400">
                        PKR {h.oldPrice.toLocaleString()}
                      </span>
                      <ArrowRight size={14} className="text-gray-300" />
                      <span className="font-bold text-green-600 bg-green-50 px-2 py-0.5 rounded border border-green-100">
                        PKR {Number(h.newPrice).toLocaleString()}
                      </span>
                    </div>
                  </div>
                </div>
              ))
            )}

            {/* Initial Entry (Virtual) */}
            <div className="relative pt-4">
              <div className="absolute -left-[21px] top-5 w-3 h-3 bg-gray-300 rounded-full border-2 border-white"></div>
              <div className="text-xs text-gray-400 pl-2 pt-1">
                Package Created{" "}
                {historyPkg?.createdAt
                  ? `on ${formatDate(historyPkg.createdAt)}`
                  : ""}
              </div>
            </div>
          </div>

          <div className="flex justify-end mt-6">
            <button
              onClick={() => setHistoryPkg(null)}
              className="px-5 py-2 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-lg text-sm font-bold transition-colors"
            >
              Close
            </button>
          </div>
        </div>
      </Modal>

      {/* CONFIRM DELETE DIALOG */}
      <ConfirmDialog
        isOpen={!!deletePkg}
        onClose={() => setDeletePkg(null)}
        onConfirm={handleConfirmDelete}
        title="Delete Package"
        message={`Are you sure you want to delete "${deletePkg?.name}"? This cannot be undone.`}
        confirmLabel="Delete Package"
        requirePassword={true}
        danger={true}
      />
    </div>
  );
}

// Sub-component
function ListManager({
  title,
  items,
  newValue,
  onNewValueChange,
  onAdd,
  onRemove,
  placeholder,
}) {
  return (
    <section className="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden flex flex-col h-full">
      <div className="px-5 py-4 border-b border-gray-200 bg-gray-50/50">
        <h2 className="text-base font-bold text-gray-800">{title}</h2>
      </div>
      <div className="p-5 flex-1 flex flex-col gap-4">
        <div className="flex gap-2">
          <input
            className={`${inp()} flex-1`}
            placeholder={placeholder}
            value={newValue}
            onChange={(e) => onNewValueChange(e.target.value)}
            onKeyDown={(e) => e.key === "Enter" && onAdd()}
          />
          <button
            onClick={onAdd}
            className="px-4 py-2 text-sm bg-gray-900 text-white font-medium rounded-lg hover:bg-black flex items-center gap-1.5 transition-colors"
          >
            <Plus size={15} /> Add
          </button>
        </div>
        <div className="flex flex-wrap gap-2 mt-1">
          {items.map((item) => (
            <span
              key={item}
              className="flex items-center gap-1.5 bg-white border border-gray-200 text-gray-700 text-sm font-medium px-3 py-1.5 rounded-lg shadow-sm"
            >
              {item}
              <button
                onClick={() => onRemove(item)}
                className="text-gray-400 hover:text-red-500 transition-colors"
              >
                <X size={14} />
              </button>
            </span>
          ))}
          {items.length === 0 && (
            <span className="text-sm text-gray-400 italic">
              None added yet.
            </span>
          )}
        </div>
      </div>
    </section>
  );
}

const inp = () =>
  "border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all w-full";
</file>

<file path="src/store/useConnectionJobStore.js">
import { create } from "zustand";
import { readAll, writeAll } from "../db/database";

// Connection Jobs are stored in the "connectionJobs" table in localStorage.
// Each job looks like:
// {
//   id: number,
//   date: "2026-03-01",
//   technicianName: "Ali",
//   subscriberName: "Ahmed Ali",         // free-text name OR username
//   subscriberUsername: "ahmed.ali",     // optional - typed username for tracking
//   note: "New connection Gulshan B5",
//   items: [
//     { inventoryItemId: 3, description: "fiber", unit: "meter", qty: 50, unitRate: 25, totalValue: 1250 },
//     { inventoryItemId: 1, description: "ONU",   unit: "piece", qty: 1,  unitRate: 150, totalValue: 150 },
//   ],
//   totalValue: 1400,
//   createdAt: "ISO string",
// }

const TABLE = "connectionJobs";

async function getJobs() {
  const data = await readAll();
  return data[TABLE] || [];
}

async function saveJobs(jobs) {
  const data = await readAll();
  data[TABLE] = jobs;
  await writeAll(data);
}

const useConnectionJobStore = create((set) => ({
  jobs: [],

  loadJobs: async () => {
    const jobs = await getJobs();
    set({ jobs });
  },

  addJob: async (jobData) => {
    const existing = await getJobs();
    const maxId = existing.reduce((m, j) => Math.max(m, Number(j.id) || 0), 0);
    const newJob = {
      ...jobData,
      id: maxId + 1,
      createdAt: new Date().toISOString(),
    };
    const updated = [...existing, newJob];
    await saveJobs(updated);
    set({ jobs: updated });
    return newJob;
  },

  deleteJob: async (id) => {
    const existing = await getJobs();
    const updated = existing.filter((j) => j.id !== id);
    await saveJobs(updated);
    set({ jobs: updated });
  },
}));

export default useConnectionJobStore;
</file>

<file path="src/store/useCustomerStore.js">
import { create } from "zustand";
import db from "../db/database";

const useCustomerStore = create((set) => ({
  customers: [],

  loadCustomers: async () => {
    const customers = await db.customers.toArray();
    set({ customers });
  },

  addCustomer: async (data) => {
    const id = await db.customers.add({
      ...data,
      createdAt: new Date().toISOString(),
    });
    const customer = await db.customers.get(id);
    set((s) => ({ customers: [...s.customers, customer] }));
    return customer;
  },

  updateCustomer: async (id, data) => {
    await db.customers.update(id, data);
    set((s) => ({
      customers: s.customers.map((c) => (c.id === id ? { ...c, ...data } : c)),
    }));
  },

  // SOFT DELETE — marks as terminated + archived, preserves all data
  archiveCustomer: async (id, reason = "") => {
    const updates = {
      status: "terminated",
      isArchived: true,
      archivedAt: new Date().toISOString(),
      archiveReason: reason,
    };
    await db.customers.update(id, updates);
    set((s) => ({
      customers: s.customers.map((c) =>
        c.id === id ? { ...c, ...updates } : c,
      ),
    }));
  },

  // HARD DELETE — only called from Archive view, truly removes everything
  permanentlyDeleteCustomer: async (id) => {
    await db.paymentCycles.where("customerId").equals(id).delete();
    await db.customers.delete(id);
    set((s) => ({ customers: s.customers.filter((c) => c.id !== id) }));
  },

  // Restore an archived customer back to active
  restoreCustomer: async (id) => {
    const updates = {
      status: "active",
      isArchived: false,
      archivedAt: null,
      archiveReason: "",
    };
    await db.customers.update(id, updates);
    set((s) => ({
      customers: s.customers.map((c) =>
        c.id === id ? { ...c, ...updates } : c,
      ),
    }));
  },
}));

export default useCustomerStore;
</file>

<file path="src/store/useExpenseStore.js">
import { create } from "zustand";
import db from "../db/database";

export const EXPENSE_CATEGORIES = [
  "Monthly Salary",
  "Food Labour",
  "Electricity Bill",
  "Petrol",
  "Misc",
  "Devices Purchased",
  "Rent",
  "Internet Uplink",
];

const useExpenseStore = create((set) => ({
  expenses: [],

  loadExpenses: async () => {
    const expenses = await db.expenses.toArray();
    set({ expenses });
  },

  addExpense: async (data) => {
    const id = await db.expenses.add({
      ...data,
      createdAt: new Date().toISOString(),
    });
    const expense = await db.expenses.get(id);
    set((s) => ({ expenses: [...s.expenses, expense] }));
  },

  updateExpense: async (id, data) => {
    await db.expenses.update(id, data);
    set((s) => ({
      expenses: s.expenses.map((e) => (e.id === id ? { ...e, ...data } : e)),
    }));
  },

  deleteExpense: async (id) => {
    await db.expenses.delete(id);
    set((s) => ({ expenses: s.expenses.filter((e) => e.id !== id) }));
  },

  getTotalExpenses: () => {
    // accessed via get() pattern, but easier as a computed here
    return 0; // components will compute from expenses array directly
  },
}));

export default useExpenseStore;
</file>

<file path="src/store/usePackageStore.js">
import { create } from "zustand";
import db from "../db/database";
import { today } from "../utils/dateUtils";

const usePackageStore = create((set) => ({
  packages: [],

  loadPackages: async () => {
    const packages = await db.packages.toArray();
    set({ packages });
  },

  addPackage: async (data) => {
    const id = await db.packages.add({
      ...data,
      price: Number(data.price), // Ensure stored as Number
      speedMbps: Number(data.speedMbps) || 0,
      priceHistory: [],
      lastUpdated: null, // Null means "Original"
      createdAt: new Date().toISOString(),
    });
    const pkg = await db.packages.get(id);
    set((s) => ({ packages: [...s.packages, pkg] }));
  },

  updatePackage: async (id, newData) => {
    // 1. Fetch latest version directly from DB to avoid stale state
    const currentPkg = await db.packages.get(id);
    if (!currentPkg) return;

    const oldPrice = Number(currentPkg.price);
    const newPrice = Number(newData.price);

    // 2. Prepare update object
    let updates = {
      name: newData.name,
      price: newPrice,
      speedMbps: Number(newData.speedMbps) || 0,
    };

    // 3. Detect Price Change
    if (oldPrice !== newPrice) {
      const historyEntry = {
        id: crypto.randomUUID(),
        oldPrice: oldPrice,
        newPrice: newPrice,
        changedAt: today(), // YYYY-MM-DD
      };

      // Robustly append to history
      const previousHistory = Array.isArray(currentPkg.priceHistory)
        ? currentPkg.priceHistory
        : [];

      updates.priceHistory = [...previousHistory, historyEntry];
      updates.lastUpdated = today();
    }

    // 4. Save to DB
    await db.packages.update(id, updates);

    // 5. Update UI State (Fetch fresh to be safe)
    const freshPkg = await db.packages.get(id);
    set((s) => ({
      packages: s.packages.map((p) => (p.id === id ? freshPkg : p)),
    }));
  },

  deletePackage: async (id) => {
    await db.packages.delete(id);
    set((s) => ({ packages: s.packages.filter((p) => p.id !== id) }));
  },
}));

export default usePackageStore;
</file>

<file path="src/utils/backup.js">
import { readAll, writeAll } from "../db/database";

export const exportBackup = async () => {
  const data = await readAll();

  const backup = {
    exportedAt: new Date().toISOString(),
    version: "2.0",
    data,
  };

  const blob = new Blob([JSON.stringify(backup, null, 2)], {
    type: "application/json",
  });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.download = `galaxy-isp-backup-${new Date().toISOString().slice(0, 10)}.json`;
  a.href = url;
  a.click();
  URL.revokeObjectURL(url);

  // Save last backup date
  const updated = await readAll();
  updated.settings = {
    ...(updated.settings || {}),
    lastBackupDate: new Date().toISOString().slice(0, 10),
  };
  await writeAll(updated);
};

export const importBackup = async (file) => {
  const text = await file.text();
  let backup;
  try {
    backup = JSON.parse(text);
  } catch {
    throw new Error("Invalid backup file. Could not parse JSON.");
  }

  // Support both v1 (Dexie) and v2 (file-based) backup formats
  let restored;
  if (backup.data && backup.version === "2.0") {
    restored = backup.data;
  } else if (backup.data) {
    // v1 format conversion
    const d = backup.data;
    restored = {
      customers: d.customers || [],
      paymentCycles: d.cycles || [],
      packages: d.packages || [],
      inventory: d.inventory || [],
      expenses: d.expenses || [],
      settings: {},
    };
    (d.settings || []).forEach((s) => {
      restored.settings[s.key] = s.value;
    });
  } else {
    throw new Error("Invalid backup format.");
  }

  await writeAll(restored);
};

export const getLastBackupDate = async () => {
  const data = await readAll();
  return (data.settings || {}).lastBackupDate || null;
};
</file>

<file path="src/utils/duplicateCheck.js">
import db from "../db/database";

/**
 * Checks if a username or mobile number already exists.
 * Pass excludeId when editing an existing customer (to skip self-match).
 * Returns: { hasDuplicate: bool, field: 'userName'|'mobileNo'|null, existing: customer|null }
 */
export const checkDuplicate = async (userName, mobileNo, excludeId = null) => {
  const all = await db.customers.toArray();

  if (userName && userName.trim()) {
    const normalised = userName.trim().toLowerCase();
    const match = all.find(
      (c) => c.userName?.toLowerCase() === normalised && c.id !== excludeId,
    );
    if (match)
      return { hasDuplicate: true, field: "userName", existing: match };
  }

  if (mobileNo && String(mobileNo).replace(/\D/g, "").length >= 10) {
    const cleaned = String(mobileNo).replace(/\D/g, "");
    const match = all.find(
      (c) =>
        String(c.mobileNo).replace(/\D/g, "") === cleaned && c.id !== excludeId,
    );
    if (match)
      return { hasDuplicate: true, field: "mobileNo", existing: match };
  }

  return { hasDuplicate: false, field: null, existing: null };
};
</file>

<file path="src/utils/Statusutils.js">
import { daysUntil } from "./dateUtils";

/**
 * Raw billing facts about a customer's cycle.
 * These are INDEPENDENT of customer.status (suspended/active).
 * Use these for filters and dashboard counts — they always reflect
 * the true billing reality regardless of manual suspension.
 */
export function getCycleFacts(cycle) {
  if (!cycle) return { expired: false, unpaid: false, daysLeft: null };
  const days = daysUntil(cycle.cycleEndDate);
  return {
    expired: days < 0,
    unpaid: cycle.amountPending > 0,
    daysLeft: days,
  };
}

/**
 * Single source of truth for the STATUS BADGE shown on each row.
 *
 * customer.status in DB is ONLY "active" or "suspended" (manually set).
 * Everything else is derived from cycle data.
 *
 *  "suspended"  → operator manually suspended (shown on badge regardless of cycle)
 *  "expired"    → active customer, cycle ended + unpaid balance
 *  "renewal"    → active customer, cycle ended + fully paid (needs new cycle)
 *  "pending"    → active customer, cycle active + unpaid balance
 *  "clear"      → active customer, cycle active + fully paid
 *
 * NOTE: A suspended customer might ALSO have an expired/unpaid cycle.
 *       The badge shows "Suspended" (the manual operator action takes
 *       visual priority). But FILTERS use getCycleFacts() directly so
 *       that suspended customers still appear in "Expired" / "Balance Due".
 */
export function computeDisplayStatus(customer, cycle) {
  if (customer.status === "suspended") return "suspended";
  if (!cycle) return "pending"; // no cycle yet → needs setup

  const { expired, unpaid } = getCycleFacts(cycle);

  if (expired && unpaid) return "expired"; // cycle ended, still owes money
  if (expired && !unpaid) return "renewal"; // cycle ended, paid — needs renew
  if (!expired && unpaid) return "pending"; // within cycle, partially paid
  return "clear"; // within cycle, fully paid
}
</file>

<file path="vite.config.js">
import { defineConfig } from "vite";
import react from "@vitejs/plugin-react";
import tailwindcss from "@tailwindcss/vite";
import fs from "node:fs";
import path from "node:path";
import { fileURLToPath } from "node:url";

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const DATA_FILE = path.join(__dirname, "galaxy-data.json");

const DEFAULT_DATA = {
  customers: [],
  paymentCycles: [],
  packages: [],
  inventory: [],
  expenses: [],
  settings: {},
};

function ensureDataFile() {
  if (!fs.existsSync(DATA_FILE)) {
    fs.writeFileSync(DATA_FILE, JSON.stringify(DEFAULT_DATA, null, 2), "utf-8");
    console.log("[galaxy-isp] Created galaxy-data.json");
  }
}

function localDataPlugin() {
  return {
    name: "local-data-api",
    configureServer(server) {
      server.middlewares.use("/api/data", (req, res, next) => {
        res.setHeader("Access-Control-Allow-Origin", "*");
        res.setHeader("Access-Control-Allow-Methods", "GET, POST, OPTIONS");
        res.setHeader("Access-Control-Allow-Headers", "Content-Type");

        if (req.method === "OPTIONS") {
          res.writeHead(200);
          res.end();
          return;
        }

        if (req.method === "GET") {
          try {
            ensureDataFile();
            const data = fs.readFileSync(DATA_FILE, "utf-8");
            res.setHeader("Content-Type", "application/json");
            res.writeHead(200);
            res.end(data);
          } catch (e) {
            res.writeHead(500);
            res.end(JSON.stringify({ error: e.message }));
          }
          return;
        }

        if (req.method === "POST") {
          let body = "";
          req.on("data", (chunk) => {
            body += chunk;
          });
          req.on("end", () => {
            try {
              const parsed = JSON.parse(body);
              fs.writeFileSync(
                DATA_FILE,
                JSON.stringify(parsed, null, 2),
                "utf-8",
              );
              res.setHeader("Content-Type", "application/json");
              res.writeHead(200);
              res.end(JSON.stringify({ ok: true }));
            } catch (e) {
              res.writeHead(400);
              res.end(JSON.stringify({ error: e.message }));
            }
          });
          return;
        }

        next();
      });
    },
  };
}

export default defineConfig({
  base: "./", // Add this line!
  plugins: [react(), tailwindcss(), localDataPlugin()],
  server: {
    watch: {
      // Tell Vite to ignore galaxy-data.json — every save to this file
      // was triggering HMR which reset all React state (tab → "dashboard")
      ignored: ["**/galaxy-data.json"],
    },
  },
});
</file>

<file path="src/components/layout/Navbar.jsx">
import { useState, useRef } from "react";
import { Download, Upload, Settings } from "lucide-react";
import { exportBackup, importBackup } from "../../utils/backup";
import ConfirmDialog from "../ui/ConfirmDialog";

export default function Navbar({ activeTab, onTabChange }) {
  const [importing, setImporting] = useState(false);
  const [confirmImport, setConfirmImport] = useState(false);
  const [pendingFile, setPendingFile] = useState(null);
  const fileRef = useRef();

  const tabs = [
    { id: "dashboard", label: "Dashboard" },
    { id: "customers", label: "Subscribers" },
    { id: "inventory", label: "Inventory" },
    { id: "expenses", label: "Expenses" },
    { id: "settings", label: "Settings" },
  ];

  const handleImportSelect = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    setPendingFile(file);
    setConfirmImport(true);
    e.target.value = "";
  };

  const doImport = async () => {
    if (!pendingFile) return;
    setImporting(true);
    try {
      await importBackup(pendingFile);
      window.location.reload();
    } catch (err) {
      alert("Import failed: " + err.message);
    }
    setImporting(false);
  };

  return (
    <>
      <nav className="bg-white border-b border-gray-200 px-4 flex items-center justify-between h-12">
        <div className="flex items-center gap-1">
          <span className="font-semibold text-gray-800 text-sm mr-4">
            Galaxy ISP
          </span>
          {tabs.map((t) => (
            <button
              key={t.id}
              onClick={() => onTabChange(t.id)}
              className={`px-3 py-1.5 text-sm rounded font-medium ${
                activeTab === t.id
                  ? "bg-blue-600 text-white"
                  : "text-gray-600 hover:bg-gray-100"
              }`}
            >
              {t.label}
            </button>
          ))}
        </div>

        <div className="flex items-center gap-2">
          <button
            onClick={exportBackup}
            className="flex items-center gap-1.5 px-3 py-1.5 text-sm bg-green-600 text-white rounded hover:bg-green-700"
          >
            <Download size={14} />
            Backup
          </button>
          <button
            onClick={() => fileRef.current.click()}
            disabled={importing}
            className="flex items-center gap-1.5 px-3 py-1.5 text-sm border border-gray-300 text-gray-700 rounded hover:bg-gray-50 disabled:opacity-50"
          >
            <Upload size={14} />
            Restore
          </button>
          <input
            ref={fileRef}
            type="file"
            accept=".json"
            className="hidden"
            onChange={handleImportSelect}
          />
        </div>
      </nav>

      <ConfirmDialog
        isOpen={confirmImport}
        onClose={() => setConfirmImport(false)}
        onConfirm={doImport}
        title="Restore from Backup"
        message="This will REPLACE all current data with the backup file. This cannot be undone. Are you sure?"
        confirmLabel="Yes, Restore"
        danger
      />
    </>
  );
}
</file>

<file path="src/components/ui/Badge.jsx">
// Badge.jsx — Unified status badge component
// Computed statuses (derived from cycle data):
//   clear     → paid up, cycle active
//   pending   → unpaid, cycle still active
//   expired   → cycle ended + unpaid (replaces "overdue" in status column)
//   renewal   → cycle ended + fully paid (needs new cycle, not suspended)
// Stored statuses (on customer record):
//   suspended → manually suspended by operator
//   terminated → archived/terminated

export default function Badge({ status }) {
  const map = {
    clear: "bg-green-100 text-green-800",
    pending: "bg-yellow-100 text-yellow-800",
    expired: "bg-red-100 text-red-800",
    renewal: "bg-blue-100 text-blue-700",
    suspended: "bg-red-200 text-red-900",
    terminated: "bg-gray-200 text-gray-600",
    // Legacy / fallback
    overdue: "bg-red-100 text-red-800",
    active: "bg-green-100 text-green-800",
    grace: "bg-orange-100 text-orange-800",
  };

  const label = {
    clear: "Clear",
    pending: "Pending",
    expired: "Expired",
    renewal: "Renewal Due",
    suspended: "Suspended",
    terminated: "Terminated",
    // Legacy / fallback
    overdue: "Expired",
    active: "Active",
    grace: "Grace Period",
  };

  return (
    <span
      className={`inline-block px-2 py-0.5 rounded text-xs font-medium ${
        map[status] || "bg-gray-100 text-gray-600"
      }`}
    >
      {label[status] || status}
    </span>
  );
}
</file>

<file path="src/components/ui/HistoryModal.jsx">
import {
  Calendar,
  Wallet,
  CheckCircle,
  AlertCircle,
  Receipt,
  ArrowRightCircle,
  History,
} from "lucide-react";
import Modal from "./Modal";
import Badge from "./Badge";
import usePaymentStore from "../../store/usePaymentStore";
import { formatDate } from "../../utils/dateUtils";

export default function HistoryModal({ customer, onClose }) {
  const getCyclesForCustomer = usePaymentStore((s) => s.getCyclesForCustomer);

  if (!customer) return null;

  const cycles = getCyclesForCustomer(customer.id);

  // Quick Summary Computations
  const totalPending = cycles.reduce(
    (sum, c) => sum + (c.amountPending || 0),
    0,
  );
  const totalCycles = cycles.length;

  return (
    <Modal
      isOpen={!!customer}
      onClose={onClose}
      title={`Payment History: ${customer.fullName}`}
      size="3xl"
    >
      <div className="space-y-6">
        {/* ── TOP SUMMARY DASHBOARD ── */}
        <div className="grid grid-cols-3 gap-4">
          <div className="bg-blue-50 border border-blue-100 p-3 rounded-xl flex flex-col justify-center items-center text-center">
            <span className="text-blue-600/80 text-[10px] font-bold uppercase tracking-wider mb-1">
              Total Cycles
            </span>
            <span className="text-xl font-black text-blue-700">
              {totalCycles}
            </span>
          </div>

          <div
            className={`p-3 rounded-xl border flex flex-col justify-center items-center text-center shadow-sm ${
              totalPending > 0
                ? "bg-red-50 border-red-200"
                : "bg-green-50 border-green-200"
            }`}
          >
            <span
              className={`text-[10px] font-bold uppercase tracking-wider mb-1 ${
                totalPending > 0 ? "text-red-600/80" : "text-green-600/80"
              }`}
            >
              Total Unpaid Balance
            </span>
            <span
              className={`text-xl font-black ${
                totalPending > 0 ? "text-red-600" : "text-green-600"
              }`}
            >
              PKR {totalPending.toLocaleString()}
            </span>
          </div>

          <div className="bg-gray-50 border border-gray-200 p-3 rounded-xl flex flex-col justify-center items-center text-center">
            <span className="text-gray-500 text-[10px] font-bold uppercase tracking-wider mb-1.5">
              Account Status
            </span>
            <Badge status={customer.status} />
          </div>
        </div>

        {/* ── TIMELINE OF CYCLES ── */}
        <div className="space-y-4 max-h-[55vh] overflow-y-auto pr-2">
          {cycles.length === 0 ? (
            <div className="text-center py-10 bg-gray-50 text-gray-400 text-sm border-2 border-dashed border-gray-200 rounded-xl">
              <Wallet size={36} className="mx-auto mb-3 opacity-40" />
              <p className="font-medium text-gray-500">
                No payment history found.
              </p>
              <p className="text-xs mt-1">
                Billing cycles will appear here once created.
              </p>
            </div>
          ) : (
            cycles.map((cycle) => {
              // 1. Detect if this cycle was transferred
              const isTransferred =
                cycle.note && cycle.note.includes("[Bal Transferred"); // Match broader string to catch both formats

              // 2. Try to extract the specific amount
              // Format matches: "[Bal Transferred: 2000]"
              const transferMatch = cycle.note
                ? cycle.note.match(/\[Bal Transferred:\s*(\d+)\]/)
                : null;
              const transferredAmount = transferMatch
                ? Number(transferMatch[1])
                : null;

              const isClear = cycle.amountPending === 0;

              // Calculate percent paid
              const percentPaid =
                cycle.totalAmount > 0
                  ? Math.min(
                      100,
                      Math.round((cycle.amountPaid / cycle.totalAmount) * 100),
                    )
                  : isTransferred || isClear
                    ? 100
                    : 0;

              // Determine styling based on status
              let borderColor = "border-gray-100";
              let headerBg = "bg-gray-50/70 border-gray-100";
              let bodyBg = "bg-white";

              if (isTransferred) {
                borderColor = "border-purple-200";
                headerBg = "bg-purple-100 border-purple-200";
                bodyBg = "bg-purple-50/30";
              } else if (!isClear) {
                borderColor = "border-orange-200";
                headerBg = "bg-orange-50 border-orange-200";
                bodyBg = "bg-orange-50/10";
              }

              return (
                <div
                  key={cycle.id}
                  className={`border-2 rounded-xl overflow-hidden transition-colors ${borderColor} ${bodyBg}`}
                >
                  {/* Cycle Header */}
                  <div
                    className={`px-4 py-3 border-b flex justify-between items-center ${headerBg}`}
                  >
                    <div className="flex items-center gap-2.5">
                      {isTransferred ? (
                        <ArrowRightCircle
                          size={16}
                          className="text-purple-600"
                        />
                      ) : (
                        <Calendar
                          size={16}
                          className={
                            isClear ? "text-gray-400" : "text-orange-500"
                          }
                        />
                      )}
                      <span className="text-sm font-bold text-gray-800 tracking-tight">
                        {formatDate(cycle.cycleStartDate)}
                        <span className="mx-2 text-gray-400 font-normal">
                          to
                        </span>
                        {formatDate(cycle.cycleEndDate)}
                      </span>
                    </div>

                    {isTransferred ? (
                      <span className="inline-flex items-center gap-1 px-2.5 py-0.5 rounded text-xs font-bold bg-purple-200 text-purple-800 border border-purple-300">
                        Forwarded
                      </span>
                    ) : (
                      <Badge status={cycle.status} />
                    )}
                  </div>

                  <div className="p-4">
                    {/* TRANSFERRED BANNER */}
                    {isTransferred && (
                      <div className="mb-4 bg-purple-100 text-purple-900 px-3 py-2.5 rounded-lg flex items-start gap-3 text-xs border border-purple-200 shadow-sm">
                        <History size={16} className="mt-0.5 shrink-0" />
                        <div className="leading-relaxed">
                          {transferredAmount ? (
                            <>
                              <strong className="text-purple-900 text-sm">
                                PKR {transferredAmount.toLocaleString()} Shifted
                              </strong>
                              <div className="mt-0.5 opacity-90">
                                This amount was unpaid in this cycle and has
                                been added to the{" "}
                                <span
                                  className="underline font-semibold cursor-help"
                                  title="Check the newest cycle"
                                >
                                  next billing cycle
                                </span>
                                .
                              </div>
                            </>
                          ) : (
                            // Fallback for older data without exact amount recorded
                            <>
                              <strong>Balance Shifted:</strong> The unpaid dues
                              were added to the next cycle.
                            </>
                          )}
                        </div>
                      </div>
                    )}

                    {/* Financials Row */}
                    <div className="flex items-center justify-between mb-3 text-sm px-2">
                      <div className="flex flex-col">
                        <span className="text-[11px] uppercase font-bold text-gray-400 flex items-center gap-1 mb-0.5">
                          <Receipt size={12} /> Total Bill
                        </span>
                        <span className="font-extrabold text-gray-800 text-base">
                          PKR {cycle.totalAmount}
                        </span>
                      </div>

                      <div className="w-px h-8 bg-gray-200"></div>

                      <div className="flex flex-col">
                        <span className="text-[11px] uppercase font-bold text-gray-400 flex items-center gap-1 mb-0.5">
                          <CheckCircle size={12} className="text-green-500" />{" "}
                          Paid
                        </span>
                        <span className="font-extrabold text-green-600 text-base">
                          PKR {cycle.amountPaid}
                        </span>
                      </div>

                      <div className="w-px h-8 bg-gray-200"></div>

                      <div className="flex flex-col">
                        <span className="text-[11px] uppercase font-bold text-gray-400 flex items-center gap-1 mb-0.5">
                          <AlertCircle
                            size={12}
                            className={
                              !isClear ? "text-red-500" : "text-gray-400"
                            }
                          />{" "}
                          Pending
                        </span>
                        <span
                          className={`font-extrabold text-base ${
                            !isClear ? "text-red-600" : "text-gray-400"
                          }`}
                        >
                          PKR {cycle.amountPending}
                        </span>
                      </div>
                    </div>

                    {/* Progress Bar */}
                    <div className="w-full bg-gray-100 rounded-full h-1.5 mb-4 overflow-hidden mt-2">
                      <div
                        className={`h-1.5 rounded-full transition-all duration-500 ${
                          isTransferred
                            ? "bg-purple-400"
                            : isClear
                              ? "bg-green-500"
                              : "bg-blue-500"
                        }`}
                        style={{ width: `${percentPaid}%` }}
                      ></div>
                    </div>

                    {/* Installments List */}
                    {cycle.installments && cycle.installments.length > 0 && (
                      <div className="bg-gray-50 rounded-lg p-3 border border-gray-100">
                        <div className="text-[10px] font-bold text-gray-400 uppercase tracking-wider flex items-center gap-1.5 mb-2.5">
                          <Wallet size={12} /> Payments Received
                        </div>
                        <div className="space-y-2">
                          {cycle.installments.map((inst) => (
                            <div
                              key={inst.id}
                              className="flex justify-between items-center bg-white px-3 py-2 rounded border border-gray-100 shadow-sm hover:border-gray-300 transition-colors"
                            >
                              <div className="flex items-center gap-3">
                                <div className="bg-green-100 text-green-600 p-1.5 rounded-full">
                                  <CheckCircle size={13} strokeWidth={2.5} />
                                </div>
                                <div>
                                  <div className="text-xs font-bold text-gray-800">
                                    {formatDate(inst.datePaid)}
                                  </div>
                                  {inst.note && (
                                    <div className="text-[10px] text-gray-500 mt-0.5 font-medium leading-none">
                                      Via: {inst.note}
                                    </div>
                                  )}
                                </div>
                              </div>
                              <span className="text-sm font-bold text-gray-800">
                                PKR {inst.amountPaid}
                              </span>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              );
            })
          )}
        </div>

        {/* Footer Close Button */}
        <div className="pt-2 flex justify-end">
          <button
            onClick={onClose}
            className="px-6 py-2.5 bg-gray-100 hover:bg-gray-200 border border-gray-200 text-gray-700 text-sm font-bold rounded-lg transition-colors focus:ring-2 focus:ring-gray-300 focus:outline-none"
          >
            Close History
          </button>
        </div>
      </div>
    </Modal>
  );
}
</file>

<file path="src/components/ui/InvoiceModal.jsx">
// src/components/ui/InvoiceModal.jsx
import { useRef } from "react";
import { toPng } from "html-to-image";
import {
  X,
  Printer,
  Wifi,
  CheckCircle2,
  AlertCircle,
  CornerDownRight,
  ImageDown,
  Tag,
  Package,
} from "lucide-react";
import { formatDate } from "../../utils/dateUtils";

function invoiceNumber(cycle) {
  const year = cycle.cycleStartDate?.slice(0, 4) || new Date().getFullYear();
  const seq = String(cycle.id).padStart(4, "0");
  return `INV-${year}-${seq}`;
}

function getScenario(cycle) {
  if (!cycle.isRenewal) return "new";
  if (Number(cycle.previousBalance) > 0) return "renewal_with_dues";
  return "renewal_clean";
}

const SCENARIO_LABELS = {
  new: {
    label: "New Connection",
    color: "#1d4ed8",
    bg: "#eff6ff",
    border: "#bfdbfe",
  },
  renewal_with_dues: {
    label: "Renewal — Previous Balance Included",
    color: "#c2410c",
    bg: "#fff7ed",
    border: "#fed7aa",
  },
  renewal_clean: {
    label: "Renewal",
    color: "#15803d",
    bg: "#f0fdf4",
    border: "#bbf7d0",
  },
};

// ── Build printable HTML ──────────────────────────────────────────────────────
function buildInvoiceHTML({
  invNo,
  scenarioMeta,
  customer,
  cycle,
  packageName,
  originalPackagePrice,
  discountAmt,
  discountLabel,
  materialTotal,
  materialItems,
  previousBalance,
  totalAmount,
  amountPaid,
  amountPending,
  installments,
}) {
  const hasDiscount = discountAmt > 0;
  const hasMaterial = materialTotal > 0;
  const hasPrevBalance = previousBalance > 0;

  const discountRow = hasDiscount
    ? `
    <tr>
      <td style="padding:5px 0; color:#15803d; font-size:13px;">
        🏷 Discount${discountLabel ? ` (${discountLabel})` : ""}
      </td>
      <td style="padding:5px 0; text-align:right; font-weight:600; color:#15803d; font-size:13px;">
        − PKR ${discountAmt.toLocaleString()}
      </td>
    </tr>`
    : "";

  const materialRows = hasMaterial
    ? `
    <tr>
      <td style="padding:5px 0; color:#92400e; font-size:13px;">📦 Material / Equipment</td>
      <td style="padding:5px 0; text-align:right; font-weight:600; color:#92400e; font-size:13px;">
        + PKR ${materialTotal.toLocaleString()}
      </td>
    </tr>
    ${(materialItems || [])
      .map(
        (it) => `
    <tr>
      <td style="padding:2px 0 2px 16px; color:#9ca3af; font-size:11px;">
        ${it.description} × ${it.qty} ${it.unit}
      </td>
      <td style="padding:2px 0; text-align:right; color:#9ca3af; font-size:11px;">
        PKR ${it.totalValue.toLocaleString()}
      </td>
    </tr>`,
      )
      .join("")}`
    : "";

  const prevBalanceRow = hasPrevBalance
    ? `
    <tr>
      <td style="padding:5px 0; color:#c2410c; font-size:13px;">↩ Previous unpaid balance</td>
      <td style="padding:5px 0; text-align:right; font-weight:600; color:#c2410c; font-size:13px;">
        + PKR ${previousBalance.toLocaleString()}
      </td>
    </tr>`
    : "";

  const installmentRows = installments
    .map(
      (inst) => `
    <tr>
      <td style="padding:6px 0; color:#374151; font-size:13px;">
        ${formatDate(inst.datePaid)}${inst.note ? ` · <span style="color:#9ca3af">${inst.note}</span>` : ""}
      </td>
      <td style="padding:6px 0; text-align:right; font-weight:600; color:#15803d; font-size:13px;">
        PKR ${Number(inst.amountPaid).toLocaleString()}
      </td>
    </tr>`,
    )
    .join("");

  const installmentsSection =
    installments.length > 0
      ? `
    <div style="border:1px solid #e5e7eb; border-radius:10px; overflow:hidden; margin-bottom:16px;">
      <div style="background:#f9fafb; padding:8px 16px; border-bottom:1px solid #e5e7eb;">
        <p style="margin:0; font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:.08em; color:#9ca3af;">Payments Received</p>
      </div>
      <div style="padding:10px 16px;">
        <table style="width:100%; border-collapse:collapse;">
          ${installmentRows}
          <tr style="border-top:1px solid #f3f4f6;">
            <td style="padding-top:8px; font-weight:600; color:#374151; font-size:13px;">Total Paid</td>
            <td style="padding-top:8px; text-align:right; font-weight:700; color:#15803d; font-size:13px;">PKR ${amountPaid.toLocaleString()}</td>
          </tr>
        </table>
      </div>
    </div>`
      : "";

  const shiftedAmount = Number(cycle.shiftedAmount || 0);
  const isCarriedForward = shiftedAmount > 0;
  const isPaid = amountPending === 0 && !isCarriedForward;

  const statusBar = isCarriedForward
    ? `
    <div style="display:flex;align-items:center;justify-content:space-between;background:#fff7ed;border:1px solid #fed7aa;border-radius:10px;padding:12px 16px;">
      <div>
        <p style="margin:0;font-weight:700;color:#9a3412;font-size:14px;">Unpaid — Carried Forward</p>
        <p style="margin:2px 0 0;color:#c2410c;font-size:12px;">PKR ${shiftedAmount.toLocaleString()} moved to next cycle.</p>
      </div>
      <p style="margin:0;font-weight:900;color:#c2410c;font-size:20px;">PKR ${shiftedAmount.toLocaleString()}</p>
    </div>`
    : isPaid
      ? `
    <div style="display:flex;align-items:center;gap:12px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:10px;padding:12px 16px;">
      <div style="font-size:20px;">✅</div>
      <div>
        <p style="margin:0;font-weight:700;color:#166534;font-size:14px;">Paid in Full</p>
        <p style="margin:2px 0 0;color:#16a34a;font-size:12px;">No outstanding balance. Thank you!</p>
      </div>
    </div>`
      : `
    <div style="display:flex;align-items:center;justify-content:space-between;background:#fef2f2;border:1px solid #fecaca;border-radius:10px;padding:12px 16px;">
      <div>
        <p style="margin:0;font-weight:700;color:#991b1b;font-size:14px;">Balance Due</p>
        <p style="margin:2px 0 0;color:#dc2626;font-size:12px;">Please pay at your earliest convenience.</p>
      </div>
      <p style="margin:0;font-weight:900;color:#b91c1c;font-size:20px;">PKR ${amountPending.toLocaleString()}</p>
    </div>`;

  return `<!DOCTYPE html>
<html><head><meta charset="UTF-8"/><title>Invoice ${invNo}</title>
<style>*{box-sizing:border-box;margin:0;padding:0;}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;color:#1f2937;background:#fff;padding:24px;font-size:14px;}@page{margin:12mm;}</style>
</head><body>
  <div style="display:flex;justify-content:space-between;align-items:flex-start;padding-bottom:16px;border-bottom:2px solid #1f2937;margin-bottom:20px;">
    <div>
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
        <span style="font-size:22px;">📡</span>
        <span style="font-size:22px;font-weight:900;letter-spacing:-0.5px;">Galaxy ISP</span>
      </div>
      <p style="color:#6b7280;font-size:12px;">Internet Service Provider</p>
    </div>
    <div style="text-align:right;">
      <p style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.1em;color:#9ca3af;margin-bottom:2px;">Invoice</p>
      <p style="font-size:17px;font-weight:900;">${invNo}</p>
      <p style="font-size:12px;color:#6b7280;margin-top:2px;">Issued: ${formatDate(cycle.cycleStartDate)}</p>
    </div>
  </div>

  <div style="display:inline-flex;align-items:center;gap:6px;background:${scenarioMeta.bg};border:1px solid ${scenarioMeta.border};border-radius:8px;padding:6px 12px;margin-bottom:20px;">
    <span style="font-size:11px;font-weight:700;color:${scenarioMeta.color};">${scenarioMeta.label}</span>
  </div>

  <table style="width:100%;border-collapse:collapse;margin-bottom:20px;">
    <tr>
      <td style="width:50%;vertical-align:top;padding-bottom:12px;">
        <p style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:#9ca3af;margin-bottom:3px;">Subscriber</p>
        <p style="font-size:15px;font-weight:700;color:#111827;">${customer.fullName}</p>
        <p style="font-size:12px;color:#6b7280;">${customer.userName}</p>
      </td>
      <td style="width:50%;vertical-align:top;padding-bottom:12px;">
        <p style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:#9ca3af;margin-bottom:3px;">Contact</p>
        <p style="font-size:13px;color:#374151;">${customer.mobileNo || "—"}</p>
        <p style="font-size:12px;color:#6b7280;">${customer.mainArea || "—"}</p>
      </td>
    </tr>
    <tr>
      <td style="vertical-align:top;">
        <p style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:#9ca3af;margin-bottom:3px;">Package</p>
        <p style="font-size:13px;font-weight:600;color:#374151;">${packageName || "—"}</p>
      </td>
      <td style="vertical-align:top;">
        <p style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:#9ca3af;margin-bottom:3px;">Billing Period</p>
        <p style="font-size:13px;color:#374151;">${formatDate(cycle.cycleStartDate)} → ${formatDate(cycle.cycleEndDate)}</p>
      </td>
    </tr>
  </table>

  <div style="border:1px solid #e5e7eb;border-radius:10px;overflow:hidden;margin-bottom:16px;">
    <div style="background:#f9fafb;padding:8px 16px;border-bottom:1px solid #e5e7eb;">
      <p style="margin:0;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:#9ca3af;">Billing Breakdown</p>
    </div>
    <div style="padding:10px 16px;">
      <table style="width:100%;border-collapse:collapse;">
        <tr>
          <td style="padding:5px 0;color:#4b5563;font-size:13px;">Package charge (${packageName})</td>
          <td style="padding:5px 0;text-align:right;font-weight:600;color:#1f2937;font-size:13px;">PKR ${originalPackagePrice.toLocaleString()}</td>
        </tr>
        ${discountRow}
        ${materialRows}
        ${prevBalanceRow}
        <tr style="border-top:1px solid #e5e7eb;">
          <td style="padding-top:10px;font-weight:700;color:#1f2937;font-size:14px;">Total Due</td>
          <td style="padding-top:10px;text-align:right;font-weight:900;color:#111827;font-size:16px;">PKR ${totalAmount.toLocaleString()}</td>
        </tr>
      </table>
    </div>
  </div>

  ${installmentsSection}
  ${statusBar}

  <div style="margin-top:28px;padding-top:12px;border-top:1px solid #e5e7eb;text-align:center;">
    <p style="font-size:10px;color:#9ca3af;">Galaxy ISP · Thank you for your business</p>
    <p style="font-size:10px;color:#d1d5db;margin-top:3px;">Computer-generated invoice — no signature required.</p>
  </div>
</body></html>`;
}

function printInvoice(htmlString) {
  const tab = window.open("", "_blank");
  if (!tab) {
    alert("Please allow pop-ups for this site to enable printing.");
    return;
  }
  tab.document.open();
  tab.document.write(htmlString);
  tab.document.close();
  tab.onload = () => {
    tab.focus();
    tab.print();
    tab.onafterprint = () => tab.close();
  };
}

// ── Main component ─────────────────────────────────────────────────────────────
export default function InvoiceModal({
  isOpen,
  onClose,
  customer,
  cycle,
  packageName,
}) {
  const invoiceRef = useRef(null);

  if (!isOpen || !customer || !cycle) return null;

  const scenario = getScenario(cycle);
  const scenarioMeta = SCENARIO_LABELS[scenario];
  const invNo = invoiceNumber(cycle);

  // Pull breakdown metadata saved by NewConnectionForm (if any)
  const bd = cycle.breakdown || {};

  // originalPackagePrice:
  //   - from breakdown (new connection with discount) → bd.originalPackagePrice
  //   - from renewal  → cycle.totalAmount - previousBalance
  //   - fallback      → cycle.totalAmount
  const previousBalance = Number(cycle.previousBalance || 0);
  const originalPackagePrice =
    bd.originalPackagePrice != null
      ? Number(bd.originalPackagePrice)
      : Number(cycle.totalAmount) - previousBalance;

  const discountAmt = Number(bd.discountAmt || 0);
  const effectivePkgPrice = Number(
    bd.effectivePkgPrice != null
      ? bd.effectivePkgPrice
      : originalPackagePrice - discountAmt,
  );
  const materialTotal = Number(bd.materialTotal || 0);

  // Build a human-readable discount label
  let discountLabel = "";
  if (bd.discountType === "percent" && bd.discountValue > 0)
    discountLabel = `${bd.discountValue}%`;
  else if (bd.discountType === "amount" && bd.discountValue > 0)
    discountLabel = `PKR ${Number(bd.discountValue).toLocaleString()} off`;

  const totalAmount = Number(cycle.totalAmount);
  const amountPaid = Number(cycle.amountPaid || 0);
  const amountPending = Number(cycle.amountPending || 0);
  const installments = cycle.installments || [];

  const isCarriedForward = Number(cycle.shiftedAmount) > 0;
  const isPaid = amountPending === 0 && !isCarriedForward;

  // Material line items (stored in connection job — not on cycle directly,
  // but breakdown.materialItems may be stored if we add it later; graceful fallback)
  const materialItems = bd.materialItems || [];

  const invoiceProps = {
    invNo,
    scenarioMeta,
    customer,
    cycle,
    packageName,
    originalPackagePrice,
    discountAmt,
    discountLabel,
    effectivePkgPrice,
    materialTotal,
    materialItems,
    previousBalance,
    totalAmount,
    amountPaid,
    amountPending,
    installments,
  };

  const handlePrint = () => printInvoice(buildInvoiceHTML(invoiceProps));
  const handleSavePng = () => {
    toPng(invoiceRef.current, { pixelRatio: 3 }).then((dataUrl) => {
      const link = document.createElement("a");
      link.download = `${invNo}.png`;
      link.href = dataUrl;
      link.click();
    });
  };

  return (
    <div
      className="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
      onClick={(e) => {
        if (e.target === e.currentTarget) onClose();
      }}
    >
      <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 max-h-[92vh] flex flex-col">
        {/* Header */}
        <div className="flex items-center justify-between px-5 py-3 border-b border-gray-200 shrink-0">
          <h2 className="text-sm font-semibold text-gray-700">
            Invoice Preview
          </h2>
          <div className="flex items-center gap-2">
            <button
              onClick={handleSavePng}
              className="flex items-center gap-1.5 px-3 py-1.5 text-xs font-semibold bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
            >
              <ImageDown size={13} /> Save PNG
            </button>
            <button
              onClick={handlePrint}
              className="flex items-center gap-1.5 px-3 py-1.5 text-xs font-semibold bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
            >
              <Printer size={13} /> Print / Save PDF
            </button>
            <button
              onClick={onClose}
              className="text-gray-400 hover:text-gray-600 p-1 rounded"
            >
              <X size={16} />
            </button>
          </div>
        </div>

        {/* Scrollable preview */}
        <div className="overflow-y-auto flex-1 p-5">
          <div
            ref={invoiceRef}
            className="bg-white p-6 font-sans text-gray-800 text-sm"
          >
            {/* Header */}
            <div className="flex items-start justify-between mb-5 pb-4 border-b-2 border-gray-800">
              <div>
                <div className="flex items-center gap-2 mb-1">
                  <Wifi size={20} className="text-blue-600" />
                  <span className="text-xl font-black text-gray-900 tracking-tight">
                    Galaxy ISP
                  </span>
                </div>
                <p className="text-xs text-gray-500">
                  Internet Service Provider
                </p>
              </div>
              <div className="text-right">
                <p className="text-[10px] font-bold uppercase text-gray-400 tracking-widest mb-0.5">
                  Invoice
                </p>
                <p className="text-base font-black text-gray-900">{invNo}</p>
                <p className="text-xs text-gray-500 mt-0.5">
                  Issued: {formatDate(cycle.cycleStartDate)}
                </p>
              </div>
            </div>

            {/* Scenario badge */}
            <div
              className="inline-flex items-center gap-1.5 rounded-lg px-3 py-1.5 mb-4 border text-xs font-semibold"
              style={{
                background: scenarioMeta.bg,
                borderColor: scenarioMeta.border,
                color: scenarioMeta.color,
              }}
            >
              {scenario === "new" && <Wifi size={12} />}
              {scenario === "renewal_clean" && <CheckCircle2 size={12} />}
              {scenario === "renewal_with_dues" && (
                <CornerDownRight size={12} />
              )}
              {scenarioMeta.label}
            </div>

            {/* Subscriber info */}
            <div className="grid grid-cols-2 gap-x-6 gap-y-3 mb-5 text-xs">
              <div>
                <p className="text-[10px] font-bold uppercase text-gray-400 tracking-wide mb-0.5">
                  Subscriber
                </p>
                <p className="font-bold text-gray-900 text-sm">
                  {customer.fullName}
                </p>
                <p className="text-gray-500">{customer.userName}</p>
              </div>
              <div>
                <p className="text-[10px] font-bold uppercase text-gray-400 tracking-wide mb-0.5">
                  Contact
                </p>
                <p className="text-gray-700">{customer.mobileNo || "—"}</p>
                <p className="text-gray-500">{customer.mainArea || "—"}</p>
              </div>
              <div>
                <p className="text-[10px] font-bold uppercase text-gray-400 tracking-wide mb-0.5">
                  Package
                </p>
                <p className="text-gray-700 font-medium">
                  {packageName || "—"}
                </p>
              </div>
              <div>
                <p className="text-[10px] font-bold uppercase text-gray-400 tracking-wide mb-0.5">
                  Billing Period
                </p>
                <p className="text-gray-700">
                  {formatDate(cycle.cycleStartDate)} →{" "}
                  {formatDate(cycle.cycleEndDate)}
                </p>
              </div>
            </div>

            {/* Billing Breakdown */}
            <div className="border border-gray-200 rounded-xl overflow-hidden mb-4">
              <div className="bg-gray-50 px-4 py-2 border-b border-gray-200">
                <p className="text-[10px] font-bold uppercase text-gray-400 tracking-widest">
                  Billing Breakdown
                </p>
              </div>
              <div className="px-4 py-3 space-y-2">
                {/* Package line */}
                <div className="flex justify-between items-center text-sm">
                  <span className="text-gray-600">
                    Package charge ({packageName})
                  </span>
                  <span className="font-semibold text-gray-800">
                    PKR {originalPackagePrice.toLocaleString()}
                  </span>
                </div>

                {/* Discount line */}
                {discountAmt > 0 && (
                  <div className="flex justify-between items-center text-sm">
                    <span className="text-green-700 flex items-center gap-1.5">
                      <Tag size={12} className="shrink-0" />
                      Discount{discountLabel ? ` (${discountLabel})` : ""}
                    </span>
                    <span className="font-semibold text-green-700">
                      − PKR {discountAmt.toLocaleString()}
                    </span>
                  </div>
                )}

                {/* Material / Equipment */}
                {materialTotal > 0 && (
                  <>
                    <div className="flex justify-between items-center text-sm">
                      <span className="text-amber-700 flex items-center gap-1.5">
                        <Package size={12} className="shrink-0" />
                        Material / Equipment
                      </span>
                      <span className="font-semibold text-amber-700">
                        + PKR {materialTotal.toLocaleString()}
                      </span>
                    </div>
                    {materialItems.length > 0 && (
                      <div className="pl-5 space-y-1">
                        {materialItems.map((it, i) => (
                          <div
                            key={i}
                            className="flex justify-between text-xs text-gray-400"
                          >
                            <span>
                              {it.description} × {it.qty} {it.unit}
                            </span>
                            <span>PKR {it.totalValue.toLocaleString()}</span>
                          </div>
                        ))}
                      </div>
                    )}
                  </>
                )}

                {/* Previous balance */}
                {previousBalance > 0 && (
                  <div className="flex justify-between items-center text-sm">
                    <span className="text-orange-600 flex items-center gap-1.5">
                      <CornerDownRight size={12} /> Previous unpaid balance
                    </span>
                    <span className="font-semibold text-orange-700">
                      + PKR {previousBalance.toLocaleString()}
                    </span>
                  </div>
                )}

                {/* Total */}
                <div className="border-t border-gray-200 pt-2 flex justify-between items-center">
                  <span className="font-bold text-gray-800">Total Due</span>
                  <span className="font-black text-gray-900 text-base">
                    PKR {totalAmount.toLocaleString()}
                  </span>
                </div>
              </div>
            </div>

            {/* Payments received */}
            {installments.length > 0 && (
              <div className="border border-gray-200 rounded-xl overflow-hidden mb-4">
                <div className="bg-gray-50 px-4 py-2 border-b border-gray-200">
                  <p className="text-[10px] font-bold uppercase text-gray-400 tracking-widest">
                    Payments Received
                  </p>
                </div>
                <div className="px-4 py-3 space-y-2">
                  {installments.map((inst, i) => (
                    <div
                      key={inst.id || i}
                      className="flex justify-between items-center text-sm"
                    >
                      <div className="flex items-center gap-2">
                        <CheckCircle2
                          size={13}
                          className="text-green-500 shrink-0"
                        />
                        <span className="text-gray-600">
                          {formatDate(inst.datePaid)}
                          {inst.note && (
                            <span className="text-gray-400 ml-1">
                              · {inst.note}
                            </span>
                          )}
                        </span>
                      </div>
                      <span className="font-semibold text-green-700">
                        PKR {Number(inst.amountPaid).toLocaleString()}
                      </span>
                    </div>
                  ))}
                  <div className="border-t border-gray-100 pt-2 flex justify-between text-sm">
                    <span className="font-semibold text-gray-700">
                      Total Paid
                    </span>
                    <span className="font-bold text-green-700">
                      PKR {amountPaid.toLocaleString()}
                    </span>
                  </div>
                </div>
              </div>
            )}

            {/* Status */}
            {isCarriedForward ? (
              <div className="flex items-center justify-between bg-orange-50 border border-orange-200 rounded-xl px-4 py-3">
                <div className="flex items-center gap-3">
                  <CornerDownRight
                    size={20}
                    className="text-orange-500 shrink-0"
                  />
                  <div>
                    <p className="font-bold text-orange-800 text-sm">
                      Unpaid — Carried Forward
                    </p>
                    <p className="text-xs text-orange-600">
                      PKR {Number(cycle.shiftedAmount).toLocaleString()} moved
                      to next cycle.
                    </p>
                  </div>
                </div>
                <p className="font-black text-orange-700 text-lg">
                  PKR {Number(cycle.shiftedAmount).toLocaleString()}
                </p>
              </div>
            ) : isPaid ? (
              <div className="flex items-center gap-3 bg-green-50 border border-green-200 rounded-xl px-4 py-3">
                <CheckCircle2 size={20} className="text-green-600 shrink-0" />
                <div>
                  <p className="font-bold text-green-800 text-sm">
                    Paid in Full
                  </p>
                  <p className="text-xs text-green-600">
                    No outstanding balance. Thank you!
                  </p>
                </div>
              </div>
            ) : (
              <div className="flex items-center justify-between bg-red-50 border border-red-200 rounded-xl px-4 py-3">
                <div className="flex items-center gap-3">
                  <AlertCircle size={20} className="text-red-500 shrink-0" />
                  <div>
                    <p className="font-bold text-red-800 text-sm">
                      Balance Due
                    </p>
                    <p className="text-xs text-red-600">
                      Please pay at your earliest convenience.
                    </p>
                  </div>
                </div>
                <p className="font-black text-red-700 text-lg">
                  PKR {amountPending.toLocaleString()}
                </p>
              </div>
            )}

            {/* Footer */}
            <div className="mt-5 pt-3 border-t border-gray-200 text-center text-[10px] text-gray-400">
              <p>Galaxy ISP · Thank you for your business</p>
              <p className="mt-0.5">
                Computer-generated invoice — no signature required.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/components/ui/Issuehistorymodal.jsx">
import {
  ArrowUpCircle,
  User,
  FileText,
  Calendar,
  Package,
  Inbox,
  DollarSign,
} from "lucide-react";
import { formatDate } from "../../utils/dateUtils";

/**
 * IssueHistoryModal
 * Displays a timeline of all stock issue events for a single inventory item.
 * Now shows per-unit price and total value per issue.
 *
 * Props:
 *  item    – the inventory item object
 *  onClose – callback to close
 */
export default function IssueHistoryModal({ item, onClose }) {
  const log = Array.isArray(item.issueLog) ? [...item.issueLog].reverse() : [];
  const totalIssued = log.reduce((sum, e) => sum + (e.qty || 0), 0);
  const totalIssuedValue = log.reduce(
    (sum, e) =>
      sum + (e.totalValue || (e.qty || 0) * (e.unitRate || item.unitRate || 0)),
    0,
  );

  return (
    <div className="space-y-4">
      {/* ── Item summary bar ── */}
      <div className="bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 flex items-center justify-between gap-4">
        <div className="flex items-center gap-2.5">
          <Package size={16} className="text-gray-500" />
          <div>
            <p className="font-bold text-gray-900">{item.description}</p>
            <p className="text-xs text-gray-500 mt-0.5">
              Unit:{" "}
              <span className="font-semibold text-gray-700">{item.unit}</span>
            </p>
          </div>
        </div>
        <div className="flex items-center gap-5 text-center">
          <div>
            <p className="text-xs text-gray-400 font-medium">Total Issued</p>
            <p className="text-lg font-black text-red-500">
              {item.stockOut || 0}
            </p>
          </div>
          <div>
            <p className="text-xs text-gray-400 font-medium">Total Value</p>
            <p className="text-base font-black text-orange-600">
              PKR {totalIssuedValue.toLocaleString()}
            </p>
          </div>
          <div>
            <p className="text-xs text-gray-400 font-medium">In Hand</p>
            <p
              className={`text-lg font-black ${(item.inHand ?? 0) === 0 ? "text-red-500" : "text-green-600"}`}
            >
              {item.inHand ?? 0}
            </p>
          </div>
          <div>
            <p className="text-xs text-gray-400 font-medium">Events</p>
            <p className="text-lg font-black text-gray-700">{log.length}</p>
          </div>
        </div>
      </div>

      {/* ── Timeline ── */}
      {log.length === 0 ? (
        <div className="flex flex-col items-center gap-3 py-10 text-center">
          <div className="w-12 h-12 rounded-full bg-gray-100 flex items-center justify-center">
            <Inbox size={22} className="text-gray-400" />
          </div>
          <p className="font-semibold text-gray-500">No issue history yet</p>
          <p className="text-xs text-gray-400">
            Use the <strong>Issue</strong> button to record stock being given
            out.
          </p>
        </div>
      ) : (
        <div className="relative">
          {/* vertical line */}
          <div className="absolute left-4.75 top-0 bottom-0 w-px bg-gray-200" />

          <div className="space-y-3">
            {log.map((entry, idx) => {
              const entryRate = entry.unitRate || item.unitRate || 0;
              const entryValue =
                entry.totalValue || (entry.qty || 0) * entryRate;
              return (
                <div key={idx} className="flex gap-3 relative">
                  {/* dot */}
                  <div className="shrink-0 w-10 flex justify-center pt-1">
                    <div className="w-5 h-5 rounded-full bg-red-100 border-2 border-red-400 flex items-center justify-center z-10">
                      <ArrowUpCircle size={10} className="text-red-500" />
                    </div>
                  </div>

                  {/* card */}
                  <div className="flex-1 bg-white border border-gray-200 rounded-xl px-4 py-3 shadow-sm mb-1">
                    <div className="flex items-start justify-between gap-2 flex-wrap">
                      {/* qty badge + value */}
                      <div className="flex items-center gap-2 flex-wrap">
                        <span className="bg-red-50 border border-red-200 text-red-700 text-sm font-black px-2.5 py-0.5 rounded-lg">
                          − {entry.qty} {item.unit}
                        </span>
                        <span className="bg-orange-50 border border-orange-200 text-orange-700 text-xs font-semibold px-2 py-0.5 rounded-lg">
                          PKR {entryValue.toLocaleString()}
                        </span>
                        {idx === 0 && (
                          <span className="text-xs bg-blue-50 border border-blue-200 text-blue-600 font-semibold px-2 py-0.5 rounded-full">
                            Latest
                          </span>
                        )}
                      </div>
                      {/* date */}
                      <span className="flex items-center gap-1 text-xs text-gray-400 font-medium whitespace-nowrap">
                        <Calendar size={11} />
                        {formatDate(entry.date)}
                      </span>
                    </div>

                    {/* Rate row */}
                    <div className="flex items-center gap-1.5 text-xs text-gray-500 mt-2">
                      <DollarSign size={11} className="text-gray-400" />
                      <span>
                        PKR {entryRate.toLocaleString()} per {item.unit}
                        {entryRate !== item.unitRate && (
                          <span className="ml-1 text-amber-600 font-semibold">
                            (custom rate)
                          </span>
                        )}
                      </span>
                    </div>

                    {/* Technician */}
                    {entry.issuedTo && (
                      <p className="flex items-center gap-1.5 text-sm text-gray-700 font-medium mt-1.5">
                        <User size={12} className="text-gray-400 shrink-0" />
                        Technician: {entry.issuedTo}
                      </p>
                    )}

                    {/* Subscriber */}
                    {entry.subscriberName && (
                      <p className="flex items-center gap-1.5 text-sm text-gray-700 font-medium mt-1">
                        <User size={12} className="text-blue-400 shrink-0" />
                        Subscriber: {entry.subscriberName}
                      </p>
                    )}

                    {/* note */}
                    {entry.note && (
                      <p className="flex items-start gap-1.5 text-xs text-gray-500 mt-1.5 leading-relaxed">
                        <FileText
                          size={11}
                          className="text-gray-400 shrink-0 mt-0.5"
                        />
                        {entry.note}
                      </p>
                    )}

                    {/* running balance */}
                    <p className="text-xs text-gray-400 mt-2 border-t border-gray-100 pt-1.5">
                      Balance after this issue:{" "}
                      <span className="font-semibold text-gray-600">
                        {entry.balanceAfter} {item.unit}
                      </span>
                    </p>
                  </div>
                </div>
              );
            })}
          </div>

          {/* ── Total summary at bottom ── */}
          {log.length > 1 && (
            <div className="ml-10 mt-2 bg-gray-50 border border-gray-200 rounded-xl px-4 py-2.5 space-y-1">
              <div className="flex items-center justify-between text-sm">
                <span className="text-gray-500 font-medium">
                  Total issued across all {log.length} events
                </span>
                <span className="font-bold text-red-600">
                  {totalIssued} {item.unit}
                </span>
              </div>
              <div className="flex items-center justify-between text-sm">
                <span className="text-gray-500 font-medium">
                  Total issued value
                </span>
                <span className="font-bold text-orange-600">
                  PKR {totalIssuedValue.toLocaleString()}
                </span>
              </div>
            </div>
          )}
        </div>
      )}

      {/* ── Close ── */}
      <div className="flex justify-end pt-1 border-t border-gray-100">
        <button
          onClick={onClose}
          className="px-5 py-2 text-sm font-medium border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors"
        >
          Close
        </button>
      </div>
    </div>
  );
}
</file>

<file path="src/components/ui/IssueStockModal.jsx">
import { useState } from "react";
import {
  ArrowUpCircle,
  Warehouse,
  User,
  FileText,
  AlertTriangle,
  CheckCircle,
  History,
  DollarSign,
  TrendingDown,
} from "lucide-react";
import useInventoryStore from "../../store/useInventoryStore";
import { today } from "../../utils/dateUtils";

/**
 * IssueStockModal
 * A focused modal for issuing stock out of a specific inventory item.
 * Supports custom per-unit price override (defaults to item's recorded rate).
 * Writes structured entries to item.issueLog (array) for full history tracking.
 *
 * Props:
 *  item          – the inventory item object (required)
 *  onClose       – callback to close the modal
 *  onViewHistory – optional callback to open the history modal
 */
export default function IssueStockModal({ item, onClose, onViewHistory }) {
  const updateItem = useInventoryStore((s) => s.updateItem);

  const [qty, setQty] = useState("");
  const [issuedTo, setIssuedTo] = useState("");
  const [subscriberName, setSubscriberName] = useState("");
  const [note, setNote] = useState("");
  const [date, setDate] = useState(today());
  const [customRate, setCustomRate] = useState(String(item.unitRate || ""));
  const [error, setError] = useState("");
  const [saving, setSaving] = useState(false);
  const [done, setDone] = useState(false);

  const currentInHand = item.inHand ?? 0;
  const issueQty = Number(qty) || 0;
  const effectiveRate = Number(customRate) || item.unitRate || 0;
  const remaining = currentInHand - issueQty;
  const totalIssueValue = issueQty * effectiveRate;

  const stockAfterPercent =
    item.quantity > 0 ? Math.max(0, (remaining / item.quantity) * 100) : 0;

  const barColor =
    remaining <= 0
      ? "bg-red-500"
      : stockAfterPercent <= 20
        ? "bg-amber-400"
        : "bg-green-500";

  const statusLabel =
    remaining < 0
      ? "Over-issuing!"
      : remaining === 0
        ? "Stock will be empty"
        : stockAfterPercent <= 20
          ? "Low stock after issue"
          : "Stock OK";

  const statusColor =
    remaining < 0
      ? "text-red-600"
      : remaining === 0
        ? "text-amber-600"
        : stockAfterPercent <= 20
          ? "text-amber-500"
          : "text-green-600";

  const existingLog = Array.isArray(item.issueLog) ? item.issueLog : [];
  const historyCount = existingLog.length;

  const handleSubmit = async () => {
    setError("");
    if (!issueQty || issueQty <= 0) {
      setError("Enter a quantity greater than 0.");
      return;
    }
    if (issueQty > currentInHand) {
      setError(
        `Only ${currentInHand} ${item.unit}(s) available in hand. Cannot issue more.`,
      );
      return;
    }
    if (!effectiveRate || effectiveRate <= 0) {
      setError("Per-unit price must be greater than 0.");
      return;
    }

    setSaving(true);
    try {
      const newStockOut = (item.stockOut || 0) + issueQty;
      const newInHand = (item.stockIn || 0) - newStockOut;

      // Build structured log entry — now includes rate & total value
      const logEntry = {
        date,
        qty: issueQty,
        unitRate: effectiveRate,
        totalValue: issueQty * effectiveRate,
        issuedTo: issuedTo.trim() || null,
        subscriberName: subscriberName.trim() || null,
        note: note.trim() || null,
        balanceAfter: newInHand,
        createdAt: new Date().toISOString(),
      };

      await updateItem(item.id, {
        ...item,
        stockOut: newStockOut,
        inHand: newInHand,
        balanced: newInHand,
        issued: newStockOut,
        issueLog: [...existingLog, logEntry],
      });
      setDone(true);
    } catch (err) {
      setError("Failed to issue stock: " + err.message);
    }
    setSaving(false);
  };

  // ── Success State ──
  if (done) {
    return (
      <div className="flex flex-col items-center gap-4 py-6 text-center">
        <div className="w-14 h-14 rounded-full bg-green-100 flex items-center justify-center">
          <CheckCircle size={28} className="text-green-600" />
        </div>
        <div>
          <p className="text-base font-bold text-gray-900">Stock Issued!</p>
          <p className="text-sm text-gray-500 mt-1">
            <span className="font-semibold text-red-500">
              {issueQty} {item.unit}
            </span>{" "}
            of <span className="font-semibold">{item.description}</span> issued
            successfully.
            <br />
            <span className="text-gray-400">
              Total value:{" "}
              <span className="font-semibold text-gray-700">
                PKR {totalIssueValue.toLocaleString()}
              </span>
            </span>
            <br />
            <span className="text-gray-400">
              Remaining in hand:{" "}
              <span className="font-semibold text-gray-600">
                {remaining} {item.unit}
              </span>
            </span>
          </p>
        </div>
        <div className="flex gap-3 mt-1">
          {onViewHistory && (
            <button
              onClick={() => {
                onClose();
                onViewHistory();
              }}
              className="flex items-center gap-1.5 px-4 py-2 text-sm font-semibold border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors"
            >
              <History size={14} /> View History
            </button>
          )}
          <button
            onClick={onClose}
            className="px-6 py-2 bg-gray-900 text-white text-sm font-semibold rounded-lg hover:bg-gray-700 transition-colors"
          >
            Close
          </button>
        </div>
      </div>
    );
  }

  // ── Form State ──
  return (
    <div className="space-y-5">
      {/* ── Item Info Banner ── */}
      <div className="bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 flex items-center justify-between gap-4">
        <div>
          <p className="text-xs text-gray-400 font-medium uppercase tracking-wide mb-0.5">
            Item
          </p>
          <p className="font-bold text-gray-900 text-base">
            {item.description}
          </p>
          <p className="text-xs text-gray-500 mt-0.5">
            Unit:{" "}
            <span className="font-semibold text-gray-700">{item.unit}</span>
            {" · "}
            <span className="text-gray-400">
              Recorded rate: PKR {(item.unitRate || 0).toLocaleString()}
            </span>
          </p>
        </div>
        <div className="flex items-end gap-4">
          {/* History badge */}
          {historyCount > 0 && onViewHistory && (
            <button
              onClick={() => {
                onClose();
                onViewHistory();
              }}
              className="flex items-center gap-1.5 text-xs font-semibold text-blue-600 hover:text-blue-800 transition-colors"
            >
              <History size={13} />
              {historyCount} issue{historyCount !== 1 ? "s" : ""} logged
            </button>
          )}
          <div className="text-right shrink-0">
            <p className="text-xs text-gray-400 font-medium uppercase tracking-wide mb-0.5">
              Available In Hand
            </p>
            <p
              className={`text-2xl font-black leading-tight ${
                currentInHand === 0 ? "text-red-500" : "text-green-600"
              }`}
            >
              {currentInHand}
            </p>
            <p className="text-xs text-gray-400">{item.unit}(s)</p>
          </div>
        </div>
      </div>

      {/* ── Out-of-stock warning ── */}
      {currentInHand === 0 && (
        <div className="flex items-center gap-2 bg-red-50 border border-red-200 rounded-lg px-3 py-2.5 text-sm text-red-700 font-medium">
          <AlertTriangle size={14} className="shrink-0" />
          This item is out of stock. No units can be issued.
        </div>
      )}

      {/* ── Qty + Date + Per Unit Price row ── */}
      <div className="grid grid-cols-2 gap-3">
        <div>
          <label className="block text-xs font-bold text-gray-600 mb-1.5">
            Quantity to Issue <span className="text-red-500">*</span>
          </label>
          <input
            type="number"
            min="1"
            max={currentInHand}
            disabled={currentInHand === 0}
            className={`w-full border rounded-lg px-3 h-10 text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all disabled:bg-gray-100 disabled:cursor-not-allowed ${
              error && (!issueQty || issueQty > currentInHand)
                ? "border-red-400 bg-red-50"
                : "border-gray-300"
            }`}
            placeholder={`Max: ${currentInHand}`}
            value={qty}
            onChange={(e) => {
              setQty(e.target.value);
              setError("");
            }}
            autoFocus
          />
        </div>
        <div>
          <label className="block text-xs font-bold text-gray-600 mb-1.5">
            Date <span className="text-red-500">*</span>
          </label>
          <input
            type="date"
            max={today()}
            className="w-full border border-gray-300 rounded-lg px-3 h-10 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
            value={date}
            onChange={(e) => setDate(e.target.value)}
          />
        </div>

        {/* Per Unit Price — full width */}
        <div className="col-span-2">
          <label className="block text-xs font-bold text-gray-600 mb-1.5">
            <span className="flex items-center gap-1.5">
              <DollarSign size={12} /> Per Unit Price (PKR){" "}
              <span className="text-red-500">*</span>
              <span className="font-normal text-gray-400">
                — default is recorded purchase rate
              </span>
            </span>
          </label>
          <div className="relative">
            <span className="absolute left-3 top-1/2 -translate-y-1/2 text-xs text-gray-400 font-semibold pointer-events-none">
              PKR
            </span>
            <input
              type="number"
              min="0"
              className="w-full border border-gray-300 rounded-lg pl-12 pr-3 h-10 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
              value={customRate}
              placeholder={`Default: ${item.unitRate || 0}`}
              onChange={(e) => {
                setCustomRate(e.target.value);
                setError("");
              }}
            />
          </div>
          {Number(customRate) !== item.unitRate && item.unitRate > 0 && (
            <p className="text-xs text-amber-600 font-medium mt-1 flex items-center gap-1">
              <AlertTriangle size={11} />
              Rate changed from recorded PKR {item.unitRate?.toLocaleString()} —
              this only affects this issue entry, not the item record.
            </p>
          )}
        </div>
      </div>

      {/* ── Live Stock + Value Preview ── */}
      {issueQty > 0 && effectiveRate > 0 && (
        <div className="bg-white border border-gray-200 rounded-xl px-4 py-3 space-y-2">
          <div className="flex items-center justify-between text-xs font-semibold text-gray-500 uppercase tracking-wide">
            <span>Stock After Issuing</span>
            <span className={statusColor}>{statusLabel}</span>
          </div>
          <div className="flex items-center justify-between text-sm font-bold">
            <span className="text-gray-600">
              {currentInHand} →{" "}
              <span
                className={remaining < 0 ? "text-red-600" : "text-gray-900"}
              >
                {remaining}
              </span>{" "}
              <span className="font-normal text-gray-400">{item.unit}(s)</span>
            </span>
            <span className="text-xs text-gray-400">
              of {item.quantity} total
            </span>
          </div>
          <div className="h-2 bg-gray-100 rounded-full overflow-hidden">
            <div
              className={`h-full rounded-full transition-all duration-300 ${barColor}`}
              style={{
                width: `${Math.max(0, Math.min(100, stockAfterPercent))}%`,
              }}
            />
          </div>
          {/* Total value of this issue */}
          <div className="flex items-center justify-between pt-1 border-t border-gray-100">
            <span className="flex items-center gap-1.5 text-xs text-gray-500 font-medium">
              <TrendingDown size={12} className="text-red-500" />
              Total value of this issue
            </span>
            <span className="text-sm font-bold text-red-600">
              PKR {totalIssueValue.toLocaleString()}
            </span>
          </div>
        </div>
      )}

      {/* ── Issued To (Technician) ── */}
      <div className="grid grid-cols-2 gap-3">
        <div>
          <label className="block text-xs font-bold text-gray-600 mb-1.5">
            <span className="flex items-center gap-1.5">
              <User size={12} /> Technician Name
              <span className="font-normal text-gray-400">(optional)</span>
            </span>
          </label>
          <input
            className="w-full border border-gray-300 rounded-lg px-3 h-10 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
            placeholder="e.g. Ali Technician"
            value={issuedTo}
            onChange={(e) => setIssuedTo(e.target.value)}
          />
        </div>
        <div>
          <label className="block text-xs font-bold text-gray-600 mb-1.5">
            <span className="flex items-center gap-1.5">
              <User size={12} /> Subscriber Name
              <span className="font-normal text-gray-400">(optional)</span>
            </span>
          </label>
          <input
            className="w-full border border-gray-300 rounded-lg px-3 h-10 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
            placeholder="e.g. Ahmed Ali (customer)"
            value={subscriberName}
            onChange={(e) => setSubscriberName(e.target.value)}
          />
        </div>
      </div>

      {/* ── Note ── */}
      <div>
        <label className="block text-xs font-bold text-gray-600 mb-1.5">
          <span className="flex items-center gap-1.5">
            <FileText size={12} /> Note
            <span className="font-normal text-gray-400">(optional)</span>
          </span>
        </label>
        <input
          className="w-full border border-gray-300 rounded-lg px-3 h-10 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
          placeholder="e.g. New connection at Gulshan, fiber repair..."
          value={note}
          onChange={(e) => setNote(e.target.value)}
        />
      </div>

      {/* ── Error ── */}
      {error && (
        <div className="flex items-center gap-2 bg-red-50 border border-red-200 rounded-lg px-3 py-2.5 text-sm text-red-700 font-medium">
          <AlertTriangle size={14} className="shrink-0" />
          {error}
        </div>
      )}

      {/* ── Actions ── */}
      <div className="flex justify-end gap-3 pt-1 border-t border-gray-100">
        <button
          onClick={onClose}
          className="px-5 py-2 text-sm font-medium border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors"
        >
          Cancel
        </button>
        <button
          onClick={handleSubmit}
          disabled={saving || currentInHand === 0}
          className="flex items-center gap-2 px-6 py-2 text-sm font-semibold bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-40 disabled:cursor-not-allowed transition-colors shadow-sm"
        >
          {saving ? (
            "Issuing..."
          ) : (
            <>
              <ArrowUpCircle size={15} />
              Issue{" "}
              {issueQty > 0
                ? `${issueQty} ${item.unit} · PKR ${totalIssueValue.toLocaleString()}`
                : "Stock"}
            </>
          )}
        </button>
      </div>
    </div>
  );
}
</file>

<file path="src/utils/dateUtils.js">
// src/utils/dateUtils.js

// ─── Core constant ────────────────────────────────────────────────────────────
// A billing cycle is exactly 30 days inclusive of both start and end date.
// That means: endDate = startDate + 29 days.
//
// Why 29 and not 30?
//   Day 1  = startDate         (e.g. 28-Feb)
//   Day 30 = startDate + 29    (e.g. 29-Mar)
//   startDate + 30 would be Day 31 — one day too many.
//
// This constant is used by the payment store wherever it creates cycles.
// Never hard-code 29 or 30 directly — always use this.
export const CYCLE_LENGTH_DAYS = 29; // offset to add to startDate to get endDate

// ─── addDays ─────────────────────────────────────────────────────────────────
// Adds `days` to a YYYY-MM-DD string and returns a new YYYY-MM-DD string.
//
// Implementation notes:
//   • We parse year/month/day manually to avoid any timezone shifting that
//     `new Date(dateStr)` can cause (it parses ISO strings as UTC midnight,
//     but `new Date(y, m, d)` uses LOCAL midnight — mixing the two is a bug).
//   • We always construct dates with `new Date(y, m - 1, d)` (local).
//   • JavaScript's Date handles month/year rollovers automatically:
//       new Date(2026, 1, 28 + 1) → 1 Mar 2026  ✓  (Feb has 28 days in 2026)
//       new Date(2024, 1, 28 + 1) → 29 Feb 2024 ✓  (2024 is a leap year)
//       new Date(2026, 11, 31 + 1)→ 1 Jan 2027  ✓  (Dec → Jan rollover)
//   • `days` may be negative (used for "go back N days").
export const addDays = (dateStr, days) => {
  const [y, m, d] = dateStr.split("-").map(Number);
  const date = new Date(y, m - 1, d + days); // JS handles overflow/underflow
  return _toYMD(date);
};

// ─── formatDate ──────────────────────────────────────────────────────────────
// Returns a human-readable date like "27-Feb-2026".
// Always parses as local midnight (y, m-1, d) to avoid UTC-offset surprises.
export const formatDate = (dateStr) => {
  if (!dateStr) return "-";
  const raw = dateStr.split("T")[0]; // strip any time component
  const [y, m, d] = raw.split("-").map(Number);
  if (!y || !m || !d) return "-";
  const date = new Date(y, m - 1, d);
  if (isNaN(date.getTime())) return "-";
  return date
    .toLocaleDateString("en-PK", {
      day: "2-digit",
      month: "short",
      year: "numeric",
    })
    .replace(/\//g, "-");
};

// ─── today ───────────────────────────────────────────────────────────────────
// Returns today's local date as YYYY-MM-DD.
// Uses local getFullYear/getMonth/getDate — never UTC — so it matches the
// machine's wall-clock date regardless of timezone.
export const today = () => {
  return _toYMD(new Date());
};

// ─── daysUntil ───────────────────────────────────────────────────────────────
// Returns how many days from today until `dateStr` (negative = past).
// Both dates are normalised to local midnight so partial-day offsets don't
// affect the result.
export const daysUntil = (dateStr) => {
  if (!dateStr) return 0;
  const raw = dateStr.split("T")[0];
  const [y, m, d] = raw.split("-").map(Number);
  const target = new Date(y, m - 1, d); // local midnight on target date
  const now = new Date();
  now.setHours(0, 0, 0, 0); // local midnight today
  return Math.round((target - now) / (1000 * 60 * 60 * 24));
};

// ─── daysSince ───────────────────────────────────────────────────────────────
// Inverse of daysUntil: positive = date is in the past.
export const daysSince = (dateStr) => -daysUntil(dateStr);

// ─── Internal helper ──────────────────────────────────────────────────────────
// Converts a local Date object to a zero-padded YYYY-MM-DD string.
function _toYMD(date) {
  const yy = date.getFullYear();
  const mm = String(date.getMonth() + 1).padStart(2, "0");
  const dd = String(date.getDate()).padStart(2, "0");
  return `${yy}-${mm}-${dd}`;
}
</file>

<file path="src/pages/Inventory/InventoryForm.jsx">
import { useState, useEffect } from "react";
import { today } from "../../utils/dateUtils";
import useInventoryStore from "../../store/useInventoryStore";
import {
  Package,
  FileText,
  Calculator,
  ArrowDownCircle,
  ArrowUpCircle,
  Warehouse,
  CheckCircle,
  AlertTriangle,
  Info,
} from "lucide-react";

const UNITS = ["meter", "piece", "box", "roll", "set", "kg", "liter"];

const EMPTY = {
  date: today(),
  invoiceNo: "",
  poNo: "",
  description: "",
  unit: "piece",
  quantity: "",
  stockIn: "",
  stockOut: "",
  unitRate: "",
  remarks: "",
};

export default function InventoryForm({ item, onClose }) {
  const addItem = useInventoryStore((s) => s.addItem);
  const updateItem = useInventoryStore((s) => s.updateItem);
  const isEdit = !!item;

  const initialForm = isEdit
    ? {
        ...item,
        stockIn: item.stockIn ?? item.received ?? "",
        stockOut: item.stockOut ?? item.issued ?? "",
      }
    : EMPTY;

  const [form, setForm] = useState(initialForm);
  const [errors, setErrors] = useState({});
  const [saving, setSaving] = useState(false);

  const qty = Number(form.quantity) || 0;
  const stockIn = Number(form.stockIn) || 0;
  const stockOut = Number(form.stockOut) || 0;
  const inHand = stockIn - stockOut;
  const totalAmount = qty * (Number(form.unitRate) || 0);

  // Auto-fill Stock In when Total Qty is set (only on Add, not Edit)
  // Only auto-fill if stockIn is still empty/zero and user hasn't touched it
  const [stockInTouched, setStockInTouched] = useState(isEdit);
  useEffect(() => {
    const t = setTimeout(() => {
      if (!isEdit && !stockInTouched && qty > 0) {
        setForm((f) => ({ ...f, stockIn: String(qty) }));
      }
    }, 0);
    return () => clearTimeout(t);
  }, [qty, isEdit, stockInTouched]);

  const set = (field, value) => {
    if (field === "stockIn") setStockInTouched(true);
    setForm((f) => ({ ...f, [field]: value }));
    setErrors((e) => ({ ...e, [field]: "", stockMovement: "" }));
  };

  // ── Derived warnings ──
  // Stock In + Stock Out must not exceed Total Qty
  const stockInExceedsQty = qty > 0 && stockIn > qty;
  const stockOutExceedsQty = qty > 0 && stockOut > qty;
  const totalMovementExceedsQty = qty > 0 && stockIn + stockOut > qty;
  const stockOutExceedsIn = stockOut > 0 && stockIn > 0 && stockOut > stockIn;
  const stockMovementEmpty = qty > 0 && stockIn === 0 && stockOut === 0;

  // remaining qty not yet assigned to Stock In or Stock Out
  const assigned = stockIn + stockOut;
  const unassigned = qty - assigned;

  const validate = () => {
    const e = {};
    if (!form.description.trim()) e.description = "Description is required";
    if (!form.quantity || qty <= 0) e.quantity = "Must be greater than 0";
    if (!form.unitRate || Number(form.unitRate) <= 0)
      e.unitRate = "Must be greater than 0";
    if (qty > 0 && stockIn === 0 && stockOut === 0)
      e.stockMovement =
        "Enter at least Stock In — how many units arrived in your warehouse?";
    if (stockInExceedsQty)
      e.stockIn = `Cannot exceed total qty purchased (${qty})`;
    if (stockOutExceedsQty)
      e.stockOut = `Cannot exceed total qty purchased (${qty})`;
    if (totalMovementExceedsQty)
      e.stockMovement = `Stock In + Stock Out (${assigned}) exceeds total qty purchased (${qty})`;
    return e;
  };

  const handleSubmit = async () => {
    const e = validate();
    if (Object.keys(e).length) {
      setErrors(e);
      return;
    }
    setSaving(true);
    try {
      const data = {
        ...form,
        quantity: qty,
        stockIn,
        stockOut,
        inHand: stockIn - stockOut,
        received: stockIn,
        issued: stockOut,
        balanced: stockIn - stockOut,
        unitRate: Number(form.unitRate),
        amount: qty * (Number(form.unitRate) || 0),
      };
      if (isEdit) await updateItem(item.id, data);
      else await addItem(data);
      onClose();
    } catch (err) {
      alert("Error: " + err.message);
    }
    setSaving(false);
  };

  return (
    <div className="space-y-5">
      {/* ── Section 1: Reference Info ── */}
      <Section icon={<FileText size={13} />} label="Reference Info (optional)">
        <div className="grid grid-cols-3 gap-3">
          <Field label="Date">
            <input
              type="date"
              className={inp()}
              value={form.date}
              max={today()}
              onChange={(e) => set("date", e.target.value)}
            />
          </Field>
          <Field label="Invoice No">
            <input
              className={inp()}
              value={form.invoiceNo}
              placeholder="e.g. INV-001"
              onChange={(e) => set("invoiceNo", e.target.value)}
            />
          </Field>
          <Field label="PO No">
            <input
              className={inp()}
              value={form.poNo}
              placeholder="e.g. PO-2024"
              onChange={(e) => set("poNo", e.target.value)}
            />
          </Field>
        </div>
      </Section>

      {/* ── Section 2: Item Details ── */}
      <Section icon={<Package size={13} />} label="Item Details">
        <div className="grid grid-cols-3 gap-3">
          <Field
            label="Description"
            required
            error={errors.description}
            className="col-span-2"
          >
            <input
              className={inp(errors.description)}
              value={form.description}
              onChange={(e) => set("description", e.target.value)}
              placeholder="e.g. Fiber Cable, ONU Device, Splitter..."
              autoFocus={!isEdit}
            />
          </Field>
          <Field label="Unit of Measure">
            <select
              className={inp()}
              value={form.unit}
              onChange={(e) => set("unit", e.target.value)}
            >
              {UNITS.map((u) => (
                <option key={u} value={u}>
                  {u}
                </option>
              ))}
            </select>
          </Field>
        </div>
      </Section>

      {/* ── Section 3: Pricing ── */}
      <Section icon={<Calculator size={13} />} label="Pricing">
        <div className="grid grid-cols-2 gap-3 items-start">
          <Field label="Total Qty Purchased" required error={errors.quantity}>
            <input
              type="number"
              min="1"
              className={inp(errors.quantity)}
              value={form.quantity}
              placeholder="How many did you buy in total?"
              onChange={(e) => set("quantity", e.target.value)}
            />
            <p className="text-xs text-gray-400 mt-1">
              Total units on the purchase invoice.
            </p>
          </Field>
          <Field label="Unit Rate (PKR)" required error={errors.unitRate}>
            <div className="relative">
              <span className="absolute left-3 top-1/2 -translate-y-1/2 text-xs text-gray-400 font-semibold pointer-events-none">
                PKR
              </span>
              <input
                type="number"
                min="0"
                className={`${inp(errors.unitRate)} pl-12`}
                value={form.unitRate}
                placeholder="Cost per unit"
                onChange={(e) => set("unitRate", e.target.value)}
              />
            </div>
            <p className="text-xs text-gray-400 mt-1">
              Price you paid per unit.
            </p>
          </Field>
        </div>

        {/* Total Value auto-preview */}
        {totalAmount > 0 && (
          <div className="flex items-center gap-2 bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 mt-1">
            <span className="text-xs text-gray-500 font-medium">
              Total Purchase Value:
            </span>
            <span className="text-sm font-black text-gray-900">
              PKR {totalAmount.toLocaleString()}
            </span>
            <span className="text-xs text-gray-400">
              ({qty} {form.unit || "units"} × PKR{" "}
              {Number(form.unitRate || 0).toLocaleString()})
            </span>
          </div>
        )}
      </Section>

      {/* ── Section 4: Stock Movement ── */}
      <Section icon={<Warehouse size={13} />} label="Stock Movement">
        {/* Explainer */}
        <div className="flex items-start gap-2 bg-blue-50 border border-blue-200 rounded-lg px-3 py-2 text-xs text-blue-700">
          <Info size={13} className="shrink-0 mt-0.5" />
          <span>
            <strong>
              Stock In + Stock Out must equal Total Qty ({qty || "?"}).
            </strong>{" "}
            Usually all {qty || "?"} units go to Stock In (arrived in
            warehouse). Only split if some were issued directly on the same day
            you received them.
          </span>
        </div>

        <div className="grid grid-cols-3 gap-3 items-start">
          {/* Stock In */}
          <Field
            label={
              <span className="flex items-center gap-1.5">
                <ArrowDownCircle size={13} className="text-green-600" />
                <span>Stock In</span>
                <span className="font-normal text-gray-400 text-xs">
                  (in warehouse)
                </span>
              </span>
            }
            required
            error={errors.stockIn}
          >
            <input
              type="number"
              min="0"
              max={qty || undefined}
              className={inp(errors.stockIn || stockInExceedsQty)}
              value={form.stockIn}
              placeholder={qty ? `Max ${qty}` : "Units received"}
              onChange={(e) => set("stockIn", e.target.value)}
            />
            <p className="text-xs text-gray-400 mt-1">
              Units physically in your warehouse now.
            </p>
          </Field>

          {/* Stock Out */}
          <Field
            label={
              <span className="flex items-center gap-1.5">
                <ArrowUpCircle size={13} className="text-red-500" />
                <span>Stock Out</span>
                <span className="font-normal text-gray-400 text-xs">
                  (already issued)
                </span>
              </span>
            }
            error={errors.stockOut}
          >
            <input
              type="number"
              min="0"
              max={qty || undefined}
              className={inp(
                errors.stockOut || stockOutExceedsQty || stockOutExceedsIn,
              )}
              value={form.stockOut}
              placeholder="0"
              onChange={(e) => set("stockOut", e.target.value)}
            />
            <p className="text-xs text-gray-400 mt-1">
              Units already given to technicians.
            </p>
          </Field>

          {/* In Hand (auto) */}
          <Field
            label={
              <span className="flex items-center gap-1.5">
                <Warehouse size={13} className="text-purple-600" />
                <span>In Hand</span>
                <span className="font-normal text-gray-400 text-xs">
                  (auto)
                </span>
              </span>
            }
          >
            <div
              className={`w-full border rounded-lg px-3 h-10 flex items-center text-sm font-bold ${
                inHand < 0
                  ? "bg-red-50 border-red-200 text-red-600"
                  : inHand === 0 && qty > 0
                    ? "bg-amber-50 border-amber-200 text-amber-600"
                    : inHand > 0
                      ? "bg-green-50 border-green-200 text-green-700"
                      : "bg-gray-50 border-gray-200 text-gray-400"
              }`}
            >
              {inHand} {form.unit || "units"}
            </div>
            <p className="text-xs text-gray-400 mt-1">Stock In − Stock Out.</p>
          </Field>
        </div>

        {/* ── Validation warnings ── */}
        {stockMovementEmpty && !errors.stockMovement && qty > 0 && (
          <div className="flex items-center gap-2 bg-amber-50 border border-amber-200 rounded-lg px-3 py-2 text-xs text-amber-700 font-medium">
            <AlertTriangle size={13} className="shrink-0" />
            Enter Stock In — how many of the {qty} {form.unit}s arrived in your
            warehouse?
          </div>
        )}

        {errors.stockMovement && (
          <div className="flex items-center gap-2 bg-red-50 border border-red-200 rounded-lg px-3 py-2 text-xs text-red-600 font-medium">
            <AlertTriangle size={13} className="shrink-0" />
            {errors.stockMovement}
          </div>
        )}

        {stockOutExceedsIn && !stockInExceedsQty && !stockOutExceedsQty && (
          <div className="flex items-center gap-2 bg-amber-50 border border-amber-200 rounded-lg px-3 py-2 text-xs text-amber-700 font-medium">
            <AlertTriangle size={13} className="shrink-0" />
            Stock Out is more than Stock In — In Hand will be negative. Please
            check your numbers.
          </div>
        )}

        {/* ── Unassigned hint (helpful nudge) ── */}
        {qty > 0 && assigned > 0 && assigned < qty && (
          <div className="flex items-center gap-2 bg-blue-50 border border-blue-200 rounded-lg px-3 py-2 text-xs text-blue-700 font-medium">
            <Info size={13} className="shrink-0" />
            {unassigned} {form.unit}
            {unassigned !== 1 ? "s" : ""} still unaccounted for (Total {qty} −
            assigned {assigned} = {unassigned}). Add them to Stock In if they
            are in your warehouse.
          </div>
        )}

        {/* ── Perfect match confirmation ── */}
        {qty > 0 && assigned === qty && assigned > 0 && (
          <div className="flex items-center gap-2 bg-green-50 border border-green-200 rounded-lg px-3 py-2 text-xs text-green-700 font-medium">
            <CheckCircle size={13} className="shrink-0" />
            All {qty} {form.unit}s accounted for — Stock In ({stockIn}) + Stock
            Out ({stockOut}) = {qty} ✓
          </div>
        )}
      </Section>

      {/* ── Remarks ── */}
      <div>
        <label className="block text-xs font-semibold text-gray-600 mb-1.5">
          Remarks <span className="font-normal text-gray-400">(optional)</span>
        </label>
        <input
          className={inp()}
          value={form.remarks}
          placeholder="Supplier name, location, notes..."
          onChange={(e) => set("remarks", e.target.value)}
        />
      </div>

      {/* ── Summary Banner ── */}
      {totalAmount > 0 && form.description && inHand >= 0 && (
        <div className="flex items-start gap-2.5 bg-blue-50 border border-blue-200 rounded-xl px-4 py-3">
          <CheckCircle size={16} className="text-blue-500 shrink-0 mt-0.5" />
          <div className="text-sm text-blue-700 leading-relaxed">
            <span className="font-semibold">{form.description}</span>
            {" — "}
            {qty} {form.unit} @ PKR{" "}
            {Number(form.unitRate || 0).toLocaleString()} each
            {" = "}
            <span className="font-bold">
              PKR {totalAmount.toLocaleString()}
            </span>
            {stockIn > 0 && (
              <span className="ml-2 text-green-700 font-medium">
                · {stockIn} in warehouse
              </span>
            )}
            {stockOut > 0 && (
              <span className="ml-2 text-red-500 font-medium">
                · {stockOut} already issued
              </span>
            )}
            {inHand > 0 && (
              <span className="ml-2 text-purple-600 font-medium">
                · {inHand} in hand
              </span>
            )}
          </div>
        </div>
      )}

      {/* ── Actions ── */}
      <div className="flex justify-end gap-3 pt-1 border-t border-gray-100">
        <button
          onClick={onClose}
          className="px-5 py-2 text-sm font-medium border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors"
        >
          Cancel
        </button>
        <button
          onClick={handleSubmit}
          disabled={saving}
          className="px-6 py-2 text-sm font-semibold bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 transition-colors shadow-sm"
        >
          {saving ? "Saving..." : isEdit ? "Save Changes" : "Add Item"}
        </button>
      </div>
    </div>
  );
}

/* ── Helpers ── */
const inp = (err) =>
  `w-full border rounded-lg px-3 h-10 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all ${
    err ? "border-red-400 bg-red-50" : "border-gray-300"
  }`;

function Section({ icon, label, children }) {
  return (
    <div className="space-y-2">
      <div className="flex items-center gap-1.5 text-xs font-bold text-gray-500 uppercase tracking-wide border-b border-gray-100 pb-1.5">
        {icon} {label}
      </div>
      {children}
    </div>
  );
}

function Field({ label, required, error, children, className = "" }) {
  return (
    <div className={className}>
      <label className="flex items-center gap-0.5 text-xs font-semibold text-gray-600 mb-1.5 min-h-[16px]">
        {label}
        {required && <span className="text-red-500 ml-0.5">*</span>}
      </label>
      {children}
      {error && (
        <p className="text-xs text-red-500 mt-1 font-medium flex items-center gap-1">
          <AlertTriangle size={11} /> {error}
        </p>
      )}
    </div>
  );
}
</file>

<file path="src/store/useInventoryStore.js">
import { create } from "zustand";
import db from "../db/database";

const useInventoryStore = create((set) => ({
  items: [],

  loadInventory: async () => {
    const items = await db.inventory.toArray();
    // Migrate legacy field names (received → stockIn, issued → stockOut, balanced → inHand)
    const migrated = items.map((item) => ({
      ...item,
      stockIn: item.stockIn ?? item.received ?? 0,
      stockOut: item.stockOut ?? item.issued ?? 0,
      inHand: item.inHand ?? item.balanced ?? 0,
    }));
    set({ items: migrated });
  },

  addItem: async (data) => {
    const stockIn = Number(data.stockIn) || 0;
    const stockOut = Number(data.stockOut) || 0;
    const inHand = stockIn - stockOut;
    const amount = (Number(data.quantity) || 0) * (Number(data.unitRate) || 0);

    const id = await db.inventory.add({
      ...data,
      stockIn,
      stockOut,
      inHand,
      amount,
      // Keep legacy fields in sync
      received: stockIn,
      issued: stockOut,
      balanced: inHand,
      restockLog: [],
      issueLog: data.issueLog || [],
      createdAt: new Date().toISOString(),
    });
    const item = await db.inventory.get(id);
    set((s) => ({ items: [...s.items, item] }));
  },

  updateItem: async (id, data) => {
    const stockIn = Number(data.stockIn) || 0;
    const stockOut = Number(data.stockOut) || 0;
    const inHand = stockIn - stockOut;
    const amount = (Number(data.quantity) || 0) * (Number(data.unitRate) || 0);

    const updates = {
      ...data,
      stockIn,
      stockOut,
      inHand,
      amount,
      // Keep legacy fields in sync
      received: stockIn,
      issued: stockOut,
      balanced: inHand,
    };
    await db.inventory.update(id, updates);
    set((s) => ({
      items: s.items.map((i) => (i.id === id ? { ...i, ...updates } : i)),
    }));
  },

  /**
   * restockItem — adds more stock to an existing item (bulk purchase).
   * Increases stockIn, quantity, and inHand.
   * Appends a structured entry to item.restockLog for full history.
   *
   * @param {number} id        - item id
   * @param {object} restock   - { qty, unitRate, invoiceNo, date, note }
   */
  restockItem: async (id, restock) => {
    const item = await db.inventory.get(id);
    if (!item) throw new Error("Item not found");

    const addedQty = Number(restock.qty) || 0;
    const newRate = Number(restock.unitRate) || item.unitRate || 0;

    const newStockIn = (item.stockIn || 0) + addedQty;
    const newQuantity = (item.quantity || 0) + addedQty;
    const newInHand = newStockIn - (item.stockOut || 0);

    // Weighted average cost per unit (optional but professional)
    const oldValue = (item.inHand || 0) * (item.unitRate || 0);
    const addedValue = addedQty * newRate;
    const newAvgRate =
      newInHand > 0 ? Math.round((oldValue + addedValue) / newInHand) : newRate;

    const newAmount = newQuantity * newAvgRate;

    const logEntry = {
      date: restock.date,
      qty: addedQty,
      unitRate: newRate,
      invoiceNo: restock.invoiceNo?.trim() || null,
      note: restock.note?.trim() || null,
      stockInAfter: newStockIn,
      inHandAfter: newInHand,
      createdAt: new Date().toISOString(),
    };

    const existingRestockLog = Array.isArray(item.restockLog)
      ? item.restockLog
      : [];

    const updates = {
      ...item,
      stockIn: newStockIn,
      quantity: newQuantity,
      inHand: newInHand,
      unitRate: newAvgRate,
      amount: newAmount,
      received: newStockIn,
      balanced: newInHand,
      restockLog: [...existingRestockLog, logEntry],
    };

    await db.inventory.update(id, updates);
    set((s) => ({
      items: s.items.map((i) => (i.id === id ? { ...i, ...updates } : i)),
    }));
  },

  deleteItem: async (id) => {
    await db.inventory.delete(id);
    set((s) => ({ items: s.items.filter((i) => i.id !== id) }));
  },
}));

export default useInventoryStore;
</file>

<file path="src/store/usePaymentStore.js">
import { create } from "zustand";
import db from "../db/database";
// CYCLE_LENGTH_DAYS = 29  →  endDate = startDate + 29 = the 30th inclusive day
import { addDays, CYCLE_LENGTH_DAYS } from "../utils/dateUtils";

const usePaymentStore = create((set, get) => ({
  cycles: [],

  loadCycles: async () => {
    const cycles = await db.paymentCycles.toArray();
    set({ cycles });
  },

  createInitialCycle: async (customerId, startDate, totalAmount) => {
    const cycleData = {
      customerId,
      cycleStartDate: startDate,
      // Day 1 = startDate, Day 30 = startDate + 29
      cycleEndDate: addDays(startDate, CYCLE_LENGTH_DAYS),
      totalAmount,
      amountPaid: 0,
      amountPending: totalAmount,
      status: "pending",
      installments: [],
      createdAt: new Date().toISOString(),
    };
    const id = await db.paymentCycles.add(cycleData);
    const cycle = await db.paymentCycles.get(id);
    set((s) => ({ cycles: [...s.cycles, cycle] }));
    return cycle;
  },

  addInstallment: async (cycleId, amountPaid, datePaid, note = "") => {
    const cycle = await db.paymentCycles.get(cycleId);
    if (!cycle) throw new Error("Cycle not found");

    const installment = {
      id: crypto.randomUUID(),
      amountPaid: Number(amountPaid),
      datePaid,
      note,
      createdAt: new Date().toISOString(),
    };

    const updatedInstallments = [...(cycle.installments || []), installment];
    const totalPaid = updatedInstallments.reduce(
      (sum, i) => sum + i.amountPaid,
      0,
    );
    const amountPending = Math.max(0, cycle.totalAmount - totalPaid);
    const status = amountPending === 0 ? "clear" : "pending";

    const updates = {
      installments: updatedInstallments,
      amountPaid: totalPaid,
      amountPending,
      status,
    };

    await db.paymentCycles.update(cycleId, updates);
    set((s) => ({
      cycles: s.cycles.map((c) =>
        c.id === cycleId ? { ...c, ...updates } : c,
      ),
    }));
  },

  renewCycle: async (customerId, startDate, packagePrice) => {
    const allCycles = get().cycles.filter((c) => c.customerId === customerId);
    const activeCycle = allCycles.sort(
      (a, b) => new Date(b.cycleStartDate) - new Date(a.cycleStartDate),
    )[0];

    // Prevent accidental double renewal on the exact same date
    if (
      activeCycle &&
      activeCycle.cycleStartDate === startDate &&
      activeCycle.isRenewal
    ) {
      return activeCycle;
    }

    let broughtForward = 0;

    if (activeCycle && activeCycle.amountPending > 0) {
      broughtForward = activeCycle.amountPending;

      const updates = {
        amountPending: 0,
        status: "clear",
        shiftedAmount: broughtForward,
      };

      await db.paymentCycles.update(activeCycle.id, updates);

      set((s) => ({
        cycles: s.cycles.map((c) =>
          c.id === activeCycle.id ? { ...c, ...updates } : c,
        ),
      }));
    }

    const totalAmount = packagePrice + broughtForward;

    const cycleData = {
      customerId,
      cycleStartDate: startDate,
      // Day 1 = startDate, Day 30 = startDate + 29
      cycleEndDate: addDays(startDate, CYCLE_LENGTH_DAYS),
      totalAmount,
      amountPaid: 0,
      amountPending: totalAmount,
      status: "pending",
      installments: [],
      isRenewal: true,
      previousBalance: broughtForward,
      createdAt: new Date().toISOString(),
    };

    const id = await db.paymentCycles.add(cycleData);
    const cycle = await db.paymentCycles.get(id);
    set((s) => ({ cycles: [...s.cycles, cycle] }));
    return cycle;
  },

  getActiveCycle: (customerId) => {
    const all = get()
      .cycles.filter((c) => c.customerId === customerId)
      .sort((a, b) => new Date(b.cycleStartDate) - new Date(a.cycleStartDate));
    return all[0] || null;
  },

  getCyclesForCustomer: (customerId) => {
    return get()
      .cycles.filter((c) => c.customerId === customerId)
      .sort((a, b) => new Date(b.cycleStartDate) - new Date(a.cycleStartDate));
  },

  deleteCycle: async (cycleId) => {
    await db.paymentCycles.delete(cycleId);
    set((s) => ({ cycles: s.cycles.filter((c) => c.id !== cycleId) }));
  },
}));

export default usePaymentStore;
</file>

<file path="src/utils/devTools.js">
// src/utils/devTools.js
import db from "../db/database";
import usePaymentStore from "../store/usePaymentStore";
import useCustomerStore from "../store/useCustomerStore";
import useExpenseStore from "../store/useExpenseStore";
import useInventoryStore from "../store/useInventoryStore";
import { addDays, today, CYCLE_LENGTH_DAYS } from "./dateUtils";

export const setupDevTools = () => {
  // 1. List Customers
  window.listCustomers = () => {
    const customers = useCustomerStore.getState().customers;
    console.table(
      customers.map((c) => ({
        ID: c.id,
        Name: c.fullName,
        Username: c.userName,
        Status: c.status,
      })),
    );
  };

  // 2. Generate History for ONE customer
  //    Every even index (0, 2, 4...) = unpaid → carried forward
  //    Every odd index  (1, 3, 5...) = fully paid
  //    Unpaid cycles set shiftedAmount on themselves and previousBalance on
  //    the following cycle — identical to what renewCycle() does in production.
  window.generateTestCycles = async (
    customerId,
    packagePrice = 2500,
    numCycles = 10,
  ) => {
    if (!customerId) return console.error("❌ Please provide a customerId.");
    try {
      // ── 1. Wipe existing cycles for this customer ──────────────────────────
      const allCycles = await db.paymentCycles.toArray();
      const customerCycles = allCycles.filter(
        (c) => Number(c.customerId) === Number(customerId),
      );
      for (const c of customerCycles) await db.paymentCycles.delete(c.id);

      // ── 2. Build date ranges oldest → newest ──────────────────────────────
      // Newest cycle (i=0) starts 10 days ago. Walk backwards from there.
      const ranges = [];
      let end = addDays(addDays(today(), -10), CYCLE_LENGTH_DAYS);
      let start = addDays(today(), -10);
      for (let i = 0; i < numCycles; i++) {
        ranges.unshift({ start, end }); // prepend so index 0 = oldest
        end = addDays(start, -1);
        start = addDays(end, -CYCLE_LENGTH_DAYS);
      }
      // ranges[0] = oldest cycle, ranges[numCycles-1] = newest (current) cycle

      // ── 3. Insert cycles oldest → newest so carry-forward links are correct ─
      // "pendingFromPrev" carries unpaid amount into the next cycle's totalAmount
      let pendingFromPrev = 0;

      for (let i = 0; i < ranges.length; i++) {
        const { start: cycleStart, end: cycleEnd } = ranges[i];
        const isNewest = i === ranges.length - 1;
        // Alternate: even index = unpaid, odd index = paid
        // The newest cycle is always left as-is (pending, no shiftedAmount yet)
        const isPaid = isNewest ? false : i % 2 !== 0;

        const totalAmount = packagePrice + pendingFromPrev;
        const previousBalance = pendingFromPrev;

        if (isPaid) {
          // Fully paid cycle — normal clear cycle
          await db.paymentCycles.add({
            customerId: Number(customerId),
            cycleStartDate: cycleStart,
            cycleEndDate: cycleEnd,
            totalAmount,
            amountPaid: totalAmount,
            amountPending: 0,
            status: "clear",
            shiftedAmount: 0,
            previousBalance,
            installments: [
              {
                id: crypto.randomUUID(),
                amountPaid: totalAmount,
                datePaid: cycleStart,
                note: `Payment (Test Data - cycle ${i + 1})`,
                createdAt: new Date().toISOString(),
              },
            ],
            isRenewal: i > 0,
            createdAt: new Date().toISOString(),
          });
          pendingFromPrev = 0; // debt cleared, nothing to carry forward
        } else if (!isNewest) {
          // Unpaid historical cycle — debt carried forward to next cycle
          await db.paymentCycles.add({
            customerId: Number(customerId),
            cycleStartDate: cycleStart,
            cycleEndDate: cycleEnd,
            totalAmount,
            amountPaid: 0,
            amountPending: 0, // cleared by system (shifted, not paid)
            status: "clear",
            shiftedAmount: totalAmount, // ← what makes it show "Carried Forward"
            previousBalance,
            installments: [],
            isRenewal: i > 0,
            createdAt: new Date().toISOString(),
          });
          pendingFromPrev = totalAmount; // full amount moves to next cycle
        } else {
          // Newest (current) cycle — always pending
          await db.paymentCycles.add({
            customerId: Number(customerId),
            cycleStartDate: cycleStart,
            cycleEndDate: cycleEnd,
            totalAmount,
            amountPaid: 0,
            amountPending: totalAmount,
            status: "pending",
            shiftedAmount: 0,
            previousBalance,
            installments: [],
            isRenewal: i > 0,
            createdAt: new Date().toISOString(),
          });
        }
      }

      await usePaymentStore.getState().loadCycles();
      console.log(
        `✅ Added ${numCycles} realistic cycles for customer ID: ${customerId}`,
      );
      console.log(`   Even cycles (1,3,5…) = Paid ✅`);
      console.log(`   Odd cycles  (2,4,6…) = Carried Forward ↪️`);
      console.log(`   Newest cycle         = Pending 🔴`);
    } catch (error) {
      console.error("❌ Failed:", error);
    }
  };

  // 3. Consecutive unpaid streak then one big clearance payment
  //    Usage: generateStreakTest(customerId, packagePrice, unpaidStreak, totalCycles)
  //    Example: generateStreakTest(3, 1500, 4, 8)
  //    → cycles 1-4 unpaid (carried forward), cycle 5 pays ALL accumulated dues,
  //      cycles 6+ back to normal alternating paid/unpaid
  window.generateStreakTest = async (
    customerId,
    packagePrice = 1500,
    unpaidStreak = 4,
    totalCycles = 8,
  ) => {
    if (!customerId) return console.error("❌ Please provide a customerId.");
    if (unpaidStreak >= totalCycles)
      return console.error("❌ unpaidStreak must be less than totalCycles.");
    try {
      // Wipe existing cycles for this customer
      const allCycles = await db.paymentCycles.toArray();
      for (const c of allCycles.filter(
        (c) => Number(c.customerId) === Number(customerId),
      ))
        await db.paymentCycles.delete(c.id);

      // Build date ranges oldest → newest
      const ranges = [];
      let end = addDays(addDays(today(), -10), CYCLE_LENGTH_DAYS);
      let start = addDays(today(), -10);
      for (let i = 0; i < totalCycles; i++) {
        ranges.unshift({ start, end });
        end = addDays(start, -1);
        start = addDays(end, -CYCLE_LENGTH_DAYS);
      }

      // Pattern (oldest = index 0):
      // 0 .. unpaidStreak-1  → unpaid (carried forward)
      // unpaidStreak         → MEGA PAYMENT clears all accumulated debt
      // unpaidStreak+1 ..    → alternating paid/unpaid (normal)
      // last (newest)        → always pending
      let pendingFromPrev = 0;

      for (let i = 0; i < ranges.length; i++) {
        const { start: cycleStart, end: cycleEnd } = ranges[i];
        const isNewest = i === ranges.length - 1;
        const totalAmount = packagePrice + pendingFromPrev;
        const previousBalance = pendingFromPrev;

        const isInStreak = i < unpaidStreak;
        const isMegaPayment = i === unpaidStreak;
        const isPaidAfterStreak = !isNewest && (i - unpaidStreak) % 2 === 1;

        if (isInStreak) {
          // Unpaid — debt carried forward to next cycle
          await db.paymentCycles.add({
            customerId: Number(customerId),
            cycleStartDate: cycleStart,
            cycleEndDate: cycleEnd,
            totalAmount,
            amountPaid: 0,
            amountPending: 0,
            status: "clear",
            shiftedAmount: totalAmount,
            previousBalance,
            installments: [],
            isRenewal: i > 0,
            createdAt: new Date().toISOString(),
          });
          pendingFromPrev = totalAmount;
        } else if (isMegaPayment) {
          // Customer pays everything at once — clears all accumulated dues
          await db.paymentCycles.add({
            customerId: Number(customerId),
            cycleStartDate: cycleStart,
            cycleEndDate: cycleEnd,
            totalAmount,
            amountPaid: totalAmount,
            amountPending: 0,
            status: "clear",
            shiftedAmount: 0,
            previousBalance,
            installments: [
              {
                id: crypto.randomUUID(),
                amountPaid: totalAmount,
                datePaid: cycleStart,
                note: `Full clearance — PKR ${totalAmount.toLocaleString()} (${unpaidStreak} cycles cleared at once)`,
                createdAt: new Date().toISOString(),
              },
            ],
            isRenewal: i > 0,
            createdAt: new Date().toISOString(),
          });
          pendingFromPrev = 0;
        } else if (isNewest) {
          // Current cycle — always pending
          await db.paymentCycles.add({
            customerId: Number(customerId),
            cycleStartDate: cycleStart,
            cycleEndDate: cycleEnd,
            totalAmount,
            amountPaid: 0,
            amountPending: totalAmount,
            status: "pending",
            shiftedAmount: 0,
            previousBalance,
            installments: [],
            isRenewal: i > 0,
            createdAt: new Date().toISOString(),
          });
        } else if (isPaidAfterStreak) {
          // Normal paid cycle after the streak
          await db.paymentCycles.add({
            customerId: Number(customerId),
            cycleStartDate: cycleStart,
            cycleEndDate: cycleEnd,
            totalAmount,
            amountPaid: totalAmount,
            amountPending: 0,
            status: "clear",
            shiftedAmount: 0,
            previousBalance,
            installments: [
              {
                id: crypto.randomUUID(),
                amountPaid: totalAmount,
                datePaid: cycleStart,
                note: `Payment (Test Data - cycle ${i + 1})`,
                createdAt: new Date().toISOString(),
              },
            ],
            isRenewal: i > 0,
            createdAt: new Date().toISOString(),
          });
          pendingFromPrev = 0;
        } else {
          // Normal unpaid cycle after the streak (also carried forward)
          await db.paymentCycles.add({
            customerId: Number(customerId),
            cycleStartDate: cycleStart,
            cycleEndDate: cycleEnd,
            totalAmount,
            amountPaid: 0,
            amountPending: 0,
            status: "clear",
            shiftedAmount: totalAmount,
            previousBalance,
            installments: [],
            isRenewal: i > 0,
            createdAt: new Date().toISOString(),
          });
          pendingFromPrev = totalAmount;
        }
      }

      await usePaymentStore.getState().loadCycles();
      console.log(`✅ Streak test generated for customer ID: ${customerId}`);
      console.log(`   Cycles 1–${unpaidStreak}   → ↪️  Carried Forward`);
      console.log(
        `   Cycle  ${unpaidStreak + 1}       → 💰 MEGA PAYMENT (all dues cleared at once)`,
      );
      console.log(
        `   Cycles ${unpaidStreak + 2}+      → alternating paid / carried forward`,
      );
      console.log(`   Newest cycle    → 🔴 Pending`);
    } catch (error) {
      console.error("❌ Failed:", error);
    }
  };

  // 4. Generate Bulk Dummy Data
  window.generateNeedsAttentionData = async (count = 15) => {
    console.log(`⏳ Generating ${count} dummy customers...`);
    try {
      for (let i = 1; i <= count; i++) {
        const customerId = await db.customers.add({
          fullName: `Urgent Tester ${i}`,
          userName: `urg_${Date.now()}_${i}`,
          mobileNo: `0300${String(i).padStart(7, "0")}`,
          mainArea: "Test Area",
          packageId: null,
          status: "active",
          createdAt: new Date().toISOString(),
        });

        const daysLeft = Math.floor(Math.random() * 10) - 5;
        const endDate = addDays(today(), daysLeft);
        const startDate = addDays(endDate, -CYCLE_LENGTH_DAYS);
        const isPaid = Math.random() > 0.5;
        const packagePrice = 2000 + Math.floor(Math.random() * 3) * 500;

        await db.paymentCycles.add({
          customerId: Number(customerId),
          cycleStartDate: startDate,
          cycleEndDate: endDate,
          totalAmount: packagePrice,
          amountPaid: isPaid ? packagePrice : 0,
          amountPending: isPaid ? 0 : packagePrice,
          status: isPaid ? "clear" : "pending",
          installments: isPaid
            ? [
                {
                  id: crypto.randomUUID(),
                  amountPaid: packagePrice,
                  datePaid: startDate,
                  note: "Paid dummy",
                  createdAt: new Date().toISOString(),
                },
              ]
            : [],
          isRenewal: false,
          createdAt: new Date().toISOString(),
        });
      }
      await useCustomerStore.getState().loadCustomers();
      await usePaymentStore.getState().loadCycles();
      console.log(`✅ Success! Generated ${count} customers.`);
    } catch (error) {
      console.error("❌ Failed:", error);
    }
  };

  // 4. Clear All Data
  window.clearAllData = async () => {
    if (
      !confirm(
        "⚠️ ARE YOU SURE? This will delete ALL customers, payments, inventory, and expenses. Settings (Packages/Areas) will be kept.",
      )
    )
      return;

    console.log("🧹 Wiping database...");

    try {
      const customers = await db.customers.toArray();
      const cycles = await db.paymentCycles.toArray();
      const expenses = await db.expenses.toArray();
      const inventory = await db.inventory.toArray();

      for (const c of customers) await db.customers.delete(c.id);
      for (const c of cycles) await db.paymentCycles.delete(c.id);
      for (const e of expenses) await db.expenses.delete(e.id);
      for (const i of inventory) await db.inventory.delete(i.id);

      await Promise.all([
        useCustomerStore.getState().loadCustomers(),
        usePaymentStore.getState().loadCycles(),
        useExpenseStore.getState().loadExpenses(),
        useInventoryStore.getState().loadInventory(),
      ]);

      console.log("✨ All data cleared. App is fresh.");
    } catch (err) {
      console.error("Error clearing data:", err);
    }
  };

  console.log("🛠️ DevTools Ready:");
  console.log("👉 listCustomers() -> See all customer IDs");
  console.log(
    "👉 generateTestCycles(id, price, count) -> Realistic mixed history",
  );
  console.log(
    "👉 generateStreakTest(id, price, streak, total) -> e.g. generateStreakTest(3, 1500, 4, 10)",
  );
  console.log("👉 generateNeedsAttentionData(15) -> Add Dummy Customers");
  console.log("👉 clearAllData() -> DELETE ALL DATA");
};
</file>

<file path="src/App.jsx">
import { useEffect, useState } from "react";
import Navbar from "./components/layout/Navbar";
import BackupBanner from "./components/ui/BackupBanner";
import Dashboard from "./pages/Dashboard";
import Customers from "./pages/Customers/Customers";
import Inventory from "./pages/Inventory/Inventory";
import Expenses from "./pages/Expenses/Expenses";
import Settings from "./pages/Settings";
import useCustomerStore from "./store/useCustomerStore";
import usePaymentStore from "./store/usePaymentStore";
import usePackageStore from "./store/usePackageStore";
import useInventoryStore from "./store/useInventoryStore";
import useExpenseStore from "./store/useExpenseStore";
import useConnectionJobStore from "./store/useConnectionJobStore";

export default function App() {
  const [tab, setTab] = useState("dashboard");
  const [customerFilter, setCustomerFilter] = useState("all");
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    Promise.all([
      useCustomerStore.getState().loadCustomers(),
      usePaymentStore.getState().loadCycles(),
      usePackageStore.getState().loadPackages(),
      useInventoryStore.getState().loadInventory(),
      useExpenseStore.getState().loadExpenses(),
      useConnectionJobStore.getState().loadJobs(),
    ]).then(() => setLoading(false));
  }, []);

  const handleNavigate = (targetTab, filterMode = "all") => {
    setTab(targetTab);
    setCustomerFilter(filterMode);
  };

  if (loading) {
    return (
      <div className="h-screen flex items-center justify-center text-gray-400 text-sm">
        Loading Galaxy ISP...
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 flex flex-col">
      <Navbar activeTab={tab} onTabChange={(t) => handleNavigate(t, "all")} />
      <BackupBanner />
      <main className="flex-1 overflow-auto">
        <div style={{ display: tab === "dashboard" ? "block" : "none" }}>
          <Dashboard onNavigate={handleNavigate} />
        </div>
        <div style={{ display: tab === "customers" ? "block" : "none" }}>
          <Customers initialFilter={customerFilter} />
        </div>
        <div style={{ display: tab === "inventory" ? "block" : "none" }}>
          <Inventory />
        </div>
        <div style={{ display: tab === "expenses" ? "block" : "none" }}>
          <Expenses />
        </div>
        <div style={{ display: tab === "settings" ? "block" : "none" }}>
          <Settings />
        </div>
      </main>
    </div>
  );
}
</file>

<file path="src/db/database.js">
/**
 * database.js — Modified for Vercel / LocalStorage
 */

// Make Sure to Remove localStorage Code once the app is fully ready for production.

// ------------------------------------------------------------------
// PART 1: ORIGINAL CODE (COMMENTED OUT)
// ------------------------------------------------------------------
/*
const API = "/api/data";

// In-memory cache so we don't hit the file on every single read
let _cache = null;

async function readAll() {
  if (_cache) return _cache;

  // 1. Check if we are running inside the Electron Desktop App
  if (window.electronAPI) {
    _cache = await window.electronAPI.readData();
    return _cache;
  }

  // 2. Fallback for normal browser (npm run dev)
  const res = await fetch(API);
  if (!res.ok) throw new Error("Failed to read data file");
  _cache = await res.json();
  return _cache;
}

async function writeAll(data) {
  _cache = data;

  // 1. Check if we are running inside the Electron Desktop App
  if (window.electronAPI) {
    await window.electronAPI.writeData(data);
    return;
  }

  // 2. Fallback for normal browser (npm run dev)
  const res = await fetch(API, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data),
  });
  if (!res.ok) throw new Error("Failed to write data file");
}

function invalidate() {
  _cache = null;
}
*/

// ------------------------------------------------------------------
// PART 2: NEW CODE (FOR VERCEL / LOCALSTORAGE)
// ------------------------------------------------------------------

// This key is where your data lives in the browser
const DB_KEY = "galaxy_isp_data_v1";

// New readAll function
async function readAll() {
  // 1. Try to get data from Chrome/Browser LocalStorage
  const rawData = localStorage.getItem(DB_KEY);

  // 2. If data exists, parse it into JSON and return it
  if (rawData) {
    return JSON.parse(rawData);
  }

  // 3. If NO data exists (first time loading), return an empty structure.
  // This prevents "undefined" errors in the rest of your app.
  return {
    customers: [],
    paymentCycles: [],
    packages: [],
    inventory: [],
    expenses: [],
    connectionJobs: [],
    settings: {},
  };
}

// New writeAll function
async function writeAll(data) {
  // Save the data object as a string in LocalStorage
  localStorage.setItem(DB_KEY, JSON.stringify(data));
}

// New invalidate function (does nothing, but prevents errors)
function invalidate() {
  // No cache to clear in LocalStorage mode
}

// ------------------------------------------------------------------
// PART 3: EXISTING LOGIC (KEEP EVERYTHING BELOW THIS LINE AS IS)
// ------------------------------------------------------------------
// ── Generic table operations ─────────────────────────────────────

async function getTable(table) {
  const data = await readAll();
  return data[table] || [];
}

async function addRow(table, row) {
  const data = await readAll();
  const rows = data[table] || [];
  // Auto-increment ID
  const maxId = rows.reduce((m, r) => Math.max(m, Number(r.id) || 0), 0);
  const newRow = { ...row, id: maxId + 1 };
  data[table] = [...rows, newRow];
  await writeAll(data);
  return newRow;
}

async function updateRow(table, id, updates) {
  const data = await readAll();
  data[table] = (data[table] || []).map((r) =>
    r.id === id ? { ...r, ...updates } : r,
  );
  await writeAll(data);
}

async function deleteRow(table, id) {
  const data = await readAll();
  data[table] = (data[table] || []).filter((r) => r.id !== id);
  await writeAll(data);
}

async function getRow(table, id) {
  const rows = await getTable(table);
  return rows.find((r) => r.id === id) || null;
}

async function deleteManyWhere(table, field, value) {
  const data = await readAll();
  data[table] = (data[table] || []).filter((r) => r[field] !== value);
  await writeAll(data);
}

// ── Settings (key/value store) ───────────────────────────────────

async function getSetting(key) {
  const data = await readAll();
  const val = (data.settings || {})[key];
  return val !== undefined ? { key, value: val } : null;
}

async function setSetting(key, value) {
  const data = await readAll();
  data.settings = { ...(data.settings || {}), [key]: value };
  await writeAll(data);
}

// ── db interface (mirrors the Dexie API used by stores) ─────────

const db = {
  customers: {
    toArray: () => getTable("customers"),
    get: (id) => getRow("customers", id),
    add: (row) => addRow("customers", row).then((r) => r.id),
    update: (id, data) => updateRow("customers", id, data),
    delete: (id) => deleteRow("customers", id),
  },
  paymentCycles: {
    toArray: () => getTable("paymentCycles"),
    get: (id) => getRow("paymentCycles", id),
    add: (row) => addRow("paymentCycles", row).then((r) => r.id),
    update: (id, data) => updateRow("paymentCycles", id, data),
    delete: (id) => deleteRow("paymentCycles", id),
    where: (field) => ({
      equals: (value) => ({
        delete: () => deleteManyWhere("paymentCycles", field, value),
        toArray: async () => {
          const rows = await getTable("paymentCycles");
          return rows.filter((r) => r[field] === value);
        },
      }),
    }),
  },
  packages: {
    toArray: () => getTable("packages"),
    get: (id) => getRow("packages", id),
    add: (row) => addRow("packages", row).then((r) => r.id),
    update: (id, data) => updateRow("packages", id, data),
    delete: (id) => deleteRow("packages", id),
  },
  inventory: {
    toArray: () => getTable("inventory"),
    get: (id) => getRow("inventory", id),
    add: (row) => addRow("inventory", row).then((r) => r.id),
    update: (id, data) => updateRow("inventory", id, data),
    delete: (id) => deleteRow("inventory", id),
  },
  expenses: {
    toArray: () => getTable("expenses"),
    get: (id) => getRow("expenses", id),
    add: (row) => addRow("expenses", row).then((r) => r.id),
    update: (id, data) => updateRow("expenses", id, data),
    delete: (id) => deleteRow("expenses", id),
  },
  connectionJobs: {
    toArray: () => getTable("connectionJobs"),
    get: (id) => getRow("connectionJobs", id),
    add: (row) => addRow("connectionJobs", row).then((r) => r.id),
    update: (id, data) => updateRow("connectionJobs", id, data),
    delete: (id) => deleteRow("connectionJobs", id),
  },
  settings: {
    get: (key) => getSetting(key),
    put: ({ key, value }) => setSetting(key, value),
  },
};

export default db;
export { readAll, writeAll, invalidate };
</file>

<file path="src/pages/Customers/CustomerForm.jsx">
import { useState, useEffect, useCallback } from "react";
import { checkDuplicate } from "../../utils/duplicateCheck";
import { today } from "../../utils/dateUtils";
import usePackageStore from "../../store/usePackageStore";
import useCustomerStore from "../../store/useCustomerStore";
import usePaymentStore from "../../store/usePaymentStore";
import db from "../../db/database";

const INITIAL = {
  fullName: "",
  userName: "",
  mobileNo: "",
  cnic: "",
  mainArea: "",
  recoveryAgent: "",
  packageId: "",
  status: "active",
  notes: "",
  startDate: today(),
};

const PAYMENT_INITIAL = {
  recordPayment: false,
  amountPaid: "",
  paymentDate: today(),
  paymentNote: "",
};

// Helper to format CNIC as 00000-0000000-0
const formatCNIC = (val) => {
  const digits = val.replace(/\D/g, "").slice(0, 13);
  let res = "";
  if (digits.length > 0) res += digits.slice(0, 5);
  if (digits.length > 5) res += "-" + digits.slice(5, 12);
  if (digits.length > 12) res += "-" + digits.slice(12, 13);
  return res;
};

export default function CustomerForm({ customer, onClose }) {
  const addCustomer = useCustomerStore((s) => s.addCustomer);
  const updateCustomer = useCustomerStore((s) => s.updateCustomer);
  const createInitialCycle = usePaymentStore((s) => s.createInitialCycle);
  const addInstallment = usePaymentStore((s) => s.addInstallment);
  const allPackages = usePackageStore((s) => s.packages);
  const packages = allPackages.filter((p) => p.isActive !== false);
  const isEdit = !!customer;

  const [form, setFormState] = useState(
    isEdit ? { cnic: "", ...customer, startDate: today() } : INITIAL,
  );
  const [payment, setPaymentState] = useState(PAYMENT_INITIAL);
  const [errors, setErrors] = useState({});
  const [dupWarning, setDupWarning] = useState(null);
  const [areas, setAreas] = useState([]);
  const [agents, setAgents] = useState([]);
  const [saving, setSaving] = useState(false);

  useEffect(() => {
    db.settings.get("areas").then((r) => setAreas(r?.value || []));
    db.settings.get("agents").then((r) => setAgents(r?.value || []));
  }, []);

  // When package changes, auto-fill amountPaid with full price as default
  useEffect(() => {
    const timer = setTimeout(() => {
      if (!isEdit && form.packageId) {
        const pkg = packages.find(
          (p) => Number(p.id) === Number(form.packageId),
        );
        if (pkg && !payment.amountPaid) {
          setPaymentState((p) => ({ ...p, amountPaid: String(pkg.price) }));
        }
      }
    }, 0);
    return clearTimeout(timer);
  }, [form.packageId, isEdit, packages, payment]);

  const setField = (field, value) => {
    setFormState((f) => ({ ...f, [field]: value }));
    setErrors((e) => ({ ...e, [field]: "" }));
  };

  const setPayField = (field, value) => {
    setPaymentState((p) => ({ ...p, [field]: value }));
    setErrors((e) => ({ ...e, [field]: "" }));
  };

  const checkDup = useCallback(
    async (field, value) => {
      if (!value) return setDupWarning(null);
      const result = await checkDuplicate(
        field === "userName" ? value : form.userName,
        field === "mobileNo" ? value : form.mobileNo,
        isEdit ? customer.id : null,
      );
      if (result.hasDuplicate) {
        setDupWarning(
          `${field === "userName" ? "Username" : "Mobile"} already used by: ${result.existing.fullName}`,
        );
      } else {
        setDupWarning(null);
      }
    },
    [form.userName, form.mobileNo, isEdit, customer],
  );

  const validate = () => {
    const e = {};
    if (!form.fullName.trim()) e.fullName = "Required";
    if (!form.userName.trim()) e.userName = "Required";
    if (!form.packageId) e.packageId = "Select a package";
    if (!form.mainArea) e.mainArea = "Select an area";

    if (form.mobileNo) {
      if (!/^0\d{10}$/.test(form.mobileNo)) {
        e.mobileNo = "Must be 11 digits starting with 0 (e.g., 03001234567)";
      }
    }

    if (form.cnic) {
      if (form.cnic.length < 15) {
        e.cnic = "Invalid CNIC format (13 digits required)";
      }
    }

    if (!isEdit && payment.recordPayment) {
      const amt = Number(payment.amountPaid);
      if (!payment.amountPaid || amt <= 0)
        e.amountPaid = "Enter a valid amount";
      const pkg = packages.find((p) => Number(p.id) === Number(form.packageId));
      if (pkg && amt > pkg.price)
        e.amountPaid = `Cannot exceed PKR ${pkg.price} (package price)`;
      if (!payment.paymentDate) e.paymentDate = "Required";
    }
    return e;
  };

  const handleSubmit = async () => {
    const e = validate();
    if (Object.keys(e).length) {
      setErrors(e);
      return;
    }
    if (dupWarning) return;

    setSaving(true);
    try {
      const pkgId = Number(form.packageId);
      const pkg = packages.find((p) => Number(p.id) === pkgId);
      const lockedPrice = pkg ? Number(pkg.price) : 0;

      const customerData = {
        fullName: form.fullName.trim(),
        userName: form.userName.trim(),
        mobileNo: form.mobileNo,
        cnic: form.cnic,
        mainArea: form.mainArea,
        recoveryAgent: form.recoveryAgent,
        packageId: pkgId,
        lockedPackagePrice: lockedPrice,
        // Only "active" or "suspended" are valid stored statuses.
        // Termination is handled via the Archive/Delete flow, not here.
        status: isEdit ? form.status : "active",
        notes: form.notes,
      };

      if (isEdit) {
        await updateCustomer(customer.id, customerData);
      } else {
        const newCustomer = await addCustomer(customerData);

        const newCycle = await createInitialCycle(
          newCustomer.id,
          form.startDate,
          lockedPrice,
        );

        if (payment.recordPayment && Number(payment.amountPaid) > 0) {
          await addInstallment(
            newCycle.id,
            Number(payment.amountPaid),
            payment.paymentDate,
            payment.paymentNote || "",
          );
        }
      }
      onClose();
    } catch (err) {
      alert("Error saving: " + err.message);
    }
    setSaving(false);
  };

  const selectedPkg = packages.find(
    (p) => Number(p.id) === Number(form.packageId),
  );
  const packagePrice = selectedPkg ? Number(selectedPkg.price) : 0;
  const amountPaidNum = Number(payment.amountPaid) || 0;
  const remaining = packagePrice - amountPaidNum;

  return (
    <div className="space-y-5">
      {/* ── DUPLICATE WARNING ── */}
      {dupWarning && (
        <div className="bg-red-50 border border-red-300 text-red-700 text-sm px-3 py-2 rounded-lg">
          ⚠ Duplicate detected: {dupWarning}
        </div>
      )}

      {/* ── SUBSCRIBER INFO ── */}
      <div>
        <p className="text-xs font-bold text-gray-500 uppercase tracking-wide mb-3">
          Subscriber Information
        </p>
        <div className="grid grid-cols-2 gap-4">
          <Field label="Full Name *" error={errors.fullName}>
            <input
              className={inp(errors.fullName)}
              value={form.fullName}
              onChange={(e) => setField("fullName", e.target.value)}
              onBlur={(e) => checkDup("fullName", e.target.value)}
              placeholder="e.g. Ali Hassan"
            />
          </Field>

          <Field label="Username *" error={errors.userName}>
            <input
              className={inp(errors.userName)}
              value={form.userName}
              onChange={(e) =>
                setField("userName", e.target.value.toLowerCase().trim())
              }
              onBlur={(e) => checkDup("userName", e.target.value)}
              placeholder="e.g. alihassan"
            />
          </Field>

          <Field label="Mobile No" error={errors.mobileNo}>
            <input
              className={inp(errors.mobileNo)}
              value={form.mobileNo}
              onChange={(e) =>
                setField(
                  "mobileNo",
                  e.target.value.replace(/\D/g, "").slice(0, 11),
                )
              }
              onBlur={(e) => checkDup("mobileNo", e.target.value)}
              placeholder="03001234567"
            />
          </Field>

          <Field label="CNIC (Optional)" error={errors.cnic}>
            <input
              className={inp(errors.cnic)}
              value={form.cnic}
              onChange={(e) => setField("cnic", formatCNIC(e.target.value))}
              placeholder="00000-0000000-0"
            />
          </Field>

          <Field label="Package *" error={errors.packageId}>
            <select
              className={inp(errors.packageId)}
              value={form.packageId}
              onChange={(e) => {
                setField("packageId", e.target.value);
                setPaymentState((p) => ({ ...p, amountPaid: "" }));
              }}
            >
              <option value="">— Select Package —</option>
              {packages.map((p) => (
                <option key={p.id} value={p.id}>
                  {p.name} — PKR {Number(p.price).toLocaleString()}
                </option>
              ))}
            </select>
          </Field>

          <Field label="Main Area *" error={errors.mainArea}>
            <select
              className={inp(errors.mainArea)}
              value={form.mainArea}
              onChange={(e) => setField("mainArea", e.target.value)}
            >
              <option value="">— Select Area —</option>
              {areas.map((a) => (
                <option key={a} value={a}>
                  {a}
                </option>
              ))}
            </select>
          </Field>

          <Field label="Recovery Agent">
            <select
              className={inp()}
              value={form.recoveryAgent}
              onChange={(e) => setField("recoveryAgent", e.target.value)}
            >
              <option value="">— Select Agent —</option>
              {agents.map((a) => (
                <option key={a} value={a}>
                  {a}
                </option>
              ))}
            </select>
          </Field>

          {!isEdit && (
            <Field label="Subscription Start Date *">
              <input
                type="date"
                className={inp()}
                value={form.startDate}
                max={today()}
                onChange={(e) => setField("startDate", e.target.value)}
              />
            </Field>
          )}

          {isEdit && (
            <Field label="Status">
              <select
                className={inp()}
                value={form.status}
                onChange={(e) => setField("status", e.target.value)}
              >
                <option value="active">Active</option>
                <option value="suspended">Suspended</option>
                {/* Termination is done via the Archive button, not here */}
              </select>
            </Field>
          )}
        </div>

        <div className="mt-4">
          <Field label="Notes">
            <textarea
              className={inp() + " resize-none"}
              rows={2}
              value={form.notes}
              onChange={(e) => setField("notes", e.target.value)}
              placeholder="Optional notes..."
            />
          </Field>
        </div>
      </div>

      {/* ── PAYMENT SECTION (Add mode only) ── */}
      {!isEdit && (
        <div className="border-t border-gray-200 pt-4">
          <label className="flex items-center gap-3 cursor-pointer select-none mb-4">
            <div
              onClick={() =>
                setPayField("recordPayment", !payment.recordPayment)
              }
              className={`relative w-11 h-6 rounded-full transition-colors ${
                payment.recordPayment ? "bg-blue-600" : "bg-gray-300"
              }`}
            >
              <div
                className={`absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform ${
                  payment.recordPayment ? "translate-x-5" : "translate-x-0"
                }`}
              />
            </div>
            <div>
              <span className="text-sm font-bold text-gray-800">
                Record First Payment Now
              </span>
              <p className="text-xs text-gray-400">
                Optionally log a payment while adding the subscriber
              </p>
            </div>
          </label>

          {payment.recordPayment && (
            <div className="bg-blue-50 border border-blue-200 rounded-xl p-4 space-y-4">
              {selectedPkg && (
                <div className="flex items-center justify-between bg-white border border-blue-100 rounded-lg px-4 py-2 text-sm">
                  <span className="text-gray-500">Package Total</span>
                  <span className="font-bold text-gray-800">
                    PKR {packagePrice.toLocaleString()}
                  </span>
                </div>
              )}

              <div className="grid grid-cols-2 gap-4">
                <Field label="Amount Paid *" error={errors.amountPaid}>
                  <input
                    type="number"
                    min="1"
                    max={packagePrice || undefined}
                    className={inp(errors.amountPaid)}
                    value={payment.amountPaid}
                    onChange={(e) => setPayField("amountPaid", e.target.value)}
                    placeholder={`Max PKR ${packagePrice.toLocaleString()}`}
                  />
                </Field>

                <Field label="Payment Date *" error={errors.paymentDate}>
                  <input
                    type="date"
                    className={inp(errors.paymentDate)}
                    value={payment.paymentDate}
                    max={today()}
                    onChange={(e) => setPayField("paymentDate", e.target.value)}
                  />
                </Field>
              </div>

              <Field label="Payment Note (optional)">
                <input
                  className={inp()}
                  value={payment.paymentNote}
                  onChange={(e) => setPayField("paymentNote", e.target.value)}
                  placeholder="e.g. Cash received, Bank transfer..."
                />
              </Field>

              {selectedPkg && amountPaidNum > 0 && (
                <div
                  className={`flex items-center justify-between rounded-lg px-4 py-2 text-sm font-semibold ${
                    remaining <= 0
                      ? "bg-green-100 text-green-800"
                      : "bg-yellow-100 text-yellow-800"
                  }`}
                >
                  <span>
                    {remaining <= 0 ? "✓ Fully Paid" : "Remaining Balance"}
                  </span>
                  <span>
                    {remaining <= 0
                      ? "PKR 0"
                      : `PKR ${remaining.toLocaleString()}`}
                  </span>
                </div>
              )}
            </div>
          )}
        </div>
      )}

      {/* ── FOOTER BUTTONS ── */}
      <div className="flex justify-end gap-3 pt-1">
        <button
          onClick={onClose}
          className="px-4 py-2 text-sm border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50"
        >
          Cancel
        </button>
        <button
          onClick={handleSubmit}
          disabled={saving || !!dupWarning}
          className="px-5 py-2 text-sm bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 disabled:opacity-50"
        >
          {saving
            ? "Saving..."
            : isEdit
              ? "Save Changes"
              : payment.recordPayment
                ? "Add Subscriber & Record Payment"
                : "Add Subscriber"}
        </button>
      </div>
    </div>
  );
}

const inp = (err) =>
  `w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 ${
    err ? "border-red-400 bg-red-50" : "border-gray-300 bg-white"
  }`;

function Field({ label, error, children }) {
  return (
    <div>
      <label className="block text-xs font-semibold text-gray-600 mb-1.5">
        {label}
      </label>
      {children}
      {error && <p className="text-xs text-red-500 mt-1">{error}</p>}
    </div>
  );
}
</file>

<file path="src/pages/Inventory/Inventory.jsx">
import { useState } from "react";
import {
  Plus,
  Search,
  X,
  Package,
  ArrowDownCircle,
  ArrowUpCircle,
  Warehouse,
  Pencil,
  Trash2,
  Info,
  History,
  AlertTriangle,
  RefreshCw,
  TrendingDown,
  DollarSign,
  ChevronUp,
  ChevronDown,
  ChevronsUpDown,
  ClipboardList,
} from "lucide-react";
import Modal from "../../components/ui/Modal";
import ConfirmDialog from "../../components/ui/ConfirmDialog";
import InventoryForm from "./InventoryForm";
import IssueStockModal from "../../components/ui/IssueStockModal";
import IssueHistoryModal from "../../components/ui/Issuehistorymodal";
import RestockModal from "../../components/ui/RestockModal";
import RestockHistoryModal from "../../components/ui/RestockHistoryModal";
import ConnectionJobsLog from "../../components/ui/ConnectionJobsLog";
import useInventoryStore from "../../store/useInventoryStore";
import { formatDate } from "../../utils/dateUtils";

export default function Inventory() {
  const items = useInventoryStore((s) => s.items);
  const deleteItem = useInventoryStore((s) => s.deleteItem);
  const [showAdd, setShowAdd] = useState(false);
  const [editItem, setEditItem] = useState(null);
  const [issueItem, setIssueItem] = useState(null);
  const [historyItem, setHistoryItem] = useState(null);
  const [restockItem, setRestockItem] = useState(null);
  const [restockHistoryItem, setRestockHistoryItem] = useState(null);
  const [deleteTarget, setDeleteTarget] = useState(null);
  const [search, setSearch] = useState("");
  const [showHelp, setShowHelp] = useState(false);
  const [sortField, setSortField] = useState("createdAt");
  const [sortDir, setSortDir] = useState("desc");
  const [showJobsLog, setShowJobsLog] = useState(false);

  const toggleSort = (field) => {
    if (sortField === field) {
      setSortDir((d) => (d === "asc" ? "desc" : "asc"));
    } else {
      setSortField(field);
      setSortDir(field === "createdAt" || field === "date" ? "desc" : "asc");
    }
  };

  const totalCurrentValue = items.reduce(
    (sum, i) => sum + (i.inHand ?? 0) * (i.unitRate || 0),
    0,
  );
  const totalOriginalCost = items.reduce((sum, i) => sum + (i.amount || 0), 0);
  const totalIssuedValue = items.reduce(
    (sum, i) => sum + (i.stockOut || 0) * (i.unitRate || 0),
    0,
  );

  const lowStockItems = items.filter((i) => {
    if (!i.quantity) return false;
    return (i.inHand ?? 0) / i.quantity <= 0.2 && (i.inHand ?? 0) > 0;
  });
  const outOfStockItems = items.filter(
    (i) => (i.inHand ?? 0) <= 0 && (i.quantity || 0) > 0,
  );

  const filtered = items.filter(
    (item) =>
      item.description?.toLowerCase().includes(search.toLowerCase()) ||
      item.invoiceNo?.toLowerCase().includes(search.toLowerCase()) ||
      item.poNo?.toLowerCase().includes(search.toLowerCase()) ||
      item.remarks?.toLowerCase().includes(search.toLowerCase()),
  );

  const sortedFiltered = [...filtered].sort((a, b) => {
    let aVal, bVal;
    switch (sortField) {
      case "date":
        aVal = a.date || "";
        bVal = b.date || "";
        break;
      case "createdAt":
        aVal = a.createdAt || a.date || "";
        bVal = b.createdAt || b.date || "";
        break;
      case "description":
        aVal = (a.description || "").toLowerCase();
        bVal = (b.description || "").toLowerCase();
        break;
      case "inHand":
        aVal = a.inHand ?? 0;
        bVal = b.inHand ?? 0;
        break;
      case "currentValue":
        aVal = (a.inHand ?? 0) * (a.unitRate || 0);
        bVal = (b.inHand ?? 0) * (b.unitRate || 0);
        break;
      default:
        aVal = a.createdAt || "";
        bVal = b.createdAt || "";
    }
    if (aVal < bVal) return sortDir === "asc" ? -1 : 1;
    if (aVal > bVal) return sortDir === "asc" ? 1 : -1;
    return 0;
  });

  const getStockColor = (inHand, quantity) => {
    if (!quantity) return "text-gray-500";
    const ratio = inHand / quantity;
    if (ratio > 0.5) return "text-green-600 font-bold";
    if (ratio > 0.2) return "text-amber-600 font-bold";
    return "text-red-600 font-bold";
  };

  const getStockBadge = (inHand, quantity) => {
    if (!quantity) return null;
    const ratio = inHand / quantity;
    if (ratio <= 0)
      return (
        <span className="text-xs bg-red-100 text-red-600 px-1.5 py-0.5 rounded-full font-semibold">
          Out
        </span>
      );
    if (ratio <= 0.2)
      return (
        <span className="text-xs bg-amber-100 text-amber-600 px-1.5 py-0.5 rounded-full font-semibold">
          Low
        </span>
      );
    return null;
  };

  return (
    <div className="p-4 space-y-4">
      {/* Header */}
      <div className="flex items-center justify-between flex-wrap gap-3">
        <div>
          <div className="flex items-center gap-2">
            <h1 className="text-lg font-bold text-gray-900">Inventory</h1>
            <button
              onClick={() => setShowHelp((v) => !v)}
              className={`transition-colors ${showHelp ? "text-blue-500" : "text-gray-400 hover:text-blue-500"}`}
              title="How does inventory work?"
            >
              <Info size={16} />
            </button>
          </div>
          <p className="text-xs text-gray-500 mt-0.5">
            {items.length} items tracked
          </p>
        </div>

        {/* Action buttons */}
        <div className="flex items-center gap-2 flex-wrap">
          {/* View Jobs Log */}
          <button
            onClick={() => setShowJobsLog(true)}
            className="flex items-center gap-2 px-3 py-2 text-sm font-semibold border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 shadow-sm transition-colors"
          >
            <ClipboardList size={15} /> Jobs Log
          </button>

          {/* Add Item */}
          <button
            onClick={() => setShowAdd(true)}
            className="flex items-center gap-2 px-4 py-2 text-sm font-semibold bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-sm transition-colors"
          >
            <Plus size={15} /> Add Item
          </button>
        </div>
      </div>

      {/* Help Panel */}
      {showHelp && (
        <div className="bg-blue-50 border border-blue-200 rounded-xl p-4 space-y-3">
          <div className="flex items-start justify-between">
            <p className="font-bold text-blue-800">How Inventory Works</p>
            <button
              onClick={() => setShowHelp(false)}
              className="text-blue-400 hover:text-blue-600"
            >
              <X size={15} />
            </button>
          </div>
          <div className="grid grid-cols-3 gap-3 text-sm">
            <div className="bg-white border border-blue-100 rounded-xl p-3 space-y-1">
              <p className="font-semibold text-gray-800 flex items-center gap-1.5">
                <ArrowDownCircle size={14} className="text-green-600" /> Buying
                Stock
              </p>
              <p className="text-xs text-gray-500 leading-relaxed">
                Click <strong>Add Item</strong> the first time you buy
                something.
              </p>
            </div>
            <div className="bg-white border border-blue-100 rounded-xl p-3 space-y-1">
              <p className="font-semibold text-gray-800 flex items-center gap-1.5">
                <RefreshCw size={14} className="text-green-500" /> Restocking
              </p>
              <p className="text-xs text-gray-500 leading-relaxed">
                When you buy more of the same item later, click{" "}
                <strong>Restock</strong>.
              </p>
            </div>
            <div className="bg-white border border-amber-100 rounded-xl p-3 space-y-1">
              <p className="font-semibold text-gray-800 flex items-center gap-1.5">
                <History size={14} className="text-purple-600" /> History
              </p>
              <p className="text-xs text-gray-500 leading-relaxed">
                Each item shows history buttons for <strong>issues</strong> and{" "}
                <strong>restocks</strong>.
              </p>
            </div>
          </div>
        </div>
      )}

      {/* Alerts */}
      {(lowStockItems.length > 0 || outOfStockItems.length > 0) && (
        <div className="space-y-2">
          {outOfStockItems.map((item) => (
            <div
              key={item.id}
              className="flex items-center justify-between bg-red-50 border border-red-200 rounded-xl px-4 py-2.5"
            >
              <div className="flex items-center gap-2.5">
                <AlertTriangle size={15} className="text-red-500 shrink-0" />
                <span className="text-sm font-bold text-red-700">
                  {item.description}
                </span>
                <span className="text-xs text-red-500">
                  — Out of Stock (0 {item.unit})
                </span>
              </div>
              <button
                onClick={() => setRestockItem(item)}
                className="flex items-center gap-1.5 px-3 py-1.5 text-xs font-semibold bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors whitespace-nowrap"
              >
                <RefreshCw size={11} /> Restock Now
              </button>
            </div>
          ))}
          {lowStockItems.map((item) => (
            <div
              key={item.id}
              className="flex items-center justify-between bg-amber-50 border border-amber-200 rounded-xl px-4 py-2.5"
            >
              <div className="flex items-center gap-2.5">
                <AlertTriangle size={15} className="text-amber-500 shrink-0" />
                <span className="text-sm font-bold text-amber-700">
                  {item.description}
                </span>
                <span className="text-xs text-amber-600">
                  — Low Stock: {item.inHand} {item.unit} left (
                  {Math.round(((item.inHand ?? 0) / item.quantity) * 100)}%)
                </span>
              </div>
              <button
                onClick={() => setRestockItem(item)}
                className="flex items-center gap-1.5 px-3 py-1.5 text-xs font-semibold bg-amber-500 text-white rounded-lg hover:bg-amber-600 transition-colors whitespace-nowrap"
              >
                <RefreshCw size={11} /> Restock
              </button>
            </div>
          ))}
        </div>
      )}

      {/* Summary Cards */}
      <div className="grid grid-cols-2 lg:grid-cols-4 gap-3">
        <div className="col-span-2 lg:col-span-1 bg-white border border-gray-200 rounded-xl px-4 py-3">
          <div className="flex items-center gap-2 mb-1.5">
            <div className="w-7 h-7 rounded-lg bg-blue-100 flex items-center justify-center shrink-0">
              <Package size={14} className="text-blue-600" />
            </div>
            <span className="text-xs font-semibold text-gray-500 uppercase tracking-wide leading-tight">
              Current Stock Value
            </span>
          </div>
          <p className="text-2xl font-black text-gray-900 leading-tight">
            PKR {totalCurrentValue.toLocaleString()}
          </p>
          <p className="text-xs text-gray-400 mt-1.5 leading-relaxed">
            What your warehouse stock is worth <em>right now</em> — in-hand qty
            × unit rate. Updates when you issue or restock.
          </p>
        </div>

        <div className="bg-white border border-gray-200 rounded-xl px-4 py-3">
          <div className="flex items-center gap-2 mb-1.5">
            <div className="w-7 h-7 rounded-lg bg-gray-100 flex items-center justify-center shrink-0">
              <Warehouse size={14} className="text-gray-500" />
            </div>
            <span className="text-xs font-semibold text-gray-500 uppercase tracking-wide">
              Items Tracked
            </span>
          </div>
          <p className="text-2xl font-black text-gray-900 leading-tight">
            {items.length}
          </p>
          <p className="text-xs text-gray-400 mt-1.5 leading-relaxed">
            Unique stock types being tracked in your warehouse.
          </p>
        </div>

        <div className="bg-white border border-gray-200 rounded-xl px-4 py-3">
          <div className="flex items-center gap-2 mb-1.5">
            <div className="w-7 h-7 rounded-lg bg-green-100 flex items-center justify-center shrink-0">
              <DollarSign size={14} className="text-green-600" />
            </div>
            <span className="text-xs font-semibold text-gray-500 uppercase tracking-wide">
              Total Purchased
            </span>
          </div>
          <p className="text-2xl font-black text-gray-900 leading-tight">
            PKR {totalOriginalCost.toLocaleString()}
          </p>
          <p className="text-xs text-gray-400 mt-1.5 leading-relaxed">
            Total money spent buying stock — across all purchases ever made.
          </p>
        </div>

        <div className="bg-white border border-gray-200 rounded-xl px-4 py-3">
          <div className="flex items-center gap-2 mb-1.5">
            <div className="w-7 h-7 rounded-lg bg-red-100 flex items-center justify-center shrink-0">
              <TrendingDown size={14} className="text-red-500" />
            </div>
            <span className="text-xs font-semibold text-gray-500 uppercase tracking-wide">
              Total Issued
            </span>
          </div>
          <p className="text-2xl font-black text-red-500 leading-tight">
            PKR {totalIssuedValue.toLocaleString()}
          </p>
          <p className="text-xs text-gray-400 mt-1.5 leading-relaxed">
            Value of stock already given out to technicians for field work.
          </p>
        </div>
      </div>

      {/* Search */}
      <div className="relative">
        <Search
          size={14}
          className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"
        />
        <input
          type="text"
          placeholder="Search by description, invoice no, PO or remarks..."
          value={search}
          onChange={(e) => setSearch(e.target.value)}
          className="w-full pl-9 pr-9 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white"
        />
        {search && (
          <button
            onClick={() => setSearch("")}
            className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
          >
            <X size={14} />
          </button>
        )}
      </div>

      {/* Table */}
      <div className="bg-white border border-gray-200 rounded-xl overflow-hidden shadow-sm">
        <div className="overflow-x-auto">
          <table className="w-full text-sm">
            <thead>
              <tr className="bg-gray-900 text-white text-left">
                <th
                  className="px-3 py-3 font-semibold text-xs whitespace-nowrap cursor-pointer select-none"
                  onClick={() => toggleSort("date")}
                >
                  <div className="flex items-center gap-1">
                    Purchase Date{" "}
                    <SortIcon
                      field="date"
                      sortField={sortField}
                      sortDir={sortDir}
                    />
                  </div>
                </th>
                <th className="px-3 py-3 font-semibold text-xs whitespace-nowrap">
                  INVOICE / PO
                </th>
                <th
                  className="px-3 py-3 font-semibold text-xs whitespace-nowrap cursor-pointer select-none"
                  onClick={() => toggleSort("description")}
                >
                  <div className="flex items-center gap-1">
                    Description{" "}
                    <SortIcon
                      field="description"
                      sortField={sortField}
                      sortDir={sortDir}
                    />
                  </div>
                </th>
                <th className="px-3 py-3 font-semibold text-xs whitespace-nowrap">
                  UNIT
                </th>
                <th className="px-3 py-3 font-semibold text-xs whitespace-nowrap text-green-400">
                  <div className="flex items-center gap-1">
                    <ArrowDownCircle size={12} />
                    IN
                  </div>
                </th>
                <th className="px-3 py-3 font-semibold text-xs whitespace-nowrap text-red-400">
                  <div className="flex items-center gap-1">
                    <ArrowUpCircle size={12} />
                    OUT
                  </div>
                </th>
                <th
                  className="px-3 py-3 font-semibold text-xs whitespace-nowrap cursor-pointer select-none text-purple-300"
                  onClick={() => toggleSort("inHand")}
                >
                  <div className="flex items-center gap-1">
                    In Hand{" "}
                    <SortIcon
                      field="inHand"
                      sortField={sortField}
                      sortDir={sortDir}
                    />
                  </div>
                </th>
                <th className="px-3 py-3 font-semibold text-xs whitespace-nowrap">
                  RATE
                </th>
                <th
                  className="px-3 py-3 font-semibold text-xs whitespace-nowrap cursor-pointer select-none"
                  onClick={() => toggleSort("currentValue")}
                >
                  <div className="flex items-center gap-1">
                    Current Value{" "}
                    <SortIcon
                      field="currentValue"
                      sortField={sortField}
                      sortDir={sortDir}
                    />
                  </div>
                </th>
                <th className="px-3 py-3 font-semibold text-xs whitespace-nowrap">
                  REMARKS
                </th>
                <th className="px-3 py-3 font-semibold text-xs whitespace-nowrap">
                  ACTIONS
                </th>
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-100">
              {sortedFiltered.map((item) => {
                const issueLogCount = Array.isArray(item.issueLog)
                  ? item.issueLog.length
                  : 0;
                const restockLogCount = Array.isArray(item.restockLog)
                  ? item.restockLog.length
                  : 0;
                const currentValue = (item.inHand ?? 0) * (item.unitRate || 0);
                const isOutOfStock = (item.inHand ?? 0) <= 0;

                return (
                  <tr
                    key={item.id}
                    className="group hover:bg-gray-50 transition-colors"
                  >
                    <td className="px-3 py-3 whitespace-nowrap">
                      <p className="font-semibold text-gray-800 text-xs">
                        {formatDate(item.date)}
                      </p>
                      <p className="text-gray-400 text-[10px]">
                        Added {formatDate(item.createdAt || item.date)}
                      </p>
                    </td>
                    <td className="px-3 py-3 text-gray-500 text-xs">
                      {item.invoiceNo || item.poNo ? (
                        <div>
                          {item.invoiceNo && <p>INV: {item.invoiceNo}</p>}
                          {item.poNo && <p>PO: {item.poNo}</p>}
                        </div>
                      ) : (
                        "—"
                      )}
                    </td>
                    <td className="px-3 py-3">
                      <p className="font-bold text-gray-900">
                        {item.description}
                      </p>
                    </td>
                    <td className="px-3 py-3">
                      <span className="inline-block px-2 py-0.5 text-xs font-medium bg-gray-100 text-gray-600 rounded-full">
                        {item.unit}
                      </span>
                    </td>
                    <td className="px-3 py-3 font-bold text-green-600">
                      {item.stockIn || 0}
                    </td>
                    <td className="px-3 py-3 font-bold text-red-500">
                      {item.stockOut || 0}
                    </td>
                    <td className="px-3 py-3">
                      <div className="flex items-center gap-1.5">
                        <span
                          className={getStockColor(item.inHand, item.quantity)}
                        >
                          {item.inHand}
                        </span>
                        {getStockBadge(item.inHand, item.quantity)}
                      </div>
                    </td>
                    <td className="px-3 py-3 text-gray-700 font-medium text-xs">
                      PKR {(item.unitRate || 0).toLocaleString()}
                    </td>
                    <td className="px-3 py-3 font-bold text-gray-800 text-xs">
                      PKR {currentValue.toLocaleString()}
                    </td>
                    <td className="px-3 py-3 text-xs text-gray-500 max-w-32 truncate">
                      {item.remarks || "—"}
                    </td>
                    <td className="px-3 py-3">
                      <div className="flex flex-col gap-1.5">
                        <div className="flex items-center gap-1">
                          <button
                            onClick={() => setRestockItem(item)}
                            className="flex items-center gap-1 px-2 py-1 text-xs font-semibold bg-green-50 text-green-700 border border-green-200 rounded-md hover:bg-green-100 transition-colors whitespace-nowrap"
                          >
                            <RefreshCw size={10} /> Restock
                          </button>
                          <button
                            onClick={() => setRestockHistoryItem(item)}
                            title={`${restockLogCount} restock event(s)`}
                            className="flex items-center gap-0.5 px-1.5 py-1 text-xs font-semibold text-gray-400 border border-gray-200 rounded-md hover:bg-gray-50 transition-colors"
                          >
                            <History size={11} />
                            <span>{restockLogCount || "0"}</span>
                          </button>
                        </div>
                        <div className="flex items-center gap-1">
                          <button
                            onClick={() => {
                              if (!isOutOfStock) setIssueItem(item);
                            }}
                            disabled={isOutOfStock}
                            className={`flex items-center gap-1 px-2 py-1 text-xs font-semibold border rounded-md transition-colors whitespace-nowrap ${
                              isOutOfStock
                                ? "bg-gray-50 text-gray-300 border-gray-200 cursor-not-allowed"
                                : "bg-red-50 text-red-700 border-red-200 hover:bg-red-100"
                            }`}
                          >
                            <ArrowUpCircle size={10} /> Issue
                          </button>
                          <button
                            onClick={() => setHistoryItem(item)}
                            title={
                              issueLogCount > 0
                                ? `${issueLogCount} issue event(s) — click to view`
                                : "No issue history"
                            }
                            className={`flex items-center gap-0.5 px-1.5 py-1 text-xs font-semibold border rounded-md transition-colors ${
                              issueLogCount > 0
                                ? "text-purple-600 border-purple-200 bg-purple-50 hover:bg-purple-100"
                                : "text-gray-400 border-gray-200 hover:bg-gray-50"
                            }`}
                          >
                            <History size={11} />
                            <span>
                              {issueLogCount > 0 ? issueLogCount : "0"}
                            </span>
                          </button>
                        </div>
                        <div className="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                          <button
                            onClick={() => setEditItem(item)}
                            title="Edit item"
                            className="p-1 rounded-md text-gray-300 hover:text-blue-600 hover:bg-blue-50 transition-colors"
                          >
                            <Pencil size={13} />
                          </button>
                          <button
                            onClick={() => setDeleteTarget(item)}
                            title="Delete item"
                            className="p-1 rounded-md text-gray-300 hover:text-red-600 hover:bg-red-50 transition-colors"
                          >
                            <Trash2 size={13} />
                          </button>
                        </div>
                      </div>
                    </td>
                  </tr>
                );
              })}

              {sortedFiltered.length === 0 && (
                <tr>
                  <td colSpan={11} className="px-3 py-14 text-center">
                    <div className="flex flex-col items-center gap-2">
                      <Package size={32} className="text-gray-300" />
                      <p className="font-medium text-gray-500">
                        {search
                          ? "No items match your search"
                          : "No inventory items yet"}
                      </p>
                      {!search && (
                        <p className="text-xs text-gray-400">
                          Click <strong>Add Item</strong> to record your first
                          stock purchase
                        </p>
                      )}
                    </div>
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </div>

      {/* ── Modals ── */}
      <Modal
        isOpen={showAdd}
        onClose={() => setShowAdd(false)}
        title="Add Inventory Item"
        size="lg"
      >
        <InventoryForm onClose={() => setShowAdd(false)} />
      </Modal>

      <Modal
        isOpen={!!editItem}
        onClose={() => setEditItem(null)}
        title="Edit Inventory Item"
        size="lg"
      >
        {editItem && (
          <InventoryForm item={editItem} onClose={() => setEditItem(null)} />
        )}
      </Modal>

      <Modal
        isOpen={!!restockItem}
        onClose={() => setRestockItem(null)}
        title={`Restock — ${restockItem?.description ?? ""}`}
        size="md"
      >
        {restockItem && (
          <RestockModal
            item={restockItem}
            onClose={() => setRestockItem(null)}
            onViewHistory={() => {
              setRestockHistoryItem(restockItem);
              setRestockItem(null);
            }}
          />
        )}
      </Modal>

      <Modal
        isOpen={!!restockHistoryItem}
        onClose={() => setRestockHistoryItem(null)}
        title={`Purchase History — ${restockHistoryItem?.description ?? ""}`}
        size="md"
      >
        {restockHistoryItem && (
          <RestockHistoryModal
            item={restockHistoryItem}
            onClose={() => setRestockHistoryItem(null)}
          />
        )}
      </Modal>

      <Modal
        isOpen={!!issueItem}
        onClose={() => setIssueItem(null)}
        title="Issue Stock"
        size="md"
      >
        {issueItem && (
          <IssueStockModal
            item={issueItem}
            onClose={() => setIssueItem(null)}
            onViewHistory={() => setHistoryItem(issueItem)}
          />
        )}
      </Modal>

      <Modal
        isOpen={!!historyItem}
        onClose={() => setHistoryItem(null)}
        title="Issue History"
        size="md"
      >
        {historyItem && (
          <IssueHistoryModal
            item={historyItem}
            onClose={() => setHistoryItem(null)}
          />
        )}
      </Modal>

      {/* Connection Jobs Log Modal */}
      <Modal
        isOpen={showJobsLog}
        onClose={() => setShowJobsLog(false)}
        title="Connection Jobs Log"
        size="lg"
      >
        <ConnectionJobsLog onClose={() => setShowJobsLog(false)} />
      </Modal>

      <ConfirmDialog
        isOpen={!!deleteTarget}
        onClose={() => setDeleteTarget(null)}
        onConfirm={() => deleteItem(deleteTarget.id)}
        title="Delete Inventory Item"
        message={`Delete "${deleteTarget?.description}"? All stock data and history for this item will be permanently removed.`}
        confirmText={deleteTarget?.description}
        requirePassword
        danger
      />
    </div>
  );
}

function SortIcon({ field, sortField, sortDir }) {
  if (sortField !== field)
    return <ChevronsUpDown size={11} className="text-gray-300" />;
  return sortDir === "asc" ? (
    <ChevronUp size={11} className="text-blue-500" />
  ) : (
    <ChevronDown size={11} className="text-blue-500" />
  );
}
</file>

<file path="src/pages/Customers/Customers.jsx">
import { useState, useEffect } from "react";
import {
  Search,
  Archive,
  ArchiveRestore,
  Trash2,
  ArrowUpDown,
  ChevronLeft,
  ChevronRight,
  Zap,
} from "lucide-react";
import Modal from "../../components/ui/Modal";
import ConfirmDialog from "../../components/ui/ConfirmDialog";
import CustomerTable from "./CustomerTable";
import { getCycleFacts } from "../../utils/Statusutils";
import CustomerForm from "./CustomerForm";
import PaymentForm from "../Payments/PaymentForm";
import NewConnectionForm from "./NewConnectionForm";
import useCustomerStore from "../../store/useCustomerStore";
import usePaymentStore from "../../store/usePaymentStore";
import { formatDate } from "../../utils/dateUtils";

function Pagination({ page, total, count, pageSize, onChange }) {
  const start = (page - 1) * pageSize + 1;
  const end = Math.min(page * pageSize, count);
  return (
    <div className="flex items-center justify-between px-1">
      <span className="text-xs text-gray-400">
        Showing {start}–{end} of {count}
      </span>
      <div className="flex items-center gap-1">
        <button
          onClick={() => onChange(page - 1)}
          disabled={page === 1}
          className="p-1.5 rounded-lg border border-gray-200 bg-white text-gray-600 hover:bg-gray-50 disabled:opacity-30 disabled:cursor-not-allowed"
        >
          <ChevronLeft size={14} />
        </button>
        {Array.from({ length: total }, (_, i) => i + 1)
          .filter((p) => p === 1 || p === total || Math.abs(p - page) <= 1)
          .reduce((acc, p, idx, arr) => {
            if (idx > 0 && p - arr[idx - 1] > 1) acc.push("...");
            acc.push(p);
            return acc;
          }, [])
          .map((p, idx) =>
            p === "..." ? (
              <span
                key={`ellipsis-${idx}`}
                className="px-1 text-xs text-gray-400"
              >
                …
              </span>
            ) : (
              <button
                key={p}
                onClick={() => onChange(p)}
                className={`min-w-7 h-7 rounded-lg text-xs font-semibold border ${
                  p === page
                    ? "bg-gray-800 text-white border-gray-900"
                    : "bg-white text-gray-600 border-gray-200 hover:bg-gray-50"
                }`}
              >
                {p}
              </button>
            ),
          )}
        <button
          onClick={() => onChange(page + 1)}
          disabled={page === total}
          className="p-1.5 rounded-lg border border-gray-200 bg-white text-gray-600 hover:bg-gray-50 disabled:opacity-30 disabled:cursor-not-allowed"
        >
          <ChevronRight size={14} />
        </button>
      </div>
    </div>
  );
}

export default function Customers({ initialFilter }) {
  const customers = useCustomerStore((s) => s.customers);
  const archiveCustomer = useCustomerStore((s) => s.archiveCustomer);
  const restoreCustomer = useCustomerStore((s) => s.restoreCustomer);
  const permanentlyDeleteCustomer = useCustomerStore(
    (s) => s.permanentlyDeleteCustomer,
  );
  const getCyclesForCustomer = usePaymentStore((s) => s.getCyclesForCustomer);
  const getActiveCycle = usePaymentStore((s) => s.getActiveCycle);

  const [view, setView] = useState("active");
  const [search, setSearch] = useState("");
  const [filter, setFilter] = useState("all");
  const [sortBy, setSortBy] = useState("newest");
  const [archiveFilter, setArchiveFilter] = useState("all");
  const [archiveSort, setArchiveSort] = useState("newest");
  const [activePage, setActivePage] = useState(1);
  const [archivePage, setArchivePage] = useState(1);
  const PAGE_SIZE = 20;

  // Modal state
  const [showNewConnection, setShowNewConnection] = useState(false);
  const [editSubscriber, setEditSubscriber] = useState(null);
  const [paySubscriber, setPaySubscriber] = useState(null);
  const [archiveTarget, setArchiveTarget] = useState(null);
  const [restoreTarget, setRestoreTarget] = useState(null);
  const [purgeTarget, setPurgeTarget] = useState(null);

  useEffect(() => {
    const t = setTimeout(() => {
      if (initialFilter) {
        setFilter(initialFilter);
        setActivePage(1);
      }
    }, 0);
    return () => clearTimeout(t);
  }, [initialFilter]);

  useEffect(() => {
    const t = setTimeout(() => setActivePage(1), 0);
    return () => clearTimeout(t);
  }, [search, filter, sortBy]);

  useEffect(() => {
    const t = setTimeout(() => setArchivePage(1), 0);
    return () => clearTimeout(t);
  }, [search]);

  const activeCustomers = customers.filter((c) => !c.isArchived);
  const archivedCustomers = customers.filter((c) => c.isArchived);

  const q = search.toLowerCase();
  const matchSearch = (c) =>
    !search ||
    c.fullName?.toLowerCase().includes(q) ||
    c.userName?.toLowerCase().includes(q) ||
    c.mobileNo?.includes(q) ||
    c.mainArea?.toLowerCase().includes(q);

  // ── Filter logic ────────────────────────────────────────────────────────────────────
  // IMPORTANT: "expired" and "balance-due" filters use raw cycle facts
  // (getCycleFacts) NOT computeDisplayStatus. This ensures a manually
  // suspended customer whose cycle is also expired still appears correctly.
  // The badge shows "Suspended" but the filter finds them by billing reality.
  const filteredActive = activeCustomers.filter((c) => {
    if (!matchSearch(c)) return false;
    if (filter === "all") return true;

    const cycle = getActiveCycle(c.id);
    const { expired, unpaid } = getCycleFacts(cycle);
    const isSuspended = c.status === "suspended";

    if (filter === "suspended") return isSuspended;
    if (filter === "active") return !isSuspended;
    // expired and balance-due intentionally include suspended customers
    if (filter === "expired") return expired && unpaid;
    if (filter === "balance-due") return unpaid;
    // pending = within cycle, unpaid, not suspended
    if (filter === "pending") return !isSuspended && !expired && unpaid;
    return true;
  });

  const sortedActive = [...filteredActive].sort((a, b) => {
    const cA = getActiveCycle(a.id);
    const cB = getActiveCycle(b.id);
    switch (sortBy) {
      case "name":
        return a.fullName.localeCompare(b.fullName);
      case "pending":
        return (cB?.amountPending || 0) - (cA?.amountPending || 0);
      case "expiring":
        if (!cA) return 1;
        if (!cB) return -1;
        return new Date(cA.cycleEndDate) - new Date(cB.cycleEndDate);
      default:
        return b.id - a.id;
    }
  });

  const filteredArchived = archivedCustomers
    .filter((c) => {
      if (!matchSearch(c)) return false;
      if (archiveFilter === "terminated")
        return c.archiveReason === "Terminated";
      if (archiveFilter === "deleted") return c.archiveReason !== "Terminated";
      return true;
    })
    .sort((a, b) => {
      if (archiveSort === "name") return a.fullName.localeCompare(b.fullName);
      if (archiveSort === "oldest")
        return new Date(a.archivedAt || 0) - new Date(b.archivedAt || 0);
      return new Date(b.archivedAt || 0) - new Date(a.archivedAt || 0);
    });

  const totalActivePages = Math.max(
    1,
    Math.ceil(sortedActive.length / PAGE_SIZE),
  );
  const totalArchivePages = Math.max(
    1,
    Math.ceil(filteredArchived.length / PAGE_SIZE),
  );
  const pagedActive = sortedActive.slice(
    (activePage - 1) * PAGE_SIZE,
    activePage * PAGE_SIZE,
  );
  const pagedArchived = filteredArchived.slice(
    (archivePage - 1) * PAGE_SIZE,
    archivePage * PAGE_SIZE,
  );

  // ── Filter tab definitions ─────────────────────────────────────────────────
  // "Overdue" label is removed — replaced with "Expired" to match status badge.
  // "Balance Due" = pending + expired (all who owe money).
  const filterOptions = [
    { id: "all", label: "All" },
    { id: "active", label: "Active" },
    { id: "pending", label: "Pending" }, // within cycle, unpaid
    { id: "expired", label: "Expired" }, // cycle ended, unpaid (was "Overdue")
    { id: "balance-due", label: "Balance Due" }, // pending + expired combined
    { id: "suspended", label: "Suspended" },
  ];

  return (
    <div className="p-4 space-y-3">
      {/* ── HEADER ── */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-3">
          <h1 className="text-base font-semibold text-gray-800">Subscribers</h1>

          <div className="flex items-center gap-0.5 bg-gray-100 rounded-lg p-0.5">
            <button
              onClick={() => setView("active")}
              className={`px-3 py-1 rounded-md text-xs font-semibold transition-colors ${
                view === "active"
                  ? "bg-white text-gray-900 shadow-sm"
                  : "text-gray-500 hover:text-gray-700"
              }`}
            >
              Active
              <span className="ml-1.5 bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded-full text-xs">
                {activeCustomers.length}
              </span>
            </button>
            <button
              onClick={() => setView("archived")}
              className={`px-3 py-1 rounded-md text-xs font-semibold transition-colors ${
                view === "archived"
                  ? "bg-white text-gray-900 shadow-sm"
                  : "text-gray-500 hover:text-gray-700"
              }`}
            >
              Archived
              {archivedCustomers.length > 0 && (
                <span className="ml-1.5 bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded-full text-xs">
                  {archivedCustomers.length}
                </span>
              )}
            </button>
          </div>
        </div>

        {view === "active" && (
          <button
            onClick={() => setShowNewConnection(true)}
            className="flex items-center gap-1.5 px-4 py-1.5 text-sm bg-blue-600 text-white rounded font-semibold hover:bg-blue-700 transition-colors"
          >
            <Zap size={14} /> New Connection
          </button>
        )}
      </div>

      {/* ── SEARCH + FILTER + SORT ── */}
      <div className="flex items-center justify-between flex-wrap gap-2">
        <div className="flex items-center gap-2 flex-1 min-w-62.5">
          <div className="relative flex-1 max-w-xs">
            <Search
              size={14}
              className="absolute left-2.5 top-2 text-gray-400"
            />
            <input
              className="w-full pl-8 pr-3 py-1.5 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
              placeholder="Search subscribers..."
              value={search}
              onChange={(e) => setSearch(e.target.value)}
            />
          </div>
          {view === "active" && (
            <div className="flex gap-1 flex-wrap">
              {filterOptions.map((f) => (
                <button
                  key={f.id}
                  onClick={() => setFilter(f.id)}
                  className={`px-3 py-1.5 text-xs rounded capitalize transition-colors ${
                    filter === f.id
                      ? "bg-gray-800 text-white"
                      : "border border-gray-300 text-gray-600 hover:bg-gray-50"
                  }`}
                >
                  {f.label}
                </button>
              ))}
            </div>
          )}
        </div>

        {view === "active" && (
          <div className="flex items-center gap-2">
            <span className="text-xs text-gray-500 font-medium">Sort by:</span>
            <div className="relative">
              <ArrowUpDown
                size={14}
                className="absolute left-2.5 top-2 text-gray-500 pointer-events-none"
              />
              <select
                className="pl-8 pr-3 py-1.5 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white text-gray-700 cursor-pointer appearance-none min-w-35"
                value={sortBy}
                onChange={(e) => setSortBy(e.target.value)}
              >
                <option value="newest">Newest First</option>
                <option value="name">Name (A-Z)</option>
                <option value="expiring">Expiring Soon</option>
                <option value="pending">Highest Debt</option>
              </select>
            </div>
          </div>
        )}
      </div>

      {/* ── ACTIVE TABLE ── */}
      {view === "active" && (
        <div className="space-y-2">
          <div className="bg-white border border-gray-200 rounded overflow-hidden">
            <CustomerTable
              customers={pagedActive}
              searchQuery=""
              onEdit={(c) => setEditSubscriber(c)}
              onPay={(c) => setPaySubscriber(c)}
              onDelete={(c) => setArchiveTarget(c)}
            />
          </div>
          {totalActivePages > 1 && (
            <Pagination
              page={activePage}
              total={totalActivePages}
              count={sortedActive.length}
              pageSize={PAGE_SIZE}
              onChange={(p) => setActivePage(p)}
            />
          )}
        </div>
      )}

      {/* ── ARCHIVED TABLE ── */}
      {view === "archived" && (
        <div className="space-y-2">
          <div className="flex items-center gap-2 flex-wrap">
            <div className="flex items-center gap-1 bg-gray-100 rounded-lg p-0.5">
              {[
                { id: "all", label: "All" },
                { id: "deleted", label: "Deleted" },
                { id: "terminated", label: "Terminated" },
              ].map((opt) => (
                <button
                  key={opt.id}
                  onClick={() => {
                    setArchiveFilter(opt.id);
                    setArchivePage(1);
                  }}
                  className={`px-3 py-1 rounded-md text-xs font-semibold transition-colors ${
                    archiveFilter === opt.id
                      ? "bg-white text-gray-900 shadow-sm"
                      : "text-gray-500 hover:text-gray-700"
                  }`}
                >
                  {opt.label}
                </button>
              ))}
            </div>
            <select
              value={archiveSort}
              onChange={(e) => {
                setArchiveSort(e.target.value);
                setArchivePage(1);
              }}
              className="text-xs border border-gray-200 rounded-lg px-2 py-1.5 bg-white text-gray-700 font-medium"
            >
              <option value="newest">Newest First</option>
              <option value="oldest">Oldest First</option>
              <option value="name">Name A–Z</option>
            </select>
            <span className="text-xs text-gray-400 ml-1">
              {filteredArchived.length} record
              {filteredArchived.length !== 1 ? "s" : ""}
            </span>
          </div>

          <div className="bg-white border border-gray-200 rounded overflow-hidden">
            {filteredArchived.length === 0 ? (
              <div className="py-16 flex flex-col items-center gap-2 text-gray-400">
                <Archive size={36} className="text-gray-300" />
                <p className="text-sm font-medium">No archived subscribers</p>
                <p className="text-xs text-gray-300">
                  Deleted subscribers appear here — nothing is ever lost.
                </p>
              </div>
            ) : (
              <table className="w-full text-sm">
                <thead>
                  <tr className="bg-gray-800 text-white text-left text-xs">
                    <th className="px-4 py-2.5 font-medium">Subscriber</th>
                    <th className="px-4 py-2.5 font-medium">Area</th>
                    <th className="px-4 py-2.5 font-medium">Archived On</th>
                    <th className="px-4 py-2.5 font-medium">Reason</th>
                    <th className="px-4 py-2.5 font-medium">Total Ever Paid</th>
                    <th className="px-4 py-2.5 font-medium">Cycles</th>
                    <th className="px-4 py-2.5 font-medium">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {pagedArchived.map((c) => {
                    const cycles = getCyclesForCustomer(c.id);
                    const totalPaid = cycles.reduce(
                      (sum, cy) =>
                        sum +
                        (cy.installments || []).reduce(
                          (s, i) => s + (i.amountPaid || 0),
                          0,
                        ),
                      0,
                    );
                    const isTerminated = c.archiveReason === "Terminated";
                    return (
                      <tr
                        key={c.id}
                        className="border-t border-gray-100 hover:bg-gray-50"
                      >
                        <td className="px-4 py-3">
                          <div className="font-medium text-gray-800">
                            {c.fullName}
                          </div>
                          <div className="text-xs text-gray-400">
                            {c.userName}
                          </div>
                          {c.mobileNo && (
                            <div className="text-xs text-gray-400">
                              {c.mobileNo}
                            </div>
                          )}
                        </td>
                        <td className="px-4 py-3 text-xs text-gray-500">
                          {c.mainArea || "—"}
                        </td>
                        <td className="px-4 py-3 text-xs text-gray-500">
                          {c.archivedAt ? formatDate(c.archivedAt) : "—"}
                        </td>
                        <td className="px-4 py-3 text-xs">
                          {isTerminated ? (
                            <span className="inline-block px-2 py-0.5 rounded-full bg-red-100 text-red-700 font-semibold text-xs">
                              Terminated
                            </span>
                          ) : c.archiveReason ? (
                            <span className="text-gray-500">
                              {c.archiveReason}
                            </span>
                          ) : (
                            <span className="text-gray-300 italic">
                              No reason given
                            </span>
                          )}
                        </td>
                        <td className="px-4 py-3 font-semibold text-gray-800">
                          PKR {totalPaid.toLocaleString()}
                        </td>
                        <td className="px-4 py-3 text-xs text-gray-500">
                          {cycles.length}
                        </td>
                        <td className="px-4 py-3">
                          <div className="flex items-center gap-1.5">
                            <button
                              onClick={() => setRestoreTarget(c)}
                              className="flex items-center gap-1 px-2.5 py-1 text-xs bg-green-600 text-white rounded hover:bg-green-700 font-medium"
                            >
                              <ArchiveRestore size={12} /> Restore
                            </button>
                            <button
                              onClick={() => setPurgeTarget(c)}
                              className="flex items-center gap-1 px-2.5 py-1 text-xs bg-red-600 text-white rounded hover:bg-red-700 font-medium"
                            >
                              <Trash2 size={12} /> Purge
                            </button>
                          </div>
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            )}
          </div>
          {totalArchivePages > 1 && (
            <Pagination
              page={archivePage}
              total={totalArchivePages}
              count={filteredArchived.length}
              pageSize={PAGE_SIZE}
              onChange={(p) => setArchivePage(p)}
            />
          )}
        </div>
      )}

      {/* ── MODALS ── */}

      {/* New Connection */}
      <Modal
        isOpen={showNewConnection}
        onClose={() => setShowNewConnection(false)}
        title="New Connection"
        size="lg"
      >
        <NewConnectionForm onClose={() => setShowNewConnection(false)} />
      </Modal>

      {/* Edit Subscriber */}
      <Modal
        isOpen={!!editSubscriber}
        onClose={() => setEditSubscriber(null)}
        title="Edit Subscriber"
        size="lg"
      >
        {editSubscriber && (
          <CustomerForm
            customer={editSubscriber}
            onClose={() => setEditSubscriber(null)}
          />
        )}
      </Modal>

      {/* Record Payment */}
      <Modal
        isOpen={!!paySubscriber}
        onClose={() => setPaySubscriber(null)}
        title="Record Payment"
        size="md"
      >
        {paySubscriber && (
          <PaymentForm
            customer={paySubscriber}
            onClose={() => setPaySubscriber(null)}
          />
        )}
      </Modal>

      {/* Archive */}
      <ConfirmDialog
        isOpen={!!archiveTarget}
        onClose={() => setArchiveTarget(null)}
        onConfirm={(reason) => archiveCustomer(archiveTarget.id, reason)}
        title="Archive Subscriber"
        message={`"${archiveTarget?.fullName}" will be moved to the Archived tab. All payment history is preserved.`}
        confirmLabel="Archive Subscriber"
        confirmText={archiveTarget?.fullName}
        showReason
        reasonLabel="Reason for archiving (optional)"
        danger
      />

      {/* Restore */}
      <ConfirmDialog
        isOpen={!!restoreTarget}
        onClose={() => setRestoreTarget(null)}
        onConfirm={() => restoreCustomer(restoreTarget.id)}
        title="Restore Subscriber"
        message={`Restore "${restoreTarget?.fullName}" back to active? Their full payment history will remain intact.`}
        confirmLabel="Yes, Restore"
        danger={false}
      />

      {/* Purge */}
      <ConfirmDialog
        isOpen={!!purgeTarget}
        onClose={() => setPurgeTarget(null)}
        onConfirm={() => permanentlyDeleteCustomer(purgeTarget.id)}
        title="Permanently Delete"
        message={`This will PERMANENTLY delete "${purgeTarget?.fullName}" and all payment records forever. This cannot be undone.`}
        confirmLabel="Permanently Delete"
        confirmText={purgeTarget?.fullName}
        requirePassword
        danger
      />
    </div>
  );
}
</file>

<file path="src/pages/Payments/PaymentForm.jsx">
import { useState, useEffect } from "react";
import {
  AlertTriangle,
  CheckCircle,
  Clock,
  RefreshCw,
  CreditCard,
  Calendar,
  Info,
  FileText,
  Wallet,
} from "lucide-react";
import { today, daysUntil } from "../../utils/dateUtils";
import usePaymentStore from "../../store/usePaymentStore";
import usePackageStore from "../../store/usePackageStore";
import useCustomerStore from "../../store/useCustomerStore";
import InvoiceModal from "../../components/ui/InvoiceModal";

// ─── helpers ─────────────────────────────────────────────────────────────────

function SummaryRow({ label, value, valueClass = "text-gray-800", highlight }) {
  return (
    <div
      className={`flex justify-between items-center text-sm py-1.5 border-b border-gray-100 last:border-0 ${highlight ? "font-bold" : ""}`}
    >
      <span className={highlight ? "text-gray-800" : "text-gray-500"}>
        {label}
      </span>
      <span className={`font-semibold ${valueClass}`}>{value}</span>
    </div>
  );
}

// ─── Main Component ───────────────────────────────────────────────────────────

export default function PaymentForm({ customer, onClose }) {
  const getActiveCycle = usePaymentStore((s) => s.getActiveCycle);
  const addInstallment = usePaymentStore((s) => s.addInstallment);
  const renewCycle = usePaymentStore((s) => s.renewCycle);
  const updateCustomer = useCustomerStore((s) => s.updateCustomer);
  const packages = usePackageStore((s) => s.packages);

  const activeCycle = getActiveCycle(customer.id);
  const days = activeCycle ? daysUntil(activeCycle.cycleEndDate) : 0;

  // ── Determine situation ───────────────────────────────────────────────────
  const isExpired = days < 0; // cycle ended
  const hasNoCycle = !activeCycle; // brand new customer
  const isPaid = activeCycle?.amountPending === 0; // fully paid
  const pendingAmount = activeCycle?.amountPending ?? 0;

  // For expired+unpaid: operator chooses mode.
  // For active+unpaid:  always "pay only" (no reason to force renewal mid-cycle).
  // For active+paid:    always "renew" (only reason to open Pay form).
  // For no cycle:       always "renew" (create first cycle).
  const canChooseMode = isExpired && !hasNoCycle;
  const defaultRenew = hasNoCycle || isPaid || (isExpired && isPaid);
  const [wantsRenewal, setWantsRenewal] = useState(defaultRenew);
  const isRenewal = wantsRenewal;

  const [selectedPkgId, setSelectedPkgId] = useState(
    String(customer.packageId || packages[0]?.id || ""),
  );
  const [amount, setAmount] = useState("");
  const [date, setDate] = useState(today());
  const [note, setNote] = useState("");
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState("");
  const [invoiceData, setInvoiceData] = useState(null);

  const selectedPkg = packages.find(
    (p) => String(p.id) === String(selectedPkgId),
  );
  const renewalPrice = selectedPkg ? Number(selectedPkg.price) : 0;

  // Auto-fill amount when mode or package changes
  useEffect(() => {
    if (isRenewal) {
      // Suggest the package price only (debt will carry forward automatically)
      setAmount(renewalPrice > 0 ? String(renewalPrice) : "");
    } else {
      // Suggest the full outstanding balance
      setAmount(pendingAmount > 0 ? String(pendingAmount) : "");
    }
    setError("");
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [isRenewal, selectedPkgId]);

  // ── Derived amounts ───────────────────────────────────────────────────────
  const enteredAmt = Number(amount) || 0;

  // In "Pay Dues Only" mode: what will be left after this payment?
  const remainingAfterPayment = Math.max(0, pendingAmount - enteredAmt);

  // In "Renew" mode: total new cycle = package price + carried debt
  const carriedDebt = isRenewal ? pendingAmount : 0;
  const newCycleTotal = renewalPrice + carriedDebt;
  // Remaining on new cycle after payment
  const remainingOnNewCycle = Math.max(0, newCycleTotal - enteredAmt);

  // Result status preview
  const resultStatus = isRenewal
    ? remainingOnNewCycle === 0
      ? "Clear ✓"
      : `Pending — PKR ${remainingOnNewCycle.toLocaleString()} left`
    : remainingAfterPayment === 0
      ? "Clear ✓"
      : `Pending — PKR ${remainingAfterPayment.toLocaleString()} left`;

  const resultStatusIsGood = isRenewal
    ? remainingOnNewCycle === 0
    : remainingAfterPayment === 0;

  // ── Submit ────────────────────────────────────────────────────────────────
  const handleSubmit = async () => {
    setError("");
    const amt = enteredAmt;

    // Validate
    if (!isRenewal) {
      if (amt <= 0) {
        setError("Enter an amount greater than 0.");
        return;
      }
      if (amt > pendingAmount) {
        setError(
          `Cannot exceed outstanding balance of PKR ${pendingAmount.toLocaleString()}.`,
        );
        return;
      }
    }
    // Renewal: amount is optional (0 = renew with full debt pending)

    setSaving(true);
    try {
      let resultCycle;

      if (isRenewal) {
        // If package changed, update customer record first
        if (String(selectedPkgId) !== String(customer.packageId)) {
          await updateCustomer(customer.id, {
            packageId: Number(selectedPkgId),
            lockedPackagePrice: renewalPrice,
          });
        }
        // Create new cycle (carries forward unpaid debt automatically)
        resultCycle = await renewCycle(customer.id, date, renewalPrice);
        // Record payment against the new cycle if amount entered
        if (amt > 0) {
          await addInstallment(resultCycle.id, amt, date, note);
          resultCycle = usePaymentStore.getState().getActiveCycle(customer.id);
        }
      } else {
        // Pay dues only — record against existing cycle, no new cycle created
        await addInstallment(activeCycle.id, amt, date, note);
        resultCycle = usePaymentStore.getState().getActiveCycle(customer.id);
      }

      setInvoiceData({
        cycle: resultCycle,
        packageName: selectedPkg?.name || "—",
      });
    } catch (err) {
      setError("Error: " + err.message);
    }
    setSaving(false);
  };

  // ── Early-return: show invoice success state ──────────────────────────────
  if (invoiceData && !invoiceData.show) {
    return (
      <div className="space-y-4 p-1">
        <div className="flex flex-col items-center gap-3 py-6 text-center">
          <div className="w-14 h-14 rounded-full bg-green-100 flex items-center justify-center">
            <CheckCircle size={28} className="text-green-600" />
          </div>
          <div>
            <p className="text-lg font-bold text-gray-900">
              Saved Successfully!
            </p>
            <p className="text-sm text-gray-500 mt-0.5">
              {isRenewal
                ? "New 30-day cycle started."
                : "Payment recorded on existing cycle."}
            </p>
          </div>
        </div>
        <div className="flex gap-2 justify-center">
          <button
            onClick={() => setInvoiceData({ ...invoiceData, show: true })}
            className="flex items-center gap-1.5 px-4 py-2 text-sm font-semibold bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors"
          >
            <FileText size={14} /> View Invoice
          </button>
          <button
            onClick={onClose}
            className="px-4 py-2 text-sm font-medium border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
          >
            Close
          </button>
        </div>
        <InvoiceModal
          isOpen={!!invoiceData?.show}
          onClose={() => setInvoiceData(null)}
          customer={customer}
          cycle={invoiceData?.cycle}
          packageName={invoiceData?.packageName}
        />
      </div>
    );
  }

  return (
    <div className="space-y-5 p-1">
      {/* ── HEADER ── */}
      <div>
        <h3 className="text-lg font-bold text-gray-900">{customer.fullName}</h3>
        <p className="text-xs text-gray-400 mt-0.5">{customer.userName}</p>
      </div>

      {/* ── MODE TOGGLE (only shown when cycle is expired+unpaid) ── */}
      {canChooseMode && (
        <div>
          <p className="text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">
            What would you like to do?
          </p>
          <div className="grid grid-cols-2 gap-2">
            {/* Pay Dues Only */}
            <button
              onClick={() => setWantsRenewal(false)}
              className={`flex flex-col items-start gap-1 rounded-xl border-2 px-4 py-3 text-left transition-all ${
                !isRenewal
                  ? "border-green-500 bg-green-50"
                  : "border-gray-200 bg-white hover:bg-gray-50"
              }`}
            >
              <div className="flex items-center gap-2">
                <Wallet
                  size={16}
                  className={!isRenewal ? "text-green-600" : "text-gray-400"}
                />
                <span
                  className={`text-sm font-bold ${!isRenewal ? "text-green-700" : "text-gray-600"}`}
                >
                  Pay Dues Only
                </span>
                {!isRenewal && (
                  <span className="ml-auto text-[10px] font-bold bg-green-500 text-white px-1.5 py-0.5 rounded-full">
                    ✓
                  </span>
                )}
              </div>
              <p className="text-xs text-gray-400 leading-relaxed">
                Record a payment on the expired cycle. No new 30-day period
                starts.
              </p>
            </button>

            {/* Pay & Renew */}
            <button
              onClick={() => setWantsRenewal(true)}
              className={`flex flex-col items-start gap-1 rounded-xl border-2 px-4 py-3 text-left transition-all ${
                isRenewal
                  ? "border-blue-500 bg-blue-50"
                  : "border-gray-200 bg-white hover:bg-gray-50"
              }`}
            >
              <div className="flex items-center gap-2">
                <RefreshCw
                  size={16}
                  className={isRenewal ? "text-blue-600" : "text-gray-400"}
                />
                <span
                  className={`text-sm font-bold ${isRenewal ? "text-blue-700" : "text-gray-600"}`}
                >
                  Pay & Renew Cycle
                </span>
                {isRenewal && (
                  <span className="ml-auto text-[10px] font-bold bg-blue-500 text-white px-1.5 py-0.5 rounded-full">
                    ✓
                  </span>
                )}
              </div>
              <p className="text-xs text-gray-400 leading-relaxed">
                Start a fresh 30-day cycle. Any unpaid dues carry forward
                automatically.
              </p>
            </button>
          </div>
        </div>
      )}

      {/* ── INFO BANNER ── */}
      {hasNoCycle && (
        <div className="flex items-start gap-3 rounded-xl bg-blue-50 border border-blue-200 px-4 py-3">
          <Info size={16} className="text-blue-600 mt-0.5 shrink-0" />
          <p className="text-sm text-blue-800">
            <span className="font-semibold">No billing cycle yet.</span> This
            will create the customer&apos;s first 30-day cycle.
          </p>
        </div>
      )}

      {isExpired && !hasNoCycle && (
        <div className="flex items-start gap-3 rounded-xl bg-red-50 border border-red-200 px-4 py-3">
          <AlertTriangle size={16} className="text-red-500 mt-0.5 shrink-0" />
          <div className="text-sm text-red-800">
            <p className="font-semibold">
              Cycle expired {Math.abs(days)} day
              {Math.abs(days) !== 1 ? "s" : ""} ago
              {pendingAmount > 0 &&
                ` — PKR ${pendingAmount.toLocaleString()} outstanding`}
              .
            </p>
            {!isRenewal && (
              <p className="mt-0.5 text-red-700 text-xs">
                The cycle remains expired after this payment. Renew the cycle
                when the customer is ready for a new 30-day period.
              </p>
            )}
          </div>
        </div>
      )}

      {!isExpired && !hasNoCycle && !isPaid && days <= 3 && (
        <div className="flex items-start gap-3 rounded-xl bg-yellow-50 border border-yellow-200 px-4 py-3">
          <Clock size={16} className="text-yellow-600 mt-0.5 shrink-0" />
          <p className="text-sm text-yellow-800">
            <span className="font-semibold">
              {days === 0
                ? "Expires today!"
                : `${days} day${days !== 1 ? "s" : ""} left`}
            </span>{" "}
            — cycle ends on <strong>{activeCycle.cycleEndDate}</strong>.
          </p>
        </div>
      )}

      {!isExpired && !hasNoCycle && isPaid && (
        <div className="flex items-start gap-3 rounded-xl bg-amber-50 border border-amber-200 px-4 py-3">
          <AlertTriangle size={16} className="text-amber-600 mt-0.5 shrink-0" />
          <p className="text-sm text-amber-800">
            <span className="font-semibold">Early renewal.</span> The current
            cycle has{" "}
            <strong>
              {days} day{days !== 1 ? "s" : ""} remaining
            </strong>{" "}
            and is fully paid. Renewing now will start a new cycle from today.
          </p>
        </div>
      )}

      {/* ── CURRENT CYCLE SUMMARY (Pay Dues Only mode) ── */}
      {!isRenewal && activeCycle && (
        <div className="rounded-xl bg-gray-50 border border-gray-200 px-4 py-3 space-y-0.5">
          <p className="text-xs font-bold uppercase text-gray-400 tracking-wide mb-2">
            Current Billing Cycle
          </p>
          <SummaryRow
            label="Period"
            value={`${activeCycle.cycleStartDate} → ${activeCycle.cycleEndDate}`}
          />
          <SummaryRow
            label="Total Bill"
            value={`PKR ${Number(activeCycle.totalAmount).toLocaleString()}`}
          />
          <SummaryRow
            label="Already Paid"
            value={`PKR ${Number(activeCycle.amountPaid).toLocaleString()}`}
            valueClass="text-green-700"
          />
          <SummaryRow
            label="Outstanding Balance"
            value={`PKR ${pendingAmount.toLocaleString()}`}
            valueClass={pendingAmount > 0 ? "text-red-600" : "text-green-700"}
            highlight
          />
        </div>
      )}

      {/* ── RENEWAL: PACKAGE SELECTOR + NEW CYCLE SUMMARY ── */}
      {isRenewal && (
        <div className="rounded-xl bg-blue-50 border border-blue-200 px-4 py-4 space-y-3">
          <p className="text-xs font-bold uppercase text-blue-700 tracking-wide">
            New 30-Day Cycle — Select Package
          </p>
          <select
            value={selectedPkgId}
            onChange={(e) => {
              setSelectedPkgId(e.target.value);
              setAmount("");
            }}
            className="w-full bg-white border border-blue-200 rounded-lg px-3 py-2.5 text-sm font-medium text-gray-800 focus:ring-2 focus:ring-blue-500 outline-none"
          >
            {packages.map((p) => (
              <option key={p.id} value={p.id}>
                {p.name} — PKR {Number(p.price).toLocaleString()}
              </option>
            ))}
          </select>

          <div className="bg-white border border-gray-200 rounded-lg px-3 py-2.5 text-sm space-y-1.5">
            <div className="flex justify-between text-gray-600">
              <span>Package price</span>
              <span>PKR {renewalPrice.toLocaleString()}</span>
            </div>
            {carriedDebt > 0 && (
              <div className="flex justify-between text-red-600 font-medium">
                <span>Carried over debt</span>
                <span>+ PKR {carriedDebt.toLocaleString()}</span>
              </div>
            )}
            <div className="flex justify-between font-bold text-gray-900 border-t border-gray-100 pt-1.5 mt-1">
              <span>New cycle total</span>
              <span>PKR {newCycleTotal.toLocaleString()}</span>
            </div>
          </div>
        </div>
      )}

      {/* ── PAYMENT INPUT ── */}
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-semibold text-gray-700 mb-1.5">
            Amount Paid{" "}
            {isRenewal && (
              <span className="text-gray-400 font-normal text-xs">
                (Optional)
              </span>
            )}
          </label>
          <input
            type="number"
            min="0"
            max={!isRenewal ? pendingAmount : undefined}
            className="w-full border border-gray-300 rounded-lg px-3 h-11 text-base focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
            value={amount}
            onChange={(e) => {
              setAmount(e.target.value);
              setError("");
            }}
            placeholder={
              isRenewal
                ? `Suggested: PKR ${renewalPrice.toLocaleString()}`
                : `Max: PKR ${pendingAmount.toLocaleString()}`
            }
          />
          {isRenewal && (
            <p className="text-xs text-gray-400 mt-1">
              Leave empty or 0 to renew without payment now.
            </p>
          )}
        </div>

        <div>
          <label className="block text-sm font-semibold text-gray-700 mb-1.5">
            Date <span className="text-red-500">*</span>
          </label>
          <div className="relative">
            <Calendar
              size={15}
              className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"
            />
            <input
              type="date"
              max={today()}
              className="w-full border border-gray-300 rounded-lg pl-9 pr-3 h-11 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
              value={date}
              onChange={(e) => setDate(e.target.value)}
            />
          </div>
        </div>
      </div>

      <div>
        <label className="block text-sm font-semibold text-gray-700 mb-1.5">
          Note{" "}
          <span className="text-gray-400 font-normal text-xs">(optional)</span>
        </label>
        <input
          className="w-full border border-gray-300 rounded-lg px-3 h-11 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
          value={note}
          onChange={(e) => setNote(e.target.value)}
          placeholder="e.g. Cash, JazzCash, EasyPaisa..."
        />
      </div>

      {/* ── LIVE RESULT PREVIEW ── */}
      {(enteredAmt > 0 || isRenewal) && !error && (
        <div
          className={`rounded-xl border px-4 py-3 text-sm space-y-1 ${
            resultStatusIsGood
              ? "bg-green-50 border-green-200"
              : "bg-yellow-50 border-yellow-200"
          }`}
        >
          <p
            className={`text-xs font-bold uppercase tracking-wide mb-1 ${
              resultStatusIsGood ? "text-green-600" : "text-yellow-600"
            }`}
          >
            <Clock size={11} className="inline mr-1 mb-0.5" />
            After this action
          </p>
          {isRenewal && (
            <p
              className={
                resultStatusIsGood ? "text-green-800" : "text-yellow-800"
              }
            >
              🔄 New 30-day cycle starts from <strong>{date}</strong> for{" "}
              <strong>{selectedPkg?.name}</strong>.
            </p>
          )}
          {enteredAmt > 0 && (
            <p
              className={
                resultStatusIsGood ? "text-green-800" : "text-yellow-800"
              }
            >
              💰 PKR <strong>{enteredAmt.toLocaleString()}</strong> recorded on{" "}
              <strong>{date}</strong>
              {note ? ` via ${note}` : ""}.
            </p>
          )}
          <p
            className={`font-semibold mt-1 ${
              resultStatusIsGood ? "text-green-700" : "text-yellow-700"
            }`}
          >
            Status after save:{" "}
            <span
              className={`inline-block px-2 py-0.5 rounded text-xs font-bold ${
                resultStatusIsGood
                  ? "bg-green-200 text-green-800"
                  : "bg-yellow-200 text-yellow-800"
              }`}
            >
              {resultStatus}
            </span>
          </p>
          {isRenewal && enteredAmt === 0 && (
            <p className="text-amber-600 text-xs mt-1">
              ⚠️ No payment entered — full amount of PKR{" "}
              {newCycleTotal.toLocaleString()} will be pending on the new cycle.
            </p>
          )}
        </div>
      )}

      {/* ── ERROR ── */}
      {error && (
        <div className="flex items-center gap-2 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm font-medium">
          <AlertTriangle size={15} className="shrink-0" />
          {error}
        </div>
      )}

      {/* ── SUBMIT BUTTON ── */}
      <div className="flex justify-end gap-3 pt-1">
        <button
          onClick={onClose}
          className="px-5 py-2.5 text-sm font-medium border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors"
        >
          Cancel
        </button>
        <button
          onClick={handleSubmit}
          disabled={saving}
          className={`px-6 py-2.5 text-sm font-semibold rounded-lg text-white shadow-sm transition-colors disabled:opacity-40 disabled:cursor-not-allowed flex items-center gap-2 ${
            isRenewal
              ? "bg-blue-600 hover:bg-blue-700"
              : "bg-green-600 hover:bg-green-700"
          }`}
        >
          {saving ? (
            "Processing..."
          ) : isRenewal ? (
            <>
              <RefreshCw size={14} />
              {enteredAmt > 0 ? "Pay & Renew Cycle" : "Renew Cycle"}
            </>
          ) : (
            <>
              <CreditCard size={14} />
              Record Payment
            </>
          )}
        </button>
      </div>
    </div>
  );
}
</file>

<file path="src/pages/Customers/CustomerTable.jsx">
import { useState } from "react";
import {
  Pencil,
  Trash2,
  CreditCard,
  History,
  CornerDownRight,
  AlertCircle,
  CheckCircle2,
  ArrowDownCircle,
  Clock,
  XCircle,
  FileText,
  Printer,
  Package,
} from "lucide-react";
import Badge from "../../components/ui/Badge";
import WhatsAppButton from "../../components/shared/WhatsAppButton";
import Modal from "../../components/ui/Modal";
import InvoiceModal from "../../components/ui/InvoiceModal";
import IssueStockModal from "../../components/ui/IssueStockModal";
import { formatDate } from "../../utils/dateUtils";
import { MESSAGE_TEMPLATES } from "../../config/messageTemplates";
import usePaymentStore from "../../store/usePaymentStore";
import usePackageStore from "../../store/usePackageStore";
import useInventoryStore from "../../store/useInventoryStore";
import useConnectionJobStore from "../../store/useConnectionJobStore";
import { computeDisplayStatus } from "../../utils/Statusutils";
import { daysUntil } from "../../utils/dateUtils";

export default function CustomerTable({
  customers,
  onEdit,
  onPay,
  onDelete,
  searchQuery,
}) {
  const getActiveCycle = usePaymentStore((s) => s.getActiveCycle);
  const getCyclesForCustomer = usePaymentStore((s) => s.getCyclesForCustomer);
  const packages = usePackageStore((s) => s.packages);
  const inventoryItems = useInventoryStore((s) => s.items);
  const jobs = useConnectionJobStore((s) => s.jobs);

  const [historyTarget, setHistoryTarget] = useState(null);
  const [invoiceTarget, setInvoiceTarget] = useState(null);
  const [issueTarget, setIssueTarget] = useState(null); // { customer, item }

  const filtered = customers.filter((c) => {
    if (!searchQuery) return true;
    const q = searchQuery.toLowerCase();
    return (
      c.fullName?.toLowerCase().includes(q) ||
      c.userName?.toLowerCase().includes(q) ||
      c.mobileNo?.includes(q) ||
      c.mainArea?.toLowerCase().includes(q)
    );
  });

  return (
    <>
      <div className="overflow-x-auto">
        <table className="w-full text-sm border-collapse">
          <thead>
            <tr className="bg-gray-100 text-gray-600 text-left">
              <th className="px-3 py-2 font-medium w-10 text-center">#</th>
              <th className="px-3 py-2 font-medium min-w-48">Subscriber</th>
              <th className="px-3 py-2 font-medium">Area</th>
              <th className="px-3 py-2 font-medium">Package</th>
              <th className="px-3 py-2 font-medium">Expires</th>
              <th className="px-3 py-2 font-medium">Pending</th>
              <th className="px-3 py-2 font-medium">Status</th>
              <th className="px-3 py-2 font-medium">Actions</th>
            </tr>
          </thead>
          <tbody>
            {filtered.map((customer, idx) => {
              const cycle = getActiveCycle(customer.id);
              const pkg = packages.find((p) => p.id === customer.packageId);
              const days = cycle ? daysUntil(cycle.cycleEndDate) : null;

              // ── Compute the single display status ──────────────────────────
              const displayStatus = computeDisplayStatus(customer, cycle);

              // ── Historical price locked at last renewal ────────────────────
              let displayPrice = null;
              if (customer.lockedPackagePrice != null) {
                displayPrice = Number(customer.lockedPackagePrice);
              } else if (cycle) {
                const carried = Number(cycle.previousBalance) || 0;
                displayPrice = Number(cycle.totalAmount) - carried;
              } else if (pkg) {
                displayPrice = Number(pkg.price);
              }

              const currentPkgPrice = pkg ? Number(pkg.price) : null;
              const priceChangedSinceLock =
                displayPrice != null &&
                currentPkgPrice != null &&
                displayPrice !== currentPkgPrice;

              // ── Row background ─────────────────────────────────────────────
              const rowBg =
                displayStatus === "expired" || displayStatus === "suspended"
                  ? "bg-red-50"
                  : displayStatus === "renewal"
                    ? "bg-orange-50"
                    : displayStatus === "pending" && days !== null && days <= 3
                      ? "bg-yellow-50"
                      : "";

              // ── WhatsApp message ───────────────────────────────────────────
              const waMessage =
                cycle && cycle.amountPending > 0
                  ? MESSAGE_TEMPLATES.paymentDue(customer, cycle)
                  : cycle
                    ? MESSAGE_TEMPLATES.expiryReminder(customer, cycle)
                    : "";

              // ── Check if subscriber has any inventory issued ───────────
              const hasInventoryIssued = jobs.some(
                (j) => j.subscriberId === customer.id,
              );
              const availableItems = inventoryItems.filter(
                (i) => (i.inHand ?? 0) > 0,
              );

              return (
                <tr
                  key={customer.id}
                  className={`border-b border-gray-100 ${rowBg} hover:bg-gray-50`}
                >
                  <td className="px-3 py-2 text-center text-xs text-gray-400 font-medium w-10">
                    {idx + 1}
                  </td>
                  <td className="px-3 py-2">
                    <div className="font-medium text-gray-800">
                      {customer.fullName}
                    </div>
                    <div className="text-xs text-gray-400">
                      {customer.userName}
                    </div>
                    {customer.mobileNo && (
                      <div className="text-xs text-gray-400">
                        {customer.mobileNo}
                      </div>
                    )}
                  </td>
                  <td className="px-3 py-2 text-gray-600">
                    {customer.mainArea || "-"}
                  </td>

                  {/* Package column */}
                  <td className="px-3 py-2">
                    <div className="font-medium text-gray-700">
                      {pkg ? pkg.name : "-"}
                    </div>
                    {displayPrice != null && (
                      <div
                        className="text-xs text-gray-400 mt-0.5"
                        title={
                          priceChangedSinceLock
                            ? `Current package price is PKR ${currentPkgPrice?.toLocaleString()} — customer is on the old locked rate`
                            : undefined
                        }
                      >
                        PKR {displayPrice.toLocaleString()}
                        {priceChangedSinceLock && (
                          <span className="ml-1 text-amber-500 font-semibold">
                            *
                          </span>
                        )}
                      </div>
                    )}
                  </td>

                  {/* Expires column — "Xd overdue" stays here as timing info */}
                  <td className="px-3 py-2">
                    {cycle ? (
                      <div>
                        <div className="text-xs">
                          {formatDate(cycle.cycleEndDate)}
                        </div>
                        <div
                          className={`text-xs ${
                            days < 0
                              ? "text-red-600 font-medium"
                              : days <= 3
                                ? "text-yellow-700"
                                : "text-gray-400"
                          }`}
                        >
                          {days < 0
                            ? `${-days}d overdue`
                            : days === 0
                              ? "expires today"
                              : `${days}d left`}
                        </div>
                      </div>
                    ) : (
                      "-"
                    )}
                  </td>

                  {/* Pending amount */}
                  <td className="px-3 py-2">
                    {cycle && cycle.amountPending > 0 ? (
                      <span className="text-red-600 font-medium">
                        PKR {cycle.amountPending.toLocaleString()}
                      </span>
                    ) : (
                      <span className="text-green-600 text-xs">Paid</span>
                    )}
                  </td>

                  {/* Status badge — clean computed status, no overdue here */}
                  <td className="px-3 py-2">
                    <Badge status={displayStatus} />
                  </td>

                  <td className="px-3 py-2">
                    <div className="flex items-center gap-1.5">
                      <button
                        onClick={() => onPay(customer)}
                        className="flex items-center gap-1 px-2.5 py-1.5 text-xs font-medium bg-blue-50 text-blue-700 rounded hover:bg-blue-100 border border-blue-200 transition-colors whitespace-nowrap"
                        title="Record Payment"
                      >
                        <CreditCard size={12} /> Pay
                      </button>
                      <button
                        onClick={() => onEdit(customer)}
                        className="flex items-center gap-1 px-2.5 py-1.5 text-xs font-medium bg-white text-gray-700 rounded hover:bg-gray-50 border border-gray-300 transition-colors"
                        title="Edit Subscriber"
                      >
                        <Pencil size={12} /> Edit
                      </button>
                      <button
                        onClick={() => onDelete(customer)}
                        className="flex items-center justify-center w-7 h-7 text-xs font-medium bg-white text-red-500 rounded hover:bg-red-50 border border-gray-200 transition-colors"
                        title="Delete Subscriber"
                      >
                        <Trash2 size={13} />
                      </button>
                      {customer.mobileNo && (
                        <WhatsAppButton
                          mobileNo={customer.mobileNo}
                          message={waMessage}
                          label="Send"
                        />
                      )}
                      {/* Divider */}
                      <div className="w-px h-5 bg-gray-200 mx-0.5" />
                      {/* Icon-only utility buttons */}
                      <button
                        onClick={() => setHistoryTarget(customer)}
                        className="flex items-center justify-center w-7 h-7 rounded border bg-white border-gray-200 text-gray-400 hover:bg-gray-50 hover:text-gray-700 transition-colors"
                        title="View Payment History"
                      >
                        <History size={14} />
                      </button>
                      {cycle ? (
                        <button
                          onClick={() =>
                            setInvoiceTarget({
                              customer,
                              cycle,
                              packageName: pkg?.name || "—",
                            })
                          }
                          className="flex items-center justify-center w-7 h-7 rounded border bg-white border-gray-200 text-gray-400 hover:bg-purple-50 hover:border-purple-200 hover:text-purple-600 transition-colors"
                          title="View / Print Latest Invoice"
                        >
                          <FileText size={14} />
                        </button>
                      ) : (
                        <div className="w-7 h-7" />
                      )}
                      {!hasInventoryIssued && availableItems.length > 0 && (
                        <button
                          onClick={() =>
                            setIssueTarget({
                              customer,
                              item: availableItems[0],
                            })
                          }
                          className="flex items-center justify-center w-7 h-7 rounded border bg-white border-amber-200 text-amber-500 hover:bg-amber-50 hover:border-amber-400 hover:text-amber-700 transition-colors"
                          title="Issue Inventory to Subscriber"
                        >
                          <Package size={14} />
                        </button>
                      )}
                    </div>
                  </td>
                </tr>
              );
            })}
            {filtered.length === 0 && (
              <tr>
                <td
                  colSpan={8}
                  className="px-3 py-8 text-center text-gray-400 text-sm"
                >
                  No customers found.
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>

      {/* History Modal */}
      <Modal
        isOpen={!!historyTarget}
        onClose={() => setHistoryTarget(null)}
        title={
          historyTarget
            ? `Payment History — ${historyTarget.fullName}`
            : "History"
        }
        size="lg"
      >
        {historyTarget && (
          <PaymentHistory
            customer={historyTarget}
            getCyclesForCustomer={getCyclesForCustomer}
            packages={packages}
            onInvoice={(cycle, pkgName) =>
              setInvoiceTarget({
                customer: historyTarget,
                cycle,
                packageName: pkgName,
              })
            }
          />
        )}
      </Modal>

      {/* Invoice Modal */}
      <InvoiceModal
        isOpen={!!invoiceTarget}
        onClose={() => setInvoiceTarget(null)}
        customer={invoiceTarget?.customer}
        cycle={invoiceTarget?.cycle}
        packageName={invoiceTarget?.packageName}
      />

      {/* Issue Stock Modal */}
      {issueTarget && (
        <Modal
          isOpen={!!issueTarget}
          onClose={() => setIssueTarget(null)}
          title={`Issue Inventory — ${issueTarget.customer.fullName}`}
          size="md"
        >
          <IssueStockModal
            item={issueTarget.item}
            onClose={() => setIssueTarget(null)}
          />
        </Modal>
      )}
    </>
  );
}

// ─── Helpers ──────────────────────────────────────────────────────────────────

/**
 * A cycle that has shiftedAmount > 0 was forcibly "cleared" by the system at
 * renewal time — the customer never actually paid. We override the display
 * status to "carried_forward" so staff are not misled by "Clear".
 */
function getCycleDisplayStatus(cycle) {
  if (Number(cycle.shiftedAmount) > 0) return "carried_forward";
  return cycle.status;
}

const STATUS_CFG = {
  clear: {
    label: "Fully Paid",
    icon: <CheckCircle2 size={13} />,
    badge: "bg-green-100 text-green-800 border-green-200",
    headerBg: "bg-green-50 border-green-200",
    cardBorder: "border-green-200",
    bar: "bg-green-500",
    pendingBg: "bg-gray-50",
    pendingText: "text-gray-400",
  },
  pending: {
    label: "Pending",
    icon: <Clock size={13} />,
    badge: "bg-yellow-100 text-yellow-800 border-yellow-200",
    headerBg: "bg-yellow-50 border-yellow-200",
    cardBorder: "border-yellow-200",
    bar: "bg-blue-500",
    pendingBg: "bg-red-50",
    pendingText: "text-red-700",
  },
  overdue: {
    label: "Overdue",
    icon: <XCircle size={13} />,
    badge: "bg-red-100 text-red-800 border-red-200",
    headerBg: "bg-red-50 border-red-200",
    cardBorder: "border-red-300",
    bar: "bg-red-400",
    pendingBg: "bg-red-50",
    pendingText: "text-red-700",
  },
  carried_forward: {
    label: "Carried Forward",
    icon: <CornerDownRight size={13} />,
    badge: "bg-orange-100 text-orange-800 border-orange-200",
    headerBg: "bg-orange-50 border-orange-200",
    cardBorder: "border-orange-300",
    bar: "bg-orange-400",
    pendingBg: "bg-orange-50",
    pendingText: "text-orange-700",
  },
};

function StatusPill({ statusKey }) {
  const cfg = STATUS_CFG[statusKey] || STATUS_CFG.pending;
  return (
    <span
      className={`inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-semibold border ${cfg.badge}`}
    >
      {cfg.icon}
      {cfg.label}
    </span>
  );
}

// ─── PaymentHistory ───────────────────────────────────────────────────────────

function PaymentHistory({
  customer,
  getCyclesForCustomer,
  packages,
  onInvoice,
}) {
  const cycles = getCyclesForCustomer(customer.id);

  if (!cycles || cycles.length === 0) {
    return (
      <div className="flex flex-col items-center justify-center py-14 text-gray-400">
        <History size={36} className="mb-3 opacity-25" />
        <p className="text-sm">No payment history available.</p>
      </div>
    );
  }

  const grandBilled = cycles.reduce(
    (s, c) => s + Number(c.totalAmount || 0) - Number(c.previousBalance || 0),
    0,
  );
  const grandPaid = cycles.reduce((s, c) => s + Number(c.amountPaid || 0), 0);
  const grandPending = Number(cycles[0]?.amountPending || 0);

  return (
    <div className="space-y-5">
      {/* ── Grand summary ── */}
      <div className="grid grid-cols-3 gap-3">
        <div className="bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-center">
          <p className="text-[10px] font-bold uppercase text-gray-400 tracking-wide mb-1">
            Total Billed
          </p>
          <p className="text-base font-bold text-gray-800">
            PKR {grandBilled.toLocaleString()}
          </p>
          <p className="text-[10px] text-gray-400 mt-0.5">
            {cycles.length} cycle{cycles.length !== 1 ? "s" : ""}
          </p>
        </div>
        <div className="bg-green-50 border border-green-200 rounded-xl px-4 py-3 text-center">
          <p className="text-[10px] font-bold uppercase text-green-600 tracking-wide mb-1">
            Total Paid
          </p>
          <p className="text-base font-bold text-green-700">
            PKR {grandPaid.toLocaleString()}
          </p>
          <p className="text-[10px] text-green-600/70 mt-0.5">
            {grandBilled > 0
              ? Math.min(100, Math.round((grandPaid / grandBilled) * 100))
              : 0}
            % of total billed
          </p>
        </div>
        <div
          className={`rounded-xl px-4 py-3 text-center border ${
            grandPending > 0
              ? "bg-red-50 border-red-200"
              : "bg-gray-50 border-gray-200"
          }`}
        >
          <p
            className={`text-[10px] font-bold uppercase tracking-wide mb-1 ${
              grandPending > 0 ? "text-red-500" : "text-gray-400"
            }`}
          >
            Outstanding
          </p>
          <p
            className={`text-base font-bold ${
              grandPending > 0 ? "text-red-700" : "text-gray-400"
            }`}
          >
            PKR {grandPending.toLocaleString()}
          </p>
          <p
            className={`text-[10px] mt-0.5 ${grandPending > 0 ? "text-red-400" : "text-gray-400"}`}
          >
            {grandPending > 0 ? "still owed" : "fully settled"}
          </p>
        </div>
      </div>

      {/* ── Per-cycle cards ── */}
      <div className="space-y-4">
        {cycles.map((cycle, index) => {
          const displayStatus = getCycleDisplayStatus(cycle);
          const cfg = STATUS_CFG[displayStatus] || STATUS_CFG.pending;
          const isCarriedForward = displayStatus === "carried_forward";
          const isClear = displayStatus === "clear";
          const hasIncomingDebt = Number(cycle.previousBalance) > 0;
          const packageOnlyPrice =
            Number(cycle.totalAmount) - Number(cycle.previousBalance || 0);
          const isLatest = index === 0;

          const percentPaid =
            Number(cycle.totalAmount) > 0
              ? Math.min(
                  100,
                  Math.round(
                    (Number(cycle.amountPaid) / Number(cycle.totalAmount)) *
                      100,
                  ),
                )
              : isClear
                ? 100
                : 0;

          const pendingDisplay = isCarriedForward
            ? Number(cycle.shiftedAmount)
            : Number(cycle.amountPending);

          return (
            <div
              key={cycle.id}
              className={`rounded-xl border-2 overflow-hidden ${cfg.cardBorder}`}
            >
              {/* Card header */}
              <div
                className={`px-4 py-3 flex items-center justify-between border-b ${cfg.headerBg}`}
              >
                <div>
                  <div className="flex items-center gap-2 flex-wrap">
                    <span className="text-sm font-bold text-gray-800">
                      {formatDate(cycle.cycleStartDate)}
                    </span>
                    <span className="text-gray-400 text-xs">→</span>
                    <span className="text-sm font-bold text-gray-800">
                      {formatDate(cycle.cycleEndDate)}
                    </span>
                    {isLatest && (
                      <span className="text-[10px] font-bold bg-blue-600 text-white px-1.5 py-0.5 rounded uppercase tracking-wide">
                        Latest
                      </span>
                    )}
                  </div>
                  <p className="text-xs text-gray-500 mt-0.5">
                    {cycle.isRenewal ? "Renewal" : "Initial"} cycle
                    {" · "}
                    {cycle.installments?.length || 0} payment
                    {(cycle.installments?.length || 0) !== 1 ? "s" : ""}{" "}
                    recorded
                  </p>
                </div>
                <div className="flex items-center gap-2 shrink-0">
                  <StatusPill statusKey={displayStatus} />
                  <button
                    onClick={() => {
                      const pkgName =
                        packages?.find(
                          (p) => String(p.id) === String(customer.packageId),
                        )?.name || "—";
                      onInvoice(cycle, pkgName);
                    }}
                    className="flex items-center justify-center w-7 h-7 rounded border bg-white border-gray-300 text-gray-400 hover:bg-purple-50 hover:border-purple-300 hover:text-purple-600 transition-colors"
                    title="View / Print Invoice"
                  >
                    <Printer size={13} />
                  </button>
                </div>
              </div>

              <div className="px-4 py-4 bg-white space-y-4">
                {/* ── CARRIED FORWARD alert ── */}
                {isCarriedForward && (
                  <div className="flex items-start gap-3 bg-orange-50 border border-orange-200 rounded-lg px-3 py-3">
                    <CornerDownRight
                      size={16}
                      className="text-orange-500 mt-0.5 shrink-0"
                    />
                    <div>
                      <p className="text-sm font-semibold text-orange-800">
                        Unpaid dues moved to next cycle — PKR{" "}
                        {Number(cycle.shiftedAmount).toLocaleString()}
                      </p>
                      <p className="text-xs text-orange-700 mt-1 leading-relaxed">
                        The customer did not pay this cycle. When the next cycle
                        was started, the full outstanding amount of{" "}
                        <strong>
                          PKR {Number(cycle.shiftedAmount).toLocaleString()}
                        </strong>{" "}
                        was automatically added to the new cycle&apos;s total
                        bill.
                      </p>
                    </div>
                  </div>
                )}

                {/* ── INCOMING DEBT notice ── */}
                {hasIncomingDebt && (
                  <div className="flex items-start gap-3 bg-blue-50 border border-blue-200 rounded-lg px-3 py-3">
                    <ArrowDownCircle
                      size={16}
                      className="text-blue-500 mt-0.5 shrink-0"
                    />
                    <div>
                      <p className="text-sm font-semibold text-blue-800">
                        Includes unpaid debt from previous cycle — PKR{" "}
                        {Number(cycle.previousBalance).toLocaleString()}
                      </p>
                      <p className="text-xs text-blue-700 mt-1 leading-relaxed">
                        This cycle&apos;s total of{" "}
                        <strong>
                          PKR {Number(cycle.totalAmount).toLocaleString()}
                        </strong>{" "}
                        is made up of the package price{" "}
                        <strong>
                          (PKR {packageOnlyPrice.toLocaleString()})
                        </strong>{" "}
                        plus the carried-over balance from the previous cycle{" "}
                        <strong>
                          (PKR {Number(cycle.previousBalance).toLocaleString()})
                        </strong>
                        .
                      </p>
                    </div>
                  </div>
                )}

                {/* ── Financials grid ── */}
                <div className="grid grid-cols-3 gap-3 text-center">
                  <div className="bg-gray-50 rounded-lg px-3 py-2.5">
                    <p className="text-[10px] font-bold uppercase text-gray-400 tracking-wide mb-1">
                      Total Bill
                    </p>
                    <p className="text-sm font-bold text-gray-800">
                      PKR {Number(cycle.totalAmount).toLocaleString()}
                    </p>
                    {hasIncomingDebt && (
                      <p className="text-[10px] text-gray-400 mt-0.5">
                        incl. PKR{" "}
                        {Number(cycle.previousBalance).toLocaleString()} debt
                      </p>
                    )}
                  </div>

                  <div className="bg-green-50 rounded-lg px-3 py-2.5">
                    <p className="text-[10px] font-bold uppercase text-green-600 tracking-wide mb-1">
                      Paid
                    </p>
                    <p className="text-sm font-bold text-green-700">
                      PKR {Number(cycle.amountPaid).toLocaleString()}
                    </p>
                  </div>

                  <div className={`rounded-lg px-3 py-2.5 ${cfg.pendingBg}`}>
                    <p
                      className={`text-[10px] font-bold uppercase tracking-wide mb-1 ${
                        isCarriedForward
                          ? "text-orange-500"
                          : pendingDisplay > 0
                            ? "text-red-500"
                            : "text-gray-400"
                      }`}
                    >
                      {isCarriedForward ? "Moved Forward" : "Pending"}
                    </p>
                    <p className={`text-sm font-bold ${cfg.pendingText}`}>
                      PKR {pendingDisplay.toLocaleString()}
                    </p>
                  </div>
                </div>

                {/* ── Progress bar ── */}
                <div>
                  <div className="flex justify-between text-[11px] text-gray-400 mb-1">
                    <span>Payment progress</span>
                    <span>{percentPaid}%</span>
                  </div>
                  <div className="w-full bg-gray-100 rounded-full h-2 overflow-hidden">
                    <div
                      className={`h-2 rounded-full transition-all duration-500 ${cfg.bar}`}
                      style={{ width: `${percentPaid}%` }}
                    />
                  </div>
                </div>

                {/* ── Installments list ── */}
                {cycle.installments && cycle.installments.length > 0 ? (
                  <div className="bg-gray-50 border border-gray-100 rounded-lg p-3">
                    <p className="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-2.5">
                      Payments Received
                    </p>
                    <div className="space-y-2">
                      {cycle.installments.map((inst) => (
                        <div
                          key={inst.id}
                          className="flex justify-between items-center bg-white rounded-lg px-3 py-2 border border-gray-100 shadow-sm"
                        >
                          <div className="flex items-center gap-2.5">
                            <div className="w-6 h-6 rounded-full bg-green-100 flex items-center justify-center shrink-0">
                              <CheckCircle2
                                size={12}
                                className="text-green-600"
                              />
                            </div>
                            <div>
                              <p className="text-xs font-semibold text-gray-800">
                                {formatDate(inst.datePaid)}
                              </p>
                              {inst.note && (
                                <p className="text-[10px] text-gray-400 mt-0.5">
                                  via {inst.note}
                                </p>
                              )}
                            </div>
                          </div>
                          <span className="text-sm font-bold text-gray-800">
                            PKR {Number(inst.amountPaid).toLocaleString()}
                          </span>
                        </div>
                      ))}
                    </div>
                  </div>
                ) : (
                  !isCarriedForward && (
                    <div className="flex items-center gap-2 text-xs text-gray-400 bg-gray-50 border border-gray-100 rounded-lg px-3 py-2.5">
                      <AlertCircle size={13} className="shrink-0" />
                      No payments recorded for this cycle.
                    </div>
                  )
                )}
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
}
</file>

<file path="src/pages/Dashboard.jsx">
import { useState, useEffect, useRef } from "react";
import {
  Users,
  TrendingUp,
  Clock,
  AlertTriangle,
  CheckCircle,
  XCircle,
  Calendar,
  CreditCard,
  ChevronLeft,
  ChevronRight,
  Eye,
  EyeOff,
  Package,
  RefreshCw,
  Info,
} from "lucide-react";
import useCustomerStore from "../store/useCustomerStore";
import usePaymentStore from "../store/usePaymentStore";
import useExpenseStore from "../store/useExpenseStore";
import useInventoryStore from "../store/useInventoryStore";
import { daysUntil, formatDate, today } from "../utils/dateUtils";
import Badge from "../components/ui/Badge";
import Modal from "../components/ui/Modal";
import PaymentForm from "./Payments/PaymentForm";
import WhatsAppButton from "../components/shared/WhatsAppButton";
import { MESSAGE_TEMPLATES } from "../config/messageTemplates";

const MONTH_NAMES = [
  "January",
  "February",
  "March",
  "April",
  "May",
  "June",
  "July",
  "August",
  "September",
  "October",
  "November",
  "December",
];

function getLatestCycle(cycles, customerId) {
  return (
    cycles
      .filter((c) => c.customerId === customerId)
      .sort(
        (a, b) => new Date(b.cycleStartDate) - new Date(a.cycleStartDate),
      )[0] || null
  );
}

export default function Dashboard({ onNavigate }) {
  const customers = useCustomerStore((s) => s.customers);
  const cycles = usePaymentStore((s) => s.cycles);
  const expenses = useExpenseStore((s) => s.expenses);
  const inventoryItems = useInventoryStore((s) => s.items);

  const [payCustomer, setPayCustomer] = useState(null);
  const [mode, setMode] = useState("alltime"); // alltime | monthly | daily

  const now = new Date();
  const [selYear, setSelYear] = useState(now.getFullYear());
  const [selMonth, setSelMonth] = useState(now.getMonth());
  const [selDate, setSelDate] = useState(today());

  const prevMonth = () => {
    if (selMonth === 0) {
      setSelMonth(11);
      setSelYear((y) => y - 1);
    } else setSelMonth((m) => m - 1);
  };
  const nextMonth = () => {
    if (selYear === now.getFullYear() && selMonth === now.getMonth()) return;
    if (selMonth === 11) {
      setSelMonth(0);
      setSelYear((y) => y + 1);
    } else setSelMonth((m) => m + 1);
  };
  const isCurrentMonth =
    selYear === now.getFullYear() && selMonth === now.getMonth();

  // ── Stats ────────────────────────────────────────────────────────────────────
  const activeCustomers = customers.filter((c) => !c.isArchived);

  // 1. ALL TIME
  let at_collected = 0,
    at_pending = 0,
    at_overdueMoney = 0,
    at_overdueCount = 0;
  let at_activeCount = 0,
    at_suspendedCount = 0,
    at_totalEver = 0;
  let at_pendingStatusBalance = 0,
    at_suspendedBalance = 0;

  activeCustomers.forEach((c) => {
    if (c.status === "active") at_activeCount++;
    if (c.status === "suspended") at_suspendedCount++;
    const cycle = getLatestCycle(cycles, c.id);
    if (!cycle) return;
    at_collected += cycle.amountPaid || 0;
    at_pending += cycle.amountPending || 0;
    const bal = cycle.amountPending || 0;
    if (bal > 0) {
      if (c.status === "suspended") at_suspendedBalance += bal;
      else at_pendingStatusBalance += bal;
    }
    const days = daysUntil(cycle.cycleEndDate);
    if (cycle.amountPending > 0 && days < 0) {
      at_overdueCount++;
      at_overdueMoney += cycle.amountPending;
    }
  });

  cycles.forEach((cy) => {
    (cy.installments || []).forEach((inst) => {
      at_totalEver += inst.amountPaid || 0;
    });
  });

  // Warehouse stock value = money you already spent buying materials still sitting in your store.
  // This IS your cost. You paid PKR 19,000 for cable — that PKR 19,000 is gone from your pocket.
  // As you issue cable and collect the cable money from subscribers (included in their payment),
  // the warehouse stock decreases and Net Income naturally improves.
  const at_inventoryValue = inventoryItems.reduce(
    (s, i) => s + (i.inHand ?? 0) * (i.unitRate || 0),
    0,
  );
  const at_totalExpenses = expenses.reduce(
    (s, e) => s + (Number(e.amount) || 0),
    0,
  );

  const allTime = {
    totalCustomers: activeCustomers.length,
    activeCount: at_activeCount,
    suspendedCount: at_suspendedCount,
    collected: at_collected,
    pending: at_pending,
    overdueMoney: at_overdueMoney,
    totalEverCollected: at_totalEver,
    overdueCount: at_overdueCount,
    pendingStatusBalance: at_pendingStatusBalance,
    suspendedBalance: at_suspendedBalance,
    totalExpenses: at_totalExpenses,
    inventoryValue: at_inventoryValue,
    // Net Income = Total ever received − Recorded expenses − Current warehouse stock value
    // The warehouse stock IS a cost you have already paid. As subscribers pay you for
    // materials (included in their connection fee), your "Ever Collected" goes up and
    // the warehouse stock goes down — so Net Income grows naturally. Correct!
    netIncome: at_totalEver - at_totalExpenses - at_inventoryValue,
  };

  // 2. MONTHLY
  const monthStart = new Date(selYear, selMonth, 1);
  const monthEnd = new Date(selYear, selMonth + 1, 0, 23, 59, 59);
  let mo_collected = 0,
    mo_pending = 0,
    mo_overdueMoney = 0,
    mo_newCustomers = 0;
  let mo_clearedCount = 0,
    mo_pendingCount = 0,
    mo_overdueCount = 0;

  activeCustomers.forEach((c) => {
    if (c.createdAt) {
      const d = new Date(c.createdAt);
      if (d >= monthStart && d <= monthEnd) mo_newCustomers++;
    }
    const cycle = getLatestCycle(cycles, c.id);
    if (!cycle) return;
    const cycleStart = new Date(cycle.cycleStartDate);
    const cycleEnd = new Date(cycle.cycleEndDate);
    if (cycleStart > monthEnd || cycleEnd < monthStart) return;
    mo_collected += cycle.amountPaid || 0;
    mo_pending += cycle.amountPending || 0;
    const days = daysUntil(cycle.cycleEndDate);
    if (cycle.amountPending === 0) mo_clearedCount++;
    else if (days < 0) {
      mo_overdueCount++;
      mo_overdueMoney += cycle.amountPending;
    } else mo_pendingCount++;
  });

  const mo_expenses = expenses
    .filter((e) => {
      const d = new Date(e.date);
      return d >= monthStart && d <= monthEnd;
    })
    .reduce((s, e) => s + (Number(e.amount) || 0), 0);

  const mo_inventoryValue = inventoryItems
    .filter((i) => {
      const d = new Date(i.date);
      return d >= monthStart && d <= monthEnd;
    })
    .reduce((s, i) => s + (i.inHand ?? 0) * (i.unitRate || 0), 0);

  let mo_totalCollected = 0;
  cycles.forEach((cy) => {
    (cy.installments || []).forEach((inst) => {
      const d = new Date(inst.datePaid);
      if (d >= monthStart && d <= monthEnd)
        mo_totalCollected += inst.amountPaid || 0;
    });
  });

  const monthly = {
    collected: mo_collected,
    totalCollected: mo_totalCollected,
    pending: mo_pending,
    overdueMoney: mo_overdueMoney,
    newCustomers: mo_newCustomers,
    clearedCount: mo_clearedCount,
    pendingCount: mo_pendingCount,
    overdueCount: mo_overdueCount,
    totalExpenses: mo_expenses,
    inventoryValue: mo_inventoryValue,
    netIncome: mo_totalCollected - mo_expenses - mo_inventoryValue,
    pendingStatusBalance: 0,
    suspendedBalance: 0,
  };

  // 3. DAILY
  let day_collected = 0,
    day_newCustomers = 0;
  cycles.forEach((cy) => {
    (cy.installments || []).forEach((inst) => {
      if (inst.datePaid === selDate) day_collected += inst.amountPaid || 0;
    });
  });
  activeCustomers.forEach((c) => {
    if (c.createdAt && c.createdAt.startsWith(selDate)) day_newCustomers++;
  });
  const day_expenses = expenses
    .filter((e) => e.date === selDate)
    .reduce((s, e) => s + (Number(e.amount) || 0), 0);
  const day_inventoryValue = inventoryItems
    .filter((i) => i.date === selDate)
    .reduce((s, i) => s + (i.inHand ?? 0) * (i.unitRate || 0), 0);

  const daily = {
    collected: day_collected,
    newCustomers: day_newCustomers,
    totalExpenses: day_expenses,
    inventoryValue: day_inventoryValue,
    netIncome: day_collected - day_expenses - day_inventoryValue,
  };

  // ── Alerts ───────────────────────────────────────────────────────────────────
  const outOfStockInventory = inventoryItems.filter(
    (i) => (i.inHand ?? 0) <= 0 && (i.quantity || 0) > 0,
  );
  const lowStockInventory = inventoryItems.filter((i) => {
    if (!i.quantity) return false;
    const ratio = (i.inHand ?? 0) / i.quantity;
    return ratio <= 0.2 && (i.inHand ?? 0) > 0;
  });

  const urgentCustomers = activeCustomers
    .map((c) => ({ customer: c, cycle: getLatestCycle(cycles, c.id) }))
    .filter(({ cycle }) => {
      if (!cycle) return true;
      const days = daysUntil(cycle.cycleEndDate);
      return days < 0 || days <= 5;
    })
    .sort((a, b) => {
      const da = a.cycle ? daysUntil(a.cycle.cycleEndDate) : -999;
      const db2 = b.cycle ? daysUntil(b.cycle.cycleEndDate) : -999;
      return da - db2;
    });

  const displayStats = mode === "monthly" ? monthly : allTime;
  const totalAttentionCount =
    urgentCustomers.length +
    outOfStockInventory.length +
    lowStockInventory.length;

  return (
    <div className="p-5 space-y-5 max-w-7xl mx-auto">
      {/* HEADER */}
      <div className="flex items-center justify-between flex-wrap gap-4">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Dashboard</h1>
          <p className="text-sm text-gray-500 mt-0.5">{today()}</p>
        </div>
        <div className="flex items-center gap-1 bg-gray-200 rounded-lg p-1">
          {["alltime", "monthly", "daily"].map((m) => (
            <button
              key={m}
              onClick={() => setMode(m)}
              className={`px-4 py-1.5 rounded-md text-sm font-semibold ${mode === m ? "bg-white text-gray-900 shadow" : "text-gray-500 hover:text-gray-800"}`}
            >
              {m === "alltime"
                ? "All Time"
                : m === "monthly"
                  ? "Monthly"
                  : "Daily"}
            </button>
          ))}
        </div>
      </div>

      {/* FILTERS */}
      {mode === "monthly" && (
        <div className="flex items-center gap-3 bg-white border-2 border-gray-200 rounded-xl px-4 py-3 w-fit">
          <button
            onClick={prevMonth}
            className="p-1 rounded-lg hover:bg-gray-100 text-gray-700"
          >
            <ChevronLeft size={20} />
          </button>
          <div className="flex items-center gap-2 min-w-43 justify-center">
            <Calendar size={17} className="text-blue-600" />
            <span className="font-bold text-gray-900 text-lg">
              {MONTH_NAMES[selMonth]} {selYear}
            </span>
          </div>
          <button
            onClick={nextMonth}
            disabled={isCurrentMonth}
            className="p-1 rounded-lg hover:bg-gray-100 text-gray-700 disabled:opacity-30 disabled:cursor-not-allowed"
          >
            <ChevronRight size={20} />
          </button>
        </div>
      )}

      {mode === "daily" && (
        <div className="flex items-center gap-3 bg-white border-2 border-gray-200 rounded-xl px-4 py-2 w-fit">
          <Calendar size={18} className="text-blue-600" />
          <input
            type="date"
            value={selDate}
            max={today()}
            onChange={(e) => setSelDate(e.target.value)}
            className="font-bold text-gray-900 text-lg outline-none cursor-pointer"
          />
        </div>
      )}

      {/* CARDS */}
      {mode !== "daily" ? (
        <>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <BigCard
              icon={<Users size={16} />}
              label="Total Subscribers"
              value={
                mode === "monthly"
                  ? monthly.newCustomers
                  : allTime.totalCustomers
              }
              sub={
                mode === "monthly"
                  ? "Joined this month"
                  : `${allTime.activeCount} active`
              }
              color="blue"
            />
            <BigCard
              icon={<CheckCircle size={16} />}
              label={
                mode === "monthly" ? "Collected This Month" : "Ever Collected"
              }
              value={`PKR ${(mode === "monthly" ? monthly.totalCollected : allTime.totalEverCollected).toLocaleString()}`}
              sub={
                mode === "monthly"
                  ? "Payments received this month"
                  : "Sum of all payments ever received"
              }
              color="green"
              isSensitive={true}
              infoContent={
                mode === "alltime"
                  ? {
                      type: "everCollected",
                      totalCycles: cycles.length,
                      totalSubscribers: activeCustomers.length,
                      pendingBalance: allTime.pending,
                    }
                  : null
              }
            />
            <BigCard
              icon={<XCircle size={16} />}
              label="Total Expenses"
              value={`PKR ${((displayStats.totalExpenses || 0) + (displayStats.inventoryValue || 0)).toLocaleString()}`}
              sub="Recorded expenses"
              color="red"
              inventoryValue={displayStats.inventoryValue || 0}
              expensesValue={displayStats.totalExpenses || 0}
            />
            <BigCard
              icon={<Clock size={16} />}
              label="Total Balance Due"
              value={`PKR ${displayStats.pending.toLocaleString()}`}
              sub="Click to view all"
              color="amber"
              onClick={() => onNavigate("customers", "balance-due")}
              isClickable
              pendingStatusBalance={displayStats.pendingStatusBalance || 0}
              suspendedBalance={displayStats.suspendedBalance || 0}
            />
          </div>

          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            <BigCard
              icon={<Users size={16} />}
              label="Expired Accounts"
              value={displayStats.overdueCount}
              sub="Cycle ended + unpaid balance"
              color="red"
              highlight={displayStats.overdueCount > 0}
              onClick={() => onNavigate("customers", "expired")}
              isClickable
            />
            <BigCard
              icon={<AlertTriangle size={16} />}
              label="Total Expired Balance"
              value={`PKR ${displayStats.overdueMoney.toLocaleString()}`}
              sub="Expired cycles with unpaid balance"
              color="red"
              highlight={displayStats.overdueMoney > 0}
              onClick={() => onNavigate("customers", "expired")}
              isClickable
            />
            <BigCard
              icon={<TrendingUp size={16} />}
              label="Net Income"
              value={`PKR ${(mode === "monthly" ? monthly.netIncome : allTime.netIncome).toLocaleString()}`}
              sub="Collected − expenses − warehouse stock"
              color={
                (mode === "monthly" ? monthly.netIncome : allTime.netIncome) >=
                0
                  ? "green"
                  : "red"
              }
              isSensitive={true}
              infoContent={{
                type: "netIncome",
                collected:
                  mode === "monthly"
                    ? monthly.totalCollected
                    : allTime.totalEverCollected,
                expenses:
                  mode === "monthly"
                    ? monthly.totalExpenses
                    : allTime.totalExpenses,
                warehouseStock:
                  mode === "monthly"
                    ? monthly.inventoryValue
                    : allTime.inventoryValue,
              }}
            />
          </div>
        </>
      ) : (
        <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
          <BigCard
            icon={<CreditCard size={16} />}
            label="Collected Today"
            value={`PKR ${daily.collected.toLocaleString()}`}
            sub={`Payments received on ${formatDate(selDate)}`}
            color="green"
            isSensitive={true}
          />
          <BigCard
            icon={<XCircle size={16} />}
            label="Expenses Today"
            value={`PKR ${(daily.totalExpenses + (daily.inventoryValue || 0)).toLocaleString()}`}
            sub={`Expenses + new stock on ${formatDate(selDate)}`}
            color="red"
            inventoryValue={daily.inventoryValue || 0}
            expensesValue={daily.totalExpenses || 0}
          />
          <BigCard
            icon={<TrendingUp size={16} />}
            label="Daily Net Income"
            value={`PKR ${daily.netIncome.toLocaleString()}`}
            sub="Collected − expenses − new stock"
            color={daily.netIncome >= 0 ? "green" : "red"}
            isSensitive={true}
          />
          <BigCard
            icon={<Users size={16} />}
            label="New Subscribers"
            value={daily.newCustomers}
            sub="Joined today"
            color="blue"
          />
        </div>
      )}

      {/* NEEDS ATTENTION */}
      <div>
        <h2 className="text-lg font-bold text-gray-900 flex items-center gap-2 mb-3">
          <AlertTriangle size={18} className="text-red-500" />
          Needs Attention
          {totalAttentionCount > 0 && (
            <span className="bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full">
              {totalAttentionCount}
            </span>
          )}
        </h2>

        {outOfStockInventory.map((item) => (
          <div
            key={`oos-${item.id}`}
            className="bg-red-50 border-2 border-red-200 rounded-xl px-5 py-3 flex items-center justify-between gap-3 mb-3"
          >
            <div className="flex items-center gap-3">
              <Package size={18} className="text-red-500 shrink-0" />
              <div>
                <span className="font-bold text-red-700 text-sm">
                  {item.description}
                </span>
                <span className="text-xs text-red-500 ml-2">
                  — Out of Stock. 0 {item.unit} remaining. Restock required.
                </span>
              </div>
            </div>
            <button
              onClick={() => onNavigate("inventory")}
              className="flex items-center gap-1.5 px-3 py-1.5 text-xs font-semibold bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors whitespace-nowrap"
            >
              <RefreshCw size={11} /> Restock Now
            </button>
          </div>
        ))}

        {lowStockInventory.map((item) => (
          <div
            key={`low-${item.id}`}
            className="bg-amber-50 border-2 border-amber-200 rounded-xl px-5 py-3 flex items-center justify-between gap-3 mb-3"
          >
            <div className="flex items-center gap-3">
              <Package size={18} className="text-amber-500 shrink-0" />
              <div>
                <span className="font-bold text-amber-700 text-sm">
                  {item.description}
                </span>
                <span className="text-xs text-amber-600 ml-2">
                  — Low Stock: {item.inHand} {item.unit} left (
                  {Math.round(((item.inHand ?? 0) / item.quantity) * 100)}% of
                  original)
                </span>
              </div>
            </div>
            <button
              onClick={() => onNavigate("inventory")}
              className="flex items-center gap-1.5 px-3 py-1.5 text-xs font-semibold bg-amber-500 text-white rounded-lg hover:bg-amber-600 transition-colors whitespace-nowrap"
            >
              <RefreshCw size={11} /> Go to Inventory
            </button>
          </div>
        ))}

        {totalAttentionCount === 0 ? (
          <div className="bg-green-50 border-2 border-green-200 rounded-xl px-5 py-4 flex items-center gap-3">
            <CheckCircle size={22} className="text-green-600" />
            <span className="text-green-800 font-semibold text-base">
              All accounts are in good standing.
            </span>
          </div>
        ) : urgentCustomers.length > 0 ? (
          <div className="bg-white border-2 border-gray-200 rounded-xl overflow-hidden overflow-x-auto">
            <table className="w-full">
              <thead>
                <tr className="bg-gray-900 text-white text-left">
                  <th className="px-4 py-3 text-sm font-semibold">
                    Subscriber
                  </th>
                  <th className="px-4 py-3 text-sm font-semibold">Area</th>
                  <th className="px-4 py-3 text-sm font-semibold">Mobile</th>
                  <th className="px-4 py-3 text-sm font-semibold">
                    Cycle Ended
                  </th>
                  <th className="px-4 py-3 text-sm font-semibold">Days</th>
                  <th className="px-4 py-3 text-sm font-semibold">
                    Balance Due
                  </th>
                  <th className="px-4 py-3 text-sm font-semibold">Status</th>
                  <th className="px-4 py-3 text-sm font-semibold">Action</th>
                </tr>
              </thead>
              <tbody>
                {urgentCustomers.map(({ customer, cycle }) => {
                  if (!cycle)
                    return (
                      <tr
                        key={customer.id}
                        className="border-t border-gray-200 bg-gray-50"
                      >
                        <td className="px-4 py-3 font-bold text-gray-900">
                          {customer.fullName}
                        </td>
                        <td
                          colSpan={6}
                          className="px-4 py-3 text-sm text-gray-500"
                        >
                          No billing cycle — needs setup
                        </td>
                        <td className="px-4 py-3">
                          <button
                            onClick={() => setPayCustomer(customer)}
                            className="px-3 py-1.5 text-sm bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700"
                          >
                            Pay Now
                          </button>
                        </td>
                      </tr>
                    );

                  const days = daysUntil(cycle.cycleEndDate);
                  const isExpiredUnpaid = days < 0 && cycle.amountPending > 0;
                  const isExpiredPaid = days < 0 && cycle.amountPending === 0;
                  const isExpiringSoon = days >= 0 && days <= 5;

                  let waMessage = "";
                  if (isExpiredUnpaid)
                    waMessage = MESSAGE_TEMPLATES.paymentOverdue(
                      customer,
                      cycle,
                    );
                  else if (cycle.amountPending > 0)
                    waMessage = MESSAGE_TEMPLATES.paymentDue(customer, cycle);
                  else
                    waMessage = MESSAGE_TEMPLATES.expiryReminder(
                      customer,
                      cycle,
                    );

                  const showPayButton =
                    cycle.amountPending > 0 || isExpiredPaid;
                  const rowBg = isExpiredUnpaid
                    ? "bg-red-50"
                    : isExpiredPaid
                      ? "bg-orange-50"
                      : "bg-yellow-50";

                  return (
                    <tr
                      key={customer.id}
                      className={`border-t border-gray-200 ${rowBg}`}
                    >
                      <td className="px-4 py-3">
                        <div className="font-bold text-gray-900 text-sm">
                          {customer.fullName}
                        </div>
                        <div className="text-xs text-gray-500">
                          {customer.userName}
                        </div>
                      </td>
                      <td className="px-4 py-3 text-sm text-gray-800">
                        {customer.mainArea || "—"}
                      </td>
                      <td className="px-4 py-3 text-sm text-gray-800">
                        {customer.mobileNo || "—"}
                      </td>
                      <td className="px-4 py-3 text-sm text-gray-800">
                        {formatDate(cycle.cycleEndDate)}
                      </td>
                      <td className="px-4 py-3">
                        {isExpiredUnpaid && (
                          <span className="text-sm font-bold text-red-700">
                            {-days}d overdue
                          </span>
                        )}
                        {isExpiredPaid && (
                          <span className="text-sm font-bold text-orange-700">
                            {-days}d ago — needs renewal
                          </span>
                        )}
                        {isExpiringSoon && (
                          <span className="text-sm font-bold text-yellow-700">
                            {days}d left
                          </span>
                        )}
                      </td>
                      <td className="px-4 py-3">
                        {cycle.amountPending > 0 ? (
                          <span className="text-sm font-bold text-red-700">
                            PKR {Number(cycle.amountPending).toLocaleString()}
                          </span>
                        ) : (
                          <span className="text-sm font-semibold text-green-700">
                            Paid ✓
                          </span>
                        )}
                      </td>
                      <td className="px-4 py-3">
                        {isExpiredUnpaid && <Badge status="expired" />}
                        {isExpiredPaid && (
                          <span className="inline-block px-2 py-0.5 rounded text-xs font-medium bg-orange-100 text-orange-800">
                            Renewal Due
                          </span>
                        )}
                        {isExpiringSoon && <Badge status="pending" />}
                      </td>
                      <td className="px-4 py-3">
                        <div className="flex items-center gap-2">
                          {showPayButton && (
                            <button
                              onClick={() => setPayCustomer(customer)}
                              className="px-3 py-1.5 text-sm bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700"
                            >
                              {isExpiredPaid ? "Renew" : "Pay Now"}
                            </button>
                          )}
                          <WhatsAppButton
                            mobileNo={customer.mobileNo}
                            message={waMessage}
                            label="WhatsApp"
                          />
                        </div>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        ) : null}
      </div>

      <Modal
        isOpen={!!payCustomer}
        onClose={() => setPayCustomer(null)}
        title="Record Payment"
        size="md"
      >
        {payCustomer && (
          <PaymentForm
            customer={payCustomer}
            onClose={() => setPayCustomer(null)}
          />
        )}
      </Modal>
    </div>
  );
}

// ── Color map ─────────────────────────────────────────────────────────────────
const colorMap = {
  blue: {
    bg: "bg-blue-50 border border-blue-200",
    iconBox: "bg-blue-100",
    icon: "text-blue-600",
  },
  green: {
    bg: "bg-green-50 border border-green-200",
    iconBox: "bg-green-100",
    icon: "text-green-600",
  },
  amber: {
    bg: "bg-amber-50 border border-amber-200",
    iconBox: "bg-amber-100",
    icon: "text-amber-600",
  },
  red: {
    bg: "bg-red-50 border border-red-200",
    iconBox: "bg-red-100",
    icon: "text-red-600",
  },
};

// ── BigCard ───────────────────────────────────────────────────────────────────
function BigCard({
  icon,
  label,
  value,
  sub,
  color,
  highlight = false,
  isSensitive = false,
  onClick,
  isClickable = false,
  inventoryValue,
  expensesValue,
  pendingStatusBalance,
  suspendedBalance,
  infoContent,
}) {
  const c = colorMap[color] || colorMap.blue;
  const [revealed, setRevealed] = useState(false);
  const [showInfo, setShowInfo] = useState(false);
  const infoRef = useRef(null);

  // Close tooltip when clicking anywhere outside
  useEffect(() => {
    if (!showInfo) return;
    const handler = (e) => {
      if (infoRef.current && !infoRef.current.contains(e.target)) {
        setShowInfo(false);
      }
    };
    document.addEventListener("mousedown", handler);
    return () => document.removeEventListener("mousedown", handler);
  }, [showInfo]);

  const hasExpenseBreakdown =
    inventoryValue !== undefined && expensesValue !== undefined;
  const hasBalanceBreakdown =
    pendingStatusBalance !== undefined && suspendedBalance !== undefined;

  return (
    <div
      onClick={isClickable ? onClick : undefined}
      className={`rounded-xl px-4 py-3 ${c.bg} flex flex-col justify-between ${highlight ? "ring-2 ring-offset-1 ring-red-300" : ""} ${isClickable ? "cursor-pointer hover:shadow-md transition-shadow active:scale-95" : ""}`}
    >
      <div>
        <div className="flex items-center justify-between mb-2">
          <div
            className={`w-8 h-8 rounded-lg flex items-center justify-center ${c.iconBox} ${c.icon}`}
          >
            {icon}
          </div>
          <div className="flex items-center gap-1.5">
            {/* Info tooltip */}
            {infoContent && (
              <div className="relative" ref={infoRef}>
                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    setShowInfo((s) => !s);
                  }}
                  className="text-gray-400 hover:text-blue-500 transition-colors"
                  title="More info"
                >
                  <Info size={14} />
                </button>
                {showInfo && (
                  <div className="absolute right-0 top-6 z-50 bg-white border border-gray-200 rounded-xl shadow-xl p-3 w-68 text-xs">
                    {infoContent.type === "everCollected" && (
                      <>
                        <p className="font-bold text-gray-800 mb-2 text-sm">
                          📥 What is Ever Collected?
                        </p>
                        <p className="text-gray-600 leading-relaxed mb-2">
                          The total of all actual cash payments ever received
                          from subscribers — across every billing cycle since
                          day one.
                        </p>
                        <div className="space-y-1 border-t border-gray-100 pt-2">
                          <div className="flex justify-between">
                            <span className="text-gray-500">
                              Billing cycles total
                            </span>
                            <span className="font-semibold text-gray-700">
                              {infoContent.totalCycles}
                            </span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-gray-500">
                              Active subscribers
                            </span>
                            <span className="font-semibold text-gray-700">
                              {infoContent.totalSubscribers}
                            </span>
                          </div>
                          {infoContent.pendingBalance > 0 && (
                            <div className="flex justify-between text-amber-600">
                              <span>Still pending (not included)</span>
                              <span className="font-semibold">
                                PKR{" "}
                                {infoContent.pendingBalance.toLocaleString()}
                              </span>
                            </div>
                          )}
                        </div>
                        <p className="text-gray-400 mt-2 italic">
                          Inventory and expenses are NOT included here — they
                          show in the Expenses card.
                        </p>
                      </>
                    )}
                    {infoContent.type === "netIncome" && (
                      <>
                        <p className="font-bold text-gray-800 mb-2 text-sm">
                          📊 Net Income Breakdown
                        </p>
                        <div className="space-y-1.5">
                          <div className="flex justify-between text-green-700">
                            <span className="font-semibold">+ Collected</span>
                            <span className="font-bold">
                              PKR {infoContent.collected.toLocaleString()}
                            </span>
                          </div>
                          <div className="flex justify-between text-red-600">
                            <span>− Recorded Expenses</span>
                            <span className="font-semibold">
                              PKR {infoContent.expenses.toLocaleString()}
                            </span>
                          </div>
                          <div className="flex justify-between text-red-600">
                            <span>− Warehouse Stock</span>
                            <span className="font-semibold">
                              PKR {infoContent.warehouseStock.toLocaleString()}
                            </span>
                          </div>
                          <div className="border-t border-gray-200 pt-1.5 flex justify-between font-bold text-gray-800">
                            <span>= Net Income</span>
                            <span>
                              PKR{" "}
                              {(
                                infoContent.collected -
                                infoContent.expenses -
                                infoContent.warehouseStock
                              ).toLocaleString()}
                            </span>
                          </div>
                        </div>
                        <div className="mt-2 bg-blue-50 border border-blue-100 rounded-lg px-2.5 py-2 text-blue-700 leading-relaxed">
                          <p className="font-semibold text-xs mb-0.5">
                            Why does issuing stock increase Net Income?
                          </p>
                          <p className="text-xs">
                            When you issue cable and the technician collects the
                            cable money from the subscriber (included in their
                            payment), your "Ever Collected" goes up AND your
                            warehouse stock goes down — so Net Income grows.
                            This is correct!
                          </p>
                        </div>
                      </>
                    )}
                  </div>
                )}
              </div>
            )}
            {isSensitive && (
              <button
                onClick={(e) => {
                  e.stopPropagation();
                  setRevealed(!revealed);
                }}
                className="text-gray-400 hover:text-gray-600 transition-colors"
                title={revealed ? "Hide Amount" : "Show Amount"}
              >
                {revealed ? <EyeOff size={15} /> : <Eye size={15} />}
              </button>
            )}
          </div>
        </div>
        <div className="text-xs font-semibold text-gray-500 uppercase tracking-wide">
          {label}
        </div>
      </div>

      <div className="mt-1">
        <div
          className={`font-bold text-gray-900 leading-tight ${String(value).length > 12 ? "text-base" : "text-lg"}`}
        >
          {isSensitive && !revealed ? (
            <span className="tracking-widest text-gray-400">••••••</span>
          ) : (
            value
          )}
        </div>
        {hasExpenseBreakdown ? (
          <div className="mt-1 space-y-0.5">
            <div className="flex items-center justify-between text-xs">
              <span className="text-gray-500 font-medium">
                Recorded expenses
              </span>
              <span className="font-semibold text-gray-700">
                PKR {expensesValue.toLocaleString()}
              </span>
            </div>
            <div className="flex items-center justify-between text-xs">
              <span className="flex items-center gap-1 text-blue-600 font-semibold">
                <span className="inline-block w-1.5 h-1.5 rounded-full bg-blue-500"></span>
                Inventory Stock
              </span>
              <span className="font-semibold text-blue-600">
                PKR {inventoryValue.toLocaleString()}
              </span>
            </div>
          </div>
        ) : hasBalanceBreakdown ? (
          <div className="mt-1 space-y-0.5">
            {pendingStatusBalance > 0 && (
              <div className="flex items-center justify-between text-xs">
                <span className="flex items-center gap-1 text-amber-600 font-medium">
                  <span className="inline-block w-1.5 h-1.5 rounded-full bg-amber-400"></span>
                  Pending
                </span>
                <span className="font-semibold text-amber-700">
                  PKR {pendingStatusBalance.toLocaleString()}
                </span>
              </div>
            )}
            {suspendedBalance > 0 && (
              <div className="flex items-center justify-between text-xs">
                <span className="flex items-center gap-1 text-orange-600 font-medium">
                  <span className="inline-block w-1.5 h-1.5 rounded-full bg-orange-400"></span>
                  Suspended
                </span>
                <span className="font-semibold text-orange-700">
                  PKR {suspendedBalance.toLocaleString()}
                </span>
              </div>
            )}
            <div className="text-xs text-gray-400 mt-0.5">
              Click to view all
            </div>
          </div>
        ) : (
          <div className="text-xs text-gray-500 mt-0.5 font-medium">{sub}</div>
        )}
      </div>
    </div>
  );
}
</file>

</files>
