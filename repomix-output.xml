This file is a merged representation of a subset of the codebase, containing specifically included files, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Only files matching these patterns are included: **/*.{js,jsx}
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
eslint.config.js
src/App.jsx
src/components/layout/Navbar.jsx
src/components/shared/WhatsAppButton.jsx
src/components/ui/BackupBanner.jsx
src/components/ui/Badge.jsx
src/components/ui/ConfirmDialog.jsx
src/components/ui/HistoryModal.jsx
src/components/ui/InvoiceModal.jsx
src/components/ui/Modal.jsx
src/config/messageTemplates.js
src/db/database.js
src/main.jsx
src/pages/Customers/CustomerForm.jsx
src/pages/Customers/Customers.jsx
src/pages/Customers/CustomerTable.jsx
src/pages/Dashboard.jsx
src/pages/Expenses/ExpenseForm.jsx
src/pages/Expenses/Expenses.jsx
src/pages/Inventory/Inventory.jsx
src/pages/Inventory/InventoryForm.jsx
src/pages/Login.jsx
src/pages/Payments/PaymentForm.jsx
src/pages/Settings.jsx
src/store/useCustomerStore.js
src/store/useExpenseStore.js
src/store/useInventoryStore.js
src/store/usePackageStore.js
src/store/usePaymentStore.js
src/utils/backup.js
src/utils/dateUtils.js
src/utils/devTools.js
src/utils/duplicateCheck.js
vite.config.js
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="src/components/ui/InvoiceModal.jsx">
// src/components/ui/InvoiceModal.jsx

import { useRef } from "react";
import { toPng } from "html-to-image";
import {
  X,
  Printer,
  Wifi,
  CheckCircle2,
  AlertCircle,
  CornerDownRight,
  ImageDown,
} from "lucide-react";
import { formatDate } from "../../utils/dateUtils";

// ‚îÄ‚îÄ Invoice number ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function invoiceNumber(cycle) {
  const year = cycle.cycleStartDate?.slice(0, 4) || new Date().getFullYear();
  const seq = String(cycle.id).padStart(4, "0");
  return `INV-${year}-${seq}`;
}

// ‚îÄ‚îÄ Scenario detector ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getScenario(cycle) {
  if (!cycle.isRenewal) return "new";
  if (Number(cycle.previousBalance) > 0) return "renewal_with_dues";
  return "renewal_clean";
}

const SCENARIO_LABELS = {
  new: {
    label: "New Connection",
    color: "#1d4ed8",
    bg: "#eff6ff",
    border: "#bfdbfe",
  },
  renewal_with_dues: {
    label: "Renewal ‚Äî Previous Balance Included",
    color: "#c2410c",
    bg: "#fff7ed",
    border: "#fed7aa",
  },
  renewal_clean: {
    label: "Renewal",
    color: "#15803d",
    bg: "#f0fdf4",
    border: "#bbf7d0",
  },
};

// ‚îÄ‚îÄ Print via new tab ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildInvoiceHTML({
  invNo,
  scenarioMeta,
  customer,
  cycle,
  packageName,
  packagePrice,
  previousBalance,
  totalAmount,
  amountPaid,
  amountPending,
  installments,
}) {
  const isPaid = amountPending === 0;

  const installmentRows = installments
    .map(
      (inst) => `
    <tr>
      <td style="padding:6px 0; color:#374151; font-size:13px;">
        ${formatDate(inst.datePaid)}${inst.note ? ` ¬∑ <span style="color:#9ca3af">${inst.note}</span>` : ""}
      </td>
      <td style="padding:6px 0; text-align:right; font-weight:600; color:#15803d; font-size:13px;">
        PKR ${Number(inst.amountPaid).toLocaleString()}
      </td>
    </tr>
  `,
    )
    .join("");

  const installmentsSection =
    installments.length > 0
      ? `
    <div style="border:1px solid #e5e7eb; border-radius:10px; overflow:hidden; margin-bottom:16px;">
      <div style="background:#f9fafb; padding:8px 16px; border-bottom:1px solid #e5e7eb;">
        <p style="margin:0; font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:.08em; color:#9ca3af;">Payments Received</p>
      </div>
      <div style="padding:10px 16px;">
        <table style="width:100%; border-collapse:collapse;">
          ${installmentRows}
          <tr style="border-top:1px solid #f3f4f6;">
            <td style="padding-top:8px; font-weight:600; color:#374151; font-size:13px;">Total Paid</td>
            <td style="padding-top:8px; text-align:right; font-weight:700; color:#15803d; font-size:13px;">PKR ${amountPaid.toLocaleString()}</td>
          </tr>
        </table>
      </div>
    </div>
  `
      : "";

  const statusBar = isPaid
    ? `
    <div style="display:flex; align-items:center; gap:12px; background:#f0fdf4; border:1px solid #bbf7d0; border-radius:10px; padding:12px 16px;">
      <div style="font-size:20px;">‚úÖ</div>
      <div>
        <p style="margin:0; font-weight:700; color:#166534; font-size:14px;">Paid in Full</p>
        <p style="margin:2px 0 0; color:#16a34a; font-size:12px;">No outstanding balance. Thank you!</p>
      </div>
    </div>
  `
    : `
    <div style="display:flex; align-items:center; justify-content:space-between; background:#fef2f2; border:1px solid #fecaca; border-radius:10px; padding:12px 16px;">
      <div style="display:flex; align-items:center; gap:12px;">
        <div style="font-size:20px;">‚ö†Ô∏è</div>
        <div>
          <p style="margin:0; font-weight:700; color:#991b1b; font-size:14px;">Balance Due</p>
          <p style="margin:2px 0 0; color:#dc2626; font-size:12px;">Please pay at your earliest convenience.</p>
        </div>
      </div>
      <p style="margin:0; font-weight:900; color:#b91c1c; font-size:20px;">PKR ${amountPending.toLocaleString()}</p>
    </div>
  `;

  const prevBalanceRow =
    previousBalance > 0
      ? `
    <tr>
      <td style="padding:5px 0; color:#c2410c; font-size:13px;">‚Ü© Previous unpaid balance</td>
      <td style="padding:5px 0; text-align:right; font-weight:600; color:#c2410c; font-size:13px;">+ PKR ${previousBalance.toLocaleString()}</td>
    </tr>
  `
      : "";

  return `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8"/>
  <title>Invoice ${invNo}</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; color: #1f2937; background: #fff; padding: 24px; font-size: 14px; }
    @page { margin: 12mm; }
  </style>
</head>
<body>

  <!-- Header -->
  <div style="display:flex; justify-content:space-between; align-items:flex-start; padding-bottom:16px; border-bottom:2px solid #1f2937; margin-bottom:20px;">
    <div>
      <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
        <span style="font-size:22px;">üì°</span>
        <span style="font-size:22px; font-weight:900; letter-spacing:-0.5px;">Galaxy ISP</span>
      </div>
      <p style="color:#6b7280; font-size:12px;">Internet Service Provider</p>
    </div>
    <div style="text-align:right;">
      <p style="font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:.1em; color:#9ca3af; margin-bottom:2px;">Invoice</p>
      <p style="font-size:17px; font-weight:900;">${invNo}</p>
      <p style="font-size:12px; color:#6b7280; margin-top:2px;">Issued: ${formatDate(cycle.cycleStartDate)}</p>
    </div>
  </div>

  <!-- Scenario badge -->
  <div style="display:inline-flex; align-items:center; gap:6px; background:${scenarioMeta.bg}; border:1px solid ${scenarioMeta.border}; border-radius:8px; padding:6px 12px; margin-bottom:20px;">
    <span style="font-size:11px; font-weight:700; color:${scenarioMeta.color};">${scenarioMeta.label}</span>
  </div>

  <!-- Customer info -->
  <table style="width:100%; border-collapse:collapse; margin-bottom:20px;">
    <tr>
      <td style="width:50%; vertical-align:top; padding-bottom:12px;">
        <p style="font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:.08em; color:#9ca3af; margin-bottom:3px;">Customer</p>
        <p style="font-size:15px; font-weight:700; color:#111827;">${customer.fullName}</p>
        <p style="font-size:12px; color:#6b7280;">${customer.userName}</p>
      </td>
      <td style="width:50%; vertical-align:top; padding-bottom:12px;">
        <p style="font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:.08em; color:#9ca3af; margin-bottom:3px;">Contact</p>
        <p style="font-size:13px; color:#374151;">${customer.mobileNo || "‚Äî"}</p>
        <p style="font-size:12px; color:#6b7280;">${customer.mainArea || "‚Äî"}</p>
      </td>
    </tr>
    <tr>
      <td style="vertical-align:top;">
        <p style="font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:.08em; color:#9ca3af; margin-bottom:3px;">Package</p>
        <p style="font-size:13px; font-weight:600; color:#374151;">${packageName || "‚Äî"}</p>
      </td>
      <td style="vertical-align:top;">
        <p style="font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:.08em; color:#9ca3af; margin-bottom:3px;">Billing Period</p>
        <p style="font-size:13px; color:#374151;">${formatDate(cycle.cycleStartDate)} ‚Üí ${formatDate(cycle.cycleEndDate)}</p>
      </td>
    </tr>
  </table>

  <!-- Billing breakdown -->
  <div style="border:1px solid #e5e7eb; border-radius:10px; overflow:hidden; margin-bottom:16px;">
    <div style="background:#f9fafb; padding:8px 16px; border-bottom:1px solid #e5e7eb;">
      <p style="margin:0; font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:.08em; color:#9ca3af;">Billing Breakdown</p>
    </div>
    <div style="padding:10px 16px;">
      <table style="width:100%; border-collapse:collapse;">
        <tr>
          <td style="padding:5px 0; color:#4b5563; font-size:13px;">Package charge (${packageName})</td>
          <td style="padding:5px 0; text-align:right; font-weight:600; color:#1f2937; font-size:13px;">PKR ${packagePrice.toLocaleString()}</td>
        </tr>
        ${prevBalanceRow}
        <tr style="border-top:1px solid #e5e7eb;">
          <td style="padding-top:10px; font-weight:700; color:#1f2937; font-size:14px;">Total Due</td>
          <td style="padding-top:10px; text-align:right; font-weight:900; color:#111827; font-size:16px;">PKR ${totalAmount.toLocaleString()}</td>
        </tr>
      </table>
    </div>
  </div>

  ${installmentsSection}
  ${statusBar}

  <!-- Footer -->
  <div style="margin-top:28px; padding-top:12px; border-top:1px solid #e5e7eb; text-align:center;">
    <p style="font-size:10px; color:#9ca3af;">Galaxy ISP ¬∑ Thank you for your business</p>
    <p style="font-size:10px; color:#d1d5db; margin-top:3px;">This is a computer-generated invoice ‚Äî no signature required.</p>
  </div>

</body>
</html>`;
}

function printInvoice(htmlString) {
  const tab = window.open("", "_blank");
  if (!tab) {
    alert("Please allow pop-ups for this site to enable printing.");
    return;
  }
  tab.document.open();
  tab.document.write(htmlString);
  tab.document.close();
  tab.onload = () => {
    tab.focus();
    tab.print();
    tab.onafterprint = () => tab.close();
  };
}

// ‚îÄ‚îÄ Main component ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
export default function InvoiceModal({
  isOpen,
  onClose,
  customer,
  cycle,
  packageName,
}) {
  const invoiceRef = useRef(null);

  if (!isOpen || !customer || !cycle) return null;

  const scenario = getScenario(cycle);
  const scenarioMeta = SCENARIO_LABELS[scenario];
  const invNo = invoiceNumber(cycle);

  const packagePrice =
    Number(cycle.totalAmount) - Number(cycle.previousBalance || 0);
  const previousBalance = Number(cycle.previousBalance || 0);
  const totalAmount = Number(cycle.totalAmount);
  const amountPaid = Number(cycle.amountPaid || 0);
  const amountPending = Number(cycle.amountPending || 0);
  const installments = cycle.installments || [];
  const isPaid = amountPending === 0;

  const invoiceProps = {
    invNo,
    scenarioMeta,
    customer,
    cycle,
    packageName,
    packagePrice,
    previousBalance,
    totalAmount,
    amountPaid,
    amountPending,
    installments,
  };

  const handlePrint = () => {
    const html = buildInvoiceHTML(invoiceProps);
    printInvoice(html);
  };

  const handleSavePng = () => {
    toPng(invoiceRef.current, { pixelRatio: 3 }).then((dataUrl) => {
      const link = document.createElement("a");
      link.download = `${invNo}.png`;
      link.href = dataUrl;
      link.click();
    });
  };

  return (
    <div
      className="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
      onClick={(e) => {
        if (e.target === e.currentTarget) onClose();
      }}
    >
      <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 max-h-[92vh] flex flex-col">
        {/* Modal header */}
        <div className="flex items-center justify-between px-5 py-3 border-b border-gray-200 shrink-0">
          <h2 className="text-sm font-semibold text-gray-700">
            Invoice Preview
          </h2>
          <div className="flex items-center gap-2">
            <button
              onClick={handleSavePng}
              className="flex items-center gap-1.5 px-3 py-1.5 text-xs font-semibold bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
            >
              <ImageDown size={13} />
              Save PNG
            </button>
            <button
              onClick={handlePrint}
              className="flex items-center gap-1.5 px-3 py-1.5 text-xs font-semibold bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
            >
              <Printer size={13} />
              Print / Save PDF
            </button>
            <button
              onClick={onClose}
              className="text-gray-400 hover:text-gray-600 p-1 rounded"
            >
              <X size={16} />
            </button>
          </div>
        </div>

        {/* Scrollable invoice preview */}
        <div className="overflow-y-auto flex-1 p-5">
          <div
            ref={invoiceRef}
            className="bg-white p-6 font-sans text-gray-800 text-sm"
          >
            {/* Header */}
            <div className="flex items-start justify-between mb-5 pb-4 border-b-2 border-gray-800">
              <div>
                <div className="flex items-center gap-2 mb-1">
                  <Wifi size={20} className="text-blue-600" />
                  <span className="text-xl font-black text-gray-900 tracking-tight">
                    Galaxy ISP
                  </span>
                </div>
                <p className="text-xs text-gray-500">
                  Internet Service Provider
                </p>
              </div>
              <div className="text-right">
                <p className="text-[10px] font-bold uppercase text-gray-400 tracking-widest mb-0.5">
                  Invoice
                </p>
                <p className="text-base font-black text-gray-900">{invNo}</p>
                <p className="text-xs text-gray-500 mt-0.5">
                  Issued: {formatDate(cycle.cycleStartDate)}
                </p>
              </div>
            </div>

            {/* Scenario badge */}
            <div
              className="inline-flex items-center gap-1.5 rounded-lg px-3 py-1.5 mb-4 border text-xs font-semibold"
              style={{
                background: scenarioMeta.bg,
                borderColor: scenarioMeta.border,
                color: scenarioMeta.color,
              }}
            >
              {scenario === "new" && <Wifi size={12} />}
              {scenario === "renewal_clean" && <CheckCircle2 size={12} />}
              {scenario === "renewal_with_dues" && (
                <CornerDownRight size={12} />
              )}
              {scenarioMeta.label}
            </div>

            {/* Customer info */}
            <div className="grid grid-cols-2 gap-x-6 gap-y-3 mb-5 text-xs">
              <div>
                <p className="text-[10px] font-bold uppercase text-gray-400 tracking-wide mb-0.5">
                  Customer
                </p>
                <p className="font-bold text-gray-900 text-sm">
                  {customer.fullName}
                </p>
                <p className="text-gray-500">{customer.userName}</p>
              </div>
              <div>
                <p className="text-[10px] font-bold uppercase text-gray-400 tracking-wide mb-0.5">
                  Contact
                </p>
                <p className="text-gray-700">{customer.mobileNo || "‚Äî"}</p>
                <p className="text-gray-500">{customer.mainArea || "‚Äî"}</p>
              </div>
              <div>
                <p className="text-[10px] font-bold uppercase text-gray-400 tracking-wide mb-0.5">
                  Package
                </p>
                <p className="text-gray-700 font-medium">
                  {packageName || "‚Äî"}
                </p>
              </div>
              <div>
                <p className="text-[10px] font-bold uppercase text-gray-400 tracking-wide mb-0.5">
                  Billing Period
                </p>
                <p className="text-gray-700">
                  {formatDate(cycle.cycleStartDate)} ‚Üí{" "}
                  {formatDate(cycle.cycleEndDate)}
                </p>
              </div>
            </div>

            {/* Billing breakdown */}
            <div className="border border-gray-200 rounded-xl overflow-hidden mb-4">
              <div className="bg-gray-50 px-4 py-2 border-b border-gray-200">
                <p className="text-[10px] font-bold uppercase text-gray-400 tracking-widest">
                  Billing Breakdown
                </p>
              </div>
              <div className="px-4 py-3 space-y-2">
                <div className="flex justify-between items-center text-sm">
                  <span className="text-gray-600">
                    Package charge ({packageName})
                  </span>
                  <span className="font-semibold text-gray-800">
                    PKR {packagePrice.toLocaleString()}
                  </span>
                </div>
                {previousBalance > 0 && (
                  <div className="flex justify-between items-center text-sm">
                    <span className="text-orange-600 flex items-center gap-1.5">
                      <CornerDownRight size={12} /> Previous unpaid balance
                    </span>
                    <span className="font-semibold text-orange-700">
                      + PKR {previousBalance.toLocaleString()}
                    </span>
                  </div>
                )}
                <div className="border-t border-gray-200 pt-2 flex justify-between items-center">
                  <span className="font-bold text-gray-800">Total Due</span>
                  <span className="font-black text-gray-900 text-base">
                    PKR {totalAmount.toLocaleString()}
                  </span>
                </div>
              </div>
            </div>

            {/* Payments received */}
            {installments.length > 0 && (
              <div className="border border-gray-200 rounded-xl overflow-hidden mb-4">
                <div className="bg-gray-50 px-4 py-2 border-b border-gray-200">
                  <p className="text-[10px] font-bold uppercase text-gray-400 tracking-widest">
                    Payments Received
                  </p>
                </div>
                <div className="px-4 py-3 space-y-2">
                  {installments.map((inst, i) => (
                    <div
                      key={inst.id || i}
                      className="flex justify-between items-center text-sm"
                    >
                      <div className="flex items-center gap-2">
                        <CheckCircle2
                          size={13}
                          className="text-green-500 shrink-0"
                        />
                        <span className="text-gray-600">
                          {formatDate(inst.datePaid)}
                          {inst.note && (
                            <span className="text-gray-400 ml-1">
                              ¬∑ {inst.note}
                            </span>
                          )}
                        </span>
                      </div>
                      <span className="font-semibold text-green-700">
                        PKR {Number(inst.amountPaid).toLocaleString()}
                      </span>
                    </div>
                  ))}
                  <div className="border-t border-gray-100 pt-2 flex justify-between text-sm">
                    <span className="font-semibold text-gray-700">
                      Total Paid
                    </span>
                    <span className="font-bold text-green-700">
                      PKR {amountPaid.toLocaleString()}
                    </span>
                  </div>
                </div>
              </div>
            )}

            {/* Status */}
            {isPaid ? (
              <div className="flex items-center gap-3 bg-green-50 border border-green-200 rounded-xl px-4 py-3">
                <CheckCircle2 size={20} className="text-green-600 shrink-0" />
                <div>
                  <p className="font-bold text-green-800 text-sm">
                    Paid in Full
                  </p>
                  <p className="text-xs text-green-600">
                    No outstanding balance. Thank you!
                  </p>
                </div>
              </div>
            ) : (
              <div className="flex items-center justify-between bg-red-50 border border-red-200 rounded-xl px-4 py-3">
                <div className="flex items-center gap-3">
                  <AlertCircle size={20} className="text-red-500 shrink-0" />
                  <div>
                    <p className="font-bold text-red-800 text-sm">
                      Balance Due
                    </p>
                    <p className="text-xs text-red-600">
                      Please pay at your earliest convenience.
                    </p>
                  </div>
                </div>
                <p className="font-black text-red-700 text-lg">
                  PKR {amountPending.toLocaleString()}
                </p>
              </div>
            )}

            {/* Footer */}
            <div className="mt-5 pt-3 border-t border-gray-200 text-center text-[10px] text-gray-400">
              <p>Galaxy ISP ¬∑ Thank you for your business</p>
              <p className="mt-0.5">
                This is a computer-generated invoice ‚Äî no signature required.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="eslint.config.js">
import js from '@eslint/js'
import globals from 'globals'
import reactHooks from 'eslint-plugin-react-hooks'
import reactRefresh from 'eslint-plugin-react-refresh'
import { defineConfig, globalIgnores } from 'eslint/config'

export default defineConfig([
  globalIgnores(['dist']),
  {
    files: ['**/*.{js,jsx}'],
    extends: [
      js.configs.recommended,
      reactHooks.configs.flat.recommended,
      reactRefresh.configs.vite,
    ],
    languageOptions: {
      ecmaVersion: 2020,
      globals: globals.browser,
      parserOptions: {
        ecmaVersion: 'latest',
        ecmaFeatures: { jsx: true },
        sourceType: 'module',
      },
    },
    rules: {
      'no-unused-vars': ['error', { varsIgnorePattern: '^[A-Z_]' }],
    },
  },
])
</file>

<file path="src/components/layout/Navbar.jsx">
import { useState, useRef } from "react";
import { Download, Upload, Settings } from "lucide-react";
import { exportBackup, importBackup } from "../../utils/backup";
import ConfirmDialog from "../ui/ConfirmDialog";

export default function Navbar({ activeTab, onTabChange }) {
  const [importing, setImporting] = useState(false);
  const [confirmImport, setConfirmImport] = useState(false);
  const [pendingFile, setPendingFile] = useState(null);
  const fileRef = useRef();

  const tabs = [
    { id: "dashboard", label: "Dashboard" },
    { id: "customers", label: "Customers" },
    { id: "inventory", label: "Inventory" },
    { id: "expenses", label: "Expenses" },
    { id: "settings", label: "Settings" },
  ];

  const handleImportSelect = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    setPendingFile(file);
    setConfirmImport(true);
    e.target.value = "";
  };

  const doImport = async () => {
    if (!pendingFile) return;
    setImporting(true);
    try {
      await importBackup(pendingFile);
      window.location.reload();
    } catch (err) {
      alert("Import failed: " + err.message);
    }
    setImporting(false);
  };

  return (
    <>
      <nav className="bg-white border-b border-gray-200 px-4 flex items-center justify-between h-12">
        <div className="flex items-center gap-1">
          <span className="font-semibold text-gray-800 text-sm mr-4">
            Galaxy ISP
          </span>
          {tabs.map((t) => (
            <button
              key={t.id}
              onClick={() => onTabChange(t.id)}
              className={`px-3 py-1.5 text-sm rounded font-medium ${
                activeTab === t.id
                  ? "bg-blue-600 text-white"
                  : "text-gray-600 hover:bg-gray-100"
              }`}
            >
              {t.label}
            </button>
          ))}
        </div>

        <div className="flex items-center gap-2">
          <button
            onClick={exportBackup}
            className="flex items-center gap-1.5 px-3 py-1.5 text-sm bg-green-600 text-white rounded hover:bg-green-700"
          >
            <Download size={14} />
            Backup
          </button>
          <button
            onClick={() => fileRef.current.click()}
            disabled={importing}
            className="flex items-center gap-1.5 px-3 py-1.5 text-sm border border-gray-300 text-gray-700 rounded hover:bg-gray-50 disabled:opacity-50"
          >
            <Upload size={14} />
            Restore
          </button>
          <input
            ref={fileRef}
            type="file"
            accept=".json"
            className="hidden"
            onChange={handleImportSelect}
          />
        </div>
      </nav>

      <ConfirmDialog
        isOpen={confirmImport}
        onClose={() => setConfirmImport(false)}
        onConfirm={doImport}
        title="Restore from Backup"
        message="This will REPLACE all current data with the backup file. This cannot be undone. Are you sure?"
        confirmLabel="Yes, Restore"
        danger
      />
    </>
  );
}
</file>

<file path="src/components/shared/WhatsAppButton.jsx">
import { generateWhatsAppLink } from "../../config/messageTemplates";

export default function WhatsAppButton({ mobileNo, message, label = "Send" }) {
  if (!mobileNo || String(mobileNo).replace(/\D/g, "").length < 10) {
    return <span className="text-xs text-gray-400">No mobile</span>;
  }

  const link = generateWhatsAppLink(mobileNo, message);

  return (
    <a
      href={link}
      target="_blank"
      rel="noopener noreferrer"
      className="inline-flex items-center gap-1 px-2 py-1 text-xs bg-green-600 text-white rounded hover:bg-green-700"
    >
      <svg
        viewBox="0 0 24 24"
        className="w-3 h-3 fill-current"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z" />
      </svg>
      {label}
    </a>
  );
}
</file>

<file path="src/components/ui/BackupBanner.jsx">
import { useState, useEffect } from "react";
import { AlertTriangle } from "lucide-react";
import { getLastBackupDate, exportBackup } from "../../utils/backup";
import { today } from "../../utils/dateUtils";

export default function BackupBanner() {
  const [show, setShow] = useState(false);
  const [loading, setLoading] = useState(false);

  useEffect(() => {
    getLastBackupDate().then((date) => {
      if (date !== today()) setShow(true);
    });
  }, []);

  if (!show) return null;

  const handleBackup = async () => {
    setLoading(true);
    await exportBackup();
    setLoading(false);
    setShow(false);
  };

  return (
    <div className="bg-amber-50 border-b border-amber-200 px-4 py-2 flex items-center justify-between text-sm">
      <div className="flex items-center gap-2 text-amber-800">
        <AlertTriangle size={15} />
        <span>No backup yet today. Save your data before closing.</span>
      </div>
      <button
        onClick={handleBackup}
        disabled={loading}
        className="text-amber-800 underline font-medium hover:text-amber-900 disabled:opacity-50"
      >
        {loading ? "Saving..." : "Backup Now"}
      </button>
    </div>
  );
}
</file>

<file path="src/components/ui/Badge.jsx">
export default function Badge({ status }) {
  const map = {
    clear: "bg-green-100 text-green-800",
    pending: "bg-yellow-100 text-yellow-800",
    overdue: "bg-red-100 text-red-800",
    active: "bg-green-100 text-green-800",
    suspended: "bg-red-100 text-red-800",
    terminated: "bg-gray-200 text-gray-600",
    grace: "bg-orange-100 text-orange-800",
  };

  const label = {
    clear: "Clear",
    pending: "Pending",
    overdue: "Overdue",
    active: "Active",
    suspended: "Suspended",
    terminated: "Terminated",
    grace: "Grace Period",
  };

  return (
    <span
      className={`inline-block px-2 py-0.5 rounded text-xs font-medium ${map[status] || "bg-gray-100 text-gray-600"}`}
    >
      {label[status] || status}
    </span>
  );
}
</file>

<file path="src/components/ui/ConfirmDialog.jsx">
import { useState, useEffect } from "react";
import { AlertTriangle, Trash2, Eye, EyeOff, Archive } from "lucide-react";
import Modal from "./Modal";

// Updated to match your Login credentials
const ADMIN_PASSWORD = "admin1357";

export default function ConfirmDialog({
  isOpen,
  onClose,
  onConfirm,
  title,
  message,
  confirmLabel = "Delete",
  danger = true,
  confirmText = null,
  requirePassword = false,
  showReason = false,
  reasonLabel = "Reason (optional)",
}) {
  const [typed, setTyped] = useState("");
  const [password, setPassword] = useState("");
  const [showPw, setShowPw] = useState(false);
  const [pwError, setPwError] = useState("");
  const [reason, setReason] = useState("");

  useEffect(() => {
    if (isOpen) {
      const timer = setTimeout(() => {
        setTyped("");
        setPassword("");
        setPwError("");
        setShowPw(false);
        setReason("");
      }, 0);
      return () => clearTimeout(timer);
    }
  }, [isOpen, confirmText]);

  const nameOk = confirmText
    ? typed.trim() === confirmText.trim() && typed.length > 0
    : true;
  const passwordOk = requirePassword ? password === ADMIN_PASSWORD : true;
  const canConfirm =
    nameOk && (requirePassword ? password.length > 0 && passwordOk : true);

  const handleConfirm = () => {
    if (confirmText && !nameOk) return;
    if (requirePassword && password !== ADMIN_PASSWORD) {
      setPwError("Incorrect admin password.");
      return;
    }
    onConfirm(reason);
    onClose();
  };

  let stepNum = 0;
  const stepCount = [confirmText, requirePassword].filter(Boolean).length;

  return (
    <Modal isOpen={isOpen} onClose={onClose} title={title} size="sm">
      <div className="space-y-4">
        {/* Warning */}
        <div className="flex gap-3 bg-red-50 border border-red-200 rounded-lg p-3">
          <div className="shrink-0 w-9 h-9 rounded-full bg-red-100 flex items-center justify-center">
            <AlertTriangle size={18} className="text-red-600" />
          </div>
          <p className="text-sm text-red-800 leading-relaxed pt-0.5">
            {message}
          </p>
        </div>

        {/* Optional reason */}
        {showReason && (
          <div className="space-y-1.5">
            <label className="block text-xs font-semibold text-gray-600">
              {reasonLabel}
            </label>
            <input
              className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="e.g. Customer relocated, Duplicate entry..."
              value={reason}
              onChange={(e) => setReason(e.target.value)}
            />
          </div>
        )}

        {/* Step: type name */}
        {confirmText && (
          <div className="space-y-1.5">
            <label className="block text-xs font-semibold text-gray-600">
              {stepCount > 1 ? `Step ${++stepNum} ‚Äî ` : ""}Type the customer
              name to confirm:
            </label>
            <div className="bg-gray-100 rounded px-2 py-1 text-xs font-mono font-bold text-gray-800 inline-block mb-1">
              {confirmText}
            </div>
            <input
              autoFocus
              className={`w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 transition-colors ${
                typed.length > 0 && !nameOk
                  ? "border-red-300 focus:ring-red-400 bg-red-50"
                  : nameOk
                    ? "border-green-400 focus:ring-green-400 bg-green-50"
                    : "border-gray-300 focus:ring-blue-500"
              }`}
              placeholder={`Type "${confirmText}"`}
              value={typed}
              onChange={(e) => setTyped(e.target.value)}
              onKeyDown={(e) => e.key === "Enter" && handleConfirm()}
            />
            {typed.length > 0 && !nameOk && (
              <p className="text-xs text-red-500">
                Name does not match. Check spelling and capitalisation.
              </p>
            )}
            {nameOk && (
              <p className="text-xs text-green-600 font-semibold">
                ‚úì Name confirmed
              </p>
            )}
          </div>
        )}

        {/* Step: admin password */}
        {requirePassword && (
          <div className="space-y-1.5">
            <label className="block text-xs font-semibold text-gray-600">
              {stepCount > 1 ? `Step ${++stepNum} ‚Äî ` : ""}Enter admin password:
            </label>
            <div className="relative">
              <input
                type={showPw ? "text" : "password"}
                className={`w-full border rounded-lg px-3 py-2 pr-10 text-sm focus:outline-none focus:ring-2 transition-colors ${
                  pwError
                    ? "border-red-300 focus:ring-red-400 bg-red-50"
                    : passwordOk && password.length > 0
                      ? "border-green-400 focus:ring-green-400 bg-green-50"
                      : "border-gray-300 focus:ring-blue-500"
                }`}
                placeholder="Admin password"
                value={password}
                onChange={(e) => {
                  setPassword(e.target.value);
                  setPwError("");
                }}
                onKeyDown={(e) => e.key === "Enter" && handleConfirm()}
              />
              <button
                type="button"
                onClick={() => setShowPw((s) => !s)}
                className="absolute right-2.5 top-2 text-gray-400 hover:text-gray-600"
              >
                {showPw ? <EyeOff size={16} /> : <Eye size={16} />}
              </button>
            </div>
            {pwError && (
              <p className="text-xs text-red-500 font-medium">{pwError}</p>
            )}
            {passwordOk && password.length > 0 && (
              <p className="text-xs text-green-600 font-semibold">
                ‚úì Password correct
              </p>
            )}
          </div>
        )}

        {/* Buttons */}
        <div className="flex gap-2 justify-end pt-1">
          <button
            onClick={onClose}
            className="px-4 py-2 text-sm border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 font-medium"
          >
            Cancel
          </button>
          <button
            onClick={handleConfirm}
            disabled={!canConfirm}
            className={`px-4 py-2 text-sm rounded-lg font-semibold text-white flex items-center gap-1.5 ${
              danger
                ? "bg-red-600 hover:bg-red-700"
                : "bg-blue-600 hover:bg-blue-700"
            } disabled:opacity-40 disabled:cursor-not-allowed`}
          >
            {danger && <Archive size={14} />}
            {confirmLabel}
          </button>
        </div>
      </div>
    </Modal>
  );
}
</file>

<file path="src/components/ui/Modal.jsx">
// src/components/ui/Modal.jsx
import { useEffect } from "react";
import { X } from "lucide-react";

export default function Modal({
  isOpen,
  onClose,
  title,
  children,
  size = "md",
}) {
  useEffect(() => {
    const handler = (e) => {
      if (e.key === "Escape") onClose();
    };
    if (isOpen) document.addEventListener("keydown", handler);
    return () => document.removeEventListener("keydown", handler);
  }, [isOpen, onClose]);

  if (!isOpen) return null;

  // Added new 2xl and 3xl sizes
  const sizeClass =
    {
      sm: "max-w-sm",
      md: "max-w-lg",
      lg: "max-w-2xl",
      xl: "max-w-4xl",
      "2xl": "max-w-6xl", // ~1152px
      "3xl": "max-w-[1200px]", // Exactly 1200px
    }[size] || "max-w-lg";

  return (
    <div
      className="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
      onClick={(e) => {
        if (e.target === e.currentTarget) onClose();
      }}
    >
      <div
        className={`bg-white rounded-lg shadow-xl w-full mx-4 ${sizeClass} max-h-[90vh] flex flex-col`}
      >
        <div className="flex items-center justify-between px-6 py-4 border-b border-gray-200">
          <h2 className="text-base font-semibold text-gray-800">{title}</h2>
          <button
            onClick={onClose}
            className="text-gray-400 hover:text-gray-600 p-1 rounded"
          >
            <X size={18} />
          </button>
        </div>
        <div className="overflow-y-auto flex-1 px-6 py-4">{children}</div>
      </div>
    </div>
  );
}
</file>

<file path="src/config/messageTemplates.js">
export const MESSAGE_TEMPLATES = {
  paymentDue: (customer, cycle) =>
    `Assalam o Alaikum *${customer.fullName}*,\n\nYour internet bill of *PKR ${cycle.amountPending}* is due. Please pay to continue uninterrupted service.\n\nThank you,\n*Galaxy Internet*`,

  paymentOverdue: (customer, cycle) =>
    `Assalam o Alaikum *${customer.fullName}*,\n\nYour account is overdue. Your service has been suspended.\n\nPlease pay *PKR ${cycle.totalAmount}* to reconnect.\n\nThank you,\n*Galaxy Internet*`,

  paymentConfirmation: (customer, installment) =>
    `Assalam o Alaikum *${customer.fullName}*,\n\nWe received your payment of *PKR ${installment.amountPaid}* on ${installment.datePaid}. Thank you!\n\nYour account is now updated.\n\n*Galaxy Internet*`,

  expiryReminder: (customer, cycle) =>
    `Assalam o Alaikum *${customer.fullName}*,\n\nYour internet plan expires on *${cycle.cycleEndDate}*. Please renew to avoid service interruption.\n\nThank you,\n*Galaxy Internet*`,

  partialPaymentReceived: (customer, installment, remaining) =>
    `Assalam o Alaikum *${customer.fullName}*,\n\nWe received *PKR ${installment.amountPaid}* on ${installment.datePaid}.\n\nRemaining balance: *PKR ${remaining}*\n\nPlease pay the remaining amount soon.\n\n*Galaxy Internet*`,
};

export const generateWhatsAppLink = (mobileNo, message) => {
  if (!mobileNo) return null;
  const cleaned = String(mobileNo).replace(/\D/g, "");
  const withCode = cleaned.startsWith("92") ? cleaned : `92${cleaned}`;
  return `https://wa.me/${withCode}?text=${encodeURIComponent(message)}`;
};
</file>

<file path="src/main.jsx">
import { createRoot } from "react-dom/client";
import "./index.css";
import App from "./App.jsx";
import { setupDevTools } from "./utils/devTools.js";

setupDevTools(); // <-- Add this

createRoot(document.getElementById("root")).render(<App />);
</file>

<file path="src/pages/Expenses/ExpenseForm.jsx">
import { useState } from "react";
import { today } from "../../utils/dateUtils";
import useExpenseStore, {
  EXPENSE_CATEGORIES,
} from "../../store/useExpenseStore";

const EMPTY = {
  date: today(),
  nameOrDept: "",
  description: "",
  category: "",
  amount: "",
};

export default function ExpenseForm({ expense, onClose }) {
  const addExpense = useExpenseStore((s) => s.addExpense);
  const updateExpense = useExpenseStore((s) => s.updateExpense);
  const isEdit = !!expense;
  const [form, setForm] = useState(isEdit ? expense : EMPTY);
  const [errors, setErrors] = useState({});
  const [saving, setSaving] = useState(false);

  const set = (field, value) => {
    setForm((f) => ({ ...f, [field]: value }));
    setErrors((e) => ({ ...e, [field]: "" }));
  };

  const validate = () => {
    const e = {};
    if (!form.date) e.date = "Required";
    if (!form.nameOrDept.trim()) e.nameOrDept = "Required";
    if (!form.category) e.category = "Required";
    if (!form.amount || Number(form.amount) <= 0) e.amount = "Must be > 0";
    return e;
  };

  const handleSubmit = async () => {
    const e = validate();
    if (Object.keys(e).length) {
      setErrors(e);
      return;
    }
    setSaving(true);
    try {
      const data = { ...form, amount: Number(form.amount) };
      if (isEdit) await updateExpense(expense.id, data);
      else await addExpense(data);
      onClose();
    } catch (err) {
      alert("Error: " + err.message);
    }
    setSaving(false);
  };

  return (
    <div className="space-y-4">
      <div className="grid grid-cols-2 gap-4">
        <Field label="Date *" error={errors.date}>
          <input
            type="date"
            className={inp(errors.date)}
            value={form.date}
            max={today()}
            onChange={(e) => set("date", e.target.value)}
          />
        </Field>
        <Field label="Category *" error={errors.category}>
          <select
            className={inp(errors.category)}
            value={form.category}
            onChange={(e) => set("category", e.target.value)}
          >
            <option value="">‚Äî Select Category ‚Äî</option>
            {EXPENSE_CATEGORIES.map((c) => (
              <option key={c} value={c}>
                {c}
              </option>
            ))}
          </select>
        </Field>
        <Field label="Name / Department *" error={errors.nameOrDept}>
          <input
            className={inp(errors.nameOrDept)}
            value={form.nameOrDept}
            onChange={(e) => set("nameOrDept", e.target.value)}
            placeholder="e.g. Ali Muhammad, Wapda"
          />
        </Field>
        <Field label="Amount (PKR) *" error={errors.amount}>
          <input
            type="number"
            min="1"
            className={inp(errors.amount)}
            value={form.amount}
            onChange={(e) => set("amount", e.target.value)}
          />
        </Field>
        <Field label="Description" className="col-span-2">
          <input
            className={inp()}
            value={form.description}
            onChange={(e) => set("description", e.target.value)}
            placeholder="Optional details..."
          />
        </Field>
      </div>
      <div className="flex justify-end gap-3 pt-1">
        <button
          onClick={onClose}
          className="px-4 py-2 text-sm border border-gray-300 rounded text-gray-700 hover:bg-gray-50"
        >
          Cancel
        </button>
        <button
          onClick={handleSubmit}
          disabled={saving}
          className="px-4 py-2 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50"
        >
          {saving ? "Saving..." : isEdit ? "Save Changes" : "Add Expense"}
        </button>
      </div>
    </div>
  );
}

const inp = (err) =>
  `w-full border rounded px-3 py-1.5 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500 ${err ? "border-red-400" : "border-gray-300"}`;
function Field({ label, error, children, className = "" }) {
  return (
    <div className={className}>
      <label className="block text-xs font-medium text-gray-600 mb-1">
        {label}
      </label>
      {children}
      {error && <p className="text-xs text-red-500 mt-0.5">{error}</p>}
    </div>
  );
}
</file>

<file path="src/pages/Expenses/Expenses.jsx">
import { useState } from "react";
import { Plus, Pencil, Trash2 } from "lucide-react";
import Modal from "../../components/ui/Modal";
import ConfirmDialog from "../../components/ui/ConfirmDialog";
import ExpenseForm from "./ExpenseForm";
import useExpenseStore, {
  EXPENSE_CATEGORIES,
} from "../../store/useExpenseStore";
import { formatDate } from "../../utils/dateUtils";

export default function Expenses() {
  const expenses = useExpenseStore((s) => s.expenses);
  const deleteExpense = useExpenseStore((s) => s.deleteExpense);
  const [showAdd, setShowAdd] = useState(false);
  const [editExpense, setEditExpense] = useState(null);
  const [deleteTarget, setDeleteTarget] = useState(null);
  const [filterCategory, setFilterCategory] = useState("all");

  const filtered =
    filterCategory === "all"
      ? expenses
      : expenses.filter((e) => e.category === filterCategory);
  const total = filtered.reduce((sum, e) => sum + (Number(e.amount) || 0), 0);

  const sorted = [...filtered].sort(
    (a, b) => new Date(b.date) - new Date(a.date),
  );

  return (
    <div className="p-4 space-y-3">
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-2">
          <h1 className="text-base font-semibold text-gray-800">Expenses</h1>
          <span className="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full">
            {filtered.length}
          </span>
        </div>
        <button
          onClick={() => setShowAdd(true)}
          className="flex items-center gap-1.5 px-3 py-1.5 text-sm bg-blue-600 text-white rounded hover:bg-blue-700"
        >
          <Plus size={14} /> Add Expense
        </button>
      </div>

      <div className="flex items-center gap-2 flex-wrap">
        <button
          onClick={() => setFilterCategory("all")}
          className={`px-3 py-1 text-xs rounded ${filterCategory === "all" ? "bg-gray-800 text-white" : "border border-gray-300 text-gray-600 hover:bg-gray-50"}`}
        >
          All
        </button>
        {EXPENSE_CATEGORIES.map((c) => (
          <button
            key={c}
            onClick={() => setFilterCategory(c)}
            className={`px-3 py-1 text-xs rounded ${filterCategory === c ? "bg-gray-800 text-white" : "border border-gray-300 text-gray-600 hover:bg-gray-50"}`}
          >
            {c}
          </button>
        ))}
      </div>

      <div className="bg-red-50 rounded p-3 text-sm">
        <span className="text-gray-500">
          Total Expenses{filterCategory !== "all" ? ` (${filterCategory})` : ""}
          :
        </span>{" "}
        <strong className="text-red-700">PKR {total.toLocaleString()}</strong>
      </div>

      <div className="bg-white border border-gray-200 rounded overflow-hidden">
        <table className="w-full text-sm">
          <thead>
            <tr className="bg-gray-100 text-gray-600 text-left">
              <th className="px-3 py-2 font-medium">Date</th>
              <th className="px-3 py-2 font-medium">Name / Dept</th>
              <th className="px-3 py-2 font-medium">Description</th>
              <th className="px-3 py-2 font-medium">Category</th>
              <th className="px-3 py-2 font-medium">Amount</th>
              <th className="px-3 py-2 font-medium"></th>
            </tr>
          </thead>
          <tbody>
            {sorted.map((e) => (
              <tr
                key={e.id}
                className="border-b border-gray-100 hover:bg-gray-50"
              >
                <td className="px-3 py-2 text-xs whitespace-nowrap">
                  {formatDate(e.date)}
                </td>
                <td className="px-3 py-2">{e.nameOrDept}</td>
                <td className="px-3 py-2 text-gray-500 text-xs">
                  {e.description || "-"}
                </td>
                <td className="px-3 py-2">
                  <span className="text-xs bg-gray-100 px-2 py-0.5 rounded">
                    {e.category}
                  </span>
                </td>
                <td className="px-3 py-2 font-medium">
                  PKR {Number(e.amount).toLocaleString()}
                </td>
                <td className="px-3 py-2">
                  <div className="flex gap-1">
                    <button
                      onClick={() => setEditExpense(e)}
                      className="p-1 rounded text-gray-500 hover:bg-gray-100"
                    >
                      <Pencil size={13} />
                    </button>
                    <button
                      onClick={() => setDeleteTarget(e)}
                      className="p-1 rounded text-red-500 hover:bg-red-50"
                    >
                      <Trash2 size={13} />
                    </button>
                  </div>
                </td>
              </tr>
            ))}
            {sorted.length === 0 && (
              <tr>
                <td colSpan={6} className="px-3 py-8 text-center text-gray-400">
                  No expenses recorded yet.
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>

      <Modal
        isOpen={showAdd}
        onClose={() => setShowAdd(false)}
        title="Add Expense"
        size="md"
      >
        <ExpenseForm onClose={() => setShowAdd(false)} />
      </Modal>
      <Modal
        isOpen={!!editExpense}
        onClose={() => setEditExpense(null)}
        title="Edit Expense"
        size="md"
      >
        {editExpense && (
          <ExpenseForm
            expense={editExpense}
            onClose={() => setEditExpense(null)}
          />
        )}
      </Modal>
      <ConfirmDialog
        isOpen={!!deleteTarget}
        onClose={() => setDeleteTarget(null)}
        onConfirm={() => deleteExpense(deleteTarget.id)}
        title="Delete Expense"
        message={`Delete this expense of PKR ${deleteTarget?.amount}?`}
      />
    </div>
  );
}
</file>

<file path="src/pages/Inventory/Inventory.jsx">
import { useState } from "react";
import { Plus, Pencil, Trash2 } from "lucide-react";
import Modal from "../../components/ui/Modal";
import ConfirmDialog from "../../components/ui/ConfirmDialog";
import InventoryForm from "./InventoryForm";
import useInventoryStore from "../../store/useInventoryStore";
import { formatDate } from "../../utils/dateUtils";

export default function Inventory() {
  const items = useInventoryStore((s) => s.items);
  const deleteItem = useInventoryStore((s) => s.deleteItem);
  const [showAdd, setShowAdd] = useState(false);
  const [editItem, setEditItem] = useState(null);
  const [deleteTarget, setDeleteTarget] = useState(null);

  const totalValue = items.reduce((sum, i) => sum + (i.amount || 0), 0);

  return (
    <div className="p-4 space-y-3">
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-2">
          <h1 className="text-base font-semibold text-gray-800">Inventory</h1>
          <span className="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full">
            {items.length} items
          </span>
        </div>
        <button
          onClick={() => setShowAdd(true)}
          className="flex items-center gap-1.5 px-3 py-1.5 text-sm bg-blue-600 text-white rounded hover:bg-blue-700"
        >
          <Plus size={14} /> Add Item
        </button>
      </div>

      <div className="bg-blue-50 rounded p-3 text-sm">
        <span className="text-gray-500">Total Inventory Value:</span>{" "}
        <strong className="text-blue-700">
          PKR {totalValue.toLocaleString()}
        </strong>
      </div>

      <div className="bg-white border border-gray-200 rounded overflow-x-auto">
        <table className="w-full text-sm border-collapse">
          <thead>
            <tr className="bg-gray-100 text-gray-600 text-left">
              {[
                "Date",
                "Invoice",
                "PO",
                "Description",
                "Unit",
                "Qty",
                "Received",
                "Issued",
                "Balanced",
                "Rate",
                "Amount",
                "Remarks",
                "",
              ].map((h) => (
                <th key={h} className="px-3 py-2 font-medium whitespace-nowrap">
                  {h}
                </th>
              ))}
            </tr>
          </thead>
          <tbody>
            {items.map((item) => (
              <tr
                key={item.id}
                className="border-b border-gray-100 hover:bg-gray-50"
              >
                <td className="px-3 py-2 whitespace-nowrap text-xs">
                  {formatDate(item.date)}
                </td>
                <td className="px-3 py-2 text-xs">{item.invoiceNo || "-"}</td>
                <td className="px-3 py-2 text-xs">{item.poNo || "-"}</td>
                <td className="px-3 py-2 font-medium">{item.description}</td>
                <td className="px-3 py-2 text-xs">{item.unit}</td>
                <td className="px-3 py-2">{item.quantity}</td>
                <td className="px-3 py-2">{item.received}</td>
                <td className="px-3 py-2">{item.issued}</td>
                <td className="px-3 py-2">{item.balanced}</td>
                <td className="px-3 py-2">{item.unitRate}</td>
                <td className="px-3 py-2 font-medium">
                  PKR {(item.amount || 0).toLocaleString()}
                </td>
                <td className="px-3 py-2 text-xs text-gray-400">
                  {item.remarks || "-"}
                </td>
                <td className="px-3 py-2">
                  <div className="flex gap-1">
                    <button
                      onClick={() => setEditItem(item)}
                      className="p-1 rounded text-gray-500 hover:bg-gray-100"
                    >
                      <Pencil size={13} />
                    </button>
                    <button
                      onClick={() => setDeleteTarget(item)}
                      className="p-1 rounded text-red-500 hover:bg-red-50"
                    >
                      <Trash2 size={13} />
                    </button>
                  </div>
                </td>
              </tr>
            ))}
            {items.length === 0 && (
              <tr>
                <td
                  colSpan={13}
                  className="px-3 py-8 text-center text-gray-400 text-sm"
                >
                  No inventory items yet.
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>

      <Modal
        isOpen={showAdd}
        onClose={() => setShowAdd(false)}
        title="Add Inventory Item"
        size="lg"
      >
        <InventoryForm onClose={() => setShowAdd(false)} />
      </Modal>
      <Modal
        isOpen={!!editItem}
        onClose={() => setEditItem(null)}
        title="Edit Item"
        size="lg"
      >
        {editItem && (
          <InventoryForm item={editItem} onClose={() => setEditItem(null)} />
        )}
      </Modal>
      <ConfirmDialog
        isOpen={!!deleteTarget}
        onClose={() => setDeleteTarget(null)}
        onConfirm={() => deleteItem(deleteTarget.id)}
        title="Delete Item"
        message={`Delete "${deleteTarget?.description}"?`}
      />
    </div>
  );
}
</file>

<file path="src/pages/Inventory/InventoryForm.jsx">
import { useState } from "react";
import { today } from "../../utils/dateUtils";
import useInventoryStore from "../../store/useInventoryStore";

const UNITS = ["meter", "piece", "box", "roll", "set", "kg", "liter"];

const EMPTY = {
  date: today(),
  invoiceNo: "",
  poNo: "",
  description: "",
  unit: "piece",
  quantity: "",
  received: "",
  issued: "",
  unitRate: "",
  remarks: "",
};

export default function InventoryForm({ item, onClose }) {
  const addItem = useInventoryStore((s) => s.addItem);
  const updateItem = useInventoryStore((s) => s.updateItem);
  const isEdit = !!item;
  const [form, setForm] = useState(isEdit ? item : EMPTY);
  const [errors, setErrors] = useState({});
  const [saving, setSaving] = useState(false);

  const set = (field, value) => {
    setForm((f) => ({ ...f, [field]: value }));
    setErrors((e) => ({ ...e, [field]: "" }));
  };

  const autoCalc = {
    amount: (Number(form.quantity) || 0) * (Number(form.unitRate) || 0),
    balanced: (Number(form.received) || 0) - (Number(form.issued) || 0),
  };

  const validate = () => {
    const e = {};
    if (!form.description.trim()) e.description = "Required";
    if (!form.quantity || Number(form.quantity) <= 0)
      e.quantity = "Must be > 0";
    if (!form.unitRate || Number(form.unitRate) <= 0)
      e.unitRate = "Must be > 0";
    return e;
  };

  const handleSubmit = async () => {
    const e = validate();
    if (Object.keys(e).length) {
      setErrors(e);
      return;
    }
    setSaving(true);
    try {
      const data = {
        ...form,
        quantity: Number(form.quantity),
        received: Number(form.received) || 0,
        issued: Number(form.issued) || 0,
        unitRate: Number(form.unitRate),
      };
      if (isEdit) await updateItem(item.id, data);
      else await addItem(data);
      onClose();
    } catch (err) {
      alert("Error: " + err.message);
    }
    setSaving(false);
  };

  return (
    <div className="space-y-4">
      <div className="grid grid-cols-2 gap-4">
        <Field label="Date">
          <input
            type="date"
            className={inp()}
            value={form.date}
            max={today()}
            onChange={(e) => set("date", e.target.value)}
          />
        </Field>
        <Field label="Invoice No">
          <input
            className={inp()}
            value={form.invoiceNo}
            onChange={(e) => set("invoiceNo", e.target.value)}
          />
        </Field>
        <Field label="PO No">
          <input
            className={inp()}
            value={form.poNo}
            onChange={(e) => set("poNo", e.target.value)}
          />
        </Field>
        <Field label="Unit">
          <select
            className={inp()}
            value={form.unit}
            onChange={(e) => set("unit", e.target.value)}
          >
            {UNITS.map((u) => (
              <option key={u} value={u}>
                {u}
              </option>
            ))}
          </select>
        </Field>
        <Field
          label="Description *"
          error={errors.description}
          className="col-span-2"
        >
          <input
            className={inp(errors.description)}
            value={form.description}
            onChange={(e) => set("description", e.target.value)}
            placeholder="e.g. Fiber Cable Rim"
          />
        </Field>
        <Field label="Quantity *" error={errors.quantity}>
          <input
            type="number"
            min="0"
            className={inp(errors.quantity)}
            value={form.quantity}
            onChange={(e) => set("quantity", e.target.value)}
          />
        </Field>
        <Field label="Received">
          <input
            type="number"
            min="0"
            className={inp()}
            value={form.received}
            onChange={(e) => set("received", e.target.value)}
          />
        </Field>
        <Field label="Issued">
          <input
            type="number"
            min="0"
            className={inp()}
            value={form.issued}
            onChange={(e) => set("issued", e.target.value)}
          />
        </Field>
        <Field label="Balanced (auto)">
          <input
            readOnly
            className={inp() + " bg-gray-50 text-gray-500"}
            value={autoCalc.balanced}
          />
        </Field>
        <Field label="Unit Rate (PKR) *" error={errors.unitRate}>
          <input
            type="number"
            min="0"
            className={inp(errors.unitRate)}
            value={form.unitRate}
            onChange={(e) => set("unitRate", e.target.value)}
          />
        </Field>
        <Field label="Amount (auto)">
          <input
            readOnly
            className={inp() + " bg-gray-50 text-gray-500 font-medium"}
            value={`PKR ${autoCalc.amount.toLocaleString()}`}
          />
        </Field>
      </div>
      <Field label="Remarks">
        <input
          className={inp()}
          value={form.remarks}
          onChange={(e) => set("remarks", e.target.value)}
        />
      </Field>
      <div className="flex justify-end gap-3 pt-1">
        <button
          onClick={onClose}
          className="px-4 py-2 text-sm border border-gray-300 rounded text-gray-700 hover:bg-gray-50"
        >
          Cancel
        </button>
        <button
          onClick={handleSubmit}
          disabled={saving}
          className="px-4 py-2 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50"
        >
          {saving ? "Saving..." : isEdit ? "Save Changes" : "Add Item"}
        </button>
      </div>
    </div>
  );
}

const inp = (err) =>
  `w-full border rounded px-3 py-1.5 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500 ${err ? "border-red-400" : "border-gray-300"}`;
function Field({ label, error, children, className = "" }) {
  return (
    <div className={className}>
      <label className="block text-xs font-medium text-gray-600 mb-1">
        {label}
      </label>
      {children}
      {error && <p className="text-xs text-red-500 mt-0.5">{error}</p>}
    </div>
  );
}
</file>

<file path="src/pages/Login.jsx">
import { useState } from "react";
import { Lock, User, KeyRound, AlertCircle } from "lucide-react";

export default function Login({ onLogin }) {
  const [username, setUsername] = useState("");
  const [password, setPassword] = useState("");
  const [error, setError] = useState("");

  const handleSubmit = (e) => {
    e.preventDefault();
    setError("");

    // Hardcoded Credentials
    if (username === "admin1357" && password === "admin1357") {
      onLogin();
    } else {
      setError("Invalid username or password");
    }
  };

  return (
    <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
      <div className="bg-white w-full max-w-sm rounded-2xl shadow-xl overflow-hidden border border-gray-200">
        {/* Header */}
        <div className="bg-blue-600 px-6 py-6 text-center">
          <div className="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-3 backdrop-blur-sm">
            <Lock className="text-white" size={24} />
          </div>
          <h1 className="text-xl font-bold text-white tracking-wide">
            Galaxy ISP
          </h1>
          <p className="text-blue-100 text-xs mt-1 font-medium">
            Admin Access Portal
          </p>
        </div>

        {/* Form */}
        <div className="p-6 pt-8">
          <form onSubmit={handleSubmit} className="space-y-5">
            {error && (
              <div className="bg-red-50 text-red-600 text-sm px-3 py-2 rounded-lg flex items-center gap-2 border border-red-100">
                <AlertCircle size={16} />
                {error}
              </div>
            )}

            <div className="space-y-1.5">
              <label className="block text-xs font-bold text-gray-500 uppercase tracking-wider ml-1">
                Admin Username
              </label>
              <div className="relative">
                <div className="absolute left-3 top-2.5 text-gray-400">
                  <User size={18} />
                </div>
                <input
                  type="text"
                  autoFocus
                  value={username}
                  onChange={(e) => setUsername(e.target.value)}
                  className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                  placeholder="Enter username"
                />
              </div>
            </div>

            <div className="space-y-1.5">
              <label className="block text-xs font-bold text-gray-500 uppercase tracking-wider ml-1">
                Admin Password
              </label>
              <div className="relative">
                <div className="absolute left-3 top-2.5 text-gray-400">
                  <KeyRound size={18} />
                </div>
                <input
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                  placeholder="Enter password"
                />
              </div>
            </div>

            <button
              type="submit"
              className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 rounded-lg transition-colors shadow-sm active:transform active:scale-[0.98]"
            >
              Login
            </button>
          </form>

          <div className="mt-6 text-center">
            <p className="text-xs text-gray-400">Authorized personnel only.</p>
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/pages/Settings.jsx">
import { useState, useEffect } from "react";
import {
  Plus,
  Trash2,
  Pencil,
  X,
  Check,
  History,
  TrendingUp,
  Calendar,
  ArrowRight,
  AlertCircle,
  ArrowUp,
  ArrowDown,
} from "lucide-react";

import usePackageStore from "../store/usePackageStore";
import db from "../db/database";
import Modal from "../components/ui/Modal";
import ConfirmDialog from "../components/ui/ConfirmDialog";
import { formatDate, today } from "../utils/dateUtils";

// ‚îÄ‚îÄ‚îÄ HELPER COMPONENT (Defined outside to avoid re-render issues) ‚îÄ‚îÄ‚îÄ
const SortIcon = ({ column, sortConfig }) => {
  if (sortConfig.key !== column)
    return <div className="w-3.5 h-3.5 inline-block" />;

  return sortConfig.direction === "asc" ? (
    <ArrowUp size={14} className="inline-block text-gray-700" />
  ) : (
    <ArrowDown size={14} className="inline-block text-gray-700" />
  );
};

export default function Settings() {
  // Store Hooks
  const packages = usePackageStore((s) => s.packages);
  const addPackage = usePackageStore((s) => s.addPackage);
  const updatePackage = usePackageStore((s) => s.updatePackage);
  const deletePackage = usePackageStore((s) => s.deletePackage);

  // Local Settings State (Areas/Agents)
  const [areas, setAreas] = useState([]);
  const [agents, setAgents] = useState([]);
  const [newArea, setNewArea] = useState("");
  const [newAgent, setNewAgent] = useState("");

  // Package Management State
  const [newPkg, setNewPkg] = useState({ name: "", price: "", speedMbps: "" });
  const [editPkgId, setEditPkgId] = useState(null);
  const [editPkgData, setEditPkgData] = useState({});
  const [historyPkg, setHistoryPkg] = useState(null);
  const [deletePkg, setDeletePkg] = useState(null);

  // Sorting State
  const [sortConfig, setSortConfig] = useState({
    key: "price",
    direction: "asc",
  });

  // Load Initial Data
  useEffect(() => {
    const loadSettings = async () => {
      const a = await db.settings.get("areas");
      const g = await db.settings.get("agents");
      setAreas(a?.value || []);
      setAgents(g?.value || []);
    };
    loadSettings();
  }, []);

  // ‚îÄ‚îÄ AREA / AGENT HANDLERS ‚îÄ‚îÄ
  const saveAreas = async (list) => {
    setAreas(list);
    await db.settings.put({ key: "areas", value: list });
  };
  const saveAgents = async (list) => {
    setAgents(list);
    await db.settings.put({ key: "agents", value: list });
  };

  const addArea = async () => {
    const v = newArea.trim();
    if (!v || areas.includes(v)) return;
    await saveAreas([...areas, v]);
    setNewArea("");
  };
  const removeArea = (a) => saveAreas(areas.filter((x) => x !== a));

  const addAgent = async () => {
    const v = newAgent.trim();
    if (!v || agents.includes(v)) return;
    await saveAgents([...agents, v]);
    setNewAgent("");
  };
  const removeAgent = (a) => saveAgents(agents.filter((x) => x !== a));

  // ‚îÄ‚îÄ PACKAGE HANDLERS ‚îÄ‚îÄ
  const handleAddPkg = async () => {
    if (!newPkg.name || !newPkg.price) return;
    await addPackage({
      name: newPkg.name,
      price: newPkg.price,
      speedMbps: newPkg.speedMbps,
    });
    setNewPkg({ name: "", price: "", speedMbps: "" });
  };

  const startEdit = (pkg) => {
    setEditPkgId(pkg.id);
    // Copy all fields to edit state
    setEditPkgData({
      name: pkg.name,
      price: pkg.price,
      speedMbps: pkg.speedMbps || "",
    });
  };

  const saveEdit = async () => {
    if (!editPkgId) return;
    await updatePackage(editPkgId, editPkgData);
    setEditPkgId(null);
    setEditPkgData({});
  };

  const cancelEdit = () => {
    setEditPkgId(null);
    setEditPkgData({});
  };

  const handleConfirmDelete = async () => {
    if (deletePkg) {
      await deletePackage(deletePkg.id);
      setDeletePkg(null);
    }
  };

  // ‚îÄ‚îÄ SORTING LOGIC ‚îÄ‚îÄ
  const requestSort = (key) => {
    let direction = "asc";
    if (sortConfig.key === key && sortConfig.direction === "asc") {
      direction = "desc";
    }
    setSortConfig({ key, direction });
  };

  const sortedPackages = [...packages].sort((a, b) => {
    const { key, direction } = sortConfig;
    const modifier = direction === "asc" ? 1 : -1;

    switch (key) {
      case "name":
        return modifier * a.name.localeCompare(b.name);
      case "speedMbps":
        return (
          modifier * ((Number(a.speedMbps) || 0) - (Number(b.speedMbps) || 0))
        );
      case "price":
        return modifier * (Number(a.price) - Number(b.price));
      case "lastUpdated": {
        // Wrapped in braces to fix lexical declaration error
        const dateA = a.lastUpdated ? new Date(a.lastUpdated) : new Date(0);
        const dateB = b.lastUpdated ? new Date(b.lastUpdated) : new Date(0);
        return modifier * (dateA - dateB);
      }
      default:
        return 0;
    }
  });

  return (
    <div className="p-5 space-y-6 max-w-6xl mx-auto">
      {/* HEADER */}
      <div>
        <h1 className="text-2xl font-bold text-gray-900">Settings</h1>
        <p className="text-sm text-gray-500 mt-0.5">
          Manage your internet packages, coverage areas, and recovery agents.
        </p>
      </div>

      {/* PACKAGES SECTION */}
      <section className="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden">
        <div className="px-6 py-5 border-b border-gray-200 bg-gray-50/50 flex justify-between items-center">
          <div>
            <h2 className="text-base font-bold text-gray-800">
              Internet Packages
            </h2>
            <p className="text-xs text-gray-500 mt-1">
              Active customer cycles are{" "}
              <strong className="text-gray-700">NOT</strong> affected by price
              changes until they renew.
            </p>
          </div>
          <div className="bg-blue-50 text-blue-700 px-3 py-1 rounded-full text-xs font-semibold">
            {packages.length} Packages
          </div>
        </div>

        <div className="overflow-x-auto">
          <table className="w-full text-sm">
            <thead>
              <tr className="bg-white text-gray-500 text-left border-b border-gray-200">
                <th
                  onClick={() => requestSort("name")}
                  className="px-6 py-4 font-semibold w-1/4 cursor-pointer hover:bg-gray-50 transition-colors select-none"
                >
                  <div className="flex items-center gap-1">
                    Package Name{" "}
                    <SortIcon column="name" sortConfig={sortConfig} />
                  </div>
                </th>
                <th
                  onClick={() => requestSort("speedMbps")}
                  className="px-6 py-4 font-semibold w-1/6 cursor-pointer hover:bg-gray-50 transition-colors select-none"
                >
                  <div className="flex items-center gap-1">
                    Speed{" "}
                    <SortIcon column="speedMbps" sortConfig={sortConfig} />
                  </div>
                </th>
                <th
                  onClick={() => requestSort("price")}
                  className="px-6 py-4 font-semibold w-1/6 cursor-pointer hover:bg-gray-50 transition-colors select-none"
                >
                  <div className="flex items-center gap-1">
                    Current Price{" "}
                    <SortIcon column="price" sortConfig={sortConfig} />
                  </div>
                </th>
                <th
                  onClick={() => requestSort("lastUpdated")}
                  className="px-6 py-4 font-semibold w-1/6 cursor-pointer hover:bg-gray-50 transition-colors select-none"
                >
                  <div className="flex items-center gap-1">
                    Last Updated{" "}
                    <SortIcon column="lastUpdated" sortConfig={sortConfig} />
                  </div>
                </th>
                <th className="px-6 py-4 text-right font-semibold">Actions</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-100">
              {sortedPackages.map((pkg) => (
                <tr
                  key={pkg.id}
                  className="hover:bg-gray-50/80 transition-colors"
                >
                  {editPkgId === pkg.id ? (
                    // EDIT MODE
                    <>
                      <td className="px-6 py-3">
                        <input
                          autoFocus
                          className={inp()}
                          value={editPkgData.name}
                          onChange={(e) =>
                            setEditPkgData((d) => ({
                              ...d,
                              name: e.target.value,
                            }))
                          }
                        />
                      </td>
                      <td className="px-6 py-3">
                        <input
                          type="number"
                          className={inp()}
                          value={editPkgData.speedMbps}
                          placeholder="Mbps"
                          onChange={(e) =>
                            setEditPkgData((d) => ({
                              ...d,
                              speedMbps: e.target.value,
                            }))
                          }
                        />
                      </td>
                      <td className="px-6 py-3">
                        <input
                          type="number"
                          className={inp()}
                          value={editPkgData.price}
                          onChange={(e) =>
                            setEditPkgData((d) => ({
                              ...d,
                              price: e.target.value,
                            }))
                          }
                        />
                      </td>
                      <td className="px-6 py-3 text-gray-400 text-xs italic">
                        Editing...
                      </td>
                      <td className="px-6 py-3">
                        <div className="flex justify-end gap-2">
                          <button
                            onClick={saveEdit}
                            className="p-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors"
                            title="Save Changes"
                          >
                            <Check size={16} />
                          </button>
                          <button
                            onClick={cancelEdit}
                            className="p-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 transition-colors"
                            title="Cancel"
                          >
                            <X size={16} />
                          </button>
                        </div>
                      </td>
                    </>
                  ) : (
                    // VIEW MODE
                    <>
                      <td className="px-6 py-4">
                        <span className="font-bold text-gray-800 text-base">
                          {pkg.name}
                        </span>
                      </td>
                      <td className="px-6 py-4">
                        <span className="bg-gray-100 text-gray-600 px-2.5 py-1 rounded text-xs font-medium border border-gray-200">
                          {pkg.speedMbps ? `${pkg.speedMbps} Mbps` : "N/A"}
                        </span>
                      </td>
                      <td className="px-6 py-4">
                        <span className="font-bold text-blue-700 text-base">
                          PKR {Number(pkg.price).toLocaleString()}
                        </span>
                      </td>
                      <td className="px-6 py-4 text-gray-500">
                        {pkg.lastUpdated ? (
                          <div
                            className={`flex items-center gap-1.5 text-xs ${pkg.lastUpdated === today() ? "text-green-600 font-bold" : ""}`}
                          >
                            <Calendar
                              size={13}
                              className={
                                pkg.lastUpdated === today()
                                  ? "text-green-600"
                                  : "text-gray-400"
                              }
                            />
                            {pkg.lastUpdated === today()
                              ? "Today"
                              : formatDate(pkg.lastUpdated)}
                          </div>
                        ) : (
                          <span className="text-xs text-gray-400 italic">
                            Original
                          </span>
                        )}
                      </td>
                      <td className="px-6 py-4">
                        <div className="flex justify-end gap-2">
                          <button
                            onClick={() => setHistoryPkg(pkg)}
                            className="flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-gray-600 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 hover:text-gray-900 transition-all shadow-sm"
                          >
                            <History size={14} /> History
                          </button>

                          <button
                            onClick={() => startEdit(pkg)}
                            className="p-1.5 text-blue-600 hover:bg-blue-50 rounded-md transition-colors"
                            title="Edit"
                          >
                            <Pencil size={15} />
                          </button>

                          <button
                            onClick={() => setDeletePkg(pkg)}
                            className="p-1.5 text-red-600 hover:bg-red-50 rounded-md transition-colors"
                            title="Delete"
                          >
                            <Trash2 size={15} />
                          </button>
                        </div>
                      </td>
                    </>
                  )}
                </tr>
              ))}
              {packages.length === 0 && (
                <tr>
                  <td
                    colSpan={5}
                    className="px-6 py-10 text-center text-gray-400"
                  >
                    No packages configured. Add your first package below.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>

        {/* ADD FORM */}
        <div className="p-5 bg-gray-50 border-t border-gray-200 flex flex-wrap md:flex-nowrap gap-4 items-center">
          <span className="text-sm font-bold text-gray-700 whitespace-nowrap">
            Add New Package:
          </span>
          <div className="flex-1 grid grid-cols-1 md:grid-cols-3 gap-3">
            <input
              className={inp()}
              placeholder="Name (e.g. Gamer Plus)"
              value={newPkg.name}
              onChange={(e) =>
                setNewPkg((d) => ({ ...d, name: e.target.value }))
              }
            />
            <input
              type="number"
              className={inp()}
              placeholder="Price (PKR)"
              value={newPkg.price}
              onChange={(e) =>
                setNewPkg((d) => ({ ...d, price: e.target.value }))
              }
            />
            <input
              type="number"
              className={inp()}
              placeholder="Speed (Mbps)"
              value={newPkg.speedMbps}
              onChange={(e) =>
                setNewPkg((d) => ({ ...d, speedMbps: e.target.value }))
              }
            />
          </div>
          <button
            onClick={handleAddPkg}
            className="px-6 py-2 bg-gray-900 text-white font-medium rounded-lg hover:bg-black transition-colors flex items-center gap-2 shadow-lg shadow-gray-200"
          >
            <Plus size={16} /> Add Package
          </button>
        </div>
      </section>

      {/* LISTS SECTION */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">
        <ListManager
          title="Coverage Areas"
          items={areas}
          newValue={newArea}
          onNewValueChange={setNewArea}
          onAdd={addArea}
          onRemove={removeArea}
          placeholder="e.g. Model Town"
        />
        <ListManager
          title="Recovery Agents"
          items={agents}
          newValue={newAgent}
          onNewValueChange={setNewAgent}
          onAdd={addAgent}
          onRemove={removeAgent}
          placeholder="e.g. Ali Raza"
        />
      </div>

      {/* HISTORY MODAL (TIMELINE) */}
      <Modal
        isOpen={!!historyPkg}
        onClose={() => setHistoryPkg(null)}
        title={`Price History: ${historyPkg?.name}`}
        size="md"
      >
        <div className="p-1">
          <div className="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-100 p-4 rounded-xl flex items-center justify-between mb-6">
            <div>
              <p className="text-xs font-bold text-blue-500 uppercase tracking-wide">
                Current Price
              </p>
              <p className="text-2xl font-black text-blue-900">
                PKR {Number(historyPkg?.price).toLocaleString()}
              </p>
            </div>
            <div className="bg-white p-2 rounded-full shadow-sm">
              <TrendingUp className="text-blue-600" size={24} />
            </div>
          </div>

          <h3 className="text-sm font-bold text-gray-800 mb-4 px-1">
            Change Log
          </h3>

          <div className="relative pl-4 border-l-2 border-gray-200 space-y-8 ml-2">
            {(historyPkg?.priceHistory || []).length === 0 ? (
              <div className="text-gray-400 text-sm flex items-center gap-2 pl-2">
                <AlertCircle size={16} /> No price changes recorded since
                creation.
              </div>
            ) : (
              [...historyPkg.priceHistory].reverse().map((h, i) => (
                <div key={i} className="relative">
                  {/* Dot */}
                  <div className="absolute -left-[21px] top-3.5 w-3 h-3 bg-white rounded-full border-2 border-blue-500 ring-4 ring-blue-50"></div>

                  <div className="bg-white p-3 rounded-lg border border-gray-200 shadow-sm hover:border-blue-300 transition-colors">
                    <div className="flex items-center justify-between mb-1.5">
                      <span className="text-xs font-bold text-gray-500">
                        {formatDate(h.changedAt)}
                      </span>
                    </div>
                    <div className="flex items-center gap-3 text-sm text-gray-800">
                      <span className="font-medium text-gray-400 line-through decoration-red-400">
                        PKR {h.oldPrice.toLocaleString()}
                      </span>
                      <ArrowRight size={14} className="text-gray-300" />
                      <span className="font-bold text-green-600 bg-green-50 px-2 py-0.5 rounded border border-green-100">
                        PKR {Number(h.newPrice).toLocaleString()}
                      </span>
                    </div>
                  </div>
                </div>
              ))
            )}

            {/* Initial Entry (Virtual) */}
            <div className="relative pt-4">
              <div className="absolute -left-[21px] top-5 w-3 h-3 bg-gray-300 rounded-full border-2 border-white"></div>
              <div className="text-xs text-gray-400 pl-2 pt-1">
                Package Created{" "}
                {historyPkg?.createdAt
                  ? `on ${formatDate(historyPkg.createdAt)}`
                  : ""}
              </div>
            </div>
          </div>

          <div className="flex justify-end mt-6">
            <button
              onClick={() => setHistoryPkg(null)}
              className="px-5 py-2 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-lg text-sm font-bold transition-colors"
            >
              Close
            </button>
          </div>
        </div>
      </Modal>

      {/* CONFIRM DELETE DIALOG */}
      <ConfirmDialog
        isOpen={!!deletePkg}
        onClose={() => setDeletePkg(null)}
        onConfirm={handleConfirmDelete}
        title="Delete Package"
        message={`Are you sure you want to delete "${deletePkg?.name}"? This cannot be undone.`}
        confirmLabel="Delete Package"
        requirePassword={true}
        danger={true}
      />
    </div>
  );
}

// Sub-component
function ListManager({
  title,
  items,
  newValue,
  onNewValueChange,
  onAdd,
  onRemove,
  placeholder,
}) {
  return (
    <section className="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden flex flex-col h-full">
      <div className="px-5 py-4 border-b border-gray-200 bg-gray-50/50">
        <h2 className="text-base font-bold text-gray-800">{title}</h2>
      </div>
      <div className="p-5 flex-1 flex flex-col gap-4">
        <div className="flex gap-2">
          <input
            className={`${inp()} flex-1`}
            placeholder={placeholder}
            value={newValue}
            onChange={(e) => onNewValueChange(e.target.value)}
            onKeyDown={(e) => e.key === "Enter" && onAdd()}
          />
          <button
            onClick={onAdd}
            className="px-4 py-2 text-sm bg-gray-900 text-white font-medium rounded-lg hover:bg-black flex items-center gap-1.5 transition-colors"
          >
            <Plus size={15} /> Add
          </button>
        </div>
        <div className="flex flex-wrap gap-2 mt-1">
          {items.map((item) => (
            <span
              key={item}
              className="flex items-center gap-1.5 bg-white border border-gray-200 text-gray-700 text-sm font-medium px-3 py-1.5 rounded-lg shadow-sm"
            >
              {item}
              <button
                onClick={() => onRemove(item)}
                className="text-gray-400 hover:text-red-500 transition-colors"
              >
                <X size={14} />
              </button>
            </span>
          ))}
          {items.length === 0 && (
            <span className="text-sm text-gray-400 italic">
              None added yet.
            </span>
          )}
        </div>
      </div>
    </section>
  );
}

const inp = () =>
  "border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all w-full";
</file>

<file path="src/store/useCustomerStore.js">
import { create } from "zustand";
import db from "../db/database";

const useCustomerStore = create((set) => ({
  customers: [],

  loadCustomers: async () => {
    const customers = await db.customers.toArray();
    set({ customers });
  },

  addCustomer: async (data) => {
    const id = await db.customers.add({
      ...data,
      createdAt: new Date().toISOString(),
    });
    const customer = await db.customers.get(id);
    set((s) => ({ customers: [...s.customers, customer] }));
    return customer;
  },

  updateCustomer: async (id, data) => {
    await db.customers.update(id, data);
    set((s) => ({
      customers: s.customers.map((c) => (c.id === id ? { ...c, ...data } : c)),
    }));
  },

  // SOFT DELETE ‚Äî marks as terminated + archived, preserves all data
  archiveCustomer: async (id, reason = "") => {
    const updates = {
      status: "terminated",
      isArchived: true,
      archivedAt: new Date().toISOString(),
      archiveReason: reason,
    };
    await db.customers.update(id, updates);
    set((s) => ({
      customers: s.customers.map((c) =>
        c.id === id ? { ...c, ...updates } : c,
      ),
    }));
  },

  // HARD DELETE ‚Äî only called from Archive view, truly removes everything
  permanentlyDeleteCustomer: async (id) => {
    await db.paymentCycles.where("customerId").equals(id).delete();
    await db.customers.delete(id);
    set((s) => ({ customers: s.customers.filter((c) => c.id !== id) }));
  },

  // Restore an archived customer back to active
  restoreCustomer: async (id) => {
    const updates = {
      status: "active",
      isArchived: false,
      archivedAt: null,
      archiveReason: "",
    };
    await db.customers.update(id, updates);
    set((s) => ({
      customers: s.customers.map((c) =>
        c.id === id ? { ...c, ...updates } : c,
      ),
    }));
  },
}));

export default useCustomerStore;
</file>

<file path="src/store/useExpenseStore.js">
import { create } from "zustand";
import db from "../db/database";

export const EXPENSE_CATEGORIES = [
  "Monthly Salary",
  "Food Labour",
  "Electricity Bill",
  "Petrol",
  "Misc",
  "Devices Purchased",
  "Rent",
  "Internet Uplink",
];

const useExpenseStore = create((set) => ({
  expenses: [],

  loadExpenses: async () => {
    const expenses = await db.expenses.toArray();
    set({ expenses });
  },

  addExpense: async (data) => {
    const id = await db.expenses.add({
      ...data,
      createdAt: new Date().toISOString(),
    });
    const expense = await db.expenses.get(id);
    set((s) => ({ expenses: [...s.expenses, expense] }));
  },

  updateExpense: async (id, data) => {
    await db.expenses.update(id, data);
    set((s) => ({
      expenses: s.expenses.map((e) => (e.id === id ? { ...e, ...data } : e)),
    }));
  },

  deleteExpense: async (id) => {
    await db.expenses.delete(id);
    set((s) => ({ expenses: s.expenses.filter((e) => e.id !== id) }));
  },

  getTotalExpenses: () => {
    // accessed via get() pattern, but easier as a computed here
    return 0; // components will compute from expenses array directly
  },
}));

export default useExpenseStore;
</file>

<file path="src/store/useInventoryStore.js">
import { create } from "zustand";
import db from "../db/database";

const useInventoryStore = create((set) => ({
  items: [],

  loadInventory: async () => {
    const items = await db.inventory.toArray();
    set({ items });
  },

  addItem: async (data) => {
    // Auto-calculate amount and balanced
    const amount = (Number(data.quantity) || 0) * (Number(data.unitRate) || 0);
    const balanced = (Number(data.received) || 0) - (Number(data.issued) || 0);
    const id = await db.inventory.add({
      ...data,
      amount,
      balanced,
      createdAt: new Date().toISOString(),
    });
    const item = await db.inventory.get(id);
    set((s) => ({ items: [...s.items, item] }));
  },

  updateItem: async (id, data) => {
    const amount = (Number(data.quantity) || 0) * (Number(data.unitRate) || 0);
    const balanced = (Number(data.received) || 0) - (Number(data.issued) || 0);
    const updates = { ...data, amount, balanced };
    await db.inventory.update(id, updates);
    set((s) => ({
      items: s.items.map((i) => (i.id === id ? { ...i, ...updates } : i)),
    }));
  },

  deleteItem: async (id) => {
    await db.inventory.delete(id);
    set((s) => ({ items: s.items.filter((i) => i.id !== id) }));
  },
}));

export default useInventoryStore;
</file>

<file path="src/store/usePackageStore.js">
import { create } from "zustand";
import db from "../db/database";
import { today } from "../utils/dateUtils";

const usePackageStore = create((set) => ({
  packages: [],

  loadPackages: async () => {
    const packages = await db.packages.toArray();
    set({ packages });
  },

  addPackage: async (data) => {
    const id = await db.packages.add({
      ...data,
      price: Number(data.price), // Ensure stored as Number
      speedMbps: Number(data.speedMbps) || 0,
      priceHistory: [],
      lastUpdated: null, // Null means "Original"
      createdAt: new Date().toISOString(),
    });
    const pkg = await db.packages.get(id);
    set((s) => ({ packages: [...s.packages, pkg] }));
  },

  updatePackage: async (id, newData) => {
    // 1. Fetch latest version directly from DB to avoid stale state
    const currentPkg = await db.packages.get(id);
    if (!currentPkg) return;

    const oldPrice = Number(currentPkg.price);
    const newPrice = Number(newData.price);

    // 2. Prepare update object
    let updates = {
      name: newData.name,
      price: newPrice,
      speedMbps: Number(newData.speedMbps) || 0,
    };

    // 3. Detect Price Change
    if (oldPrice !== newPrice) {
      const historyEntry = {
        id: crypto.randomUUID(),
        oldPrice: oldPrice,
        newPrice: newPrice,
        changedAt: today(), // YYYY-MM-DD
      };

      // Robustly append to history
      const previousHistory = Array.isArray(currentPkg.priceHistory)
        ? currentPkg.priceHistory
        : [];

      updates.priceHistory = [...previousHistory, historyEntry];
      updates.lastUpdated = today();
    }

    // 4. Save to DB
    await db.packages.update(id, updates);

    // 5. Update UI State (Fetch fresh to be safe)
    const freshPkg = await db.packages.get(id);
    set((s) => ({
      packages: s.packages.map((p) => (p.id === id ? freshPkg : p)),
    }));
  },

  deletePackage: async (id) => {
    await db.packages.delete(id);
    set((s) => ({ packages: s.packages.filter((p) => p.id !== id) }));
  },
}));

export default usePackageStore;
</file>

<file path="src/utils/backup.js">
import { readAll, writeAll } from "../db/database";

export const exportBackup = async () => {
  const data = await readAll();

  const backup = {
    exportedAt: new Date().toISOString(),
    version: "2.0",
    data,
  };

  const blob = new Blob([JSON.stringify(backup, null, 2)], {
    type: "application/json",
  });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.download = `galaxy-isp-backup-${new Date().toISOString().slice(0, 10)}.json`;
  a.href = url;
  a.click();
  URL.revokeObjectURL(url);

  // Save last backup date
  const updated = await readAll();
  updated.settings = {
    ...(updated.settings || {}),
    lastBackupDate: new Date().toISOString().slice(0, 10),
  };
  await writeAll(updated);
};

export const importBackup = async (file) => {
  const text = await file.text();
  let backup;
  try {
    backup = JSON.parse(text);
  } catch {
    throw new Error("Invalid backup file. Could not parse JSON.");
  }

  // Support both v1 (Dexie) and v2 (file-based) backup formats
  let restored;
  if (backup.data && backup.version === "2.0") {
    restored = backup.data;
  } else if (backup.data) {
    // v1 format conversion
    const d = backup.data;
    restored = {
      customers: d.customers || [],
      paymentCycles: d.cycles || [],
      packages: d.packages || [],
      inventory: d.inventory || [],
      expenses: d.expenses || [],
      settings: {},
    };
    (d.settings || []).forEach((s) => {
      restored.settings[s.key] = s.value;
    });
  } else {
    throw new Error("Invalid backup format.");
  }

  await writeAll(restored);
};

export const getLastBackupDate = async () => {
  const data = await readAll();
  return (data.settings || {}).lastBackupDate || null;
};
</file>

<file path="src/utils/duplicateCheck.js">
import db from "../db/database";

/**
 * Checks if a username or mobile number already exists.
 * Pass excludeId when editing an existing customer (to skip self-match).
 * Returns: { hasDuplicate: bool, field: 'userName'|'mobileNo'|null, existing: customer|null }
 */
export const checkDuplicate = async (userName, mobileNo, excludeId = null) => {
  const all = await db.customers.toArray();

  if (userName && userName.trim()) {
    const normalised = userName.trim().toLowerCase();
    const match = all.find(
      (c) => c.userName?.toLowerCase() === normalised && c.id !== excludeId,
    );
    if (match)
      return { hasDuplicate: true, field: "userName", existing: match };
  }

  if (mobileNo && String(mobileNo).replace(/\D/g, "").length >= 10) {
    const cleaned = String(mobileNo).replace(/\D/g, "");
    const match = all.find(
      (c) =>
        String(c.mobileNo).replace(/\D/g, "") === cleaned && c.id !== excludeId,
    );
    if (match)
      return { hasDuplicate: true, field: "mobileNo", existing: match };
  }

  return { hasDuplicate: false, field: null, existing: null };
};
</file>

<file path="vite.config.js">
import { defineConfig } from "vite";
import react from "@vitejs/plugin-react";
import tailwindcss from "@tailwindcss/vite";
import fs from "node:fs";
import path from "node:path";
import { fileURLToPath } from "node:url";

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const DATA_FILE = path.join(__dirname, "galaxy-data.json");

const DEFAULT_DATA = {
  customers: [],
  paymentCycles: [],
  packages: [],
  inventory: [],
  expenses: [],
  settings: {},
};

function ensureDataFile() {
  if (!fs.existsSync(DATA_FILE)) {
    fs.writeFileSync(DATA_FILE, JSON.stringify(DEFAULT_DATA, null, 2), "utf-8");
    console.log("[galaxy-isp] Created galaxy-data.json");
  }
}

function localDataPlugin() {
  return {
    name: "local-data-api",
    configureServer(server) {
      server.middlewares.use("/api/data", (req, res, next) => {
        res.setHeader("Access-Control-Allow-Origin", "*");
        res.setHeader("Access-Control-Allow-Methods", "GET, POST, OPTIONS");
        res.setHeader("Access-Control-Allow-Headers", "Content-Type");

        if (req.method === "OPTIONS") {
          res.writeHead(200);
          res.end();
          return;
        }

        if (req.method === "GET") {
          try {
            ensureDataFile();
            const data = fs.readFileSync(DATA_FILE, "utf-8");
            res.setHeader("Content-Type", "application/json");
            res.writeHead(200);
            res.end(data);
          } catch (e) {
            res.writeHead(500);
            res.end(JSON.stringify({ error: e.message }));
          }
          return;
        }

        if (req.method === "POST") {
          let body = "";
          req.on("data", (chunk) => {
            body += chunk;
          });
          req.on("end", () => {
            try {
              const parsed = JSON.parse(body);
              fs.writeFileSync(
                DATA_FILE,
                JSON.stringify(parsed, null, 2),
                "utf-8",
              );
              res.setHeader("Content-Type", "application/json");
              res.writeHead(200);
              res.end(JSON.stringify({ ok: true }));
            } catch (e) {
              res.writeHead(400);
              res.end(JSON.stringify({ error: e.message }));
            }
          });
          return;
        }

        next();
      });
    },
  };
}

export default defineConfig({
  base: "./", // Add this line!
  plugins: [react(), tailwindcss(), localDataPlugin()],
  server: {
    watch: {
      // Tell Vite to ignore galaxy-data.json ‚Äî every save to this file
      // was triggering HMR which reset all React state (tab ‚Üí "dashboard")
      ignored: ["**/galaxy-data.json"],
    },
  },
});
</file>

<file path="src/components/ui/HistoryModal.jsx">
import {
  Calendar,
  Wallet,
  CheckCircle,
  AlertCircle,
  Receipt,
  ArrowRightCircle,
  History,
} from "lucide-react";
import Modal from "./Modal";
import Badge from "./Badge";
import usePaymentStore from "../../store/usePaymentStore";
import { formatDate } from "../../utils/dateUtils";

export default function HistoryModal({ customer, onClose }) {
  const getCyclesForCustomer = usePaymentStore((s) => s.getCyclesForCustomer);

  if (!customer) return null;

  const cycles = getCyclesForCustomer(customer.id);

  // Quick Summary Computations
  const totalPending = cycles.reduce(
    (sum, c) => sum + (c.amountPending || 0),
    0,
  );
  const totalCycles = cycles.length;

  return (
    <Modal
      isOpen={!!customer}
      onClose={onClose}
      title={`Payment History: ${customer.fullName}`}
      size="3xl"
    >
      <div className="space-y-6">
        {/* ‚îÄ‚îÄ TOP SUMMARY DASHBOARD ‚îÄ‚îÄ */}
        <div className="grid grid-cols-3 gap-4">
          <div className="bg-blue-50 border border-blue-100 p-3 rounded-xl flex flex-col justify-center items-center text-center">
            <span className="text-blue-600/80 text-[10px] font-bold uppercase tracking-wider mb-1">
              Total Cycles
            </span>
            <span className="text-xl font-black text-blue-700">
              {totalCycles}
            </span>
          </div>

          <div
            className={`p-3 rounded-xl border flex flex-col justify-center items-center text-center shadow-sm ${
              totalPending > 0
                ? "bg-red-50 border-red-200"
                : "bg-green-50 border-green-200"
            }`}
          >
            <span
              className={`text-[10px] font-bold uppercase tracking-wider mb-1 ${
                totalPending > 0 ? "text-red-600/80" : "text-green-600/80"
              }`}
            >
              Total Unpaid Balance
            </span>
            <span
              className={`text-xl font-black ${
                totalPending > 0 ? "text-red-600" : "text-green-600"
              }`}
            >
              PKR {totalPending.toLocaleString()}
            </span>
          </div>

          <div className="bg-gray-50 border border-gray-200 p-3 rounded-xl flex flex-col justify-center items-center text-center">
            <span className="text-gray-500 text-[10px] font-bold uppercase tracking-wider mb-1.5">
              Account Status
            </span>
            <Badge status={customer.status} />
          </div>
        </div>

        {/* ‚îÄ‚îÄ TIMELINE OF CYCLES ‚îÄ‚îÄ */}
        <div className="space-y-4 max-h-[55vh] overflow-y-auto pr-2">
          {cycles.length === 0 ? (
            <div className="text-center py-10 bg-gray-50 text-gray-400 text-sm border-2 border-dashed border-gray-200 rounded-xl">
              <Wallet size={36} className="mx-auto mb-3 opacity-40" />
              <p className="font-medium text-gray-500">
                No payment history found.
              </p>
              <p className="text-xs mt-1">
                Billing cycles will appear here once created.
              </p>
            </div>
          ) : (
            cycles.map((cycle) => {
              // 1. Detect if this cycle was transferred
              const isTransferred =
                cycle.note && cycle.note.includes("[Bal Transferred"); // Match broader string to catch both formats

              // 2. Try to extract the specific amount
              // Format matches: "[Bal Transferred: 2000]"
              const transferMatch = cycle.note
                ? cycle.note.match(/\[Bal Transferred:\s*(\d+)\]/)
                : null;
              const transferredAmount = transferMatch
                ? Number(transferMatch[1])
                : null;

              const isClear = cycle.amountPending === 0;

              // Calculate percent paid
              const percentPaid =
                cycle.totalAmount > 0
                  ? Math.min(
                      100,
                      Math.round((cycle.amountPaid / cycle.totalAmount) * 100),
                    )
                  : isTransferred || isClear
                    ? 100
                    : 0;

              // Determine styling based on status
              let borderColor = "border-gray-100";
              let headerBg = "bg-gray-50/70 border-gray-100";
              let bodyBg = "bg-white";

              if (isTransferred) {
                borderColor = "border-purple-200";
                headerBg = "bg-purple-100 border-purple-200";
                bodyBg = "bg-purple-50/30";
              } else if (!isClear) {
                borderColor = "border-orange-200";
                headerBg = "bg-orange-50 border-orange-200";
                bodyBg = "bg-orange-50/10";
              }

              return (
                <div
                  key={cycle.id}
                  className={`border-2 rounded-xl overflow-hidden transition-colors ${borderColor} ${bodyBg}`}
                >
                  {/* Cycle Header */}
                  <div
                    className={`px-4 py-3 border-b flex justify-between items-center ${headerBg}`}
                  >
                    <div className="flex items-center gap-2.5">
                      {isTransferred ? (
                        <ArrowRightCircle
                          size={16}
                          className="text-purple-600"
                        />
                      ) : (
                        <Calendar
                          size={16}
                          className={
                            isClear ? "text-gray-400" : "text-orange-500"
                          }
                        />
                      )}
                      <span className="text-sm font-bold text-gray-800 tracking-tight">
                        {formatDate(cycle.cycleStartDate)}
                        <span className="mx-2 text-gray-400 font-normal">
                          to
                        </span>
                        {formatDate(cycle.cycleEndDate)}
                      </span>
                    </div>

                    {isTransferred ? (
                      <span className="inline-flex items-center gap-1 px-2.5 py-0.5 rounded text-xs font-bold bg-purple-200 text-purple-800 border border-purple-300">
                        Forwarded
                      </span>
                    ) : (
                      <Badge status={cycle.status} />
                    )}
                  </div>

                  <div className="p-4">
                    {/* TRANSFERRED BANNER */}
                    {isTransferred && (
                      <div className="mb-4 bg-purple-100 text-purple-900 px-3 py-2.5 rounded-lg flex items-start gap-3 text-xs border border-purple-200 shadow-sm">
                        <History size={16} className="mt-0.5 shrink-0" />
                        <div className="leading-relaxed">
                          {transferredAmount ? (
                            <>
                              <strong className="text-purple-900 text-sm">
                                PKR {transferredAmount.toLocaleString()} Shifted
                              </strong>
                              <div className="mt-0.5 opacity-90">
                                This amount was unpaid in this cycle and has
                                been added to the{" "}
                                <span
                                  className="underline font-semibold cursor-help"
                                  title="Check the newest cycle"
                                >
                                  next billing cycle
                                </span>
                                .
                              </div>
                            </>
                          ) : (
                            // Fallback for older data without exact amount recorded
                            <>
                              <strong>Balance Shifted:</strong> The unpaid dues
                              were added to the next cycle.
                            </>
                          )}
                        </div>
                      </div>
                    )}

                    {/* Financials Row */}
                    <div className="flex items-center justify-between mb-3 text-sm px-2">
                      <div className="flex flex-col">
                        <span className="text-[11px] uppercase font-bold text-gray-400 flex items-center gap-1 mb-0.5">
                          <Receipt size={12} /> Total Bill
                        </span>
                        <span className="font-extrabold text-gray-800 text-base">
                          PKR {cycle.totalAmount}
                        </span>
                      </div>

                      <div className="w-px h-8 bg-gray-200"></div>

                      <div className="flex flex-col">
                        <span className="text-[11px] uppercase font-bold text-gray-400 flex items-center gap-1 mb-0.5">
                          <CheckCircle size={12} className="text-green-500" />{" "}
                          Paid
                        </span>
                        <span className="font-extrabold text-green-600 text-base">
                          PKR {cycle.amountPaid}
                        </span>
                      </div>

                      <div className="w-px h-8 bg-gray-200"></div>

                      <div className="flex flex-col">
                        <span className="text-[11px] uppercase font-bold text-gray-400 flex items-center gap-1 mb-0.5">
                          <AlertCircle
                            size={12}
                            className={
                              !isClear ? "text-red-500" : "text-gray-400"
                            }
                          />{" "}
                          Pending
                        </span>
                        <span
                          className={`font-extrabold text-base ${
                            !isClear ? "text-red-600" : "text-gray-400"
                          }`}
                        >
                          PKR {cycle.amountPending}
                        </span>
                      </div>
                    </div>

                    {/* Progress Bar */}
                    <div className="w-full bg-gray-100 rounded-full h-1.5 mb-4 overflow-hidden mt-2">
                      <div
                        className={`h-1.5 rounded-full transition-all duration-500 ${
                          isTransferred
                            ? "bg-purple-400"
                            : isClear
                              ? "bg-green-500"
                              : "bg-blue-500"
                        }`}
                        style={{ width: `${percentPaid}%` }}
                      ></div>
                    </div>

                    {/* Installments List */}
                    {cycle.installments && cycle.installments.length > 0 && (
                      <div className="bg-gray-50 rounded-lg p-3 border border-gray-100">
                        <div className="text-[10px] font-bold text-gray-400 uppercase tracking-wider flex items-center gap-1.5 mb-2.5">
                          <Wallet size={12} /> Payments Received
                        </div>
                        <div className="space-y-2">
                          {cycle.installments.map((inst) => (
                            <div
                              key={inst.id}
                              className="flex justify-between items-center bg-white px-3 py-2 rounded border border-gray-100 shadow-sm hover:border-gray-300 transition-colors"
                            >
                              <div className="flex items-center gap-3">
                                <div className="bg-green-100 text-green-600 p-1.5 rounded-full">
                                  <CheckCircle size={13} strokeWidth={2.5} />
                                </div>
                                <div>
                                  <div className="text-xs font-bold text-gray-800">
                                    {formatDate(inst.datePaid)}
                                  </div>
                                  {inst.note && (
                                    <div className="text-[10px] text-gray-500 mt-0.5 font-medium leading-none">
                                      Via: {inst.note}
                                    </div>
                                  )}
                                </div>
                              </div>
                              <span className="text-sm font-bold text-gray-800">
                                PKR {inst.amountPaid}
                              </span>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              );
            })
          )}
        </div>

        {/* Footer Close Button */}
        <div className="pt-2 flex justify-end">
          <button
            onClick={onClose}
            className="px-6 py-2.5 bg-gray-100 hover:bg-gray-200 border border-gray-200 text-gray-700 text-sm font-bold rounded-lg transition-colors focus:ring-2 focus:ring-gray-300 focus:outline-none"
          >
            Close History
          </button>
        </div>
      </div>
    </Modal>
  );
}
</file>

<file path="src/pages/Customers/CustomerForm.jsx">
import { useState, useEffect, useCallback } from "react";
import { checkDuplicate } from "../../utils/duplicateCheck";
import { today } from "../../utils/dateUtils";
import usePackageStore from "../../store/usePackageStore";
import useCustomerStore from "../../store/useCustomerStore";
import usePaymentStore from "../../store/usePaymentStore";
import db from "../../db/database";

const INITIAL = {
  fullName: "",
  userName: "",
  mobileNo: "",
  cnic: "", // New CNIC field
  mainArea: "",
  recoveryAgent: "",
  packageId: "",
  status: "active",
  notes: "",
  startDate: today(),
};

const PAYMENT_INITIAL = {
  recordPayment: false,
  amountPaid: "",
  paymentDate: today(),
  paymentNote: "",
};

// Helper to format CNIC as 00000-0000000-0
const formatCNIC = (val) => {
  // Remove non-digits and limit to 13 digits
  const digits = val.replace(/\D/g, "").slice(0, 13);
  let res = "";
  if (digits.length > 0) res += digits.slice(0, 5);
  if (digits.length > 5) res += "-" + digits.slice(5, 12);
  if (digits.length > 12) res += "-" + digits.slice(12, 13);
  return res;
};

export default function CustomerForm({ customer, onClose }) {
  const addCustomer = useCustomerStore((s) => s.addCustomer);
  const updateCustomer = useCustomerStore((s) => s.updateCustomer);
  const createInitialCycle = usePaymentStore((s) => s.createInitialCycle);
  const addInstallment = usePaymentStore((s) => s.addInstallment);
  const allPackages = usePackageStore((s) => s.packages);
  const packages = allPackages.filter((p) => p.isActive !== false);
  const isEdit = !!customer;

  // Initialize form. Ensure 'cnic' exists even for old records.
  const [form, setFormState] = useState(
    isEdit ? { cnic: "", ...customer, startDate: today() } : INITIAL,
  );
  const [payment, setPaymentState] = useState(PAYMENT_INITIAL);
  const [errors, setErrors] = useState({});
  const [dupWarning, setDupWarning] = useState(null);
  const [areas, setAreas] = useState([]);
  const [agents, setAgents] = useState([]);
  const [saving, setSaving] = useState(false);

  useEffect(() => {
    db.settings.get("areas").then((r) => setAreas(r?.value || []));
    db.settings.get("agents").then((r) => setAgents(r?.value || []));
  }, []);

  // When package changes, auto-fill amountPaid with full price as default
  useEffect(() => {
    const timer = setTimeout(() => {
      if (!isEdit && form.packageId) {
        const pkg = packages.find(
          (p) => Number(p.id) === Number(form.packageId),
        );
        if (pkg && !payment.amountPaid) {
          setPaymentState((p) => ({ ...p, amountPaid: String(pkg.price) }));
        }
      }
    }, 0);
    return clearTimeout(timer);
  }, [form.packageId, isEdit, packages, payment]);

  const setField = (field, value) => {
    setFormState((f) => ({ ...f, [field]: value }));
    setErrors((e) => ({ ...e, [field]: "" }));
  };

  const setPayField = (field, value) => {
    setPaymentState((p) => ({ ...p, [field]: value }));
    setErrors((e) => ({ ...e, [field]: "" }));
  };

  const checkDup = useCallback(
    async (field, value) => {
      if (!value) return setDupWarning(null);
      const result = await checkDuplicate(
        field === "userName" ? value : form.userName,
        field === "mobileNo" ? value : form.mobileNo,
        isEdit ? customer.id : null,
      );
      if (result.hasDuplicate) {
        setDupWarning(
          `${field === "userName" ? "Username" : "Mobile"} already used by: ${result.existing.fullName}`,
        );
      } else {
        setDupWarning(null);
      }
    },
    [form.userName, form.mobileNo, isEdit, customer],
  );

  const validate = () => {
    const e = {};
    if (!form.fullName.trim()) e.fullName = "Required";
    if (!form.userName.trim()) e.userName = "Required";
    if (!form.packageId) e.packageId = "Select a package";
    if (!form.mainArea) e.mainArea = "Select an area";

    // Mobile Validation (Strict Pakistani Format)
    if (form.mobileNo) {
      if (!/^0\d{10}$/.test(form.mobileNo)) {
        e.mobileNo = "Must be 11 digits starting with 0 (e.g., 03001234567)";
      }
    }

    // CNIC Validation (Format: 00000-0000000-0)
    if (form.cnic) {
      if (form.cnic.length < 15) {
        e.cnic = "Invalid CNIC format (13 digits required)";
      }
    }

    // Validate payment section only if enabled
    if (!isEdit && payment.recordPayment) {
      const amt = Number(payment.amountPaid);
      if (!payment.amountPaid || amt <= 0)
        e.amountPaid = "Enter a valid amount";
      const pkg = packages.find((p) => Number(p.id) === Number(form.packageId));
      if (pkg && amt > pkg.price)
        e.amountPaid = `Cannot exceed PKR ${pkg.price} (package price)`;
      if (!payment.paymentDate) e.paymentDate = "Required";
    }
    return e;
  };

  const handleSubmit = async () => {
    const e = validate();
    if (Object.keys(e).length) {
      setErrors(e);
      return;
    }
    if (dupWarning) return;

    setSaving(true);
    try {
      const pkgId = Number(form.packageId);
      const pkg = packages.find((p) => Number(p.id) === pkgId);
      const lockedPrice = pkg ? Number(pkg.price) : 0;

      const customerData = {
        fullName: form.fullName.trim(),
        userName: form.userName.trim(),
        mobileNo: form.mobileNo,
        cnic: form.cnic, // Save CNIC
        mainArea: form.mainArea,
        recoveryAgent: form.recoveryAgent,
        packageId: pkgId,
        lockedPackagePrice: lockedPrice,
        status: isEdit ? form.status : "active",
        notes: form.notes,
      };

      if (isEdit) {
        await updateCustomer(customer.id, customerData);
      } else {
        const newCustomer = await addCustomer(customerData);

        // Always create the billing cycle first
        const newCycle = await createInitialCycle(
          newCustomer.id,
          form.startDate,
          lockedPrice,
        );

        // If staff also entered a payment, record it immediately
        if (payment.recordPayment && Number(payment.amountPaid) > 0) {
          await addInstallment(
            newCycle.id,
            Number(payment.amountPaid),
            payment.paymentDate,
            payment.paymentNote || "",
          );
        }
      }
      onClose();
    } catch (err) {
      alert("Error saving: " + err.message);
    }
    setSaving(false);
  };

  // Derived: selected package price for display
  const selectedPkg = packages.find(
    (p) => Number(p.id) === Number(form.packageId),
  );
  const packagePrice = selectedPkg ? Number(selectedPkg.price) : 0;
  const amountPaidNum = Number(payment.amountPaid) || 0;
  const remaining = packagePrice - amountPaidNum;

  return (
    <div className="space-y-5">
      {/* ‚îÄ‚îÄ DUPLICATE WARNING ‚îÄ‚îÄ */}
      {dupWarning && (
        <div className="bg-red-50 border border-red-300 text-red-700 text-sm px-3 py-2 rounded-lg">
          ‚ö† Duplicate detected: {dupWarning}
        </div>
      )}

      {/* ‚îÄ‚îÄ CUSTOMER INFO ‚îÄ‚îÄ */}
      <div>
        <p className="text-xs font-bold text-gray-500 uppercase tracking-wide mb-3">
          Customer Information
        </p>
        <div className="grid grid-cols-2 gap-4">
          <Field label="Full Name *" error={errors.fullName}>
            <input
              className={inp(errors.fullName)}
              value={form.fullName}
              onChange={(e) => setField("fullName", e.target.value)}
              placeholder="e.g. Muhammad Qasim"
            />
          </Field>

          <Field label="Username *" error={errors.userName}>
            <input
              className={inp(errors.userName)}
              value={form.userName}
              onChange={(e) => {
                setField("userName", e.target.value);
                checkDup("userName", e.target.value);
              }}
              placeholder="e.g. Qasim6655"
            />
          </Field>

          <Field label="Mobile No" error={errors.mobileNo}>
            <input
              className={inp(errors.mobileNo)}
              value={form.mobileNo}
              onChange={(e) => {
                // Digits only, max 11 chars
                const val = e.target.value.replace(/\D/g, "").slice(0, 11);
                setField("mobileNo", val);
                checkDup("mobileNo", val);
              }}
              placeholder="03001234567"
              type="tel"
            />
          </Field>

          <Field label="CNIC (Optional)" error={errors.cnic}>
            <input
              className={inp(errors.cnic)}
              value={form.cnic}
              onChange={(e) => {
                // Apply CNIC masking
                const val = formatCNIC(e.target.value);
                setField("cnic", val);
              }}
              placeholder="35202-1234567-1"
              maxLength={15} // 13 digits + 2 dashes
            />
          </Field>

          <Field label="Package *" error={errors.packageId}>
            <select
              className={inp(errors.packageId)}
              value={form.packageId}
              onChange={(e) => {
                setField("packageId", e.target.value);
                // Reset payment amount so it auto-fills with new price
                setPaymentState((p) => ({ ...p, amountPaid: "" }));
              }}
            >
              <option value="">‚Äî Select Package ‚Äî</option>
              {packages.map((p) => (
                <option key={p.id} value={p.id}>
                  {p.name} ‚Äî PKR {Number(p.price).toLocaleString()}
                </option>
              ))}
            </select>
          </Field>

          <Field label="Main Area *" error={errors.mainArea}>
            <select
              className={inp(errors.mainArea)}
              value={form.mainArea}
              onChange={(e) => setField("mainArea", e.target.value)}
            >
              <option value="">‚Äî Select Area ‚Äî</option>
              {areas.map((a) => (
                <option key={a} value={a}>
                  {a}
                </option>
              ))}
            </select>
          </Field>

          <Field label="Recovery Agent">
            <select
              className={inp()}
              value={form.recoveryAgent}
              onChange={(e) => setField("recoveryAgent", e.target.value)}
            >
              <option value="">‚Äî Select Agent ‚Äî</option>
              {agents.map((a) => (
                <option key={a} value={a}>
                  {a}
                </option>
              ))}
            </select>
          </Field>

          {!isEdit && (
            <Field label="Subscription Start Date *">
              <input
                type="date"
                className={inp()}
                value={form.startDate}
                max={today()}
                onChange={(e) => setField("startDate", e.target.value)}
              />
            </Field>
          )}

          {isEdit && (
            <Field label="Status">
              <select
                className={inp()}
                value={form.status}
                onChange={(e) => setField("status", e.target.value)}
              >
                <option value="active">Active</option>
                <option value="suspended">Suspended</option>
                <option value="terminated">Terminated</option>
              </select>
            </Field>
          )}
        </div>

        <div className="mt-4">
          <Field label="Notes">
            <textarea
              className={inp() + " resize-none"}
              rows={2}
              value={form.notes}
              onChange={(e) => setField("notes", e.target.value)}
              placeholder="Optional notes..."
            />
          </Field>
        </div>
      </div>

      {/* ‚îÄ‚îÄ PAYMENT SECTION (Add mode only) ‚îÄ‚îÄ */}
      {!isEdit && (
        <div className="border-t border-gray-200 pt-4">
          {/* Toggle */}
          <label className="flex items-center gap-3 cursor-pointer select-none mb-4">
            <div
              onClick={() =>
                setPayField("recordPayment", !payment.recordPayment)
              }
              className={`relative w-11 h-6 rounded-full transition-colors ${
                payment.recordPayment ? "bg-blue-600" : "bg-gray-300"
              }`}
            >
              <div
                className={`absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform ${
                  payment.recordPayment ? "translate-x-5" : "translate-x-0"
                }`}
              />
            </div>
            <div>
              <span className="text-sm font-bold text-gray-800">
                Record First Payment Now
              </span>
              <p className="text-xs text-gray-400">
                Optionally log a payment while adding the customer
              </p>
            </div>
          </label>

          {payment.recordPayment && (
            <div className="bg-blue-50 border border-blue-200 rounded-xl p-4 space-y-4">
              {/* Package price hint */}
              {selectedPkg && (
                <div className="flex items-center justify-between bg-white border border-blue-100 rounded-lg px-4 py-2 text-sm">
                  <span className="text-gray-500">Package Total</span>
                  <span className="font-bold text-gray-800">
                    PKR {packagePrice.toLocaleString()}
                  </span>
                </div>
              )}

              <div className="grid grid-cols-2 gap-4">
                <Field label="Amount Paid *" error={errors.amountPaid}>
                  <input
                    type="number"
                    min="1"
                    max={packagePrice || undefined}
                    className={inp(errors.amountPaid)}
                    value={payment.amountPaid}
                    onChange={(e) => setPayField("amountPaid", e.target.value)}
                    placeholder={`Max PKR ${packagePrice.toLocaleString()}`}
                  />
                </Field>

                <Field label="Payment Date *" error={errors.paymentDate}>
                  <input
                    type="date"
                    className={inp(errors.paymentDate)}
                    value={payment.paymentDate}
                    max={today()}
                    onChange={(e) => setPayField("paymentDate", e.target.value)}
                  />
                </Field>
              </div>

              <Field label="Payment Note (optional)">
                <input
                  className={inp()}
                  value={payment.paymentNote}
                  onChange={(e) => setPayField("paymentNote", e.target.value)}
                  placeholder="e.g. Cash received, Bank transfer..."
                />
              </Field>

              {/* Live remaining balance */}
              {selectedPkg && amountPaidNum > 0 && (
                <div
                  className={`flex items-center justify-between rounded-lg px-4 py-2 text-sm font-semibold ${
                    remaining <= 0
                      ? "bg-green-100 text-green-800"
                      : "bg-yellow-100 text-yellow-800"
                  }`}
                >
                  <span>
                    {remaining <= 0 ? "‚úì Fully Paid" : "Remaining Balance"}
                  </span>
                  <span>
                    {remaining <= 0
                      ? "PKR 0"
                      : `PKR ${remaining.toLocaleString()}`}
                  </span>
                </div>
              )}
            </div>
          )}
        </div>
      )}

      {/* ‚îÄ‚îÄ FOOTER BUTTONS ‚îÄ‚îÄ */}
      <div className="flex justify-end gap-3 pt-1">
        <button
          onClick={onClose}
          className="px-4 py-2 text-sm border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50"
        >
          Cancel
        </button>
        <button
          onClick={handleSubmit}
          disabled={saving || !!dupWarning}
          className="px-5 py-2 text-sm bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 disabled:opacity-50"
        >
          {saving
            ? "Saving..."
            : isEdit
              ? "Save Changes"
              : payment.recordPayment
                ? "Add Customer & Record Payment"
                : "Add Customer"}
        </button>
      </div>
    </div>
  );
}

const inp = (err) =>
  `w-full border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 ${
    err ? "border-red-400 bg-red-50" : "border-gray-300 bg-white"
  }`;

function Field({ label, error, children }) {
  return (
    <div>
      <label className="block text-xs font-semibold text-gray-600 mb-1.5">
        {label}
      </label>
      {children}
      {error && <p className="text-xs text-red-500 mt-1">{error}</p>}
    </div>
  );
}
</file>

<file path="src/utils/dateUtils.js">
// src/utils/dateUtils.js

// ‚îÄ‚îÄ‚îÄ Core constant ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// A billing cycle is exactly 30 days inclusive of both start and end date.
// That means: endDate = startDate + 29 days.
//
// Why 29 and not 30?
//   Day 1  = startDate         (e.g. 28-Feb)
//   Day 30 = startDate + 29    (e.g. 29-Mar)
//   startDate + 30 would be Day 31 ‚Äî one day too many.
//
// This constant is used by the payment store wherever it creates cycles.
// Never hard-code 29 or 30 directly ‚Äî always use this.
export const CYCLE_LENGTH_DAYS = 29; // offset to add to startDate to get endDate

// ‚îÄ‚îÄ‚îÄ addDays ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Adds `days` to a YYYY-MM-DD string and returns a new YYYY-MM-DD string.
//
// Implementation notes:
//   ‚Ä¢ We parse year/month/day manually to avoid any timezone shifting that
//     `new Date(dateStr)` can cause (it parses ISO strings as UTC midnight,
//     but `new Date(y, m, d)` uses LOCAL midnight ‚Äî mixing the two is a bug).
//   ‚Ä¢ We always construct dates with `new Date(y, m - 1, d)` (local).
//   ‚Ä¢ JavaScript's Date handles month/year rollovers automatically:
//       new Date(2026, 1, 28 + 1) ‚Üí 1 Mar 2026  ‚úì  (Feb has 28 days in 2026)
//       new Date(2024, 1, 28 + 1) ‚Üí 29 Feb 2024 ‚úì  (2024 is a leap year)
//       new Date(2026, 11, 31 + 1)‚Üí 1 Jan 2027  ‚úì  (Dec ‚Üí Jan rollover)
//   ‚Ä¢ `days` may be negative (used for "go back N days").
export const addDays = (dateStr, days) => {
  const [y, m, d] = dateStr.split("-").map(Number);
  const date = new Date(y, m - 1, d + days); // JS handles overflow/underflow
  return _toYMD(date);
};

// ‚îÄ‚îÄ‚îÄ formatDate ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Returns a human-readable date like "27-Feb-2026".
// Always parses as local midnight (y, m-1, d) to avoid UTC-offset surprises.
export const formatDate = (dateStr) => {
  if (!dateStr) return "-";
  const raw = dateStr.split("T")[0]; // strip any time component
  const [y, m, d] = raw.split("-").map(Number);
  if (!y || !m || !d) return "-";
  const date = new Date(y, m - 1, d);
  if (isNaN(date.getTime())) return "-";
  return date
    .toLocaleDateString("en-PK", {
      day: "2-digit",
      month: "short",
      year: "numeric",
    })
    .replace(/\//g, "-");
};

// ‚îÄ‚îÄ‚îÄ today ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Returns today's local date as YYYY-MM-DD.
// Uses local getFullYear/getMonth/getDate ‚Äî never UTC ‚Äî so it matches the
// machine's wall-clock date regardless of timezone.
export const today = () => {
  return _toYMD(new Date());
};

// ‚îÄ‚îÄ‚îÄ daysUntil ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Returns how many days from today until `dateStr` (negative = past).
// Both dates are normalised to local midnight so partial-day offsets don't
// affect the result.
export const daysUntil = (dateStr) => {
  if (!dateStr) return 0;
  const raw = dateStr.split("T")[0];
  const [y, m, d] = raw.split("-").map(Number);
  const target = new Date(y, m - 1, d); // local midnight on target date
  const now = new Date();
  now.setHours(0, 0, 0, 0); // local midnight today
  return Math.round((target - now) / (1000 * 60 * 60 * 24));
};

// ‚îÄ‚îÄ‚îÄ daysSince ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Inverse of daysUntil: positive = date is in the past.
export const daysSince = (dateStr) => -daysUntil(dateStr);

// ‚îÄ‚îÄ‚îÄ Internal helper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Converts a local Date object to a zero-padded YYYY-MM-DD string.
function _toYMD(date) {
  const yy = date.getFullYear();
  const mm = String(date.getMonth() + 1).padStart(2, "0");
  const dd = String(date.getDate()).padStart(2, "0");
  return `${yy}-${mm}-${dd}`;
}
</file>

<file path="src/utils/devTools.js">
// src/utils/devTools.js
import db from "../db/database";
import usePaymentStore from "../store/usePaymentStore";
import useCustomerStore from "../store/useCustomerStore";
import useExpenseStore from "../store/useExpenseStore";
import useInventoryStore from "../store/useInventoryStore";
import { addDays, today, CYCLE_LENGTH_DAYS } from "./dateUtils";

export const setupDevTools = () => {
  // 1. List Customers
  window.listCustomers = () => {
    const customers = useCustomerStore.getState().customers;
    console.table(
      customers.map((c) => ({
        ID: c.id,
        Name: c.fullName,
        Username: c.userName,
        Status: c.status,
      })),
    );
  };

  // 2. Generate History for ONE customer
  window.generateTestCycles = async (
    customerId,
    packagePrice = 2500,
    numCycles = 10,
  ) => {
    if (!customerId) return console.error("‚ùå Please provide a customerId.");
    try {
      const allCycles = await db.paymentCycles.toArray();
      const customerCycles = allCycles.filter(
        (c) => Number(c.customerId) === Number(customerId),
      );
      for (const c of customerCycles) await db.paymentCycles.delete(c.id);

      // Start 10 days ago, each cycle is exactly 30 days inclusive (offset = 29)
      let currentStart = addDays(today(), -10);
      let currentEnd = addDays(currentStart, CYCLE_LENGTH_DAYS);

      for (let i = 0; i < numCycles; i++) {
        const isCurrent = i === 0;
        await db.paymentCycles.add({
          customerId: Number(customerId),
          cycleStartDate: currentStart,
          cycleEndDate: currentEnd,
          totalAmount: packagePrice,
          amountPaid: isCurrent ? 0 : packagePrice,
          amountPending: isCurrent ? packagePrice : 0,
          status: isCurrent ? "pending" : "clear",
          installments: isCurrent
            ? []
            : [
                {
                  id: crypto.randomUUID(),
                  amountPaid: packagePrice,
                  datePaid: currentStart,
                  note: `Auto-payment (Test Data - Month ${i})`,
                  createdAt: new Date().toISOString(),
                },
              ],
          isRenewal: i > 0,
          createdAt: new Date().toISOString(),
        });
        // Walk backwards: previous cycle ends the day before this one starts
        currentEnd = addDays(currentStart, -1);
        currentStart = addDays(currentEnd, -CYCLE_LENGTH_DAYS);
      }
      await usePaymentStore.getState().loadCycles();
      console.log(
        `‚úÖ Added ${numCycles} historical cycles for customer ID: ${customerId}`,
      );
    } catch (error) {
      console.error("‚ùå Failed:", error);
    }
  };

  // 3. Generate Bulk Dummy Data
  window.generateNeedsAttentionData = async (count = 15) => {
    console.log(`‚è≥ Generating ${count} dummy customers...`);
    try {
      for (let i = 1; i <= count; i++) {
        const customerId = await db.customers.add({
          fullName: `Urgent Tester ${i}`,
          userName: `urg_${Date.now()}_${i}`,
          mobileNo: `0300${String(i).padStart(7, "0")}`,
          mainArea: "Test Area",
          packageId: null,
          status: "active",
          createdAt: new Date().toISOString(),
        });

        const daysLeft = Math.floor(Math.random() * 10) - 5;
        const endDate = addDays(today(), daysLeft);
        // startDate is exactly 30 days inclusive before endDate
        const startDate = addDays(endDate, -CYCLE_LENGTH_DAYS);
        const isPaid = Math.random() > 0.5;
        const packagePrice = 2000 + Math.floor(Math.random() * 3) * 500;

        await db.paymentCycles.add({
          customerId: Number(customerId),
          cycleStartDate: startDate,
          cycleEndDate: endDate,
          totalAmount: packagePrice,
          amountPaid: isPaid ? packagePrice : 0,
          amountPending: isPaid ? 0 : packagePrice,
          status: isPaid ? "clear" : "pending",
          installments: isPaid
            ? [
                {
                  id: crypto.randomUUID(),
                  amountPaid: packagePrice,
                  datePaid: startDate,
                  note: "Paid dummy",
                  createdAt: new Date().toISOString(),
                },
              ]
            : [],
          isRenewal: false,
          createdAt: new Date().toISOString(),
        });
      }
      await useCustomerStore.getState().loadCustomers();
      await usePaymentStore.getState().loadCycles();
      console.log(`‚úÖ Success! Generated ${count} customers.`);
    } catch (error) {
      console.error("‚ùå Failed:", error);
    }
  };

  // 4. Clear All Data
  window.clearAllData = async () => {
    if (
      !confirm(
        "‚ö†Ô∏è ARE YOU SURE? This will delete ALL customers, payments, inventory, and expenses. Settings (Packages/Areas) will be kept.",
      )
    )
      return;

    console.log("üßπ Wiping database...");

    try {
      const customers = await db.customers.toArray();
      const cycles = await db.paymentCycles.toArray();
      const expenses = await db.expenses.toArray();
      const inventory = await db.inventory.toArray();

      for (const c of customers) await db.customers.delete(c.id);
      for (const c of cycles) await db.paymentCycles.delete(c.id);
      for (const e of expenses) await db.expenses.delete(e.id);
      for (const i of inventory) await db.inventory.delete(i.id);

      await Promise.all([
        useCustomerStore.getState().loadCustomers(),
        usePaymentStore.getState().loadCycles(),
        useExpenseStore.getState().loadExpenses(),
        useInventoryStore.getState().loadInventory(),
      ]);

      console.log("‚ú® All data cleared. App is fresh.");
    } catch (err) {
      console.error("Error clearing data:", err);
    }
  };

  console.log("üõ†Ô∏è DevTools Ready:");
  console.log("üëâ window.generateNeedsAttentionData(15) -> Add Dummy Data");
  console.log("üëâ window.clearAllData() -> DELETE ALL DATA");
};
</file>

<file path="src/App.jsx">
import { useEffect, useState } from "react";
import Navbar from "./components/layout/Navbar";
import BackupBanner from "./components/ui/BackupBanner";
import Dashboard from "./pages/Dashboard";
import Customers from "./pages/Customers/Customers";
import Inventory from "./pages/Inventory/Inventory";
import Expenses from "./pages/Expenses/Expenses";
import Settings from "./pages/Settings";
import useCustomerStore from "./store/useCustomerStore";
import usePaymentStore from "./store/usePaymentStore";
import usePackageStore from "./store/usePackageStore";
import useInventoryStore from "./store/useInventoryStore";
import useExpenseStore from "./store/useExpenseStore";

export default function App() {
  const [tab, setTab] = useState("dashboard");
  const [customerFilter, setCustomerFilter] = useState("all");
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    Promise.all([
      useCustomerStore.getState().loadCustomers(),
      usePaymentStore.getState().loadCycles(),
      usePackageStore.getState().loadPackages(),
      useInventoryStore.getState().loadInventory(),
      useExpenseStore.getState().loadExpenses(),
    ]).then(() => setLoading(false));
  }, []);

  const handleNavigate = (targetTab, filterMode = "all") => {
    setTab(targetTab);
    setCustomerFilter(filterMode);
  };

  if (loading) {
    return (
      <div className="h-screen flex items-center justify-center text-gray-400 text-sm">
        Loading Galaxy ISP...
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 flex flex-col">
      <Navbar activeTab={tab} onTabChange={(t) => handleNavigate(t, "all")} />
      <BackupBanner />
      <main className="flex-1 overflow-auto">
        <div style={{ display: tab === "dashboard" ? "block" : "none" }}>
          <Dashboard onNavigate={handleNavigate} />
        </div>
        <div style={{ display: tab === "customers" ? "block" : "none" }}>
          <Customers initialFilter={customerFilter} />
        </div>
        <div style={{ display: tab === "inventory" ? "block" : "none" }}>
          <Inventory />
        </div>
        <div style={{ display: tab === "expenses" ? "block" : "none" }}>
          <Expenses />
        </div>
        <div style={{ display: tab === "settings" ? "block" : "none" }}>
          <Settings />
        </div>
      </main>
    </div>
  );
}
</file>

<file path="src/db/database.js">
/**
 * database.js ‚Äî Modified for Vercel / LocalStorage
 */

// Make Sure to Remove localStorage Code once the app is fully ready for production.

// ------------------------------------------------------------------
// PART 1: ORIGINAL CODE (COMMENTED OUT)
// ------------------------------------------------------------------
/*
const API = "/api/data";

// In-memory cache so we don't hit the file on every single read
let _cache = null;

async function readAll() {
  if (_cache) return _cache;

  // 1. Check if we are running inside the Electron Desktop App
  if (window.electronAPI) {
    _cache = await window.electronAPI.readData();
    return _cache;
  }

  // 2. Fallback for normal browser (npm run dev)
  const res = await fetch(API);
  if (!res.ok) throw new Error("Failed to read data file");
  _cache = await res.json();
  return _cache;
}

async function writeAll(data) {
  _cache = data;

  // 1. Check if we are running inside the Electron Desktop App
  if (window.electronAPI) {
    await window.electronAPI.writeData(data);
    return;
  }

  // 2. Fallback for normal browser (npm run dev)
  const res = await fetch(API, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data),
  });
  if (!res.ok) throw new Error("Failed to write data file");
}

function invalidate() {
  _cache = null;
}
*/

// ------------------------------------------------------------------
// PART 2: NEW CODE (FOR VERCEL / LOCALSTORAGE)
// ------------------------------------------------------------------

// This key is where your data lives in the browser
const DB_KEY = "galaxy_isp_data_v1";

// New readAll function
async function readAll() {
  // 1. Try to get data from Chrome/Browser LocalStorage
  const rawData = localStorage.getItem(DB_KEY);

  // 2. If data exists, parse it into JSON and return it
  if (rawData) {
    return JSON.parse(rawData);
  }

  // 3. If NO data exists (first time loading), return an empty structure.
  // This prevents "undefined" errors in the rest of your app.
  return {
    customers: [],
    paymentCycles: [],
    packages: [],
    inventory: [],
    expenses: [],
    settings: {},
  };
}

// New writeAll function
async function writeAll(data) {
  // Save the data object as a string in LocalStorage
  localStorage.setItem(DB_KEY, JSON.stringify(data));
}

// New invalidate function (does nothing, but prevents errors)
function invalidate() {
  // No cache to clear in LocalStorage mode
}

// ------------------------------------------------------------------
// PART 3: EXISTING LOGIC (KEEP EVERYTHING BELOW THIS LINE AS IS)
// ------------------------------------------------------------------
// ‚îÄ‚îÄ Generic table operations ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function getTable(table) {
  const data = await readAll();
  return data[table] || [];
}

async function addRow(table, row) {
  const data = await readAll();
  const rows = data[table] || [];
  // Auto-increment ID
  const maxId = rows.reduce((m, r) => Math.max(m, Number(r.id) || 0), 0);
  const newRow = { ...row, id: maxId + 1 };
  data[table] = [...rows, newRow];
  await writeAll(data);
  return newRow;
}

async function updateRow(table, id, updates) {
  const data = await readAll();
  data[table] = (data[table] || []).map((r) =>
    r.id === id ? { ...r, ...updates } : r,
  );
  await writeAll(data);
}

async function deleteRow(table, id) {
  const data = await readAll();
  data[table] = (data[table] || []).filter((r) => r.id !== id);
  await writeAll(data);
}

async function getRow(table, id) {
  const rows = await getTable(table);
  return rows.find((r) => r.id === id) || null;
}

async function deleteManyWhere(table, field, value) {
  const data = await readAll();
  data[table] = (data[table] || []).filter((r) => r[field] !== value);
  await writeAll(data);
}

// ‚îÄ‚îÄ Settings (key/value store) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async function getSetting(key) {
  const data = await readAll();
  const val = (data.settings || {})[key];
  return val !== undefined ? { key, value: val } : null;
}

async function setSetting(key, value) {
  const data = await readAll();
  data.settings = { ...(data.settings || {}), [key]: value };
  await writeAll(data);
}

// ‚îÄ‚îÄ db interface (mirrors the Dexie API used by stores) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const db = {
  customers: {
    toArray: () => getTable("customers"),
    get: (id) => getRow("customers", id),
    add: (row) => addRow("customers", row).then((r) => r.id),
    update: (id, data) => updateRow("customers", id, data),
    delete: (id) => deleteRow("customers", id),
  },
  paymentCycles: {
    toArray: () => getTable("paymentCycles"),
    get: (id) => getRow("paymentCycles", id),
    add: (row) => addRow("paymentCycles", row).then((r) => r.id),
    update: (id, data) => updateRow("paymentCycles", id, data),
    delete: (id) => deleteRow("paymentCycles", id),
    where: (field) => ({
      equals: (value) => ({
        delete: () => deleteManyWhere("paymentCycles", field, value),
        toArray: async () => {
          const rows = await getTable("paymentCycles");
          return rows.filter((r) => r[field] === value);
        },
      }),
    }),
  },
  packages: {
    toArray: () => getTable("packages"),
    get: (id) => getRow("packages", id),
    add: (row) => addRow("packages", row).then((r) => r.id),
    update: (id, data) => updateRow("packages", id, data),
    delete: (id) => deleteRow("packages", id),
  },
  inventory: {
    toArray: () => getTable("inventory"),
    get: (id) => getRow("inventory", id),
    add: (row) => addRow("inventory", row).then((r) => r.id),
    update: (id, data) => updateRow("inventory", id, data),
    delete: (id) => deleteRow("inventory", id),
  },
  expenses: {
    toArray: () => getTable("expenses"),
    get: (id) => getRow("expenses", id),
    add: (row) => addRow("expenses", row).then((r) => r.id),
    update: (id, data) => updateRow("expenses", id, data),
    delete: (id) => deleteRow("expenses", id),
  },
  settings: {
    get: (key) => getSetting(key),
    put: ({ key, value }) => setSetting(key, value),
  },
};

export default db;
export { readAll, writeAll, invalidate };
</file>

<file path="src/pages/Customers/Customers.jsx">
import { useState, useEffect } from "react";
import {
  Plus,
  Search,
  Archive,
  ArchiveRestore,
  Trash2,
  ArrowUpDown,
} from "lucide-react";
import Modal from "../../components/ui/Modal";
import ConfirmDialog from "../../components/ui/ConfirmDialog";
import CustomerTable from "./CustomerTable";
import CustomerForm from "./CustomerForm";
import PaymentForm from "../Payments/PaymentForm";
import useCustomerStore from "../../store/useCustomerStore";
import usePaymentStore from "../../store/usePaymentStore";
import { formatDate, daysUntil } from "../../utils/dateUtils";

export default function Customers({ initialFilter }) {
  const customers = useCustomerStore((s) => s.customers);
  const archiveCustomer = useCustomerStore((s) => s.archiveCustomer);
  const restoreCustomer = useCustomerStore((s) => s.restoreCustomer);
  const permanentlyDeleteCustomer = useCustomerStore(
    (s) => s.permanentlyDeleteCustomer,
  );
  const getCyclesForCustomer = usePaymentStore((s) => s.getCyclesForCustomer);
  const getActiveCycle = usePaymentStore((s) => s.getActiveCycle);

  const [view, setView] = useState("active");
  const [search, setSearch] = useState("");
  const [filter, setFilter] = useState("all");
  const [sortBy, setSortBy] = useState("newest");

  const [showAdd, setShowAdd] = useState(false);
  const [editCustomer, setEditCustomer] = useState(null);
  const [payCustomer, setPayCustomer] = useState(null);
  const [archiveTarget, setArchiveTarget] = useState(null);
  const [restoreTarget, setRestoreTarget] = useState(null);
  const [purgeTarget, setPurgeTarget] = useState(null);

  // Sync prop filter to local state when prop changes
  useEffect(() => {
    const timer = setTimeout(() => {
      if (initialFilter) {
        setFilter(initialFilter);
      }
    }, 0);
    return () => clearTimeout(timer);
  }, [initialFilter]);

  const activeCustomers = customers.filter((c) => !c.isArchived);
  const archivedCustomers = customers.filter((c) => c.isArchived);

  // 1. FILTERING
  const q = search.toLowerCase();
  const matchSearch = (c) =>
    !search ||
    c.fullName?.toLowerCase().includes(q) ||
    c.userName?.toLowerCase().includes(q) ||
    c.mobileNo?.includes(q) ||
    c.mainArea?.toLowerCase().includes(q);

  const filteredActive = activeCustomers.filter((c) => {
    // Check search first
    if (!matchSearch(c)) return false;

    // Check Filter
    if (filter === "all") return true;
    if (filter === "active") return c.status === "active";
    if (filter === "suspended") return c.status === "suspended";
    if (filter === "terminated") return c.status === "terminated";

    // New filters based on payment status
    const cycle = getActiveCycle(c.id);
    const days = cycle ? daysUntil(cycle.cycleEndDate) : 0;
    const pending = cycle ? cycle.amountPending : 0;

    if (filter === "overdue") {
      // Must be active AND have pending balance AND be overdue (days < 0)
      return c.status === "active" && pending > 0 && days < 0;
    }
    if (filter === "pending") {
      // Must be active AND have pending balance BUT NOT overdue (days >= 0)
      return c.status === "active" && pending > 0 && days >= 0;
    }

    return true;
  });

  // 2. SORTING
  const sortedActive = [...filteredActive].sort((a, b) => {
    const cycleA = getActiveCycle(a.id);
    const cycleB = getActiveCycle(b.id);

    switch (sortBy) {
      case "name":
        return a.fullName.localeCompare(b.fullName);

      case "pending":
        // Highest balance first
        return (cycleB?.amountPending || 0) - (cycleA?.amountPending || 0);

      case "expiring":
        // Soonest expiry date first.
        if (!cycleA) return 1;
        if (!cycleB) return -1;
        return new Date(cycleA.cycleEndDate) - new Date(cycleB.cycleEndDate);

      case "newest":
      default:
        // IDs are auto-incrementing
        return b.id - a.id;
    }
  });

  const filteredArchived = archivedCustomers.filter(matchSearch);

  const filterOptions = [
    { id: "all", label: "All" },
    { id: "active", label: "Active" },
    { id: "pending", label: "Pending" }, // Added
    { id: "overdue", label: "Overdue" }, // Added
    { id: "suspended", label: "Suspended" },
  ];

  return (
    <div className="p-4 space-y-3">
      {/* HEADER */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-3">
          <h1 className="text-base font-semibold text-gray-800">Customers</h1>

          {/* Active / Archived tab switcher */}
          <div className="flex items-center gap-0.5 bg-gray-100 rounded-lg p-0.5">
            <button
              onClick={() => setView("active")}
              className={`px-3 py-1 rounded-md text-xs font-semibold transition-colors ${
                view === "active"
                  ? "bg-white text-gray-900 shadow-sm"
                  : "text-gray-500 hover:text-gray-700"
              }`}
            >
              Active
              <span className="ml-1.5 bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded-full text-xs">
                {activeCustomers.length}
              </span>
            </button>
            <button
              onClick={() => setView("archived")}
              className={`px-3 py-1 rounded-md text-xs font-semibold transition-colors ${
                view === "archived"
                  ? "bg-white text-gray-900 shadow-sm"
                  : "text-gray-500 hover:text-gray-700"
              }`}
            >
              Archived
              {archivedCustomers.length > 0 && (
                <span className="ml-1.5 bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded-full text-xs">
                  {archivedCustomers.length}
                </span>
              )}
            </button>
          </div>
        </div>

        {view === "active" && (
          <button
            onClick={() => setShowAdd(true)}
            className="flex items-center gap-1.5 px-3 py-1.5 text-sm bg-blue-600 text-white rounded hover:bg-blue-700"
          >
            <Plus size={14} /> Add Customer
          </button>
        )}
      </div>

      {/* SEARCH + FILTER + SORT */}
      <div className="flex items-center justify-between flex-wrap gap-2">
        {/* Left Side: Search & Status Filters */}
        <div className="flex items-center gap-2 flex-1 min-w-62.5">
          <div className="relative flex-1 max-w-xs">
            <Search
              size={14}
              className="absolute left-2.5 top-2 text-gray-400"
            />
            <input
              className="w-full pl-8 pr-3 py-1.5 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
              placeholder="Search..."
              value={search}
              onChange={(e) => setSearch(e.target.value)}
            />
          </div>
          {view === "active" && (
            <div className="flex gap-1">
              {filterOptions.map((f) => (
                <button
                  key={f.id}
                  onClick={() => setFilter(f.id)}
                  className={`px-3 py-1.5 text-xs rounded capitalize transition-colors ${
                    filter === f.id
                      ? "bg-gray-800 text-white"
                      : "border border-gray-300 text-gray-600 hover:bg-gray-50"
                  }`}
                >
                  {f.label}
                </button>
              ))}
            </div>
          )}
        </div>

        {/* Right Side: Sorting Dropdown */}
        {view === "active" && (
          <div className="flex items-center gap-2">
            <span className="text-xs text-gray-500 font-medium">Sort by:</span>
            <div className="relative">
              <ArrowUpDown
                size={14}
                className="absolute left-2.5 top-2 text-gray-500 pointer-events-none"
              />
              <select
                className="pl-8 pr-3 py-1.5 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 bg-white text-gray-700 cursor-pointer appearance-none min-w-35"
                value={sortBy}
                onChange={(e) => setSortBy(e.target.value)}
              >
                <option value="newest">Newest First</option>
                <option value="name">Name (A-Z)</option>
                <option value="expiring">Expiring Soon</option>
                <option value="pending">Highest Debt</option>
              </select>
            </div>
          </div>
        )}
      </div>

      {/* ACTIVE TABLE */}
      {view === "active" && (
        <div className="bg-white border border-gray-200 rounded overflow-hidden">
          <CustomerTable
            customers={sortedActive}
            searchQuery={""} // Search handled above
            onEdit={(c) => setEditCustomer(c)}
            onPay={(c) => setPayCustomer(c)}
            onDelete={(c) => setArchiveTarget(c)}
          />
        </div>
      )}

      {/* ARCHIVED TABLE */}
      {view === "archived" && (
        <div className="bg-white border border-gray-200 rounded overflow-hidden">
          {filteredArchived.length === 0 ? (
            <div className="py-16 flex flex-col items-center gap-2 text-gray-400">
              <Archive size={36} className="text-gray-300" />
              <p className="text-sm font-medium">No archived customers</p>
              <p className="text-xs text-gray-300">
                Deleted customers appear here ‚Äî nothing is ever lost.
              </p>
            </div>
          ) : (
            <table className="w-full text-sm">
              <thead>
                <tr className="bg-gray-800 text-white text-left text-xs">
                  <th className="px-4 py-2.5 font-medium">Customer</th>
                  <th className="px-4 py-2.5 font-medium">Area</th>
                  <th className="px-4 py-2.5 font-medium">Archived On</th>
                  <th className="px-4 py-2.5 font-medium">Reason</th>
                  <th className="px-4 py-2.5 font-medium">Total Ever Paid</th>
                  <th className="px-4 py-2.5 font-medium">Cycles</th>
                  <th className="px-4 py-2.5 font-medium">Actions</th>
                </tr>
              </thead>
              <tbody>
                {filteredArchived.map((c) => {
                  const cycles = getCyclesForCustomer(c.id);
                  const totalPaid = cycles.reduce(
                    (sum, cy) =>
                      sum +
                      (cy.installments || []).reduce(
                        (s, i) => s + (i.amountPaid || 0),
                        0,
                      ),
                    0,
                  );
                  return (
                    <tr
                      key={c.id}
                      className="border-t border-gray-100 hover:bg-gray-50"
                    >
                      <td className="px-4 py-3">
                        <div className="font-medium text-gray-800">
                          {c.fullName}
                        </div>
                        <div className="text-xs text-gray-400">
                          {c.userName}
                        </div>
                        {c.mobileNo && (
                          <div className="text-xs text-gray-400">
                            {c.mobileNo}
                          </div>
                        )}
                      </td>
                      <td className="px-4 py-3 text-xs text-gray-500">
                        {c.mainArea || "‚Äî"}
                      </td>
                      <td className="px-4 py-3 text-xs text-gray-500">
                        {c.archivedAt ? formatDate(c.archivedAt) : "‚Äî"}
                      </td>
                      <td className="px-4 py-3 text-xs text-gray-500 max-w-50">
                        {c.archiveReason || (
                          <span className="text-gray-300 italic">
                            No reason given
                          </span>
                        )}
                      </td>
                      <td className="px-4 py-3 font-semibold text-gray-800">
                        PKR {totalPaid.toLocaleString()}
                      </td>
                      <td className="px-4 py-3 text-xs text-gray-500">
                        {cycles.length}
                      </td>
                      <td className="px-4 py-3">
                        <div className="flex items-center gap-1.5">
                          <button
                            onClick={() => setRestoreTarget(c)}
                            className="flex items-center gap-1 px-2.5 py-1 text-xs bg-green-600 text-white rounded hover:bg-green-700 font-medium"
                          >
                            <ArchiveRestore size={12} /> Restore
                          </button>
                          <button
                            onClick={() => setPurgeTarget(c)}
                            title="Permanently delete all data"
                            className="flex items-center gap-1 px-2.5 py-1 text-xs bg-red-600 text-white rounded hover:bg-red-700 font-medium"
                          >
                            <Trash2 size={12} /> Purge
                          </button>
                        </div>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          )}
        </div>
      )}

      {/* MODALS */}
      <Modal
        isOpen={showAdd}
        onClose={() => setShowAdd(false)}
        title="Add New Customer"
        size="lg"
      >
        <CustomerForm onClose={() => setShowAdd(false)} />
      </Modal>

      <Modal
        isOpen={!!editCustomer}
        onClose={() => setEditCustomer(null)}
        title="Edit Customer"
        size="lg"
      >
        {editCustomer && (
          <CustomerForm
            customer={editCustomer}
            onClose={() => setEditCustomer(null)}
          />
        )}
      </Modal>

      <Modal
        isOpen={!!payCustomer}
        onClose={() => setPayCustomer(null)}
        title="Record Payment"
        size="md"
      >
        {payCustomer && (
          <PaymentForm
            customer={payCustomer}
            onClose={() => setPayCustomer(null)}
          />
        )}
      </Modal>

      {/* Archive dialog */}
      <ConfirmDialog
        isOpen={!!archiveTarget}
        onClose={() => setArchiveTarget(null)}
        onConfirm={(reason) => archiveCustomer(archiveTarget.id, reason)}
        title="Archive Customer"
        message={`"${archiveTarget?.fullName}" will be moved to the Archived tab. All payment history is preserved and you can restore them at any time.`}
        confirmLabel="Archive Customer"
        confirmText={archiveTarget?.fullName}
        showReason
        reasonLabel="Reason for archiving (optional)"
        danger
      />

      {/* Restore dialog */}
      <ConfirmDialog
        isOpen={!!restoreTarget}
        onClose={() => setRestoreTarget(null)}
        onConfirm={() => restoreCustomer(restoreTarget.id)}
        title="Restore Customer"
        message={`Restore "${restoreTarget?.fullName}" back to Active customers? Their full payment history will remain intact.`}
        confirmLabel="Yes, Restore"
        danger={false}
      />

      {/* Purge dialog */}
      <ConfirmDialog
        isOpen={!!purgeTarget}
        onClose={() => setPurgeTarget(null)}
        onConfirm={() => permanentlyDeleteCustomer(purgeTarget.id)}
        title="Permanently Delete"
        message={`This will PERMANENTLY delete "${purgeTarget?.fullName}" and every payment record forever. This cannot be undone.`}
        confirmLabel="Permanently Delete"
        confirmText={purgeTarget?.fullName}
        requirePassword
        danger
      />
    </div>
  );
}
</file>

<file path="src/pages/Dashboard.jsx">
import { useState } from "react";
import {
  Users,
  TrendingUp,
  Clock,
  AlertTriangle,
  CheckCircle,
  XCircle,
  Calendar,
  CreditCard,
  Activity,
  ChevronLeft,
  ChevronRight,
  RefreshCw,
  Eye,
  EyeOff,
} from "lucide-react";
import useCustomerStore from "../store/useCustomerStore";
import usePaymentStore from "../store/usePaymentStore";
import useExpenseStore from "../store/useExpenseStore";
import { daysUntil, formatDate, today } from "../utils/dateUtils";
import Badge from "../components/ui/Badge";
import Modal from "../components/ui/Modal";
import PaymentForm from "./Payments/PaymentForm";
import WhatsAppButton from "../components/shared/WhatsAppButton";
import { MESSAGE_TEMPLATES } from "../config/messageTemplates";

const MONTH_NAMES = [
  "January",
  "February",
  "March",
  "April",
  "May",
  "June",
  "July",
  "August",
  "September",
  "October",
  "November",
  "December",
];

function getLatestCycle(cycles, customerId) {
  return (
    cycles
      .filter((c) => c.customerId === customerId)
      .sort(
        (a, b) => new Date(b.cycleStartDate) - new Date(a.cycleStartDate),
      )[0] || null
  );
}

export default function Dashboard({ onNavigate }) {
  const customers = useCustomerStore((s) => s.customers);
  const cycles = usePaymentStore((s) => s.cycles);
  const expenses = useExpenseStore((s) => s.expenses);

  const [payCustomer, setPayCustomer] = useState(null);
  const [mode, setMode] = useState("alltime"); // alltime | monthly | daily

  // Date state for Monthly view
  const now = new Date();
  const [selYear, setSelYear] = useState(now.getFullYear());
  const [selMonth, setSelMonth] = useState(now.getMonth());

  // Date state for Daily view
  const [selDate, setSelDate] = useState(today());

  // Monthly Navigation
  const prevMonth = () => {
    if (selMonth === 0) {
      setSelMonth(11);
      setSelYear((y) => y - 1);
    } else setSelMonth((m) => m - 1);
  };
  const nextMonth = () => {
    if (selYear === now.getFullYear() && selMonth === now.getMonth()) return;
    if (selMonth === 11) {
      setSelMonth(0);
      setSelYear((y) => y + 1);
    } else setSelMonth((m) => m + 1);
  };
  const isCurrentMonth =
    selYear === now.getFullYear() && selMonth === now.getMonth();

  // ‚îÄ‚îÄ Stats Calculation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const activeCustomers = customers.filter((c) => !c.isArchived);

  // 1. ALL TIME STATS
  let at_collected = 0,
    at_pending = 0,
    at_overdueMoney = 0;
  let at_overdueCount = 0;
  let at_expiringCount = 0;
  let at_renewalCount = 0;
  let at_activeCount = 0,
    at_suspendedCount = 0,
    at_totalEver = 0;

  activeCustomers.forEach((c) => {
    if (c.status === "active") at_activeCount++;
    if (c.status === "suspended") at_suspendedCount++;
    const cycle = getLatestCycle(cycles, c.id);
    if (!cycle) return;

    at_collected += cycle.amountPaid || 0;
    at_pending += cycle.amountPending || 0;

    const days = daysUntil(cycle.cycleEndDate);

    // Overdue Logic (Pending AND Expired)
    if (cycle.amountPending > 0 && days < 0) {
      at_overdueCount++;
      at_overdueMoney += cycle.amountPending;
    }

    if (days >= 0 && days <= 5) at_expiringCount++;
    if (days < 0) at_renewalCount++;
  });

  cycles.forEach((cy) => {
    (cy.installments || []).forEach((inst) => {
      at_totalEver += inst.amountPaid || 0;
    });
  });

  const at_totalExpenses = expenses.reduce(
    (s, e) => s + (Number(e.amount) || 0),
    0,
  );

  const allTime = {
    totalCustomers: activeCustomers.length,
    activeCount: at_activeCount,
    suspendedCount: at_suspendedCount,
    collected: at_collected,
    pending: at_pending,
    overdueMoney: at_overdueMoney,
    totalEverCollected: at_totalEver,
    overdueCount: at_overdueCount,
    expiringCount: at_expiringCount,
    renewalCount: at_renewalCount,
    totalExpenses: at_totalExpenses,
    netIncome: at_totalEver - at_totalExpenses,
  };

  // 2. MONTHLY STATS
  const monthStart = new Date(selYear, selMonth, 1);
  const monthEnd = new Date(selYear, selMonth + 1, 0, 23, 59, 59);
  let mo_collected = 0,
    mo_pending = 0,
    mo_overdueMoney = 0,
    mo_newCustomers = 0;
  let mo_clearedCount = 0,
    mo_pendingCount = 0,
    mo_overdueCount = 0,
    mo_renewalCount = 0,
    mo_expiringCount = 0;

  cycles.forEach((cy) => {
    // Collected in this month
    (cy.installments || []).forEach((inst) => {
      const d = new Date(inst.datePaid);
      if (d >= monthStart && d <= monthEnd)
        mo_collected += inst.amountPaid || 0;
    });

    // Check if cycle is relevant to this month
    const cStart = new Date(cy.cycleStartDate);
    const cEnd = new Date(cy.cycleEndDate);
    if (cStart <= monthEnd && cEnd >= monthStart) {
      mo_pending += cy.amountPending || 0;
      if (cy.status === "clear") mo_clearedCount++;
      else mo_pendingCount++;

      const days = daysUntil(cy.cycleEndDate);
      if (days < 0 && cy.amountPending > 0) {
        mo_overdueMoney += cy.amountPending;
        mo_overdueCount++;
      }
      if (days < 0) mo_renewalCount++;
      if (days >= 0 && days <= 5) mo_expiringCount++;
    }
  });

  activeCustomers.forEach((c) => {
    const d = new Date(c.createdAt);
    if (d >= monthStart && d <= monthEnd) mo_newCustomers++;
  });

  const mo_expenses = expenses
    .filter((e) => {
      const d = new Date(e.date);
      return d >= monthStart && d <= monthEnd;
    })
    .reduce((s, e) => s + (Number(e.amount) || 0), 0);

  const monthly = {
    collected: mo_collected,
    pending: mo_pending,
    overdueMoney: mo_overdueMoney,
    newCustomers: mo_newCustomers,
    clearedCount: mo_clearedCount,
    pendingCount: mo_pendingCount,
    overdueCount: mo_overdueCount,
    renewalCount: mo_renewalCount,
    expiringCount: mo_expiringCount,
    totalExpenses: mo_expenses,
    netIncome: mo_collected - mo_expenses,
  };

  // 3. DAILY STATS
  let day_collected = 0;
  let day_newCustomers = 0;

  cycles.forEach((cy) => {
    (cy.installments || []).forEach((inst) => {
      if (inst.datePaid === selDate) {
        day_collected += inst.amountPaid || 0;
      }
    });
  });

  activeCustomers.forEach((c) => {
    if (c.createdAt && c.createdAt.startsWith(selDate)) {
      day_newCustomers++;
    }
  });

  const day_expenses = expenses
    .filter((e) => e.date === selDate)
    .reduce((s, e) => s + (Number(e.amount) || 0), 0);

  const daily = {
    collected: day_collected,
    newCustomers: day_newCustomers,
    totalExpenses: day_expenses,
    netIncome: day_collected - day_expenses,
  };

  // ‚îÄ‚îÄ Urgent List Logic ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const urgentCustomers = activeCustomers
    .map((c) => ({ customer: c, cycle: getLatestCycle(cycles, c.id) }))
    .filter(({ cycle }) => {
      if (!cycle) return true;
      const days = daysUntil(cycle.cycleEndDate);
      return days < 0 || days <= 5;
    })
    .sort((a, b) => {
      const da = a.cycle ? daysUntil(a.cycle.cycleEndDate) : -999;
      const db2 = b.cycle ? daysUntil(b.cycle.cycleEndDate) : -999;
      return da - db2;
    });

  const displayStats = mode === "monthly" ? monthly : allTime;

  return (
    <div className="p-5 space-y-5 max-w-7xl mx-auto">
      {/* HEADER */}
      <div className="flex items-center justify-between flex-wrap gap-4">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Dashboard</h1>
          <p className="text-sm text-gray-500 mt-0.5">{today()}</p>
        </div>
        <div className="flex items-center gap-1 bg-gray-200 rounded-lg p-1">
          <button
            onClick={() => setMode("alltime")}
            className={`px-4 py-1.5 rounded-md text-sm font-semibold ${mode === "alltime" ? "bg-white text-gray-900 shadow" : "text-gray-500 hover:text-gray-800"}`}
          >
            All Time
          </button>
          <button
            onClick={() => setMode("monthly")}
            className={`px-4 py-1.5 rounded-md text-sm font-semibold ${mode === "monthly" ? "bg-white text-gray-900 shadow" : "text-gray-500 hover:text-gray-800"}`}
          >
            Monthly
          </button>
          <button
            onClick={() => setMode("daily")}
            className={`px-4 py-1.5 rounded-md text-sm font-semibold ${mode === "daily" ? "bg-white text-gray-900 shadow" : "text-gray-500 hover:text-gray-800"}`}
          >
            Daily
          </button>
        </div>
      </div>

      {/* FILTERS */}
      {mode === "monthly" && (
        <div className="flex items-center gap-3 bg-white border-2 border-gray-200 rounded-xl px-4 py-3 w-fit">
          <button
            onClick={prevMonth}
            className="p-1 rounded-lg hover:bg-gray-100 text-gray-700"
          >
            <ChevronLeft size={20} />
          </button>
          <div className="flex items-center gap-2 min-w-43 justify-center">
            <Calendar size={17} className="text-blue-600" />
            <span className="font-bold text-gray-900 text-lg">
              {MONTH_NAMES[selMonth]} {selYear}
            </span>
          </div>
          <button
            onClick={nextMonth}
            disabled={isCurrentMonth}
            className="p-1 rounded-lg hover:bg-gray-100 text-gray-700 disabled:opacity-30 disabled:cursor-not-allowed"
          >
            <ChevronRight size={20} />
          </button>
        </div>
      )}

      {mode === "daily" && (
        <div className="flex items-center gap-3 bg-white border-2 border-gray-200 rounded-xl px-4 py-2 w-fit">
          <Calendar size={18} className="text-blue-600" />
          <input
            type="date"
            value={selDate}
            max={today()}
            onChange={(e) => setSelDate(e.target.value)}
            className="font-bold text-gray-900 text-lg outline-none cursor-pointer"
          />
        </div>
      )}

      {/* ‚îÄ‚îÄ‚îÄ CARDS GRID ‚îÄ‚îÄ‚îÄ */}

      {mode !== "daily" ? (
        <>
          {/* Top Row: 5 Columns */}
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
            <BigCard
              icon={<Users size={20} />}
              label="Total Customers"
              value={
                mode === "monthly"
                  ? monthly.newCustomers
                  : allTime.totalCustomers
              }
              sub={
                mode === "monthly"
                  ? "Joined this month"
                  : `${allTime.activeCount} active`
              }
              color="blue"
            />
            <BigCard
              icon={<CheckCircle size={20} />}
              label="Total Collected"
              value={`PKR ${mode === "monthly" ? monthly.collected.toLocaleString() : allTime.totalEverCollected.toLocaleString()}`}
              sub={
                mode === "monthly" ? "Received this month" : "All payments ever"
              }
              color="green"
              isSensitive={true}
            />
            <BigCard
              icon={<Clock size={20} />}
              label="Currently Pending"
              value={`PKR ${displayStats.pending.toLocaleString()}`}
              sub="Click to view details"
              color="amber"
              // Navigate to Customers > Pending
              onClick={() => onNavigate("customers", "pending")}
              isClickable
            />
            <BigCard
              icon={<AlertTriangle size={20} />}
              label="Total Overdue"
              value={`PKR ${displayStats.overdueMoney.toLocaleString()}`}
              sub="Expired + Unpaid"
              color="red"
              highlight={displayStats.overdueMoney > 0}
              // Navigate to Customers > Overdue
              onClick={() => onNavigate("customers", "overdue")}
              isClickable
            />
            <BigCard
              icon={<XCircle size={20} />}
              label="Total Expenses"
              value={`PKR ${displayStats.totalExpenses.toLocaleString()}`}
              sub="Recorded expenses"
              color="red"
            />
          </div>

          {/* Bottom Row: 4 Columns */}
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <BigCard
              icon={<Users size={20} />}
              label="Overdue Customers"
              value={displayStats.overdueCount}
              sub="Count of customers overdue"
              color="red"
              highlight={displayStats.overdueCount > 0}
            />
            <BigCard
              icon={<RefreshCw size={20} />}
              label="Needs Renewal"
              value={displayStats.renewalCount}
              sub="Cycle expired, renew now"
              color="red"
              highlight={displayStats.renewalCount > 0}
            />
            <BigCard
              icon={<Activity size={20} />}
              label="Expiring in 5 Days"
              value={displayStats.expiringCount}
              sub="Collect before cutoff"
              color="amber"
              highlight={displayStats.expiringCount > 0}
            />
            <BigCard
              icon={<TrendingUp size={20} />}
              label="Net Income"
              value={`PKR ${displayStats.netIncome.toLocaleString()}`}
              sub="Total collected ‚àí expenses"
              color={displayStats.netIncome >= 0 ? "green" : "red"}
              isSensitive={true}
            />
          </div>
        </>
      ) : (
        /* Daily View */
        <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
          <BigCard
            icon={<CreditCard size={20} />}
            label="Collected Today"
            value={`PKR ${daily.collected.toLocaleString()}`}
            sub={`Payments received on ${formatDate(selDate)}`}
            color="green"
            isSensitive={true}
          />
          <BigCard
            icon={<XCircle size={20} />}
            label="Expenses Today"
            value={`PKR ${daily.totalExpenses.toLocaleString()}`}
            sub={`Expenses recorded on ${formatDate(selDate)}`}
            color="red"
          />
          <BigCard
            icon={<TrendingUp size={20} />}
            label="Daily Net Income"
            value={`PKR ${daily.netIncome.toLocaleString()}`}
            sub="Collected ‚àí expenses"
            color={daily.netIncome >= 0 ? "green" : "red"}
            isSensitive={true}
          />
          <BigCard
            icon={<Users size={20} />}
            label="New Customers"
            value={daily.newCustomers}
            sub="Joined today"
            color="blue"
          />
        </div>
      )}

      {/* NEEDS ATTENTION TABLE */}
      <div>
        <h2 className="text-lg font-bold text-gray-900 flex items-center gap-2 mb-3">
          <AlertTriangle size={18} className="text-red-500" />
          Needs Attention
          {urgentCustomers.length > 0 && (
            <span className="bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full">
              {urgentCustomers.length}
            </span>
          )}
        </h2>

        {urgentCustomers.length === 0 ? (
          <div className="bg-green-50 border-2 border-green-200 rounded-xl px-5 py-4 flex items-center gap-3">
            <CheckCircle size={22} className="text-green-600" />
            <span className="text-green-800 font-semibold text-base">
              All accounts are in good standing.
            </span>
          </div>
        ) : (
          <div className="bg-white border-2 border-gray-200 rounded-xl overflow-hidden overflow-x-auto">
            <table className="w-full">
              <thead>
                <tr className="bg-gray-900 text-white text-left">
                  <th className="px-4 py-3 text-sm font-semibold">Customer</th>
                  <th className="px-4 py-3 text-sm font-semibold">Area</th>
                  <th className="px-4 py-3 text-sm font-semibold">Mobile</th>
                  <th className="px-4 py-3 text-sm font-semibold">
                    Cycle Ended
                  </th>
                  <th className="px-4 py-3 text-sm font-semibold">Days</th>
                  <th className="px-4 py-3 text-sm font-semibold">
                    Balance Due
                  </th>
                  <th className="px-4 py-3 text-sm font-semibold">Status</th>
                  <th className="px-4 py-3 text-sm font-semibold">Action</th>
                </tr>
              </thead>
              <tbody>
                {urgentCustomers.map(({ customer, cycle }) => {
                  if (!cycle)
                    return (
                      <tr
                        key={customer.id}
                        className="border-t border-gray-200 bg-gray-50"
                      >
                        <td className="px-4 py-3 font-bold text-gray-900">
                          {customer.fullName}
                        </td>
                        <td
                          colSpan={6}
                          className="px-4 py-3 text-sm text-gray-500"
                        >
                          No billing cycle ‚Äî needs setup
                        </td>
                        <td className="px-4 py-3">
                          <button
                            onClick={() => setPayCustomer(customer)}
                            className="px-3 py-1.5 text-sm bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700"
                          >
                            Pay Now
                          </button>
                        </td>
                      </tr>
                    );

                  const days = daysUntil(cycle.cycleEndDate);
                  const isExpiredUnpaid = days < 0 && cycle.amountPending > 0;
                  const isExpiredPaid = days < 0 && cycle.amountPending === 0;
                  const isExpiringSoon = days >= 0 && days <= 5;

                  let waMessage = "";
                  if (isExpiredUnpaid) {
                    waMessage = MESSAGE_TEMPLATES.paymentOverdue(
                      customer,
                      cycle,
                    );
                  } else if (cycle.amountPending > 0) {
                    waMessage = MESSAGE_TEMPLATES.paymentDue(customer, cycle);
                  } else {
                    waMessage = MESSAGE_TEMPLATES.expiryReminder(
                      customer,
                      cycle,
                    );
                  }

                  const showPayButton =
                    cycle.amountPending > 0 || isExpiredPaid;

                  const rowBg = isExpiredUnpaid
                    ? "bg-red-50"
                    : isExpiredPaid
                      ? "bg-orange-50"
                      : "bg-yellow-50";

                  return (
                    <tr
                      key={customer.id}
                      className={`border-t border-gray-200 ${rowBg}`}
                    >
                      <td className="px-4 py-3">
                        <div className="font-bold text-gray-900 text-sm">
                          {customer.fullName}
                        </div>
                        <div className="text-xs text-gray-500">
                          {customer.userName}
                        </div>
                      </td>
                      <td className="px-4 py-3 text-sm text-gray-800">
                        {customer.mainArea || "‚Äî"}
                      </td>
                      <td className="px-4 py-3 text-sm text-gray-800">
                        {customer.mobileNo || "‚Äî"}
                      </td>
                      <td className="px-4 py-3 text-sm text-gray-800">
                        {formatDate(cycle.cycleEndDate)}
                      </td>
                      <td className="px-4 py-3">
                        {isExpiredUnpaid && (
                          <span className="text-sm font-bold text-red-700">
                            {-days}d overdue
                          </span>
                        )}
                        {isExpiredPaid && (
                          <span className="text-sm font-bold text-orange-700">
                            {-days}d ago ‚Äî needs renewal
                          </span>
                        )}
                        {isExpiringSoon && (
                          <span className="text-sm font-bold text-yellow-700">
                            {days}d left
                          </span>
                        )}
                      </td>
                      <td className="px-4 py-3">
                        {cycle.amountPending > 0 ? (
                          <span className="text-sm font-bold text-red-700">
                            PKR {Number(cycle.amountPending).toLocaleString()}
                          </span>
                        ) : (
                          <span className="text-sm font-semibold text-green-700">
                            Paid ‚úì
                          </span>
                        )}
                      </td>
                      <td className="px-4 py-3">
                        {isExpiredUnpaid && <Badge status="overdue" />}
                        {isExpiredPaid && (
                          <span className="inline-block px-2 py-0.5 rounded text-xs font-medium bg-orange-100 text-orange-800">
                            Renewal Due
                          </span>
                        )}
                        {isExpiringSoon && <Badge status="pending" />}
                      </td>
                      <td className="px-4 py-3">
                        <div className="flex items-center gap-2">
                          {showPayButton && (
                            <button
                              onClick={() => setPayCustomer(customer)}
                              className="px-3 py-1.5 text-sm bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700"
                            >
                              {isExpiredPaid ? "Renew" : "Pay Now"}
                            </button>
                          )}
                          <WhatsAppButton
                            mobileNo={customer.mobileNo}
                            message={waMessage}
                            label="WhatsApp"
                          />
                        </div>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        )}
      </div>

      <Modal
        isOpen={!!payCustomer}
        onClose={() => setPayCustomer(null)}
        title="Record Payment"
        size="md"
      >
        {payCustomer && (
          <PaymentForm
            customer={payCustomer}
            onClose={() => setPayCustomer(null)}
          />
        )}
      </Modal>
    </div>
  );
}

// Updated Colors: Softer backgrounds with borders and icons
const colorMap = {
  blue: {
    bg: "bg-blue-50 border border-blue-200",
    iconBox: "bg-blue-100",
    icon: "text-blue-600",
  },
  green: {
    bg: "bg-green-50 border border-green-200",
    iconBox: "bg-green-100",
    icon: "text-green-600",
  },
  amber: {
    bg: "bg-amber-50 border border-amber-200",
    iconBox: "bg-amber-100",
    icon: "text-amber-600",
  },
  red: {
    bg: "bg-red-50 border border-red-200",
    iconBox: "bg-red-100",
    icon: "text-red-600",
  },
};

function BigCard({
  icon,
  label,
  value,
  sub,
  color,
  highlight = false,
  isSensitive = false,
  onClick,
  isClickable = false,
}) {
  const c = colorMap[color] || colorMap.blue;
  const [revealed, setRevealed] = useState(false);

  return (
    <div
      onClick={isClickable ? onClick : undefined}
      className={`rounded-xl p-5 ${c.bg} flex flex-col justify-between ${highlight ? "ring-2 ring-offset-1 ring-red-300" : ""} ${isClickable ? "cursor-pointer hover:shadow-md transition-shadow active:scale-95" : ""}`}
    >
      <div>
        <div className="flex items-center justify-between mb-3">
          <div
            className={`w-10 h-10 rounded-lg flex items-center justify-center ${c.iconBox} ${c.icon}`}
          >
            {icon}
          </div>
          {isSensitive && (
            <button
              onClick={(e) => {
                e.stopPropagation();
                setRevealed(!revealed);
              }}
              className="text-gray-400 hover:text-gray-600 transition-colors"
              title={revealed ? "Hide Amount" : "Show Amount"}
            >
              {revealed ? <EyeOff size={18} /> : <Eye size={18} />}
            </button>
          )}
        </div>
        <div className="text-sm font-semibold text-gray-500 uppercase tracking-wide">
          {label}
        </div>
      </div>

      <div className="mt-2">
        <div className="text-2xl font-bold text-gray-900 leading-tight">
          {isSensitive && !revealed ? (
            <span className="tracking-widest text-gray-400">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
          ) : (
            value
          )}
        </div>
        <div className="text-xs text-gray-500 mt-1 font-medium">{sub}</div>
      </div>
    </div>
  );
}
</file>

<file path="src/store/usePaymentStore.js">
import { create } from "zustand";
import db from "../db/database";
// CYCLE_LENGTH_DAYS = 29  ‚Üí  endDate = startDate + 29 = the 30th inclusive day
import { addDays, CYCLE_LENGTH_DAYS } from "../utils/dateUtils";

const usePaymentStore = create((set, get) => ({
  cycles: [],

  loadCycles: async () => {
    const cycles = await db.paymentCycles.toArray();
    set({ cycles });
  },

  createInitialCycle: async (customerId, startDate, totalAmount) => {
    const cycleData = {
      customerId,
      cycleStartDate: startDate,
      // Day 1 = startDate, Day 30 = startDate + 29
      cycleEndDate: addDays(startDate, CYCLE_LENGTH_DAYS),
      totalAmount,
      amountPaid: 0,
      amountPending: totalAmount,
      status: "pending",
      installments: [],
      createdAt: new Date().toISOString(),
    };
    const id = await db.paymentCycles.add(cycleData);
    const cycle = await db.paymentCycles.get(id);
    set((s) => ({ cycles: [...s.cycles, cycle] }));
    return cycle;
  },

  addInstallment: async (cycleId, amountPaid, datePaid, note = "") => {
    const cycle = await db.paymentCycles.get(cycleId);
    if (!cycle) throw new Error("Cycle not found");

    const installment = {
      id: crypto.randomUUID(),
      amountPaid: Number(amountPaid),
      datePaid,
      note,
      createdAt: new Date().toISOString(),
    };

    const updatedInstallments = [...(cycle.installments || []), installment];
    const totalPaid = updatedInstallments.reduce(
      (sum, i) => sum + i.amountPaid,
      0,
    );
    const amountPending = Math.max(0, cycle.totalAmount - totalPaid);
    const status = amountPending === 0 ? "clear" : "pending";

    const updates = {
      installments: updatedInstallments,
      amountPaid: totalPaid,
      amountPending,
      status,
    };

    await db.paymentCycles.update(cycleId, updates);
    set((s) => ({
      cycles: s.cycles.map((c) =>
        c.id === cycleId ? { ...c, ...updates } : c,
      ),
    }));
  },

  renewCycle: async (customerId, startDate, packagePrice) => {
    const allCycles = get().cycles.filter((c) => c.customerId === customerId);
    const activeCycle = allCycles.sort(
      (a, b) => new Date(b.cycleStartDate) - new Date(a.cycleStartDate),
    )[0];

    // Prevent accidental double renewal on the exact same date
    if (
      activeCycle &&
      activeCycle.cycleStartDate === startDate &&
      activeCycle.isRenewal
    ) {
      return activeCycle;
    }

    let broughtForward = 0;

    if (activeCycle && activeCycle.amountPending > 0) {
      broughtForward = activeCycle.amountPending;

      const updates = {
        amountPending: 0,
        status: "clear",
        shiftedAmount: broughtForward,
      };

      await db.paymentCycles.update(activeCycle.id, updates);

      set((s) => ({
        cycles: s.cycles.map((c) =>
          c.id === activeCycle.id ? { ...c, ...updates } : c,
        ),
      }));
    }

    const totalAmount = packagePrice + broughtForward;

    const cycleData = {
      customerId,
      cycleStartDate: startDate,
      // Day 1 = startDate, Day 30 = startDate + 29
      cycleEndDate: addDays(startDate, CYCLE_LENGTH_DAYS),
      totalAmount,
      amountPaid: 0,
      amountPending: totalAmount,
      status: "pending",
      installments: [],
      isRenewal: true,
      previousBalance: broughtForward,
      createdAt: new Date().toISOString(),
    };

    const id = await db.paymentCycles.add(cycleData);
    const cycle = await db.paymentCycles.get(id);
    set((s) => ({ cycles: [...s.cycles, cycle] }));
    return cycle;
  },

  getActiveCycle: (customerId) => {
    const all = get()
      .cycles.filter((c) => c.customerId === customerId)
      .sort((a, b) => new Date(b.cycleStartDate) - new Date(a.cycleStartDate));
    return all[0] || null;
  },

  getCyclesForCustomer: (customerId) => {
    return get()
      .cycles.filter((c) => c.customerId === customerId)
      .sort((a, b) => new Date(b.cycleStartDate) - new Date(a.cycleStartDate));
  },

  deleteCycle: async (cycleId) => {
    await db.paymentCycles.delete(cycleId);
    set((s) => ({ cycles: s.cycles.filter((c) => c.id !== cycleId) }));
  },
}));

export default usePaymentStore;
</file>

<file path="src/pages/Customers/CustomerTable.jsx">
import { useState } from "react";
import {
  Pencil,
  Trash2,
  CreditCard,
  History,
  CornerDownRight,
  AlertCircle,
  CheckCircle2,
  ArrowDownCircle,
  Clock,
  XCircle,
  FileText,
  Printer,
} from "lucide-react";
import Badge from "../../components/ui/Badge";
import WhatsAppButton from "../../components/shared/WhatsAppButton";
import Modal from "../../components/ui/Modal";
import InvoiceModal from "../../components/ui/InvoiceModal";
import { formatDate, daysUntil } from "../../utils/dateUtils";
import { MESSAGE_TEMPLATES } from "../../config/messageTemplates";
import usePaymentStore from "../../store/usePaymentStore";
import usePackageStore from "../../store/usePackageStore";

export default function CustomerTable({
  customers,
  onEdit,
  onPay,
  onDelete,
  searchQuery,
}) {
  const getActiveCycle = usePaymentStore((s) => s.getActiveCycle);
  const getCyclesForCustomer = usePaymentStore((s) => s.getCyclesForCustomer);
  const packages = usePackageStore((s) => s.packages);

  const [historyTarget, setHistoryTarget] = useState(null);
  // invoiceTarget: { customer, cycle, packageName }
  const [invoiceTarget, setInvoiceTarget] = useState(null);

  const filtered = customers.filter((c) => {
    if (!searchQuery) return true;
    const q = searchQuery.toLowerCase();
    return (
      c.fullName?.toLowerCase().includes(q) ||
      c.userName?.toLowerCase().includes(q) ||
      c.mobileNo?.includes(q) ||
      c.mainArea?.toLowerCase().includes(q)
    );
  });

  return (
    <>
      <div className="overflow-x-auto">
        <table className="w-full text-sm border-collapse">
          <thead>
            <tr className="bg-gray-100 text-gray-600 text-left">
              <th className="px-3 py-2 font-medium">Customer</th>
              <th className="px-3 py-2 font-medium">Area</th>
              <th className="px-3 py-2 font-medium">Package</th>
              <th className="px-3 py-2 font-medium">Expires</th>
              <th className="px-3 py-2 font-medium">Pending</th>
              <th className="px-3 py-2 font-medium">Status</th>
              <th className="px-3 py-2 font-medium">Actions</th>
            </tr>
          </thead>
          <tbody>
            {filtered.map((customer) => {
              const cycle = getActiveCycle(customer.id);
              const pkg = packages.find((p) => p.id === customer.packageId);
              const days = cycle ? daysUntil(cycle.cycleEndDate) : null;

              // Historical price: locked at last renewal > derived from cycle > current pkg price
              let displayPrice = null;
              if (customer.lockedPackagePrice != null) {
                displayPrice = Number(customer.lockedPackagePrice);
              } else if (cycle) {
                const carried = Number(cycle.previousBalance) || 0;
                displayPrice = Number(cycle.totalAmount) - carried;
              } else if (pkg) {
                displayPrice = Number(pkg.price);
              }

              const currentPkgPrice = pkg ? Number(pkg.price) : null;
              const priceChangedSinceLock =
                displayPrice != null &&
                currentPkgPrice != null &&
                displayPrice !== currentPkgPrice;

              let rowBg = "";
              let cycleStatus = cycle ? cycle.status : "pending";
              if (cycle) {
                if (days !== null && days < 0 && cycleStatus !== "clear") {
                  cycleStatus = "overdue";
                  rowBg = "bg-red-50";
                } else if (
                  days !== null &&
                  days <= 3 &&
                  cycleStatus !== "clear"
                ) {
                  rowBg = "bg-yellow-50";
                } else if (cycleStatus === "clear") {
                  rowBg = "";
                }
              }

              const waMessage =
                cycle && cycle.amountPending > 0
                  ? MESSAGE_TEMPLATES.paymentDue(customer, cycle)
                  : cycle
                    ? MESSAGE_TEMPLATES.expiryReminder(customer, cycle)
                    : "";

              return (
                <tr
                  key={customer.id}
                  className={`border-b border-gray-100 ${rowBg} hover:bg-gray-50`}
                >
                  <td className="px-3 py-2">
                    <div className="font-medium text-gray-800">
                      {customer.fullName}
                    </div>
                    <div className="text-xs text-gray-400">
                      {customer.userName}
                    </div>
                    {customer.mobileNo && (
                      <div className="text-xs text-gray-400">
                        {customer.mobileNo}
                      </div>
                    )}
                  </td>
                  <td className="px-3 py-2 text-gray-600">
                    {customer.mainArea || "-"}
                  </td>

                  {/* Package column with locked historical price */}
                  <td className="px-3 py-2">
                    <div className="font-medium text-gray-700">
                      {pkg ? pkg.name : "-"}
                    </div>
                    {displayPrice != null && (
                      <div
                        className="text-xs text-gray-400 mt-0.5"
                        title={
                          priceChangedSinceLock
                            ? `Current package price is PKR ${currentPkgPrice?.toLocaleString()} ‚Äî customer is on the old locked rate`
                            : undefined
                        }
                      >
                        PKR {displayPrice.toLocaleString()}
                        {priceChangedSinceLock && (
                          <span className="ml-1 text-amber-500 font-semibold">
                            *
                          </span>
                        )}
                      </div>
                    )}
                  </td>

                  <td className="px-3 py-2">
                    {cycle ? (
                      <div>
                        <div className="text-xs">
                          {formatDate(cycle.cycleEndDate)}
                        </div>
                        <div
                          className={`text-xs ${
                            days < 0
                              ? "text-red-600"
                              : days <= 3
                                ? "text-yellow-700"
                                : "text-gray-400"
                          }`}
                        >
                          {days < 0
                            ? `${-days}d overdue`
                            : days === 0
                              ? "expires today"
                              : `${days}d left`}
                        </div>
                      </div>
                    ) : (
                      "-"
                    )}
                  </td>
                  <td className="px-3 py-2">
                    {cycle && cycle.amountPending > 0 ? (
                      <span className="text-red-600 font-medium">
                        PKR {cycle.amountPending}
                      </span>
                    ) : (
                      <span className="text-green-600 text-xs">Paid</span>
                    )}
                  </td>
                  <td className="px-3 py-2">
                    <Badge
                      status={
                        customer.status === "active"
                          ? cycleStatus
                          : customer.status
                      }
                    />
                  </td>
                  <td className="px-3 py-2">
                    <div className="flex items-center gap-2 flex-wrap">
                      <button
                        onClick={() => onPay(customer)}
                        className="flex items-center gap-1 px-2 py-1 text-xs font-medium bg-blue-50 text-blue-700 rounded hover:bg-blue-100 border border-blue-200 transition-colors"
                        title="Record Payment"
                      >
                        <CreditCard size={13} /> Pay
                      </button>
                      <button
                        onClick={() => onEdit(customer)}
                        className="flex items-center gap-1 px-2 py-1 text-xs font-medium bg-white text-gray-700 rounded hover:bg-gray-50 border border-gray-300 transition-colors"
                        title="Edit Customer"
                      >
                        <Pencil size={13} /> Edit
                      </button>
                      <button
                        onClick={() => onDelete(customer)}
                        className="flex items-center gap-1 px-2 py-1 text-xs font-medium bg-white text-red-600 rounded hover:bg-red-50 border border-gray-200 transition-colors"
                        title="Delete Customer"
                      >
                        <Trash2 size={13} />
                      </button>
                      {customer.mobileNo && (
                        <WhatsAppButton
                          mobileNo={customer.mobileNo}
                          message={waMessage}
                          label="Send"
                        />
                      )}
                      <button
                        onClick={() => setHistoryTarget(customer)}
                        className="flex items-center justify-center w-7 h-7 rounded border bg-white border-gray-300 text-gray-500 hover:bg-gray-50 transition-colors"
                        title="View Payment History"
                      >
                        <History size={15} />
                      </button>
                      {/* Invoice button ‚Äî opens latest cycle's invoice */}
                      {cycle && (
                        <button
                          onClick={() =>
                            setInvoiceTarget({
                              customer,
                              cycle,
                              packageName: pkg?.name || "‚Äî",
                            })
                          }
                          className="flex items-center justify-center w-7 h-7 rounded border bg-white border-gray-300 text-gray-500 hover:bg-purple-50 hover:border-purple-300 hover:text-purple-600 transition-colors"
                          title="View / Print Latest Invoice"
                        >
                          <FileText size={15} />
                        </button>
                      )}
                    </div>
                  </td>
                </tr>
              );
            })}
            {filtered.length === 0 && (
              <tr>
                <td
                  colSpan={7}
                  className="px-3 py-8 text-center text-gray-400 text-sm"
                >
                  No customers found.
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>

      {/* History Modal ‚Äî size "lg" for more breathing room */}
      <Modal
        isOpen={!!historyTarget}
        onClose={() => setHistoryTarget(null)}
        title={
          historyTarget
            ? `Payment History ‚Äî ${historyTarget.fullName}`
            : "History"
        }
        size="lg"
      >
        {historyTarget && (
          <PaymentHistory
            customer={historyTarget}
            getCyclesForCustomer={getCyclesForCustomer}
            packages={packages}
            onInvoice={(cycle, pkgName) =>
              setInvoiceTarget({
                customer: historyTarget,
                cycle,
                packageName: pkgName,
              })
            }
          />
        )}
      </Modal>

      {/* Invoice Modal */}
      <InvoiceModal
        isOpen={!!invoiceTarget}
        onClose={() => setInvoiceTarget(null)}
        customer={invoiceTarget?.customer}
        cycle={invoiceTarget?.cycle}
        packageName={invoiceTarget?.packageName}
      />
    </>
  );
}

// ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

/**
 * A cycle that has shiftedAmount > 0 was forcibly "cleared" by the system at
 * renewal time ‚Äî the customer never actually paid. We override the display
 * status to "carried_forward" so staff are not misled by "Clear".
 */
function getCycleDisplayStatus(cycle) {
  if (Number(cycle.shiftedAmount) > 0) return "carried_forward";
  return cycle.status;
}

const STATUS_CFG = {
  clear: {
    label: "Fully Paid",
    icon: <CheckCircle2 size={13} />,
    badge: "bg-green-100 text-green-800 border-green-200",
    headerBg: "bg-green-50 border-green-200",
    cardBorder: "border-green-200",
    bar: "bg-green-500",
    pendingBg: "bg-gray-50",
    pendingText: "text-gray-400",
  },
  pending: {
    label: "Pending",
    icon: <Clock size={13} />,
    badge: "bg-yellow-100 text-yellow-800 border-yellow-200",
    headerBg: "bg-yellow-50 border-yellow-200",
    cardBorder: "border-yellow-200",
    bar: "bg-blue-500",
    pendingBg: "bg-red-50",
    pendingText: "text-red-700",
  },
  overdue: {
    label: "Overdue",
    icon: <XCircle size={13} />,
    badge: "bg-red-100 text-red-800 border-red-200",
    headerBg: "bg-red-50 border-red-200",
    cardBorder: "border-red-300",
    bar: "bg-red-400",
    pendingBg: "bg-red-50",
    pendingText: "text-red-700",
  },
  carried_forward: {
    label: "Carried Forward",
    icon: <CornerDownRight size={13} />,
    badge: "bg-orange-100 text-orange-800 border-orange-200",
    headerBg: "bg-orange-50 border-orange-200",
    cardBorder: "border-orange-300",
    bar: "bg-orange-400",
    pendingBg: "bg-orange-50",
    pendingText: "text-orange-700",
  },
};

function StatusPill({ statusKey }) {
  const cfg = STATUS_CFG[statusKey] || STATUS_CFG.pending;
  return (
    <span
      className={`inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-semibold border ${cfg.badge}`}
    >
      {cfg.icon}
      {cfg.label}
    </span>
  );
}

// ‚îÄ‚îÄ‚îÄ PaymentHistory ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function PaymentHistory({
  customer,
  getCyclesForCustomer,
  packages,
  onInvoice,
}) {
  const cycles = getCyclesForCustomer(customer.id);

  if (!cycles || cycles.length === 0) {
    return (
      <div className="flex flex-col items-center justify-center py-14 text-gray-400">
        <History size={36} className="mb-3 opacity-25" />
        <p className="text-sm">No payment history available.</p>
      </div>
    );
  }

  // Overall summary across all cycles.
  //
  // WHY we subtract previousBalance from totalAmount:
  //   When a customer is renewed with unpaid dues, the new cycle's totalAmount
  //   already includes the carried-over debt (e.g. PKR 1600 package + PKR 1600
  //   debt = PKR 3200). The old cycle's totalAmount is ALSO PKR 1600. If we
  //   naively sum all totalAmounts we count that PKR 1600 debt twice (PKR 4800).
  //   Subtracting previousBalance from each cycle gives us only the actual new
  //   package charge per cycle, avoiding double-counting.
  //
  // grandPending: only the latest cycle's amountPending is the real current
  //   outstanding ‚Äî older cycles were either paid or their debt was rolled
  //   forward into the latest cycle (and is already counted there).
  const grandBilled = cycles.reduce(
    (s, c) => s + Number(c.totalAmount || 0) - Number(c.previousBalance || 0),
    0,
  );
  const grandPaid = cycles.reduce((s, c) => s + Number(c.amountPaid || 0), 0);
  const grandPending = Number(cycles[0]?.amountPending || 0);

  return (
    <div className="space-y-5">
      {/* ‚îÄ‚îÄ Grand summary ‚îÄ‚îÄ */}
      <div className="grid grid-cols-3 gap-3">
        <div className="bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-center">
          <p className="text-[10px] font-bold uppercase text-gray-400 tracking-wide mb-1">
            Total Billed
          </p>
          <p className="text-base font-bold text-gray-800">
            PKR {grandBilled.toLocaleString()}
          </p>
          <p className="text-[10px] text-gray-400 mt-0.5">
            {cycles.length} cycle{cycles.length !== 1 ? "s" : ""}
          </p>
        </div>
        <div className="bg-green-50 border border-green-200 rounded-xl px-4 py-3 text-center">
          <p className="text-[10px] font-bold uppercase text-green-600 tracking-wide mb-1">
            Total Paid
          </p>
          <p className="text-base font-bold text-green-700">
            PKR {grandPaid.toLocaleString()}
          </p>
          <p className="text-[10px] text-green-600/70 mt-0.5">
            {grandBilled > 0
              ? Math.min(100, Math.round((grandPaid / grandBilled) * 100))
              : 0}
            % of total billed
          </p>
        </div>
        <div
          className={`rounded-xl px-4 py-3 text-center border ${
            grandPending > 0
              ? "bg-red-50 border-red-200"
              : "bg-gray-50 border-gray-200"
          }`}
        >
          <p
            className={`text-[10px] font-bold uppercase tracking-wide mb-1 ${
              grandPending > 0 ? "text-red-500" : "text-gray-400"
            }`}
          >
            Outstanding
          </p>
          <p
            className={`text-base font-bold ${
              grandPending > 0 ? "text-red-700" : "text-gray-400"
            }`}
          >
            PKR {grandPending.toLocaleString()}
          </p>
          <p
            className={`text-[10px] mt-0.5 ${grandPending > 0 ? "text-red-400" : "text-gray-400"}`}
          >
            {grandPending > 0 ? "still owed" : "fully settled"}
          </p>
        </div>
      </div>

      {/* ‚îÄ‚îÄ Per-cycle cards ‚îÄ‚îÄ */}
      <div className="space-y-4">
        {cycles.map((cycle, index) => {
          const displayStatus = getCycleDisplayStatus(cycle);
          const cfg = STATUS_CFG[displayStatus] || STATUS_CFG.pending;
          const isCarriedForward = displayStatus === "carried_forward";
          const isClear = displayStatus === "clear";
          const hasIncomingDebt = Number(cycle.previousBalance) > 0;
          const packageOnlyPrice =
            Number(cycle.totalAmount) - Number(cycle.previousBalance || 0);
          const isLatest = index === 0;

          const percentPaid =
            Number(cycle.totalAmount) > 0
              ? Math.min(
                  100,
                  Math.round(
                    (Number(cycle.amountPaid) / Number(cycle.totalAmount)) *
                      100,
                  ),
                )
              : isClear
                ? 100
                : 0;

          // For carried-forward cycles the "pending" shown should be what was shifted
          const pendingDisplay = isCarriedForward
            ? Number(cycle.shiftedAmount)
            : Number(cycle.amountPending);

          return (
            <div
              key={cycle.id}
              className={`rounded-xl border-2 overflow-hidden ${cfg.cardBorder}`}
            >
              {/* Card header */}
              <div
                className={`px-4 py-3 flex items-center justify-between border-b ${cfg.headerBg}`}
              >
                <div>
                  <div className="flex items-center gap-2 flex-wrap">
                    <span className="text-sm font-bold text-gray-800">
                      {formatDate(cycle.cycleStartDate)}
                    </span>
                    <span className="text-gray-400 text-xs">‚Üí</span>
                    <span className="text-sm font-bold text-gray-800">
                      {formatDate(cycle.cycleEndDate)}
                    </span>
                    {isLatest && (
                      <span className="text-[10px] font-bold bg-blue-600 text-white px-1.5 py-0.5 rounded uppercase tracking-wide">
                        Latest
                      </span>
                    )}
                  </div>
                  <p className="text-xs text-gray-500 mt-0.5">
                    {cycle.isRenewal ? "Renewal" : "Initial"} cycle
                    {" ¬∑ "}
                    {cycle.installments?.length || 0} payment
                    {(cycle.installments?.length || 0) !== 1 ? "s" : ""}{" "}
                    recorded
                  </p>
                </div>
                <div className="flex items-center gap-2 shrink-0">
                  <StatusPill statusKey={displayStatus} />
                  <button
                    onClick={() => {
                      // Resolve package name for this cycle
                      const pkgName =
                        packages?.find(
                          (p) => String(p.id) === String(customer.packageId),
                        )?.name || "‚Äî";
                      onInvoice(cycle, pkgName);
                    }}
                    className="flex items-center justify-center w-7 h-7 rounded border bg-white border-gray-300 text-gray-400 hover:bg-purple-50 hover:border-purple-300 hover:text-purple-600 transition-colors"
                    title="View / Print Invoice"
                  >
                    <Printer size={13} />
                  </button>
                </div>
              </div>

              <div className="px-4 py-4 bg-white space-y-4">
                {/* ‚îÄ‚îÄ CARRIED FORWARD alert ‚Äî shown on the OLD cycle ‚îÄ‚îÄ */}
                {isCarriedForward && (
                  <div className="flex items-start gap-3 bg-orange-50 border border-orange-200 rounded-lg px-3 py-3">
                    <CornerDownRight
                      size={16}
                      className="text-orange-500 mt-0.5 shrink-0"
                    />
                    <div>
                      <p className="text-sm font-semibold text-orange-800">
                        Unpaid dues moved to next cycle ‚Äî PKR{" "}
                        {Number(cycle.shiftedAmount).toLocaleString()}
                      </p>
                      <p className="text-xs text-orange-700 mt-1 leading-relaxed">
                        The customer did not pay this cycle. When the next cycle
                        was started, the full outstanding amount of{" "}
                        <strong>
                          PKR {Number(cycle.shiftedAmount).toLocaleString()}
                        </strong>{" "}
                        was automatically added to the new cycle&apos;s total
                        bill. This cycle was then marked as &quot;settled&quot;
                        by the system, but no actual payment was received.
                      </p>
                    </div>
                  </div>
                )}

                {/* ‚îÄ‚îÄ INCOMING DEBT notice ‚Äî shown on the NEW cycle ‚îÄ‚îÄ */}
                {hasIncomingDebt && (
                  <div className="flex items-start gap-3 bg-blue-50 border border-blue-200 rounded-lg px-3 py-3">
                    <ArrowDownCircle
                      size={16}
                      className="text-blue-500 mt-0.5 shrink-0"
                    />
                    <div>
                      <p className="text-sm font-semibold text-blue-800">
                        Includes unpaid debt from previous cycle ‚Äî PKR{" "}
                        {Number(cycle.previousBalance).toLocaleString()}
                      </p>
                      <p className="text-xs text-blue-700 mt-1 leading-relaxed">
                        This cycle&apos;s total of{" "}
                        <strong>
                          PKR {Number(cycle.totalAmount).toLocaleString()}
                        </strong>{" "}
                        is made up of the package price{" "}
                        <strong>
                          (PKR {packageOnlyPrice.toLocaleString()})
                        </strong>{" "}
                        plus the carried-over balance from the previous cycle{" "}
                        <strong>
                          (PKR {Number(cycle.previousBalance).toLocaleString()})
                        </strong>
                        .
                      </p>
                    </div>
                  </div>
                )}

                {/* ‚îÄ‚îÄ Financials grid ‚îÄ‚îÄ */}
                <div className="grid grid-cols-3 gap-3 text-center">
                  <div className="bg-gray-50 rounded-lg px-3 py-2.5">
                    <p className="text-[10px] font-bold uppercase text-gray-400 tracking-wide mb-1">
                      Total Bill
                    </p>
                    <p className="text-sm font-bold text-gray-800">
                      PKR {Number(cycle.totalAmount).toLocaleString()}
                    </p>
                    {hasIncomingDebt && (
                      <p className="text-[10px] text-gray-400 mt-0.5">
                        incl. PKR{" "}
                        {Number(cycle.previousBalance).toLocaleString()} debt
                      </p>
                    )}
                  </div>

                  <div className="bg-green-50 rounded-lg px-3 py-2.5">
                    <p className="text-[10px] font-bold uppercase text-green-600 tracking-wide mb-1">
                      Paid
                    </p>
                    <p className="text-sm font-bold text-green-700">
                      PKR {Number(cycle.amountPaid).toLocaleString()}
                    </p>
                  </div>

                  <div className={`rounded-lg px-3 py-2.5 ${cfg.pendingBg}`}>
                    <p
                      className={`text-[10px] font-bold uppercase tracking-wide mb-1 ${
                        isCarriedForward
                          ? "text-orange-500"
                          : pendingDisplay > 0
                            ? "text-red-500"
                            : "text-gray-400"
                      }`}
                    >
                      {isCarriedForward ? "Moved Forward" : "Pending"}
                    </p>
                    <p className={`text-sm font-bold ${cfg.pendingText}`}>
                      PKR {pendingDisplay.toLocaleString()}
                    </p>
                  </div>
                </div>

                {/* ‚îÄ‚îÄ Progress bar ‚îÄ‚îÄ */}
                <div>
                  <div className="flex justify-between text-[11px] text-gray-400 mb-1">
                    <span>Payment progress</span>
                    <span>{percentPaid}%</span>
                  </div>
                  <div className="w-full bg-gray-100 rounded-full h-2 overflow-hidden">
                    <div
                      className={`h-2 rounded-full transition-all duration-500 ${cfg.bar}`}
                      style={{ width: `${percentPaid}%` }}
                    />
                  </div>
                </div>

                {/* ‚îÄ‚îÄ Installments list ‚îÄ‚îÄ */}
                {cycle.installments && cycle.installments.length > 0 ? (
                  <div className="bg-gray-50 border border-gray-100 rounded-lg p-3">
                    <p className="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-2.5">
                      Payments Received
                    </p>
                    <div className="space-y-2">
                      {cycle.installments.map((inst) => (
                        <div
                          key={inst.id}
                          className="flex justify-between items-center bg-white rounded-lg px-3 py-2 border border-gray-100 shadow-sm"
                        >
                          <div className="flex items-center gap-2.5">
                            <div className="w-6 h-6 rounded-full bg-green-100 flex items-center justify-center shrink-0">
                              <CheckCircle2
                                size={12}
                                className="text-green-600"
                              />
                            </div>
                            <div>
                              <p className="text-xs font-semibold text-gray-800">
                                {formatDate(inst.datePaid)}
                              </p>
                              {inst.note && (
                                <p className="text-[10px] text-gray-400 mt-0.5">
                                  via {inst.note}
                                </p>
                              )}
                            </div>
                          </div>
                          <span className="text-sm font-bold text-gray-800">
                            PKR {Number(inst.amountPaid).toLocaleString()}
                          </span>
                        </div>
                      ))}
                    </div>
                  </div>
                ) : (
                  !isCarriedForward && (
                    <div className="flex items-center gap-2 text-xs text-gray-400 bg-gray-50 border border-gray-100 rounded-lg px-3 py-2.5">
                      <AlertCircle size={13} className="shrink-0" />
                      No payments recorded for this cycle.
                    </div>
                  )
                )}
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
}
</file>

<file path="src/pages/Payments/PaymentForm.jsx">
import { useState, useEffect } from "react";
import {
  AlertTriangle,
  CheckCircle,
  Clock,
  RefreshCw,
  CreditCard,
  Calendar,
  Info,
  FileText,
} from "lucide-react";
import { today, daysUntil } from "../../utils/dateUtils";
import usePaymentStore from "../../store/usePaymentStore";
import usePackageStore from "../../store/usePackageStore";
import useCustomerStore from "../../store/useCustomerStore";
import InvoiceModal from "../../components/ui/InvoiceModal";

// ‚îÄ‚îÄ‚îÄ Scenario helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

/**
 * Returns one of four scenarios:
 *   "overdue"       ‚Äì cycle expired AND unpaid balance remains
 *   "early_renewal" ‚Äì cycle still active AND fully clear (paid), renewing early
 *   "partial_active"‚Äì cycle still active BUT balance still pending (partial pay)
 *   "no_cycle"      ‚Äì customer has never had a cycle
 */
function getScenario(activeCycle, days) {
  if (!activeCycle) return "no_cycle";
  const expired = days < 0;
  const clear = activeCycle.status === "clear";
  if (expired) return "overdue";
  if (clear) return "early_renewal";
  return "partial_active";
}

// ‚îÄ‚îÄ‚îÄ Alert banner sub-component ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function ScenarioBanner({ scenario, days, activeCycle }) {
  if (scenario === "no_cycle") {
    return (
      <div className="flex items-start gap-3 rounded-xl bg-blue-50 border border-blue-200 px-4 py-3">
        <Info size={18} className="text-blue-600 mt-0.5 shrink-0" />
        <div className="text-sm text-blue-800">
          <p className="font-semibold">No active billing cycle found.</p>
          <p className="mt-0.5 text-blue-700">
            This will create the customer&apos;s very first billing cycle.
          </p>
        </div>
      </div>
    );
  }

  if (scenario === "overdue") {
    const overdueDays = Math.abs(days);
    return (
      <div className="flex items-start gap-3 rounded-xl bg-red-50 border border-red-200 px-4 py-3">
        <AlertTriangle size={18} className="text-red-600 mt-0.5 shrink-0" />
        <div className="text-sm text-red-800">
          <p className="font-semibold">
            ‚ö†Ô∏è Account is overdue by {overdueDays} day
            {overdueDays !== 1 ? "s" : ""}!
          </p>
          <p className="mt-0.5 text-red-700">
            Cycle ended on <strong>{activeCycle.cycleEndDate}</strong>.
            {activeCycle.amountPending > 0 && (
              <>
                {" "}
                Outstanding balance of{" "}
                <strong>
                  PKR {activeCycle.amountPending.toLocaleString()}
                </strong>{" "}
                will be carried forward automatically into the new cycle.
              </>
            )}
          </p>
        </div>
      </div>
    );
  }

  if (scenario === "early_renewal") {
    return (
      <div className="flex items-start gap-3 rounded-xl bg-amber-50 border border-amber-200 px-4 py-3">
        <AlertTriangle size={18} className="text-amber-600 mt-0.5 shrink-0" />
        <div className="text-sm text-amber-800">
          <p className="font-semibold">
            ‚ö†Ô∏è Renewing early ‚Äî {days} day{days !== 1 ? "s" : ""} remaining in
            current cycle.
          </p>
          <p className="mt-0.5 text-amber-700">
            The current cycle ends on{" "}
            <strong>{activeCycle.cycleEndDate}</strong>. Renewing now will{" "}
            <strong>
              waste the remaining {days} day{days !== 1 ? "s" : ""}
            </strong>
            . The new cycle starts today.
          </p>
        </div>
      </div>
    );
  }

  if (scenario === "partial_active") {
    return (
      <div className="flex items-start gap-3 rounded-xl bg-yellow-50 border border-yellow-200 px-4 py-3">
        <CreditCard size={18} className="text-yellow-700 mt-0.5 shrink-0" />
        <div className="text-sm text-yellow-800">
          <p className="font-semibold">Pending payment on active cycle.</p>
          <p className="mt-0.5 text-yellow-700">
            The current cycle has{" "}
            <strong>
              {days} day{days !== 1 ? "s" : ""} left
            </strong>{" "}
            (expires <strong>{activeCycle.cycleEndDate}</strong>). Record a
            payment below or renew the cycle early.
          </p>
        </div>
      </div>
    );
  }

  return null;
}

// ‚îÄ‚îÄ‚îÄ Billing summary row ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function SummaryRow({ label, value, valueClass = "text-gray-800" }) {
  return (
    <div className="flex justify-between items-center text-sm py-1.5 border-b border-gray-100 last:border-0">
      <span className="text-gray-500">{label}</span>
      <span className={`font-semibold ${valueClass}`}>{value}</span>
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ Main Component ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

export default function PaymentForm({ customer, onClose }) {
  const getActiveCycle = usePaymentStore((s) => s.getActiveCycle);
  const addInstallment = usePaymentStore((s) => s.addInstallment);
  const renewCycle = usePaymentStore((s) => s.renewCycle);
  const updateCustomer = useCustomerStore((s) => s.updateCustomer);
  const packages = usePackageStore((s) => s.packages);

  const activeCycle = getActiveCycle(customer.id);
  const days = activeCycle ? daysUntil(activeCycle.cycleEndDate) : 0;

  const scenario = getScenario(activeCycle, days);

  // Whether to show the RENEWAL UI vs. just "record payment" UI
  // Overdue and no_cycle always force renewal.
  // partial_active: admin can optionally choose to renew early.
  // early_renewal: already flagged, show renewal by default.
  const forceRenewal = scenario === "overdue" || scenario === "no_cycle";
  const [wantsRenewal, setWantsRenewal] = useState(
    forceRenewal || scenario === "early_renewal",
  );
  const isRenewal = forceRenewal || wantsRenewal;

  const [selectedPkgId, setSelectedPkgId] = useState(
    String(customer.packageId || (packages[0]?.id ?? "")),
  );
  const [amount, setAmount] = useState("");
  const [date, setDate] = useState(today());
  const [note, setNote] = useState("");
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState("");
  // After a successful save, store the resulting cycle here to offer invoice
  const [invoiceData, setInvoiceData] = useState(null);

  const selectedPkg = packages.find(
    (p) => String(p.id) === String(selectedPkgId),
  );
  const renewalPrice = selectedPkg ? Number(selectedPkg.price) : 0;

  // Auto-fill amount whenever package or mode changes
  useEffect(() => {
    if (isRenewal) {
      setAmount(renewalPrice > 0 ? String(renewalPrice) : "");
    } else if (activeCycle) {
      setAmount(String(activeCycle.amountPending));
    }
    setError("");
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [isRenewal, selectedPkgId]);

  const maxPayable = isRenewal ? undefined : (activeCycle?.amountPending ?? 0);

  const handleSubmit = async () => {
    setError("");
    const amt = Number(amount) || 0;

    if (!isRenewal) {
      if (amt <= 0) {
        setError("Enter a valid amount greater than 0.");
        return;
      }
      if (activeCycle && amt > activeCycle.amountPending) {
        setError(
          `Amount exceeds outstanding balance of PKR ${activeCycle.amountPending.toLocaleString()}.`,
        );
        return;
      }
    }

    setSaving(true);
    try {
      let resultCycle;
      if (isRenewal) {
        if (String(selectedPkgId) !== String(customer.packageId)) {
          await updateCustomer(customer.id, {
            packageId: Number(selectedPkgId),
            lockedPackagePrice: renewalPrice,
          });
        }
        resultCycle = await renewCycle(customer.id, date, renewalPrice);
        if (amt > 0) {
          await addInstallment(resultCycle.id, amt, date, note);
          // Re-fetch cycle from store so amountPaid is up to date
          resultCycle = usePaymentStore.getState().getActiveCycle(customer.id);
        }
      } else {
        await addInstallment(activeCycle.id, amt, date, note);
        resultCycle = usePaymentStore.getState().getActiveCycle(customer.id);
      }
      // Show invoice prompt instead of immediately closing
      setInvoiceData({
        cycle: resultCycle,
        packageName: selectedPkg?.name || "‚Äî",
      });
    } catch (err) {
      setError("Error: " + err.message);
    }
    setSaving(false);
  };

  // ‚îÄ‚îÄ Derived labels ‚îÄ‚îÄ
  const modeTag = isRenewal ? (
    <span className="inline-flex items-center gap-1 bg-blue-100 text-blue-700 text-xs font-bold px-2.5 py-1 rounded-full">
      <RefreshCw size={11} />
      RENEWAL
    </span>
  ) : (
    <span className="inline-flex items-center gap-1 bg-green-100 text-green-700 text-xs font-bold px-2.5 py-1 rounded-full">
      <CreditCard size={11} />
      PAYMENT
    </span>
  );

  return (
    <div className="space-y-5 p-1">
      {/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */}
      <div className="flex items-center justify-between">
        <div>
          <h3 className="text-lg font-bold text-gray-900 leading-tight">
            {customer.fullName}
          </h3>
          <p className="text-xs text-gray-400 mt-0.5">{customer.userName}</p>
        </div>
        {modeTag}
      </div>

      {/* ‚îÄ‚îÄ SCENARIO BANNER ‚îÄ‚îÄ */}
      <ScenarioBanner
        scenario={scenario}
        days={days}
        activeCycle={activeCycle}
      />

      {/* ‚îÄ‚îÄ CURRENT CYCLE SUMMARY (shown only when cycle is active & not doing renewal) ‚îÄ‚îÄ */}
      {activeCycle && !isRenewal && (
        <div className="rounded-xl bg-gray-50 border border-gray-200 px-4 py-3 space-y-0.5">
          <p className="text-xs font-bold uppercase text-gray-400 tracking-wide mb-2">
            Current Billing Cycle
          </p>
          <SummaryRow
            label="Period"
            value={`${activeCycle.cycleStartDate} ‚Üí ${activeCycle.cycleEndDate}`}
          />
          <SummaryRow
            label="Total Bill"
            value={`PKR ${Number(activeCycle.totalAmount).toLocaleString()}`}
          />
          <SummaryRow
            label="Paid So Far"
            value={`PKR ${Number(activeCycle.amountPaid).toLocaleString()}`}
            valueClass="text-green-700"
          />
          <SummaryRow
            label="Outstanding Balance"
            value={`PKR ${Number(activeCycle.amountPending).toLocaleString()}`}
            valueClass={
              activeCycle.amountPending > 0 ? "text-red-600" : "text-green-700"
            }
          />
          {activeCycle.amountPending === 0 && (
            <div className="flex items-center gap-1.5 mt-2 text-xs text-green-700 font-semibold">
              <CheckCircle size={13} />
              Fully paid for this cycle
            </div>
          )}
        </div>
      )}

      {/* ‚îÄ‚îÄ RENEWAL: PACKAGE SELECTOR ‚îÄ‚îÄ */}
      {isRenewal && (
        <div className="rounded-xl bg-blue-50 border border-blue-100 px-4 py-4 space-y-3">
          <p className="text-xs font-bold uppercase text-blue-700 tracking-wide">
            New Billing Cycle ‚Äî Select Package
          </p>
          <select
            value={selectedPkgId}
            onChange={(e) => {
              setSelectedPkgId(e.target.value);
              setAmount("");
            }}
            className="w-full bg-white border border-blue-200 rounded-lg px-3 py-2.5 text-sm font-medium text-gray-800 focus:ring-2 focus:ring-blue-500 outline-none"
          >
            {packages.map((p) => (
              <option key={p.id} value={p.id}>
                {p.name} ‚Äî PKR {Number(p.price).toLocaleString()}
              </option>
            ))}
          </select>

          {/* Show carried-over debt clearly */}
          {activeCycle && activeCycle.amountPending > 0 && (
            <div className="bg-white border border-red-200 rounded-lg px-3 py-2.5 text-sm space-y-1">
              <p className="font-semibold text-gray-700">New cycle summary:</p>
              <div className="flex justify-between text-gray-600">
                <span>Package price</span>
                <span>PKR {renewalPrice.toLocaleString()}</span>
              </div>
              <div className="flex justify-between text-red-600 font-medium">
                <span>Carried over debt</span>
                <span>
                  + PKR {Number(activeCycle.amountPending).toLocaleString()}
                </span>
              </div>
              <div className="flex justify-between font-bold text-gray-900 border-t border-gray-100 pt-1 mt-1">
                <span>Total due</span>
                <span>
                  PKR{" "}
                  {(
                    renewalPrice + Number(activeCycle.amountPending)
                  ).toLocaleString()}
                </span>
              </div>
            </div>
          )}
        </div>
      )}

      {/* ‚îÄ‚îÄ TOGGLE: offer early renewal for partial_active ‚îÄ‚îÄ */}
      {scenario === "partial_active" && (
        <div className="flex items-center gap-3 bg-gray-50 border border-gray-200 rounded-xl px-4 py-3">
          <input
            type="checkbox"
            id="earlyRenew"
            checked={wantsRenewal}
            onChange={(e) => setWantsRenewal(e.target.checked)}
            className="w-4 h-4 accent-blue-600 cursor-pointer"
          />
          <label
            htmlFor="earlyRenew"
            className="text-sm text-gray-700 cursor-pointer select-none"
          >
            <span className="font-semibold">Renew cycle early instead</span>
            <span className="block text-xs text-gray-400 mt-0.5">
              This will start a fresh 30-day cycle today and carry over any
              unpaid balance.
            </span>
          </label>
        </div>
      )}

      {/* ‚îÄ‚îÄ INPUT FIELDS ‚îÄ‚îÄ */}
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-semibold text-gray-700 mb-1.5">
            Amount Paid{" "}
            {isRenewal && (
              <span className="text-gray-400 font-normal">(Optional)</span>
            )}
          </label>
          <input
            type="number"
            min="0"
            max={maxPayable || undefined}
            className="w-full border border-gray-300 rounded-lg px-3 h-11 text-base focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
            value={amount}
            onChange={(e) => {
              setAmount(e.target.value);
              setError("");
            }}
            placeholder={
              isRenewal
                ? `Suggested: ${renewalPrice.toLocaleString()}`
                : `Max: PKR ${(maxPayable || 0).toLocaleString()}`
            }
          />
          {isRenewal && (
            <p className="text-xs text-gray-400 mt-1">
              Leave 0 to renew without recording a payment now.
            </p>
          )}
        </div>

        <div>
          <label className="block text-sm font-semibold text-gray-700 mb-1.5">
            Date <span className="text-red-500">*</span>
          </label>
          <div className="relative">
            <Calendar
              size={15}
              className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"
            />
            <input
              type="date"
              max={today()}
              className="w-full border border-gray-300 rounded-lg pl-9 pr-3 h-11 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
              value={date}
              onChange={(e) => setDate(e.target.value)}
            />
          </div>
        </div>
      </div>

      <div>
        <label className="block text-sm font-semibold text-gray-700 mb-1.5">
          Note <span className="text-gray-400 font-normal">(optional)</span>
        </label>
        <input
          className="w-full border border-gray-300 rounded-lg px-3 h-11 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all"
          value={note}
          onChange={(e) => setNote(e.target.value)}
          placeholder="e.g. Cash, JazzCash, EasyPaisa..."
        />
      </div>

      {/* ‚îÄ‚îÄ ERROR ‚îÄ‚îÄ */}
      {error && (
        <div className="flex items-center gap-2 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm font-medium">
          <AlertTriangle size={15} className="shrink-0" />
          {error}
        </div>
      )}

      {/* ‚îÄ‚îÄ QUICK SUMMARY before submit ‚Äî hidden after successful save ‚îÄ‚îÄ */}
      {!invoiceData && (Number(amount) > 0 || isRenewal) && (
        <div className="bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm text-gray-600 space-y-1">
          <p className="font-semibold text-gray-800 text-xs uppercase tracking-wide mb-1.5">
            <Clock size={12} className="inline mr-1 mb-0.5" />
            Action Summary
          </p>
          {isRenewal && (
            <p>
              ‚úÖ Start a new 30-day billing cycle for{" "}
              <strong>{selectedPkg?.name}</strong> at{" "}
              <strong>PKR {renewalPrice.toLocaleString()}</strong>.
            </p>
          )}
          {Number(amount) > 0 && (
            <p>
              üí∞ Record payment of{" "}
              <strong>PKR {Number(amount).toLocaleString()}</strong> on{" "}
              <strong>{date}</strong>
              {note ? ` via ${note}` : ""}.
            </p>
          )}
          {isRenewal && Number(amount) === 0 && (
            <p className="text-amber-600">
              ‚ö†Ô∏è No payment recorded ‚Äî cycle will be renewed with full amount
              pending.
            </p>
          )}
        </div>
      )}

      {/* ‚îÄ‚îÄ ACTIONS ‚îÄ‚îÄ */}
      <div className="flex justify-end gap-3 pt-1">
        <button
          onClick={onClose}
          className="px-5 py-2.5 text-sm font-medium border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors"
        >
          Cancel
        </button>
        <button
          onClick={handleSubmit}
          disabled={saving || !!invoiceData}
          className={`px-6 py-2.5 text-sm font-semibold rounded-lg text-white shadow-sm transition-colors disabled:opacity-40 disabled:cursor-not-allowed flex items-center gap-2 ${
            isRenewal
              ? "bg-blue-600 hover:bg-blue-700"
              : "bg-green-600 hover:bg-green-700"
          }`}
        >
          {saving ? (
            "Processing..."
          ) : isRenewal ? (
            <>
              <RefreshCw size={14} />
              Renew Cycle
            </>
          ) : (
            <>
              <CreditCard size={14} />
              Record Payment
            </>
          )}
        </button>
      </div>

      {/* ‚îÄ‚îÄ SUCCESS: show invoice prompt after save ‚îÄ‚îÄ */}
      {invoiceData && (
        <div className="mt-2 flex items-center justify-between bg-green-50 border border-green-200 rounded-xl px-4 py-3">
          <div className="flex items-center gap-2 text-sm text-green-800 font-medium">
            <CheckCircle size={16} className="text-green-600" />
            Saved successfully!
          </div>
          <div className="flex gap-2">
            <button
              onClick={() => setInvoiceData({ ...invoiceData, show: true })}
              className="flex items-center gap-1.5 px-3 py-1.5 text-xs font-semibold bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors"
            >
              <FileText size={13} />
              View Invoice
            </button>
            <button
              onClick={onClose}
              className="px-3 py-1.5 text-xs font-medium border border-green-300 text-green-700 rounded-lg hover:bg-green-100 transition-colors"
            >
              Close
            </button>
          </div>
        </div>
      )}

      {/* Invoice modal ‚Äî shown after successful save */}
      <InvoiceModal
        isOpen={!!invoiceData?.show}
        onClose={() => setInvoiceData(null)}
        customer={customer}
        cycle={invoiceData?.cycle}
        packageName={invoiceData?.packageName}
      />
    </div>
  );
}
</file>

</files>
